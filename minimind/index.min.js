/*! Copyright minimind 19-03-2021 */

let UnitActionBuild=t=>(class extends t{buildInit(t={}){this.build=t;const e=this.build;e.started=!1,e.start=this.buildStart,e.stop=this.buildStop}buildDeinit(){this.build.started&&this.buildStop()}buildStart(t){const e=this.build;e.started=!0,e.unit=t,this.buildDo()}buildStop(){this.currentAction=null,this.build.started=!1}buildDo(){const t=this.build;new UnitSpawner(this.scene,t.unit.x,t.unit.y,this.player,{parent:t.unit});t.unit.destroy()}}),UnitActionConnect=t=>(class extends t{connectInit(t){this.connect=t;const e=this.connect;e.start=this.connectStart,e.stop=this.connectStop,e.started=!1,e.range=this.scene.scaleResolution(this.connect.range),e.rangeSquared=this.connect.range*this.connect.range,e.target=null,this.actionImage=this.scene.cardScene.add.image(this.scene.cameras.main.centerX,this.scene.cameras.main.centerY,"ActionProgress"),this.actionImage.visible=!1,this.actionImage.setDepth(2),this.actionImage.alpha=.5,this.actionImage.setTint(16711935);let i=this.scene.add.sprite(this.scene.cameras.main.centerX,this.scene.cameras.main.centerY,"laser");this.scene.anims.create({key:"Laser",frames:this.scene.anims.generateFrameNumbers("Laser"),frameRate:8,repeat:-1,yoyo:!1}),i.anims.play("Laser"),i.visible=!1,i.setOrigin(0,.5),this.laser=i,this.laser.setTint(16724787)}connectDeinit(){this.laser.destroy(),this.connect.started&&this.connectStop()}connectStart(t){const e=this.connect;e.started=!0,e.target=t,e.target.addListener(this),this.connectDo(),this.laser.visible=!0,this.actionImage.visible=!0}connectStop(){this.currentAction=null;const t=this.connect;if(t.started=!1,this.connectValid()){let t=this.control.target.unit;t||(t=new UnitRoute(this.scene,this.lastX,this.lastY,this.player,{})),this.connect.target.addRoute(t),this.scene.cardScene.statusBot.update(-1)}this.laser.visible=!1,this.actionImage.visible=!1,t.target.removeListener(this),t.target=null}connectValid(){return Phaser.Math.Distance.Between(this.lastX,this.lastY,this.connect.target.x,this.connect.target.y)>2*this.width}connectDo(){this.connect;this.laser.x=this.x,this.laser.y=this.y;let t=Phaser.Math.Angle.BetweenPoints(this.laser,this.connect.target);this.laser.setRotation(t);var e=Phaser.Math.Distance.Between(this.laser.x,this.laser.y,this.connect.target.x,this.connect.target.y);if(this.laser.scaleX=e/this.laser.width,this.lastX=this.x,this.lastY=this.y,this.connectValid()){const t=16711935;this.laser.tint=t,this.actionImage.tint=t}else{const t=16711680;this.laser.tint=t,this.actionImage.tint=t}}}),UnitActionControl=t=>(class extends t{controlInit(t){this.control=t,this.control.started=!1,this.targetPosition=null,this.targetPositionImage=this.scene.add.image(0,0,"ControlTarget"),this.targetPositionImage.visible=!1,this.control.target={unit:null,focus:null,focusImage:this.scene.add.image(this.x,this.y,UnitBot.name+"Target"),img:this.scene.add.image(this.x,this.y,UnitBot.name+"Target")},this.control.target.img.visible=!1,this.control.target.focusImage.visible=!1,this.control.target.focusImage.tint=10066329,this.control.speed=1,this.currentAction=null,this.control.action=null,this.body.moves=!0,this.body.immovable=!1}controlDeinit(){const t=this.control;t.started&&this.controlStop(),t.action&&t.action.menuDeinit(),t.target.img.destroy(),t.target.focusImage.destroy(),this.control=null}controlStart(){this.control.started=!0,this.setDrag(1.5*this.body.maxSpeed),this.body.setAllowDrag(!0)}controlStop(){this.control.started=!1}controlDo(t,e,i,s,n){const a=this.control;if(null===a.action){if(t||e||i||s){n&&this.controlResume(null);let h=this,o=this.x,r=this.y;t?r-=a.speed:e&&(r+=a.speed),i?o-=a.speed:s&&(o+=a.speed);let l=Phaser.Math.Angle.Between(h.x,h.y,o,r);h.rotation=Phaser.Math.Angle.RotateTo(h.rotation,l,a.turnSpeed),this.scene.physics.velocityFromRotation(this.rotation,this.body.maxSpeed,this.body.acceleration)}else if(n)this.controlPause();else if(this.targetPosition){let t=Phaser.Math.Angle.Between(this.x,this.y,this.targetPosition[0],this.targetPosition[1]);this.rotation=Phaser.Math.Angle.RotateTo(this.rotation,t,a.turnSpeed),this.scene.physics.velocityFromRotation(this.rotation,this.body.maxSpeed,this.body.acceleration)}if(null!==this.targetPosition){Phaser.Math.Distance.Squared(this.x,this.y,this.targetPosition[0],this.targetPosition[1])<this.targetPositionProximity&&this.controlPause()}}else n&&(t||e||i||s)&&a.action.actionSelect(t,e,i,s)}controlPause(){this.setFrame(0),this.body.setAcceleration(0),null!==this.targetPosition&&(this.targetPositionImage.visible=!1,this.targetPosition=null)}controlResume(t){if(this.targetPosition=t,this.setFrame(1),t){this.targetPositionImage.setPosition(t[0],t[1]);let e=Phaser.Math.Distance.Squared(this.x,this.y,t[0],t[1]);this.targetPositionProximity=e/5,this.targetPositionProximity>this.width*this.width*2&&(this.targetPositionProximity=this.width*this.width*2)}this.targetPositionImage.visible=null!==t}controlPoint(t){if(null!==this.control.action)return this.controlPause(),!1;if(t){if(this.getBounds().contains(t[0],t[1]))return this.control.pad.select(),!0;this.controlResume(t)}else this.controlPause();return!0}controlAction(t){const e=this.control;return this.currentAction?(this.currentAction.stop.call(this),void(this.currentAction=null)):e.action?(e.action.actionActivate(),void(e.action=null)):(e.target.unit?this.currentAction||(e.action=e.target.unit,e.action.menuStart(this),e.target.unit=null,e.target.img.visible=!1,e.target.focus=null,e.target.focusImage.visible=!1):this.spawnStart(),void this.controlPause())}}),UnitActionFollow=t=>(class extends t{followInit(t={}){this.follow=t,this.follow.started=!1}followDeinit(){this.follow.started&&this.followStop()}followStart(t){const e=this.follow;e.started=!0,e.path=t,this.body.enable=!1,this.visible=!1;let i=new Phaser.Curves.Path(t[0].x,t[0].y);for(let e=1,s=t.length-1;e<s;e++)i.lineTo(t[e].x,t[e].y);this.pathFollower=this.scene.add.follower(i,t[0].x,t[0].y,UnitElement.name),this.pathFollower.setTint(13421772),this.pathFollower.startFollow({duration:500*t.length,onComplete:(e,i)=>{if(this.x=this.pathFollower.x,this.y=this.pathFollower.y,this.pathFollower.destroy(!0),this.pathFollower=null,0===this.decay.timeout)return this.destroy(),!1;let s=t[t.length-2],n=!1;s.unit.damage>0?(s.unit.damage-=this.unit.health-this.unit.damage,s.unit.damage<0&&(s.unit.damage=0),s.updateDamage(),n=!0):(this.unit.gravity=s,this.spawn()),this.followStop(),n&&this.destroy()}})}followStop(){const t=this.follow;t.path=null,t.started=!1}followDo(){this.follow;this.unit.disabled}}),UnitActionGuard=t=>(class extends t{guardInit(t){this.guard=t;const e=this.guard;e.time=1/0,e.range*=this.scene.game.resolutionSquared,e.followDist=e.followDist*this.scene.game.resolutionSquared||0,e.rangeSquared=e.range*e.range,e.homeRangeSquared=e.homeRange*e.homeRange,e.homeDist=this.width*this.width/4,e.homeX=this.x,e.homeY=this.y,e.goHome=!1,e.enemy=null,e.followDistSquared=e.followDist*e.followDist}guardDeinit(){this.guard.time!==1/0&&this.guardStop()}guardStart(t){const e=this.guard;e.time=0,e.unit=t}guardStop(){const t=this.guard;t.time=1/0,t.unit=null}guardFollow(){const t=this.guard;return Phaser.Math.Distance.Squared(this.x,this.y,t.enemy.x,t.enemy.y)>t.followDistSquared&&this.guardTarget(null),200}guardFindEnemy(t){const e=this.guard;for(let i=0;i<this.scene.teamTroops.length;i++){const s=this.scene.teamTroops[i];if(this.player.team.id===i)continue;let n=s.getChildren();for(let i=n.length-1;i>=0;i--){let s=n[i];if(t<s.unit.guardTime)continue;let a=Phaser.Math.Distance.Squared(s.x,s.y,e.unit.x,e.unit.y)-e.rangeSquared;if(a<=0)return this.guardTarget(s),0;{const e=9e4;let i=200;a>e&&(i*=a/e),s.unit.guardTime=t+i}}}return 1e3}}),UnitActionMenu=t=>(class extends t{menuInit(t={}){this.action=t;const e=this.action;e.started=!1,e.list=t.actions,e.actions=[],e.selected=null}menuDeinit(){this.action.started&&this.menuStop()}menuStart(t){const e=this.action;e.started=!0;if(e.actions.push(new UIAction(this,"ActionCancel",null,null,"center","green",0)),this.unit.damage>0)e.actions.push(new UIAction(this,"ActionSpawn",t,t.spawn,"up","green",1));else{const i=["up","right","down","left"];for(let s=0;s<e.list.length;s++){let n=e.list[s];n===Unit.Action.Connect&&e.actions.push(new UIAction(this,"ActionConnect",t,t.connect,i[s],"lila",1)),n===Unit.Action.Teleport&&e.actions.push(new UIAction(this,"ActionTeleport",t,t.teleport,i[s],"blue",0)),n===Unit.Action.Build&&e.actions.push(new UIAction(this,"ActionBuild",t,t.build,i[s],"blue",0))}}e.selected=e.actions[0]}menuStop(){const t=this.action;for(t.started=!1;t.actions.length>0;){let e=t.actions.shift();(e!==this.action.selected||this.scene.cardScene.isGameOver)&&this.scene.tweens.add({targets:[e.first,e.next,e.icon],alpha:0,ease:"Power1",duration:150,onCompleteScope:this,onComplete:function(){e.destroy()}},this)}}setSelected(t){const e=this.action;e.selected&&e.selected.setState("enabled"),t.setState("active"),e.selected=t}menuSelect(t,e,i){const s=this.action;if(!s.started)return null;for(let i=0;i<s.actions.length;i++){let n=s.actions[i];if(n.first.setTexture("ActionBg"),n.first.getBounds().contains(t,e)){if("disabled"!==n.state)return this.setSelected(n),this.actionActivate(),null;n.showStatus()}}return this}actionSelect(t,e,i,s){const n=this.action;if(t+e+i+s>1&&n.selected!==n.actions[0])return;for(let t=0;t<n.actions.length;t++){n.actions[t].first.setTexture("ActionBg")}let a=0;t?a=1:e&&(a=3),i?a=4:s&&(a=2),a>=n.actions.length&&(a=0),"disabled"!==n.actions[a].state?this.setSelected(n.actions[a]):n.actions[a].showStatus()}actionActivate(){this.action;let t=this.action.selected;t.setState("active");this.scene.cameras.main.centerX,this.scene.cameras.main.centerY;let e=t.actionUnit;this.scene.tweens.add({targets:[t.first,t.next,t.icon],ease:"Power1",alpha:0,duration:750,onCompleteScope:this,onComplete:function(){if(t.action){this.scene.cardScene.energy;e.activateAction(t.action,t.menuUnit)}}},this),this.menuStop()}}),UnitActionMove=t=>(class extends t{moveInit(t){this.move=t;const e=this.move;e.time=1/0,this.body.moves=!0,this.body.immovable=!1,this.body.maxSpeed=e.speed*this.scene.game.resolution,this.setDrag(this.body.maxSpeed,this.body.maxSpeed),this.body.setAllowDrag(!0),e.toUnit=null,e.area=null}moveDeinit(){this.move.time!==1/0&&this.moveStop()}moveStart(t=null){const e=this.move;e.time!==1/0&&this.moveStop(),e.time=0,t instanceof Phaser.GameObjects.Sprite?(e.toUnit=t,e.toUnit.addListener(this)):null!==t&&(e.area=t)}moveStop(){const t=this.move;t.time=1/0,null!==t.toUnit&&(t.toUnit.removeListener(this),t.toUnit=null)}moveDo(){const t=this.move;return null!==t.toUnit?this.moveToUnit():(e=this.x<t.area.x?0:this.y<t.area.y?Math.PI/2:this.x>t.area.x+t.area.w?Math.PI:this.y>t.area.y+t.area.h?-Math.PI/2:Phaser.Math.Angle.Random(),this.scene.physics.velocityFromRotation(e,this.body.maxSpeed,this.body.acceleration),2e3);var e}moveEvent(t,e){"stop"===e&&t===this.move.toUnit&&(this.moveStop(),this.moveStart(this.unit.parent))}moveToUnit(){const t=this.move;let e=Phaser.Math.Angle.BetweenPoints(this,t.toUnit);this.scene.physics.velocityFromRotation(e,this.body.maxSpeed,this.body.acceleration);return 1e3}}),UnitActionProduce=t=>(class extends t{produceInit(t){this.produce=t,this.produce.started=!1,0===this.unit.damage&&this.produceStart()}produceDeinit(){this.produce.started&&this.produceStop()}produceStart(){this.unit.disabled=!1;const t=this.produce;t.started=!0,t.paths=[],this.produce.delay>0&&(this.produce.timeout=this.produce.delay,this.scene.addEvent(this.produceDo,this.produce.timeout,this))}produceStop(){this.unit.disabled=!0;const t=this.produce;t.paths=[],t.started=!1,this.produce.timeout=0}produceDo(){this.unit.disabled>0||(this.produce.timeout>0&&this.scene.addEvent(this.produceDo,this.produce.timeout,this),0!==this.route.connectEmitter.length&&this.produceUnit())}produceAddPath(t){for(let e=0;e<this.produce.paths.length;e++){let i=this.produce.paths[e];if(i[i.length-2]===t[t.length-2])return}this.produce.paths.push(t)}produceRemovePath(t){for(let e=0;e<this.produce.paths.length;e++){let i=this.produce.paths[e];if(i[i.length-2]===t[i.length-2]){this.produce.paths.slice(e,1);break}}}}),UnitActionRoute=t=>(class extends t{routeInit(t){this.route=t;const e=this.route;e.started=!1,e.rangeMin=this.width,e.rangeMinSquared=e.rangeMin*e.rangeMin,e.range=this.scene.scaleResolution(t.range),e.rangeSquared=e.range*e.range,e.sources=[],e.targets=[],e.connectEmitter=[]}routeDeinit(){this.route.started&&this.stopRoute()}startRoute(){this.route.started=!0}stopRoute(){this.route.started=!1,this.clearRoutes()}clearRoutes(){const t=this.route;t.sources.forEach(function(t){t.routeTargetRemove(this)},this),t.sources=[],t.targets.forEach(function(t){t.routeSourceRemove(this)},this),t.targets=[]}updateRoutes(){const t=this.route;this.stopRoute();const e=this.scene.mapUnitGroup.getChildren();for(let i=e.length-1;i>=0;i--){let s=e[i];s!==this&&s.player.id===this.player.id&&(Phaser.Math.Distance.Squared(s.x,s.y,this.x,this.y),t.rangeSquared)}}addRoute(t){const e=this.route;for(let i=0;i<e.targets.length;i++){if(e.targets[i]===t)return;if(e.sources[i]===t)return}e.targets.push(t),t.route.sources.push(this),this.scene.unitMap.refresh(this)}routeTargetRemove(t){const e=this.route;for(let i=0;i<e.targets.length;i++)if(e.targets[i]===t){e.targets.splice(i,1),this.scene.unitMap.refresh();break}}routeSourceRemove(t){const e=this.route;for(let i=0;i<e.sources.length;i++)if(e.sources[i]===t){e.sources.splice(i,1),this.scene.unitMap.refresh();break}}drawRoute(t){const e=this.route;if(t){const t=this.scene;this.dragTexture&&this.dragTexture.destroy(),this.dragTexture=t.add.renderTexture(this.x,this.y,2*e.range,2*e.range),this.dragTexture.setOrigin(.5);let i=new Phaser.GameObjects.Graphics(t);i.fillStyle(16711935,.25),i.setBlendMode(Phaser.BlendModes.SCREEN),i.fillCircle(e.range,e.range,e.range),this.dragTexture.draw(i),i.destroy(),this.positionGraphics=t.add.graphics(),this.positionGraphics.setDepth(-2),this.invalidArea=t.add.graphics(),this.invalidArea.setDepth(-2),this.invalidArea.setBlendMode(Phaser.BlendModes.SCREEN),this.lastX=-1,this.lastY=-1}else this.dragTexture.visible=!1,this.positionGraphics.destroy(),this.invalidArea.destroy();this.routeEnabled=t}drawValidRouted(t){let e=null;this.positionGraphics.clear(),e=t.mapUnitGroup.getChildren(),this.invalidArea.clear();for(let i=(e=t.mapUnitGroup.getChildren()).length-1;i>=0;i--){let t=e[i];this.invalidArea.fillStyle(3342336,1),this.invalidArea.fillCircle(t.x,t.y,t.route.rangeMin)}for(let i=(e=t.planets.getChildren()).length-1;i>=0;i--){let t=e[i];this.invalidArea.fillStyle(3342336,1),this.invalidArea.fillCircle(t.x,t.y,t.width)}}unitMapUpdated(t){if(null===t)return this.unit.disabled=!0,this.scene.clearEvents(this),void(this.route.connectEmitter.length>0&&this.route.connectEmitter[0].produceRemovePath(this.route.connectEmitter));this.route.sources.length>0||this.route.targets.length;let e=this.scene.getHqUnits(this.player);for(let i=0;i<e.length;i++)if(e[i]instanceof UnitEmitter){let s=t.findUnitPath(e[i],this);(0===this.route.connectEmitter.length||s.length<this.route.connectEmitter.length)&&(this.route.connectEmitter=s)}this.route.connectEmitter.length>0&&this.unit.damage>0&&(this.route.connectEmitter.push(this.unit.damage),this.route.connectEmitter[0].produceAddPath(this.route.connectEmitter));for(let e=this.route.sources.length-1;e>=0;e--)t.drawConnection(this,this.route.sources[e]);0===this.unit.damage&&this.route.connectEmitter.length>0&&(this.unit.disabled=!1)}uiAction(t){log("remove"),this.unit.damage>0?this.heal():t.bot.connectStart(this)}}),UnitActionSpawn=t=>(class extends t{spawnInit(t={}){this.spawn=t;const e=this.spawn;e.started=!1,e.start=this.spawnStart,e.stop=this.spawnStop}spawnDeinit(){this.spawn.started&&this.spawnStop()}spawnStart(t){if(!this.scene.cardScene.statusEnergy.update(-1))return;const e=this.spawn;e.started=!0,e.unit=t||this,e.count=10,this.spawnDo()}spawnStop(){this.currentAction=null,this.spawn.started=!1}spawnDo(){const t=this.spawn;if(t.count>0){t.count--;new UnitElement(this.scene,this.x,this.y,this.player,{parent:t.unit});this.scene.addEvent(this.spawnDo,100,this)}else this.spawnStop()}}),UnitActionTeleport=t=>(class extends t{teleportInit(t={}){this.teleport=t;const e=this.teleport;e.start=this.teleportStart,e.stop=this.teleportStop,e.started=!1,this.teleport.from=null,this.teleport.to=null}teleportDeinit(){this.teleport.started&&this.teleportStop()}teleportStart(t){this.teleport.started=!0,this.teleportDo(t),this.body.checkCollision.none=!0}teleportStop(){this.teleport.started=!1;let t=4*this.width,e=this.scene.getEnemyUnits(this.x,this.y,t*t,this.player),i=64*this.scene.game.resolution,s=this.scene.level.grid.w*i,n=this.scene.level.grid.h*i;for(let t=0;t<e.length;t++)if(!(e[t]instanceof UnitTeleport)){let a,h;for(;a=e[t].x,h=e[t].y,a+=0==Phaser.Math.Between(0,1)?1:-1*Phaser.Math.Between(3*this.width,4*this.width),h+=0==Phaser.Math.Between(0,1)?1:-1*Phaser.Math.Between(3*this.height,4*this.height),a<i||a>s-i||h<i||h>n-i;);e[t].body.moves=!1,e[t].alpha=.25,this.scene.tweens.add({targets:e[t],ease:"Quad.easeOut",duration:2e3,alpha:1,x:a,y:h,callback:()=>{e[t].body.moves=!0},callbackScope:this})}this.body.checkCollision.none=!0,this.scene.time.addEvent({delay:2500,callback:()=>{this.body.checkCollision.none=!1},callbackScope:this})}teleportEffect(t,e,i=2500){this.teleport;this.scene.time.addEvent({callback:()=>{let t=this.scene.add.image(e.x,e.y,"EffectTeleport");t.scale=0,this.scene.tweens.add({targets:t,scale:3,ease:"Linear",duration:i/2,alpha:0,rotation:2*Math.PI,onComplete:function(){t.destroy()}})},callbackScope:this,repeat:1});t&&(this.setScale(0),this.alpha=0);this.scene.tweens.add({targets:this,ease:"Quad.easeOut",duration:i,scale:t?1:0,alpha:t?1:0,callback:()=>{},callbackScope:this})}teleportDo(t){this.teleport;if(t.unit.damage>0)return t.tint=10066329,void this.scene.time.addEvent({delay:500,callback:()=>{t.clearTint()},callbackScope:this});this.controlPoint(null),this.teleport.from=t,this.teleportEffect(!1,this.teleport.from,1500),EventDispatcher.getInstance().emit("GameStatus",{teleport:!0,from:t,time:2500}),this.x=this.teleport.from.x,this.y=this.teleport.from.y,this.body.setVelocity(0),this.body.setAcceleration(0),this.stop()}}),UnitActionWatch=t=>(class extends t{watchInit(t={}){this.watch=t;const e=this.watch;e.time=1/0,e.rangeSquared||(e.rangeSquared=e.range*e.range*this.scene.game.resolutionSquared),e.unit=null,e.unitDistanceSquared=1/0}watchDeinit(){this.watch.time!==1/0&&this.watchStop()}watchStart(t){const e=this.watch;e.time=0,t instanceof Phaser.GameObjects.Sprite?(this.watchTarget(t),e.unitArrays=null):(this.watchTarget(null),e.unitArrays=t)}watchStop(){const t=this.watch;t.time=1/0,this.watchTarget(null),t.unitArrays=null}watchDo(t){const e=this.watch;let i=1/0;if(null!==e.unit)return e.unitDistanceSquared=Phaser.Math.Distance.Squared(this.x,this.y,e.unit.x,e.unit.y),e.unitDistanceSquared>e.rangeSquared&&this.watchTarget(null),e.latency;for(let t=e.unitArrays.length-1;t>=0;t--){let s=e.unitArrays[t];for(let t=s.length-1;t>=0;t--){const n=s[t];if(e.unitDistanceSquared=Phaser.Math.Distance.Squared(this.x,this.y,n.x,n.y),e.unitDistanceSquared<e.rangeSquared)return this.watchTarget(n),e.latency;let a=e.unitDistanceSquared/e.rangeSquared*e.latency;a<i&&(i=a)}}return i}watchEvent(t,e){const i=this.watch;"stop"===e&&t===i.unit&&this.watchTarget(null),"start"===e&&i.unitArrays&&i.time===1/0&&(this.unit.time=0,i.time=0)}watchTarget(t){const e=this.watch;e.unit&&e.unit.removeListener(this),e.unit=t,e.unit&&e.unit.addListener(this)}});class Unit extends Phaser.Physics.Arcade.Sprite{constructor(t,e,i,s,n,a,h){super(t,e,i,s),this.player=a,this.action=null,this.guardTime=0,this.id=h.id||Unit.id++}toString(){return this.id}startUnit(t){this.unit=t,this.unit.listeners=[],this.unit.watchListeners=[],this.unit.time=0,this.unit.tint=0,this.unit.freeze=0,this.unit.level=t.level||1,this.unit.damage=t.damage||0,this.unit.defenceFactor=t.defenceFactor||1,this.body.mass=t.mass||this.width,this.body.allowDrag=!1,this.body.allowGravity=!1,this.unit.sizeSquared=this.width*this.width/2,t.damageSize&&(this.unit.levelMax>=2&&(this.unit.damageImage2=this.scene.add.image(this.x,this.y,"damage-"+(t.damageSize+10)),this.unit.damageImage2.setDepth(-1),this.unit.level<this.unit.levelMax?(this.unit.damageImage2.alpha=.25,this.unit.damageImage2.setFrame(this.unit.damageImage2.texture.frameTotal-2)):this.unit.damageImage2.setTint(this.player.color)),this.unit.damageImage=this.scene.add.image(this.x,this.y,"Unit-damage-"+t.damageSize,0),this.unit.damageImage.setDepth(-1),this.unit.damageImage.setTint(this.player.color),this.updateDamageImage()),0===this.unit.damage?this.unit.disabled=!1:(this.unit.disabled=!0,this.updateDamage()),this.unit.parent&&this.unit.parent.addListener(this),this.body.moves=!1,this.body.immovable=!0,this.unit.watchTime=0}stopUnit(){this.unit.parent&&this.unit.parent.removeListener(this),this.unit.damageImage&&this.unit.damageImage.destroy(),this.unit.damageImage2&&this.unit.damageImage2.destroy(),this.notify("stop"),this.unit.listeners=[],this.unit.watchListeners=[],this.scene.clearEvents(this)}addWatch2(t){-1===this.unit.watchListeners.indexOf(t)&&this.unit.watchListeners.push(t)}removeWatch2(t){let e=this.unit.watchListeners.indexOf(t);-1!==e&&this.unit.watchListeners.splice(e,1)}watchNotify2(t){for(let e=this.unit.watchListeners.length-1;e>=0;e--)this.unit.watchListeners[e].watchDo(this,t)}addListener(t){-1===this.unit.listeners.indexOf(t)&&this.unit.listeners.push(t)}removeListener(t){let e=this.unit.listeners.indexOf(t);-1!==e&&this.unit.listeners.splice(e,1)}notify(t){for(let e=this.unit.listeners.length-1;e>=0&&!this.unit.listeners[e].event(this,t);e--);}event(t,e){}updateDamage(){if(!this.unit)return void this.setScale(this.incubation.scale);let t=(this.unit.health-this.unit.damage)/this.unit.health;this.setScale(t)}updateDamageImage(){if(1===this.unit.level){let t=this.unit.damageImage.texture.frameTotal-2,e=Math.trunc(t*(this.unit.health-this.unit.damage)/this.unit.health);this.unit.damageImage.setFrame(e)}else{let t=this.unit.health/2;if(this.unit.damage<t){let e=this.unit.damageImage.texture.frameTotal-2;this.unit.damageImage.setFrame(e);let i=Math.trunc(e*(t-this.unit.damage)/t);this.unit.damageImage2.setFrame(i),this.unit.damageImage2.alpha=1}else{let e=this.unit.damageImage.texture.frameTotal-2;this.unit.damageImage2.setFrame(e-1),this.unit.damageImage2.alpha=.5;let i=Math.trunc(e*(this.unit.health-this.unit.damage)/t);this.unit.damageImage.setFrame(i)}}}scaleResolution(t){return this.scene.game.resolution*t}setPlayer(t){0===t.id&&this.sound("claim"),0===this.player.id&&this.sound("lose"),this.notify("stop");let e=[this.unit.damageImage];this.scene.tweens.add({targets:e,duration:150,scaleX:0,callbackScope:this,rotation:Math.PI,onComplete:function(t){this.scene.tweens.add({targets:e,duration:150,scaleX:1,callbackScope:this,rotation:0,onComplete:function(t){this.unit.damageImage.setTint(this.player.color)}},this)}},this),this.player=t,this.unit.level=1,this.updateDamage(),this.updateRoutes(),this.unit.damageImage2&&(this.unit.damageImage2.alpha=.25,this.unit.damageImage2.setTint(16777215))}unitDamage(t){this.unit.damage;return this.unit.damage+=t*this.unit.defenceFactor,this.unit.damage>this.unit.health?(this.unit.damage=this.unit.health,!0):(this.updateDamage(),!1)}heal(){this.scene.cardScene.bot.spawnEnergy(this.scene.cardScene,this)}addDamage(t){0===this.unit.damage&&this.route&&this.route.connectEmitter.length>0&&(this.route.connectEmitter[this.route.connectEmitter.length-1]=this.unit.damage,this.route.connectEmitter[0].produceAddPath(this.route.connectEmitter)),this.unit.damage+=t,this.updateDamage()}damageEnemy(t){if(this.player.team.id!==t.player.team.id){let e=t.unit.health-t.unit.damage;t.unitDamage(this.unit.health-this.unit.damage)&&t.destroy(),this.unitDamage(e)&&this.destroy()}}overlapEnemy(t){let e=t.unit.health-t.unit.damage;return t.unitDamage(this.unit.health-this.unit.damage)&&t.destroy(),!!this.unitDamage(e)&&(this.unit.damage=this.unit.health-(this.unit.damage-this.unit.health),!0)}overlapFriend(t){if(this.unit.damage>0){let e=t.unit.health-t.unit.damage;this.unit.level>1&&(e/=this.unit.level),e/=2,this.unit.damage-=e,this.unit.damage<0&&(this.unit.damage=0),t.destroy(),this.updateDamage()}}overlap(t){t.unit.activeDelay>0||(this.player.team.id===t.player.team.id?this.overlapFriend(t):this.damageEnemy(t))}unitMapUpdated(){}explodeEffect(){let t=this.scene.add.particles("Unit-explode");t.createEmitter({frame:[2],x:this.x,y:this.y,speed:{start:this.scene.scaleResolution(112.5),end:this.scene.scaleResolution(-112.5)},quantity:5,ease:"Power2",lifespan:1e3,maxParticles:50,blendMode:"SCREEN",alpha:{start:1,end:0}}),t.createEmitter({frame:[0],x:this.x,y:this.y,speed:{start:this.scene.scaleResolution(75),end:this.scene.scaleResolution(-75)},quantity:5,ease:"Power2",lifespan:750,maxParticles:100,blendMode:"SCREEN",alpha:{start:1,end:0}}),this.scene.time.delayedCall(1e3,function(){t.destroy()},this)}uiAction(t){}sound(t){this.scene.cardScene.audio.play(t)}static preload(t,e){e.push({name:"Unit-damage-10",size:10});for(let t=40;t<=40;t+=10)e.push({name:"Unit-damage-"+t,size:t})}}Unit.id=1e3,Unit.defaultHealth=64,Unit.defaultMass=100,Unit.defaultSpeed=150,Unit.Action={Connect:UnitActionConnect,Build:UnitActionBuild,Teleport:UnitActionTeleport};class UnitBot extends(UnitActionBuild(UnitActionSpawn(UnitActionConnect(UnitActionTeleport(UnitActionControl(Unit)))))){constructor(t,e,i,s,n){super(t,e,i,UnitBot.name,0,s,n),t.addTeamTroop(this,this.player.team.id),this.startUnit({health:Unit.defaultHealth,mass:Unit.defaultMass}),this.body.maxSpeed=Unit.defaultSpeed*this.scene.game.resolution,this.buildInit({}),this.spawnInit({}),this.controlInit({turnSpeed:.25}),this.controlStart(),this.move={speedSquared:9e4},this.teleportInit({}),this.connectInit({range:50}),this.body.setSize(this.width/2,this.height/2),this.setDepth(9),this.scene.physics.add.collider(this,this.scene.groundLayer,this.collideGround.bind(this)),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.scene.removeUnitListener(this),this.control.action&&this.control.action.stop(),EventDispatcher.getInstance().emit("GameStatus",{shutdown:!0}),this.scene.explode(this),this.player.bot=null,this.scene.cardScene.input.enabled=!1,this.scene.cardScene.bot=null,this.connectDeinit(),this.teleportDeinit(),this.controlDeinit(),this.spawnDeinit(),this.stopUnit()}unitProcess(t){return 1/0}event(t,e){"stop"===e&&t===this.shoot.target&&this.setShootTarget(null)}updateDamage(){this.scene.cardScene.statusBody.update(-this.unit.damage)}shootUnit(t){this.shoot.target.unit.damage<this.shoot.target.unit.health?this.shoot.target.unitDamage(this.shoot.damage):(this.shoot.target.destroy(),this.laser.visible=!1)}collideGround(){}preUpdate2(){}menuSelect(t,e){this.control.action=this.control.action.menuSelect(t,e,this)}uiAction(t){this.controlAction(t)}update(t){let e=null,i=this.width,s=this.scene.getUnits(this.x,this.y,i*i,this.player);if(s)for(let t=0;t<s.length;t++){let i=s[t];if(i.action){e=i;break}}e!==this.control.target.unit&&(this.control.target.unit=e,e&&(this.control.target.img.x=e.x,this.control.target.img.y=e.y),this.control.target.img.visible=!!e),this.control.target.focus&&this.control.target.unit===this.control.target.focus&&(this.currentAction?(this.currentAction.stop.call(this),this.currentAction=null):this.control.pad.select(),this.control.target.focus=null,this.control.target.focusImage.visible=!1),this.connect.target&&this.connectDo()}activateAction(t,e){this.currentAction=t,t.start.call(this,e)}static preload(t,e){t.push("EffectTeleport"),t.push(UnitBot.name+"Target"),e.push({name:UnitBot.name,size:32}),e.push({name:"Laser",width:30,height:8})}}UnitBot.name="UnitBot";class UnitElement extends(UnitActionFollow(UnitActionMove(Unit))){constructor(t,e,i,s,n){let a=n?n.frame:0;super(t,e,i,UnitElement.name,a,s,n),t.addTeamBullet(this,this.player.team.id),this.body.setAllowRotation(!1),this.setTint(this.player.color),this.target=null,this.startUnit({health:n.health||UnitElement.health,parent:n.parent}),this.moveInit({speed:50}),this.moveStart(n.parent),this.decay={timeout:200},this.followInit({}),n.follow&&n.follow.path?this.followStart(n.follow.path):this.spawn(),this.scene.addUnitListener(this),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.scene.removeUnitListener(this),this.decay.timeout=0,this.pathFollower&&this.pathFollower.destroy(!0),this.followDeinit(),this.moveDeinit(),this.stopUnit();let t=this.scene.add.image(this.x,this.y,UnitElement.name+"-flash");this.scene.tweens.add({targets:t,duration:.5,alpha:0,onComplete:function(){t.destroy()}},this)}unitProcess(t){let e=1/0;const i=this.move;return t>i.time&&(i.time=t+this.moveToUnit(),this.degenerate(),i.time<e&&(e=i.time)),e}degenerate(){this.unit.damage+=.1,this.unit.damage>this.unit.health?this.destroy():this.updateDamage()}addTarget(t){this.moveStart(t)}updateDamage(){let t=this.texture.frameTotal-1,e=t-Math.trunc(t*(this.unit.health-this.unit.damage-1)/this.unit.health);e>0&&e--,this.setFrame(e)}followPath2(){if(this.unit.damage>0)return!1;let t=null,e=null;if(this.unit.parent.healPaths){let i=Object.keys(this.unit.parent.healPaths);for(let s=i.length-1;s>=0;s--){let n=this.unit.parent.healPaths[i[s]];n[n.length-1].damage>0&&(t=n,e=this.unit.parent.healCurve[i[s]])}}if(null===t&&this.unit.parent.paths){let i=Object.keys(this.unit.parent.paths);if(i.length>0){let s=i.length*Math.random()<<0;t=this.unit.parent.paths[i[s]],e=this.unit.parent.curve[i[s]]}}if(null===t||t.length<=1)return!1;this.unit.parent=t[t.length-1],this.body.enable=!1,this.visible=!1;let i=new Phaser.Curves.Path(t[0].x,t[0].y);for(let e=1,s=t.length;e<s;e++)i.lineTo(t[e].x,t[e].y);return this.pathFollower=this.scene.add.follower(i,t[0].x,t[0].y,UnitElement.name),this.pathFollower.setTint(13421772),this.pathFollower.startFollow({duration:500*t.length,onComplete:(e,i)=>{if(this.x=this.pathFollower.x,this.y=this.pathFollower.y,this.pathFollower.destroy(!0),this.pathFollower=null,0===this.decay.timeout)return this.destroy(),!1;this.followPath()||(this.unit.parent=t[t.length-1],this.spawn())}}),!0}spawn(){this.body.enable=!0,this.visible=!0,this.rotation=Phaser.Math.RND.rotation(),this.scene.physics.velocityFromRotation(this.rotation,this.body.maxSpeed,this.body.velocity)}event(t,e){this.moveEvent(t,e),"stop"===e&&(t===this.unit.target&&(this.unit.target.removeListener(this),this.unit.target=null),t===this.unit.parent&&this.destroy())}static preload(t,e){t.push(UnitElement.name+"-flash"),e.push({name:UnitElement.name,size:8})}}UnitElement.name="UnitElement",UnitElement.health=8;class UnitEmitter extends(UnitActionWatch(UnitActionProduce(UnitActionRoute(UnitActionMenu(Unit))))){constructor(t,e,i,s,n){super(t,e,i,UnitEmitter.name,0,s,n),t.mapUnitGroup.add(this,!0),this.body.move=!1,this.body.immovable=!0,this.startUnit({health:4*UnitElement.health,damage:0,damageSize:40,mass:200,levelMax:n.levelMax||1}),this.routeInit({range:100}),this.route.connectEmitter=[this],this.updateRoutes(),this.produceInit({delay:n.produceDelay||1e3}),this.watchInit({range:150,latency:500}),this.watchStart(this.scene.getEnemyTroops(this.player)),this.menuInit({actions:[Unit.Action.Connect]}),this.scene.addUnitListener(this),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.scene.removeUnitListener(this),this.rotateTween&&this.rotateTween.remove(),this.menuDeinit(),this.watchDeinit(),this.produceDeinit(),this.routeDeinit(),this.stopUnit()}unitProcess(t){let e=1/0;const i=this.watch;if(t>i.time){let s=i.unit;i.time=t+this.watchDo(t),i.time<e&&(e=i.time),s!==i.unit&&null!==i.unit&&this.attackUnit(i.unit)}return e}event(t,e){this.watchEvent(t,e),"stop"===e&&t===this.watch.attack&&(this.watch.attack.removeListener(this),this.watch.attack=null)}produceUnit(){let t={};this.produce.paths.length>0&&(t.path=this.produce.paths[0],t.path[t.path.length-1]-=UnitElement.health,t.path[t.path.length-1]<=0&&this.produce.paths.splice(0,1));let e=new UnitElement(this.scene,this.x,this.y,this.player,{parent:this,follow:t});this.watch.attack&&e.addTarget(this.watch.attack)}attackUnit(t){this.watch.attack=t,this.watch.attack.addListener(this);for(let e=this.unit.listeners.length-1;e>=0;e--)this.unit.listeners[e].addTarget&&this.unit.listeners[e].addTarget(t)}updateDamage(){this.updateDamageImage(),0===this.unit.damage&&(this.produceStart(),this.rotateTween=this.scene.tweens.add({targets:this,duration:5e3,rotation:2*Math.PI,callbackScope:this,repeat:-1,onComplete:function(t){}},this))}damageEnemy(t){}unitMapUpdated(t){if(null!==t)for(let e=this.route.sources.length-1;e>=0;e--)t.drawConnection(this,this.route.sources[e])}unitMapUpdated2(t){if(null===t||!this.player.HQ)return this.produceStop(),void this.scene.clearEvents(this);if(this.route.connectHq=t.findUnitPath(this.player.HQ,this),this.route.connectHq.length>0){this.produceStart(),this.produce.timeout=this.produce.delay,t.drawConnectHq(this);for(let e=this.route.sources.length-1;e>=0;e--)t.drawConnection(this,this.route.sources[e]);this.route.connectHq=this.route.connectHq.reverse(),this.route.curveToHq=new Phaser.Curves.Spline(this.route.connectHq)}}upgradeLevel(){}static preload(t,e){e.push({name:UnitEmitter.name,size:32})}}UnitEmitter.name="UnitEmitter";class UnitEnergy extends(UnitActionWatch(Unit)){constructor(t,e,i,s,n){super(t,e,i,UnitEnergy.name,n.frame,s,n),t.addUnit(this),this.startUnit({mass:0}),this.watchInit({range:75,latency:20}),this.watchStart([[s.bot]]),this.setScale(0),this.scene.tweens.add({targets:this,duration:250,ease:"Linear",scale:1},this),this.body.angularVelocity=100,this.body.moves=!0,this.scene.addUnitListener(this),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.scene.removeUnitListener(this),this.watchDeinit(),this.stopUnit()}unitProcess(t){let e=1/0;const i=this.watch;if(t>i.time){let s=i.unit;i.time=t+this.watchDo(t),i.time<e&&(e=i.time),s!==i.unit&&(this.scene.cardScene.statusEnergy.update(1),this.consume(i.unit,this.scene.cardScene.statusEnergy),this.destroy())}return e}event(t,e){this.watchEvent(t,e)}consume(t,e){let i=this.scene.add.image(this.x,this.y,"UnitEnergy");e.bg.tint=0,this.scene.tweens.add({targets:i,ease:"Power1",duration:150,x:t.x,y:t.y,scale:0,angle:360,onComplete:function(){e.bg.clearTint(),i.destroy()}})}unitDamage(){}static preload(t,e){e.push({name:UnitEnergy.name,size:20})}}UnitEnergy.name="UnitEnergy";class UnitGuard extends(UnitActionWatch(UnitActionMove(Unit))){constructor(t,e,i,s,n){if(super(t,e,i,UnitGuard.name+"Idle",n.frame,s,n),this.config=n,-1===this.config.incubation){t.addIdle(this);let e=64*this.scene.game.resolution;for(;this.x=Phaser.Math.Between(2,this.scene.level.grid.w-2)*e,this.y=Phaser.Math.Between(2,this.scene.level.grid.h-2)*e,0!==this.scene.getUnits(this.x,this.y,3*this.width).length;);}this.setScale(.75);for(let t=0;t<n.parents.length;t++)n.parents[t].addListener(this);this.config.parent=n.parents[0]}createUnit(){this.config;this.scene.idleUnits.remove(this,!0),this.scene.addTeamTroop(this,this.player.team.id),this.startUnit({health:1.5*Unit.defaultHealth}),this.watchInit({range:100,latency:100,homeDistanceSquared:this.width*this.width/16}),this.watchStart(this.scene.getEnemyTroops(this.player)),this.moveInit({speed:100}),this.moveStart(this.scene.getBounds()),this.setDrag(4*this.body.maxSpeed,4*this.body.maxSpeed),this.anims.play(UnitGuard.name),this.body.setSize(this.width/2,this.height/2),this.setDrag(4*this.move.speed,4*this.move.speed),this.body.setAllowDrag(!0),this.scene.addUnitListener(this),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.scene.removeUnitListener(this),this.watchDeinit(),this.moveDeinit(),this.stopUnit()}guardTarget(t){this.guard.enemy=t}healUnit(){this.guard;this.unit.damage>0&&(this.config.parent.unit.damage<this.config.parent.unit.health-4&&(this.config.parent.addDamage(4),this.unit.damage-=4,this.updateDamage(),this.unit.damage<0&&(this.unit.damage=0)),this.unit.damage)}unitProcess(t){let e=1/0;const i=this.move;t>i.time&&(i.time=t+this.moveDo(),i.time<e&&(e=i.time),this.body.speed>=this.move.speed&&this.body.setAcceleration(0));const s=this.watch;if(t>s.time){let i=s.unit;if(s.time=t+this.watchDo(t),s.time<e&&(e=s.time),i!==s.unit)null!==i&&(this.moveStop(),this.moveStart(this.config.parent)),null!==s.unit?this.moveStart(s.unit):this.moveStart(this.config.parent);else if(this.move.toUnit===this.config.parent){Phaser.Math.Distance.Squared(this.x,this.y,this.config.parent.x,this.config.parent.y)<s.homeDistanceSquared&&this.healUnit()}}return e}event(t,e){if(this.unit)this.moveEvent(t,e),this.watchEvent(t,e);else if("enable"===e)for(let e=0;e<this.config.parents.length;e++)if(t===this.config.parents[e]){for(let t=0;t<this.config.parents.length;t++)this.config.parents[t].removeListener(this);return this.config.parent=t,this.config.parents=null,this.createUnit(),this.moveStart(this.config.parent),!0}}static preload(t,e){t.push(UnitGuard.name+"Idle"),e.push({name:UnitGuard.name,size:32})}}UnitGuard.name="UnitGuard",UnitGuard.animFrameRate=8;class UnitRoute extends(UnitActionRoute(UnitActionMenu(Unit))){constructor(t,e,i,s,n){super(t,e,i,UnitRoute.name,0,s,n),t.addTeamBuilding(this,this.player.team.id),this.startUnit({health:8*UnitElement.health,damage:8*UnitElement.health,damageSize:10}),this.routeInit({range:100}),this.updateRoutes(),this.menuInit({actions:[Unit.Action.Connect,Unit.Action.Build]}),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.menuDeinit(),this.routeDeinit(),this.stopUnit()}updateDamage(){this.updateDamageImage(),0===this.unit.damage&&(this.unit.disabled=!1)}unitMapUpdated2(t){if(null!==t&&this.player.HQ){this.route.connectHq=t.findUnitPath(this.player.HQ,this);for(let e=this.route.sources.length-1;e>=0;e--)t.drawConnection(this,this.route.sources[e])}}static preload(t,e){t.push(UnitRoute.name)}}UnitRoute.name="UnitRoute";class UnitSpawner extends(UnitActionRoute(UnitActionMenu(Unit))){constructor(t,e,i,s,n){super(t,e,i,UnitSpawner.name,0,s,n),t.addTeamBuilding(this,this.player.team.id),this.startUnit({health:8*UnitElement.health,damage:8*UnitElement.health,damageSize:40}),this.routeInit({range:100}),this.updateRoutes(),this.menuInit({actions:[Unit.Action.Connect,Unit.Action.Build]}),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.menuDeinit(),this.routeDeinit(),this.stopUnit()}updateDamage(){this.updateDamageImage(),0===this.unit.damage&&(this.unit.disabled=!1)}unitMapUpdated2(t){if(null!==t&&this.player.HQ){this.route.connectHq=t.findUnitPath(this.player.HQ,this);for(let e=this.route.sources.length-1;e>=0;e--)t.drawConnection(this,this.route.sources[e])}}static preload(t,e){t.push(UnitSpawner.name)}}UnitSpawner.name="UnitSpawner";class UnitTeleport extends(UnitActionRoute(UnitActionWatch(UnitActionMenu(Unit)))){constructor(t,e,i,s,n){super(t,e,i,UnitTeleport.name,0,s,n),t.mapUnitGroup.add(this,!0),this.teleport=n,this.startUnit({health:8*UnitElement.health,damage:8*UnitElement.health,damageSize:40}),this.routeInit({range:100}),this.updateRoutes(),this.watchInit({rangeSquared:this.scene.cameras.main.centerY*this.scene.cameras.main.centerY,latency:500}),this.watchStart([[s.bot]]),this.anims.pause(),this.menuInit({actions:[Unit.Action.Teleport]}),this.scene.addUnitListener(this),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.scene.removeUnitListener(this),this.menuDeinit(),this.watchDeinit(),this.routeDeinit(),this.stopUnit()}unitProcess(t){let e=1/0;const i=this.watch;if(t>i.time){let s=i.unit;i.time=t+this.watchDo(t),i.time<e&&(e=i.time),s!==i.unit&&(this.watchStop(),this.scene.cardScene.brain.addTeleport(this))}return e}event(t,e){this.watchEvent(t,e)}disabledBy(t){this.unit.disabled=t,this.unit.disabled.addListener(this),this.anims.pause()}uiAction(t){this.anims.isPaused||t.bot.teleportDo(this)}updateDamage(){this.updateDamageImage(),this.anims.isPlaying?this.unit.damage>0&&(this.notify("disable"),this.anims.pause(),this.unit.disabled=!0):0===this.unit.damage&&(this.notify("enable"),this.scene.anims.exists(UnitTeleport.name)?this.anims.play(UnitTeleport.name):this.anims.resume(),this.unit.disabled=!1)}updateDamage2(){}unitMapUpdated3(t){if(null===t)return this.unit.disabled=!0,this.anims.pause(),void this.scene.clearEvents(this);(this.route.sources.length>0||this.route.targets.length>0)&&(this.unit.disabled=!1,this.anims.resume());for(let e=this.route.sources.length-1;e>=0;e--)t.drawConnection(this,this.route.sources[e])}static preload(t,e){e.push({name:UnitTeleport.name,size:32})}}UnitTeleport.name="UnitTeleport",UnitTeleport.animFrameRate=30;class UnitVirus extends(UnitActionWatch(UnitActionMove(Unit))){constructor(t,e,i,s,n){super(t,e,i,UnitVirus.name+"Idle",n.frame,s,n),this.config=n,this.config.incubation?t.addIdle(this):this.createUnit(),this.updateDamage()}createUnit(){this.config;this.scene.idleUnits.remove(this,!0),this.scene.addTeamTroop(this,this.player.team.id),this.startUnit({health:.5*Unit.defaultHealth}),this.watchInit({range:100,latency:1e3}),this.watchStart(this.scene.getEnemyTroops(this.player)),this.moveInit({speed:20}),this.moveStart(this.scene.getBounds()),this.setTexture(UnitVirus.name),this.body.setSize(this.width/2,this.height/2),this.body.angularVelocity=100,this.scene.addUnitListener(this),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.scene.removeUnitListener(this),this.moveDeinit(),this.watchDeinit(),this.stopUnit()}unitProcess(t){let e=1/0;const i=this.move;t>i.time&&(i.time=t+this.moveDo(),i.time<e&&(e=i.time));const s=this.watch;if(t>s.time){let i=s.unit;s.time=t+this.watchDo(t),s.time<e&&(e=s.time),i!==s.unit&&(null!==i&&(this.moveStop(),this.moveStart()),null!==s.unit&&this.moveStart(s.unit))}return e}event(t,e){this.moveEvent(t,e),this.watchEvent(t,e)}static preload(t,e){t.push(UnitVirus.name+"Idle"),t.push(UnitVirus.name)}}UnitVirus.name="UnitVirus";class CardContainer extends Phaser.GameObjects.Container{constructor(t,e,i,s){super(t,e,i),this.origX=e,this.origY=i,t.add.existing(this),this.containerImage=t.add.image(0,0,"sprites","card-disabled.png"),this.setSize(this.containerImage.width,this.containerImage.height),this.add(this.containerImage),this.visible=!0,this.active=!1,this.deck=s,this.sprite=null}setCard(t){if(null===t){for(;this.getAt(1);)this.removeAt(1,!0);this.card=null}else this.card=t,this.add(new Phaser.GameObjects.Image(this.scene,0,0,"sprites",this.card.name+".png")),this.card.container=this,this.card.costImage=this.scene.add.image(this.width/2,this.height/2,"Card-costs",this.card.cost),this.card.costImage.x-=this.card.costImage.width/2,this.card.costImage.y-=this.card.costImage.height/2,this.add(this.card.costImage),this.card.costImage.visible=!0;this.active=null!==t}enabled(){return this.deck.energyValue>=this.card.cost}enable(t){this.input&&this.input.enabled===t||t&&this.card.started||(this.containerImage.setTexture("sprites",t?"card-enabled.png":"card-disabled.png"),t?(this.setInteractive(),this.scene.input.setDraggable(this)):this.disableInteractive())}select(t,e){this.card&&this.card.select(t,e),t?this.x+=this.width/5:this.x-=this.width/5}}class EventDispatcher extends Phaser.Events.EventEmitter{constructor(){super()}static getInstance(){return null===EventDispatcher.instance&&(EventDispatcher.instance=new EventDispatcher),EventDispatcher.instance}}EventDispatcher.instance=null;class GameScene extends Phaser.Scene{constructor(t){super({key:t}),this.teleports=[[0,1],[1,2],[2,3],[3,4],[4,5],[5,0]],this.random=Date.now()}init(){this.firstGameToday=!1,parseInt(0|this.game.restore("lastPlayTime"))+43200<(Date.now()/1e3|0)&&(this.firstGameToday=!0)}preload(){this.load.path=this.registry.get("path");this.scene.get("LoaderScene")}create(){this.debugInfo=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY/2,"",{font:16*this.game.resolution+"px Arial",fill:"#ffffff"}).setOrigin(.5),EventDispatcher.getInstance().on("GameStatus",this.gameStatus.bind(this)),this.startLevel(),this.level.end||this.startGame()}startGame(){let t=this.registry.get("level");this.level=t,t.players&&this.startUIScene()}startLevel(){let t=this.registry.get("level");this.level=t,t.end}startUIScene(){let t=this.scene.get("UIScene");t=this.scene.add("UIScene",new UIScene("UIScene"));this.scene.run(t,{sceneCreated:this.uiSceneCreated.bind(this),layout:{y:0,x:0,h:this.cameras.main.height-0,w:this.cameras.main.width-0}}),this.uiScene=t}startScene(t,e){let i=this.scene.get(t);i?(this.scene.run(i,e),this.unitScene=i):this.time.delayedCall(100,function(){this.startScene(t,e)},[],this)}uiSceneCreated(){this.level.teleport=this.teleport;let t=this.level,e="UnitScene-"+t.id,i=this.scene.get(e);i?(i.scene.wake(),this.uiScene.setUnitSceneLevel(i,this.level),this.uiScene.setPlayer(t.data.players[0]),this.unitScene=i):(i=this.scene.add(e,new UnitScene(e,this.uiScene)),t.sceneCreated=this.sceneCreated.bind(this),this.startScene(e,t))}sceneCreated(t){this.level.teleport=this.teleport,this.uiScene.setUnitSceneLevel(t,this.level),this.unitScene.levelFactory||(this.unitScene.levelFactory=new LevelFactory(this.uiScene,this.unitScene,this.level,this.teleports))}gameStatus(t){t.shutdown&&(this.scene.wake(),this.cameras.main.fadeOut(150,255,255,255,function(t,e){1===e&&this.cameras.main.fadeIn(1e3,255,255,255,function(t,e){})},this),this.scene.manager.scenes.forEach(function(t){t instanceof LoaderScene||t instanceof GameScene||t.gameOver()}),this.time.delayedCall(3e3,function(){this.scene.manager.scenes.forEach(function(t){t instanceof LoaderScene||t instanceof GameScene||t.destroyed()}),this.time.delayedCall(100,function(){EventDispatcher.getInstance().emit("GameStatus",{gameover:!0})},[],this)},[],this)),t.start&&this.scene.setVisible(!1),t.teleportComplete&&(this.startLevel(),this.uiSceneCreated(),this.uiScene.player.bot.teleportStop()),t.teleport&&(this.teleport=t.from.teleport),t.gameover}handleLoseFocus(){console.log("handleLoseFocus")}}class LevelFactory{constructor(t,e,i,s){this.units=[],this.events=[],i.data={players:[],playerTeams:[]};let n=-1;for(let s=0;s<i.players.length;s++)i.data.players[s]=new Player(s,e),i.data.players[s].id=s,i.players[s].team>=0?n=i.players[s].team:n++,i.data.playerTeams[n]||(i.data.playerTeams[n]=new PlayerTeam(n,t,e)),i.data.playerTeams[n].addPlayer(i.data.players[s]);this.level=i,this.tilesize=64*e.game.resolution;let a=i.data.players[0];i.players[0].bot[0].id=1;let h=this.createUnits(e,i.players[0].bot,UnitBot,a)[0];a.bot=h;this.createTeleports(e,i,s,a);for(let t=0;t<i.players.length;t++){let s=i.players[t],n=i.data.players[t];this.createUnits(e,s.guard,UnitGuard,n),this.createUnits(e,s.emitter,UnitEmitter,n),this.createUnits(e,s.teleport,UnitTeleport,n)}if(i.event)for(let t=0;t<i.event.length;t++){let e=i.event[t],s=this.getUnitById(e.unit);e.disable&&(e.disableUnit=this.getUnitById(e.disable)),this.events.push(new LevelEvent(s,e))}t.setPlayer(a);for(let t=0;t<this.units.length;t++)this.units[t].unit?this.units[t].notify("start"):e.addIdle(this.units[t])}randomXY(){let t=this.level,e=this.tilesize,i=this.position;i||(this.position={},(i=this.position).areas=[1,2,3,4],Phaser.Utils.Array.Shuffle(i.areas));let s=i.areas.splice(0,1),n=t.grid.w/2-1.5,a=t.grid.h/2-1.5;return i.x=Phaser.Math.FloatBetween(1.5,n),i.y=Phaser.Math.FloatBetween(1.5,a),2===s[0]&&(i.x+=t.grid.w/2),3===s[0]&&(i.y+=t.grid.h/2),4===s[0]&&(i.x+=t.grid.w/2,i.y+=t.grid.h/2),i.x*=e,i.y*=e,i}createTeleports(t,e,i,s){let n=[],a=2;for(let h=0;h<i.length;h++){let o=i[h];if(o[0]===e.id||o[1]===e.id){let i=this.randomXY(),h=i.x,r=i.y,l=o[0]===e.id?o[1]:o[0],c={id:a++,from:e.id,to:l},d=new UnitTeleport(t,h,r,s,c);n.push(d),this.units.push(d)}}return n}createEmitters2(t,e,i,s){for(let i=0;i<1;i++){let i=this.randomXY();new UnitEmitter(t,i.x,i.y,s,e)}}createEnergy(t,e,i,s){let n=[];for(let i=0;i<e.grid.w+e.grid.h;i+=10){let i=64*t.game.resolution,a=Phaser.Math.Between(2,e.grid.w-2)*i,h=Phaser.Math.Between(2,e.grid.h-2)*i,o=new UnitEnergy(t,a,h,s,e);n.push(o)}return n}relocateUnit(t,e,i,s,n){let a,h,o=64*t.game.resolution;do{a=i.x;let t=Phaser.Math.Between(s,n)*o;0===Phaser.Math.Between(0,1)&&(t=-t),a+=t}while(a<1*o||a>e.grid.w*o-o);do{h=i.y;let t=Phaser.Math.Between(s,n)*o;0===Phaser.Math.Between(0,1)&&(t=-t),h+=t}while(h<1*o||h>e.grid.h*o-o);return{x:a,y:h}}destroy(){for(let t=0;t<this.events.length;t++)this.events[t].destroy();this.events=null}createUnits(t,e,i,s){let n=[];if(e)for(let a=0;a<e.length;a++){let h=e[a],o=0,r=0;if(h.position<0){let t=this.randomXY();o=t.x,r=t.y}else{h.parents=[];for(let t=0;h.unit&&t<h.unit.length;t++)h.parents.push(this.getUnitById(h.unit[t]));h.x||(h.x=10,h.y=10),this.dx=100,this.dx2=0,this.dy=100,this.dy2=0,o=h.x*this.dx-this.dx2,r=h.y*this.dy-this.dy2,o||(o=0),r||(r=0)}let l=this.createUnit(t,i,o,r,s,h);n.push(l),this.units.push(l)}return n}createUnit(t,e,i,s,n,a){if(a.unit){a.parents=[];for(let t=0;t<a.unit.length;t++)a.parents.push(this.getUnitById(a.unit[t]))}let h=new e(t,i,s,n,a);return a.id&&(h.id=a.id),h}getUnitById(t){for(let e=0;e<this.units.length;e++)if(this.units[e].id===t)return this.units[e];return null}createUnits2(t,e,i,s,n){let a=[];if(e)for(let h=0;h<e.length;h++){let o=new i(t,s,n,e[h]);a.push(o.sprite)}return a}static preload(t,e){}}class LoaderScene extends Phaser.Scene{constructor(t){super({key:"LoaderScene",visible:!1}),this.loadProgress=0,this.levelList=t}init(){}preload(){this.load.path=this.registry.get("path"),this.game.getImage=this.getImage,this.game.config.width>=2560&&this.game.config.height>=1440?(this.res="",this.game.resolution=4):this.game.config.width>=1920&&this.game.config.height>=1080?(this.res="-L",this.game.resolution=3):this.game.config.width>=1280&&this.game.config.height>=720?(this.res="-M",this.game.resolution=2):(this.res="-S",this.game.resolution=1),this.game.resolutionSquared=this.game.resolution*this.game.resolution,this.game.res=this.res,this.levelNo=parseInt(this.game.restore("levelNo")||0);for(let t=0;t<this.levelList.length;t++)if(this.levelList[t]===LEVEL){this.levelNo=t,console.log("Level "+LEVEL);break}this.load.json("json/"+this.levelList[this.levelNo])}gameStatus(t){t.gameover&&this.restartLevel(1e3,!0),t.teleport&&(this.levelNo=t.from.teleport.to,this.restartLevel(t.teleport.time,!1))}checkOriention(t,e){t===Phaser.Scale.PORTRAIT||Phaser.Scale.LANDSCAPE}create(){this.debugInfo=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY/2,"",{font:16*this.game.resolution+"px Arial",fill:"#ffff00"}).setOrigin(.5);let t=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,Text.loading,{font:16*this.game.resolution+"px Arial",fill:"#000000"}).setOrigin(.5);this.load.on("loadProgress",function(e){t.text=Text.loading+" "+parseInt(100*e)+" %"},this),EventDispatcher.getInstance().on("GameStatus",this.gameStatus.bind(this)),this.startLevel()}loadLevel(){this.levelList&&this.levelNo>=this.levelList.length||(this.registry.set("level",null),this.load.json("json/"+this.levelList[this.levelNo]),this.load.start())}restartLevel(t,e){if(e){let t=EventDispatcher.getInstance();t.shutdown(),t.on("GameStatus",this.gameStatus.bind(this))}this.scene.setVisible(!0),this.scene.bringToTop(),this.cameras.main.alpha=1,this.cameras.main.once("camerafadeoutcomplete",()=>{e&&this.scene.manager.scenes.forEach(function(t){t!==this&&this.scene.remove(t)},this),this.time.delayedCall(100,function(){this.startLevel()},[],this)}),this.cameras.main.fadeOut(t,255,255,255)}startLevel(){let t=this.cache.json.get("json/"+this.levelList[this.levelNo]);if(!t)return this.load.once("complete",function(){this.startLevel()},this),this.load.json("json/"+this.levelList[this.levelNo]),void this.load.start();this.registry.set("level",t),this.scene.setVisible(!1),this.scene.get("GameScene")?EventDispatcher.getInstance().emit("GameStatus",{teleportComplete:!0}):this.scene.add("GameScene",new GameScene("GameScene"),!0)}getImage(t,e,i,s){return this.cache.json.get("sprites").frames[s+".png"]?new Phaser.GameObjects.Image(t,e,i,"sprites-doodd",s):new Phaser.GameObjects.Image(t,e,i,s)}loadBitmap2(t,e){this.bitmaps={frames:[]},e.forEach(function(e){t===this||this.sprites.frames[e+".png"]||t.load.bitmapFont(e,"img/"+e+this.res+".png","img/"+e+this.res+".xml")},this)}loadImages(t,e,i="png"){this.sprites={frames:[]},e.forEach(function(e){if(t!==this&&!this.sprites.frames[e+"."+i]){let s="";this.registry.get("debug")&&(s="?t="+Date.now()),t.load.image(e,"img/"+e+this.res+"."+i+s)}},this)}loadSpritesheets(t,e){e.forEach(function(e){let i=e.width?e.width:e.size,s=e.height?e.height:e.size,n="";this.registry.get("debug")&&(n="?t="+Date.now()),t.load.spritesheet(e.name,"img/"+e.name+this.res+".png"+n,{frameWidth:i*this.game.resolution,frameHeight:s*this.game.resolution})},this)}}const TEAM_COLOR=[13421721,9638133,6710886,6684774],TEAM_COLOR_BG=[1907968,51,3342336,1900573],ROUTE_COLOR=[10066227,3355443,16777215,3355443];class Player{constructor(t,e){this.id=t,this.color=TEAM_COLOR[this.id],this.routeColor=ROUTE_COLOR[this.id],this.bgColor=TEAM_COLOR_BG[this.id],this.unitScene=e}addHQ(t){this.HQ=t}setTeam(t){this.team=t,this.unitScene.addTeam(this.team.id)}}class PlayerTeam{constructor(t,e,i){this.id=t,this.cardScene=e,this.unitScene=i,this.players=[]}addPlayer(t){this.players.push(t),t.setTeam(this)}}class PriorityQueue{constructor(){this.collection=[]}enqueue(t){if(this.isEmpty())this.collection.push(t);else{let e=!1;for(let i=1;i<=this.collection.length;i++)if(t[1]<this.collection[i-1][1]){this.collection.splice(i-1,0,t),e=!0;break}e||this.collection.push(t)}}dequeue(){return 0===this.collection.length?null:this.collection.shift()}dequeueExpired(t){return 0===this.collection.length?null:t>=this.collection[0][1]?this.collection.shift():null}isEmpty(){return 0===this.collection.length}clear(t){for(let e=this.collection.length-1;e>=0;e--)t===this.collection[e][2]&&this.collection.splice(e,1)}destroy(){this.collection=[]}}var Text={id:"minimind",gameName:"minimind",loading:"Loading",next:"NEXT",play:"PLAY",quit:"QUIT",pause:"PAUSE",resume:"RESUME",restart:"TRY\nAGAIN",gameOverCongratulations:"All levels passed.\n\nCongratulations!",win:"YOU WIN",wait:"Wait for computer,\nmay take a minute.",setLang(t){"fi"===t&&(this.gameName="NANOBOT LIFE",this.loading="Ladataan",this.next="JATKA",this.play="PELAA",this.quit="POISTU",this.pause="PAUSE",this.resume="RESUME",this.restart="ALOITA\nALUSTA",this.gameOverCongratulations="Kaikki tasot selvitetty.\n\nOnnittelut!",this.draw="TASAN",this.win="VOITIT",this.wait="Odota tietokonetta,\nvoi kestää minuutin.")}};class UIAction extends Phaser.GameObjects.Container{constructor(t,e,i=null,s=null,n="center",a="gray",h=0){let o=t.scene.cardScene;super(o),o.add.existing(this),this.menuUnit=t,this.actionUnit=i,this.action=s,this.bgColor=a,this.cost=h;let r=o.cameras.main.centerX,l=o.cameras.main.centerY,c=new Phaser.GameObjects.Image(o,r,l,"ActionBg");this.add(c);let d=new Phaser.GameObjects.Image(o,r,l,"ActionIconBg");this.add(d);let u=new Phaser.GameObjects.Image(o,r,l,e);this.icon=u,this.add(u),"up"===n?this.y-=1.25*c.height:"down"===n?this.y+=1.25*c.height:"left"===n?this.x-=1.25*c.width:"right"===n&&(this.x+=1.25*c.width),"ActionCancel"===e?this.setState("active"):"ActionSpawn"===e&&this.scene.statusEnergy.val()>=this.cost?this.setState("enabled"):!t.unit.disabled&&this.scene.statusBot.val()>=this.cost?this.setState("enabled"):this.setState("disabled"),this.name=e,this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}setState(t){const e={gray:{active:10079385,enabled:6723942,disabled:13421772},blue:{active:10079385,enabled:6723942,disabled:13421772},green:{active:11202218,enabled:6723942,disabled:13421772},lila:{active:10079385,enabled:6723942,disabled:13421772},yellow:{active:10079385,enabled:6723942,disabled:13421772}};this.first.setTint(e[this.bgColor][t]),"active"===t?this.next.clearTint():this.next.setTint(e[this.bgColor][t]),this.state=t}showStatus(){if("disabled"===this.state){let t;t="ActionSpawn"===this.name?this.scene.statusEnergy.valueImage:this.scene.statusBot.valueImage,this.scene.tweens.addCounter({from:0,to:204,duration:250,onComplete:()=>{this.first.setState(),t.setTint(t.color)},onUpdate:e=>{const i=Math.floor(e.getValue());this.first.setTint(Phaser.Display.Color.GetColor(i,i,i)),t.setTint(Phaser.Display.Color.GetColor(i,i,i))}})}}destroyed(){}}class UIBrain extends Phaser.GameObjects.Graphics{constructor(t){super(t),t.add.existing(this);let e=4*this.scene.game.resolution;this.brain=t.add.image(t.cameras.main.width-e,e,"StatusBigBrain"),this.brain.setDepth(-1),this.brain.setOrigin(1,0),this.bot=t.add.image(0,0,"BrainBot"),this.teleports=[],this.reset(this.scene.level.grid),this.lastUpdate=0}reset(t){let e=this.brain.getTopLeft();this.x0=e.x-1*this.scene.game.resolution+t.x*this.scene.game.resolution,this.y0=e.y-8*this.scene.game.resolution+t.y*this.scene.game.resolution,this.w0=2*t.w*this.scene.game.resolution,this.h0=2*t.h*this.scene.game.resolution,this.dd=0}addTeleport(t){let e=this.scene.add.image(this.x0,this.y0,"BrainTeleport");e.connection=t.teleport,e.x+=t.x/t.scene.groundLayer.width*this.w0,e.y+=t.y/t.scene.groundLayer.height*this.h0;for(let t=0;t<this.teleports.length;t++){let i=this.teleports[t];e.connection.from===i.connection.to&&e.connection.to===i.connection.from&&(this.lineStyle(2*this.scene.game.resolution,16776960,.5),this.lineBetween(e.x,e.y,i.x,i.y))}this.teleports.push(e)}update(t){if(this.scene.time.now<this.updateTime)return;this.updateTime=this.scene.time.now+340,0===this.dd&&(this.dd=this.w0/t.scene.groundLayer.width);let e=t.x*this.dd,i=t.y*this.dd;this.bot.x=this.x0+e,this.bot.y=this.y0+i,this.bot.rotation=t.rotation+Math.PI/2}}class UIControl{constructor(t){this.scene=t;let e=t.add.image(0,t.cameras.main.height,"ControlPadBg").setOrigin(.5,.5);e.x=.3*e.width,e.y-=.3*e.height,e.tint=8421504,this.padMoveBg=e,e.alpha=.5,this.padMove=t.add.image(e.x,e.y,"ControlPadButton"),this.padMove.tint=10079385,this.padMove.step=this.padMove.width/4;let i=t.add.image(t.cameras.main.width-e.x,e.y,"ControlPadBg").setOrigin(.5,.5);i.tint=8421504,i.alpha=.5,this.padButtonBg=i,this.padButton=t.add.image(i.x,i.y,"ControlPadButton"),this.padButton.tint=16751001,this.reset()}resetMove(){this.up=!1,this.down=!1,this.left=!1,this.right=!1,this.move=!1}resetButton(){this.button=!1}reset(){this.resetMove(),this.resetButton()}setUnit(t){this.unit=t,this.unit.control.pad=this}isPointerOver(t){return this.padMoveBg.getBounds().contains(t.x,t.y)?this.padMoveBg:this.padButtonBg.getBounds().contains(t.x,t.y)?this.padButtonBg:null}onPointermove(t,e,i){if(!this.unit)return;let s=null;if(this.padButtonBg.pointerId===t.id){s=this.padButtonBg,this.isPointerOver(t)||(s.x+=(t.x-s.x)/8,s.y+=(t.y-s.y)/8,this.padButton.x=this.padButtonBg.x,this.padButton.y=this.padButtonBg.y)}else if(this.padMoveBg.pointerId===t.id){s=this.padMoveBg,this.isPointerOver(t)?this.updatePadmove(t):(s.x+=(t.x-s.x)/8,s.y+=(t.y-s.y)/8,this.padMove.x=this.padMoveBg.x,this.padMove.y=this.padMoveBg.y)}else this.isPointerOver(t)||(this.padMove.tint=10551200,this.unit.controlPoint([t.x+e,t.y+i]))}onPointerdown(t){if(!this.unit)return;this.update(!1,!1,!1,!1),this.unit.controlPoint(null);let e=this.isPointerOver(t);return e===this.padMoveBg?(this.move=!0,e.pointerId=t.id):e===this.padButtonBg&&(e.pointerId=t.id,this.button=!0),this.move|this.button}updatePadmove(t){let e=!1,i=!1;t.y<this.padMoveBg.y-this.padMove.step?e=!0:t.y>this.padMoveBg.y+this.padMove.step&&(i=!0);let s=!1,n=!1;t.x<this.padMoveBg.x-this.padMove.step?s=!0:t.x>this.padMoveBg.x+this.padMove.step&&(n=!0),this.update(e,i,s,n)}onPointerup(t,e,i){if(!this.unit)return;this.update(!1,!1,!1,!1);this.move,this.button;this.padMoveBg.pointerId===t.id&&(this.up=!1,this.down=!1,this.left=!1,this.right=!1,this.move=!1,this.padMoveBg.pointerId=-1),this.padButtonBg.pointerId===t.id&&(this.button=!1,this.padButtonBg.pointerId=-1);let s=this.isPointerOver(t);if(s)s===this.padButtonBg&&this.select();else if(this.unit.controlPoint([t.x+e,t.y+i])){this.unit.control.target.unit=null,this.unit.control.target.focus=null;let s=this.unit.width,n=this.unit.scene.getUnits(t.x+e,t.y+i,s*s,this.unit.player);if(n)for(let t=0;t<n.length;t++){let e=n[t];if(e.action){this.unit.control.target.focus=e;break}}this.unit.control.target.focus?(this.unit.control.target.focusImage.setPosition(this.unit.control.target.focus.x,this.unit.control.target.focus.y),this.unit.control.target.focusImage.visible=!0):this.unit.control.target.focusImage.visible=!1}else this.unit.menuSelect(t.x,t.y),this.scene.input.enabled=!1,this.scene.time.delayedCall(250,function(){this.scene.input.enabled=!0},[],this)}padActive2(t){t||this.move?this.padMove.tint=10551200:this.padMove.tint=10079385}update(t,e,i,s){if(t!==this.up||e!==this.down||i!==this.left||s!==this.right){this.up=t,this.down=e,this.left=i,this.right=s,this.unit.controlPoint(null),this.padMove.y=this.padMoveBg.y,this.up?this.padMove.y-=this.padMove.step:this.down&&(this.padMove.y+=this.padMove.step),this.padMove.x=this.padMoveBg.x,this.left?this.padMove.x-=this.padMove.step:this.right&&(this.padMove.x+=this.padMove.step),this.unit.controlDo(t,e,i,s,!0);let n=t||e||i||s;this.padMove.tint=n?10551200:10079385}}refresh(){this.unit.controlDo(this.up,this.down,this.left,this.right,!1)}select(){this.scene.select()}static preload(t,e){Array.prototype.push.apply(t,["ControlTarget","ControlPadBg","ControlPadButton"])}}class UIScene extends Phaser.Scene{constructor(t){super({key:t}),this.selectTime=0,this.moveTime=0,this.updateControlTargetTime=0,this.isGameOver=!1}init(){this.levelNo=parseInt(this.game.restore("levelNo")||1),this.level=this.registry.get("level"),this.events.on(Phaser.Scenes.Events.SHUTDOWN,()=>{}),this.events.on(Phaser.Scenes.Events.DESTROY,()=>{})}preload(){this.load.path=this.registry.get("path");let t=this.scene.get("LoaderScene"),e=["ActionBg","ActionIconBg","ActionProgress","ActionCancel","ActionSpawn","ActionConnect","ActionTeleport","ActionBuild","StatusBg","StatusEnergy","StatusBody","StatusBot","BrainBot","BrainTeleport","StatusBigBg","StatusBigValue","StatusBigBrain"],i=[{name:"StatusValue",size:50}];UIControl.preload(e,i),t.loadImages(this,e),t.loadSpritesheets(this,i)}create(t){this.debugInfo=this.add.text(this.cameras.main.centerX,this.cameras.main.height,"",{font:16*this.game.resolution+"px Arial",fill:"#ffffff"}).setOrigin(.5),this.debugInfo.y-=this.debugInfo.height,this.input.enabled=!1,this.input.setTopOnly(!0),this.input.addPointer(1),this.brain=new UIBrain(this);let e=4*this.game.resolution,i=e,s=e;this.statusBody=new UIStatus(this,i,s,"Status","Body",10066329,64,0,64),s+=this.statusBody.bg.height+e,this.statusEnergy=new UIStatus(this,i,s,"Status","Energy",10066176,8,0,8),s+=this.statusEnergy.bg.height+e,this.statusBot=new UIStatus(this,i,s,"Status","Bot",10027161,8,0,8),this.controlPad=new UIControl(this),this.input.dragDistanceThreshold=16,this.input.dragTimeThreshold=500,this.upPrev=!1,this.downPrev=!1,this.leftPrev=!1,this.rightPrev=!1,EventDispatcher.getInstance().on("GameStatus",this.gameStatus.bind(this));var n=this.input.keyboard.addKeys("W,S,A,D");this.keys=n;let a=this.input.keyboard.createCursorKeys();var h=this.input.keyboard.addKeys(["CTRL","SPACE"]);h[0].on("down",function(){this.controlPad.select()},this),h[1].on("down",function(){this.controlPad.select()},this),this.cursors=a,this.gamepad=null,this.input.gamepad.once("connected",function(t){this.gamepad=t,this.gamepad.on(Phaser.Input.Gamepad.Events.BUTTON_DOWN,function(t){this.gamepad.left||this.gamepad.right||this.controlPad.select()},this)},this),this.input.mouse&&this.input.mouse.disableContextMenu(),this.game.input.touch.capture=!1,this.input.on("pointerup",this.onPointerup,this),this.input.on("pointerdown",this.onPointerdown,this),this.input.on("pointermove",this.onPointermove,this),t.sceneCreated&&t.sceneCreated(this)}onPointermove(t){if(!this.input.enabled)return;if(!t.isDown)return;let e=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollX:0,i=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollY:0;this.controlPad.onPointermove(t,e,i)}onPointerdown(t){this.input.enabled&&(this.time.now<this.moveTime||this.controlPad.onPointerdown(t))}onPointerup(t){if(!this.input.enabled)return;if(this.time.now<this.moveTime)return;this.moveTime=this.time.now+150;let e=t.upTime-t.downTime,i=t.upX-t.downX,s=t.upY-t.downY;if(e<200){let t=64*this.game.resolution,e=Math.abs(i),n=Math.abs(s);if(e>t||n>t){let a=!1,h=!1,o=!1,r=!1;return e>t&&(i>0?a=!0:h=!0),n>t&&(s>0?r=!0:o=!0),void this.controlPad.update(o,r,h,a)}}let n=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollX:0,a=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollY:0;this.controlPad.onPointerup(t,n,a)}updateControlTarget2(t,e){if(0!==t){if(t<this.updateControlTargetTime)return this.bot.control.target.unit;this.updateControlTargetTime=t+50}let i=this.bot.width,s=this.unitScene.getUnits(e.x,e.y,i*i);if(this.bot.control.target.unit=null,s)for(let t=0;t<s.length;t++){let e=s[t];if(e.action)return e}return null}update(t,e){if(this.input.enabled&&(this.debugInfo.text="FPS "+parseInt(this.game.loop.actualFps),this.bot&&this.input.enabled)){this.brain.update(this.bot),this.bot.update(t,e);let i=!1,s=!1,n=!1,a=!1;if(this.keys){let t=this.keys;t.W.isDown&&(i=!0),t.S.isDown&&(s=!0),t.A.isDown&&(n=!0),t.D.isDown&&(a=!0)}if(this.cursors){let t=this.cursors;t.up.isDown&&(i=!0),t.down.isDown&&(s=!0),t.left.isDown&&(n=!0),t.right.isDown&&(a=!0)}this.gamepad&&((this.gamepad.up||this.gamepad.leftStick.y<=-.5||this.gamepad.rightStick.y<=-.5)&&(i=!0),(this.gamepad.down||this.gamepad.leftStick.y>=.5||this.gamepad.rightStick.y>=.5)&&(s=!0),(this.gamepad.left||this.gamepad.leftStick.x<=-.5||this.gamepad.rightStick.x<=-.5)&&(n=!0),(this.gamepad.right||this.gamepad.leftStick.x>=.5||this.gamepad.rightStick.x>=.5)&&(a=!0)),this.upPrev===i&&this.downPrev===s&&this.leftPrev===n&&this.rightPrev===a||(this.upPrev=i,this.downPrev=s,this.leftPrev=n,this.rightPrev=a,this.controlPad.update(i,s,n,a)),this.controlPad.refresh()}}setUnitSceneLevel(t,e){this.up=this.upPrev=!1,this.down=this.downPrev=!1,this.left=this.leftPrev=!1,this.right=this.rightPrev=!1,this.input.keyboard.resetKeys(),this.controlPad&&this.controlPad.reset(),this.level=e,this.unitScene&&this.unitScene.scene.sleep(),this.unitScene=t}setPlayer(t){if(!this.isGameOver&&(this.player=t,this.bot&&(this.bot.setActive(!1),t.bot&&(t.bot.rotation=this.bot.rotation)),this.bot=t.bot,this.bot)){if(this.level.teleport){let t=this.unitScene.getHqUnits(this.player);for(let e=t.length-1;e>=0;e--){let i=t[e];if(i instanceof UnitTeleport&&this.level.teleport.from===i.teleport.to){this.bot.setPosition(i.x,i.y);break}}}this.bot.setActive(!0),this.bot.teleportEffect(!0,this.bot),this.unitScene.children.bringToTop(this.bot),this.controlPad.setUnit(this.bot),this.unitScene.cameras.main.startFollow(this.bot),this.unitScene.children.bringToTop(this.bot),this.bot?(this.brain.reset(this.level.grid),this.input.keyboard.enabled=!0,this.input.enabled=!0):(this.input.keyboard.enabled=!1,this.input.enabled=!1)}}select(){this.input.enabled&&(this.time.now<this.selectTime||(this.selectTime=this.time.now+150,this.tweens.addCounter({from:204,to:153,duration:125,callbackScope:this,onUpdate:function(t){const e=Math.floor(t.getValue());this.controlPad.padButton.setTint(Phaser.Display.Color.GetColor(255,e,e))}},this),this.bot&&this.bot.uiAction(this)))}gameStatus(t){if(t.start){this.scene.get("UnitScene");this.time.delayedCall(500,function(){},[],this)}t.gameover,t.teleport&&(this.input.keyboard.enabled=!1,this.input.enabled=!1),t.teleportComplete&&this.time.delayedCall(500,function(){this.input.keyboard.enabled=!0,this.input.enabled=!0},[],this)}closeUI(){}destroyed(){let t=this.children.getChildren();for(let e=t.length-1;e>=0;e--)t[e].destroy(!0,!0)}gameOver(t){this.isGameOver=!0,this.input.enabled=!1,this.tweens.killAll()}}class UIStatus extends Phaser.GameObjects.Container{constructor(t,e,i,s,n,a,h=0,o=0,r=1){super(t),this.value=h,this.min=o,this.max=r;let l=t.add.image(e,i,s+"Bg");l.x+=l.width/2,l.y+=l.height/2,l.setDepth(-1),this.bg=l,this.bg.visible=!1,this.valueImage=t.add.image(l.x,l.y,s+"Value"),this.valueImage.setTint(a),this.valueImage.setDepth(-1),this.color=a,this.image=t.add.image(l.x,l.y,s+n),this.image.setDepth(-1),this.update(0)}val(){return this.value}showStatus(){let t=this.valueImage,e=this;this.scene.tweens.addCounter({from:0,to:204,duration:250,onComplete:()=>{t.setTint(e.color)},onUpdate:e=>{const i=Math.floor(e.getValue());t.setTint(Phaser.Display.Color.GetColor(i,i,i))}})}update(t){if(0!==t){if(t>0&&this.value+t>this.max)return this.showStatus(),!1;if(t<0&&this.value+t<this.min)return this.showStatus(),!1;this.value+=t,this.value<this.min&&(this.value=this.min),this.value>this.max&&(this.value=this.max)}return this.valueImage.setFrame(parseInt(this.value/(this.max-this.min)*8)),!0}reset(){return this.value}}class UnitMap extends Phaser.GameObjects.Group{constructor(t,e,i,s){super(t),this.level=e,t.add.existing(this),this.mapUnitGroup=i,this.buildingGroup=s,this.adjacencyList={},this.updateList=[]}refresh(t){this.updateList.length>0||(this.updateList.push(t),this.scene.addEvent(this.update,0,this))}findUnitPath(t,e){let i={},s={};this.mapUnitGroup.getChildren().concat(this.buildingGroup.getChildren()).forEach(t=>{i[t]=1/0}),i[t]=0;let n=new PriorityQueue;n.enqueue([t,0]);let a=n.dequeue();for(;null!==a;){let t=a[0];if(null===t)break;for(let e=t.route.targets.length-1;e>=0;e--){let a=t.route.targets[e],h=1,o=i[t]+h;o<i[a]&&(i[a]=o,s[a]=t,n.enqueue([a,o]))}for(let e=t.route.sources.length-1;e>=0;e--){let a=t.route.sources[e],h=1,o=i[t]+h;o<i[a]&&(i[a]=o,s[a]=t,n.enqueue([a,o]))}a=n.dequeue()}let h=[e],o=e;for(;o!==t;)if(h.unshift(s[o]),!(o=s[o]))return[];return h}update(){this.updateList.pop(),this.clear();this.unconnectedSprites=[];this.connectedSprites=[];let t=this.scene.cardScene.selectedCard;t&&(t.card.select(!1),t.card.select(!0));let e=[];this.rotating=e;let i=this.mapUnitGroup.getChildren().concat(this.buildingGroup.getChildren());for(let t=i.length-1;t>=0;t--){i[t].unitMapUpdated(null)}for(let t=i.length-1;t>=0;t--){i[t].unitMapUpdated(this)}this.rotateTween&&this.rotateTween.remove(),this.rotateTween=this.scene.tweens.add({targets:e,duration:5e3,rotation:2*Math.PI,callbackScope:this,repeat:-1,onComplete:function(t){}},this)}drawPath2(t,e,i,s,n,a){t.draw(e,{x:i.x,y:i.y},s,n,a)}loopTargets(t){if(!0!==t.visited){t.visited=!0;for(let e=t.route.targets.length-1;e>=0;e--){let i=t.route.targets[e];i.isConnectedToHq=!0,this.connectedArr.push(i.sprite),this.tagConnected(i)}}}drawConnectHq(t){t.route.connectHq.length}drawConnection(t,e){let i=this.create(t.x,t.y,"UnitMapPipe");i.setOrigin(0,.5);let s=Phaser.Math.Angle.BetweenPoints(t,e);i.setRotation(s);var n=Phaser.Math.Distance.Between(i.x,i.y,e.x,e.y);i.scaleX=n/i.width,i.setDepth(-1),i.setTint(13395660)}}Unit.Type={Bot:UnitBot,Teleport:UnitTeleport,Energy:UnitEnergy,Emitter:UnitEmitter,Element:UnitElement,Route:UnitRoute,Spawner:UnitSpawner,Guard:UnitGuard,Virus:UnitVirus};const ZOOMTIME=500;class UnitScene extends Phaser.Scene{constructor(t,e){super({key:t}),this.debug=!0,this.cardScene=e,this.teamBuildings=[],this.teamTroops=[],this.teamBullets=[],this.eventQueue=new PriorityQueue,this.loser=null,this.unitListeners=[],this.guardListeners=[]}init(){this.zoomTween=null,this.events.on(Phaser.Scenes.Events.DESTROY,()=>{})}preload(){this.load.path=this.registry.get("path");let t=["UnitMapPipe","BgTileCell"],e=[{name:"EffectExplode",size:16}];Unit.preload(t,e),Object.entries(Unit.Type).forEach(function(i){i[1].preload&&i[1].preload(t,e)});let i=this.scene.get("LoaderScene");i.loadImages(this,t),i.loadSpritesheets(this,e)}create(t){this.level=t,this.createBackground(),this.scene.sendToBack(),Object.entries(Unit.Type).forEach(function(t){if(t[1].animFrameRate){let e="Unit"+t[0];this.anims.create({key:e,frames:this.anims.generateFrameNumbers(e),frameRate:t[1].animFrameRate,repeat:-1,yoyo:!1})}},this),this.mapUnitGroup=this.physics.add.group(),this.fields=this.physics.add.group(),this.idleUnits=this.physics.add.group(),this.unitMaps=[],this.scene.sendToBack(),this.cameras.main.setBackgroundColor("#0b032d"),t.sceneCreated&&t.sceneCreated(this),this.addEvent(this.createRandomUnit,1e3,this)}getBounds(t=null){let e,i,s,n,a=64*this.game.resolution;return t||(e=0*a,i=0*a,s=this.level.grid.w*a,n=this.level.grid.h*a),{x:e,y:i,w:s,h:n}}createBackground(){let t=64*this.game.resolution;var e=[];let i=this.textures.get("BgTileCell").getSourceImage().width/this.textures.get("BgTileCell").getSourceImage().height,s=this.level.grid.w,n=this.level.grid.h;for(let t=0;t<n;t++){e[t]=[];for(let a=0;a<s;a++){if(0===t||t===n-1){e[t][a]=3;continue}let s=Phaser.Math.Between(0,i-2);e[t][a]=s}e[t][0]=3,e[t][s-1]=3}let a=this.make.tilemap({data:e,tileWidth:t,tileHeight:t});var h=a.addTilesetImage("BgTileCell","BgTileCell",t,t);let o=a.createLayer(0,h);this.groundLayer=o,o.depth=-1,o.setCollisionBetween(3,i-1)}isFreeSpace(t,e,i,s){let n=t.getChildren();for(let t=n.length-1;t>=0;t--){let a=n[t];if(Phaser.Math.Distance.Squared(e,i,a.x,a.y)<s)return!1}return!0}countEnergy(){let t=this.fields.getChildren(),e=0;for(let i=t.length-1;i>=0;i--)t[i]instanceof UnitEnergy&&e++;return e}createEnergy(t,e){new UnitEnergy(this,t,e,this.cardScene.player,this.level)}createRandomUnit(){if(!this.cardScene.player.bot.scene)return;let t=this.level.units,e=Phaser.Math.Between(1,100),i=null;for(let s=0;s<t.length;s++){let n=t[s];if((e-=n.freq)<0){i=n;break}}if(i){let t=this.getBounds(),e=1024*this.game.resolutionSquared;for(let s=0;s<10;s++){let s,n=Phaser.Math.Between(t.x,t.w),a=Phaser.Math.Between(t.y,t.h);if(this.isFreeSpace(this.mapUnitGroup,n,a,e)&&(this.isFreeSpace(this.fields,n,a,e)&&this.isFreeSpace(this.idleUnits,n,a,e))){for(s=0;s<this.teamBuildings.length&&this.isFreeSpace(this.teamBuildings[s],n,a,e)&&this.isFreeSpace(this.teamTroops[s],n,a,e)&&this.isFreeSpace(this.teamBullets[s],n,a,e);s++);if(s===this.teamBuildings.length){let t;"Virus"===i.type&&(t=Unit.Type.Virus),"Energy"===i.type&&(t=Unit.Type.Energy),"Guard"===i.type&&(t=Unit.Type.Guard),this.levelFactory.createUnit(this,t,n,a,this.levelFactory.level.data.players[i.player],i);break}}}}let s=this.idleUnits.getChildren();for(let t=s.length-1;t>=0;t--){let e=s[t];e.config.incubation>0&&e.incubation.scale<1&&(e.incubation.scale+=e.config.incubation,e.incubation.scale>=1?(e.incubation.scale=1,e.createUnit()):e.updateDamage())}let n=this.teamBuildings[0].getChildren().length;n>50&&(n=50);let a=1e3-20*n;this.addEvent(this.createRandomUnit,a,this)}addIdle(t){this.idleUnits.add(t,!0),t.body.move=!1,t.body.immovable=!0,t.incubation={scale:0}}zoomTo(t,e,i){}addUnit(t){this.fields.add(t,!0)}addTeamBuilding(t,e){this.teamBuildings[e].add(t,!0)}addTeamTroop(t,e){this.teamTroops[e].add(t,!0)}addTeamBullet(t,e){this.teamBullets[e].add(t,!0)}addTeam(t){if(this.teamTroops[t])return;let e=this.physics.add.group();e.runChildUpdate=!1;let i=this.physics.add.group();i.runChildUpdate=!1;let s=this.physics.add.group();s.runChildUpdate=!1;for(let t=0;t<this.teamTroops.length;t++)this.physics.add.collider(i,this.teamTroops[t],this.overlapUnit,null,this),this.physics.add.collider(s,this.teamTroops[t],this.overlapUnit,null,this),this.physics.add.collider(this.teamBullets[t],i,this.overlapUnit,null,this);this.physics.add.overlap(this.mapUnitGroup,s,this.overlapUnit,null,this),this.physics.add.overlap(e,s,this.overlapUnit,null,this),this.physics.add.collider(i,this.idleUnits),this.teamBuildings[t]=e,this.teamTroops[t]=i,this.teamBullets[t]=s,0===t&&(this.unitMap=new UnitMap(this,this.level,this.mapUnitGroup,e))}addGuard(t){-1===this.guardListeners.indexOf(t)&&this.guardListeners.push(t)}removeGuard(t){let e=this.guardListeners.indexOf(t);-1!==e&&this.guardListeners.splice(e,1)}guardNotify(t){for(let e=this.guardListeners.length-1;e>=0;e--){let i=this.guardListeners[e];for(let e=0;e<this.teamTroops.length;e++)if(i.player.team.id!==e)for(let s=this.teamTroops[e].getChildren().length-1;s>=0;s--){let n=this.teamTroops[e].getChildren()[s];i.guardDo(n,t)}}}addUnitListener(t){if(-1===this.unitListeners.indexOf(t)){for(let e=this.unitListeners.length-1;e>=0;e--){this.unitListeners[e].event(t,"start")}this.unitListeners.push(t)}}removeUnitListener(t){const e=this.unitListeners;let i=e.indexOf(t);if(-1!==i){e.splice(i,1);for(let e=this.unitListeners.length-1;e>=0;e--){this.unitListeners[e].event(t,"stop")}}}processUnitListeners(t){const e=this.unitListeners;for(let i=e.length-1;i>=0;i--){let s=e[i];t>s.unit.time&&(s.unit.time=s.unitProcess(t))}}addBullet2(t,e){e.scene=this,this.add.existing(e),this.debug&&(e.body.debugShowBody=!0,e.body.debugShowVelocity=!0)}overlapUnit(t,e){this.physics.world.isPaused||t.overlap(e)}scaleResolution(t){return t*this.game.resolution}explode(t){let e=this.add.particles("EffectExplode");e.createEmitter({frame:[2],x:t.x,y:t.y,speed:{start:this.scaleResolution(112.5),end:this.scaleResolution(-112.5)},quantity:5,ease:"Power2",lifespan:1500,maxParticles:50,blendMode:"SCREEN",alpha:{start:1,end:0}}),e.createEmitter({frame:[0],x:t.x,y:t.y,speed:{start:this.scaleResolution(75),end:this.scaleResolution(-75)},quantity:5,ease:"Power2",lifespan:1e3,maxParticles:100,blendMode:"SCREEN",alpha:{start:1,end:0}}),e.createEmitter({frame:[0],x:t.x,y:t.y,speed:{start:this.scaleResolution(56.25),end:this.scaleResolution(-56.25)},quantity:5,ease:"Power2",lifespan:1e3,maxParticles:50,blendMode:"SCREEN",alpha:{start:1,end:0}});e.createGravityWell({x:t.x,y:t.y,power:2,epsilon:100,gravity:t.scene.scaleResolution(8)});this.time.delayedCall(2e3,function(){e.destroy()},this)}showGameOver(t,e,i,s,n,a,h){this.input.enabled=!1;let o=this.add.group();this.cardScene.input.once("pointerdown",function(){o.destroy(!0),o=null,this.input.enabled=!0},this);let r=this.add.graphics();if(o.add(r),r.fillStyle(0,.5),r.fillRect(0,0,this.cameras.main.width,this.cameras.main.height),this.level.tutorial.img)return void this.add.image(this.cameras.main.centerX,this.cameras.main.centerY/3,"tutorial-drag-to-select");let l=-1===e?this.cameras.main.centerX:e*a,c=-1===i?this.cameras.main.centerY:i*h,d=o.create(l,c,"sprites","alice.png");if(d.setDepth(10),d.alpha=0,n){let t=o.create(n[0]*a,n[1]*h,"sprites","hand.png");t.x<this.cameras.main.width/2&&(t.scaleX=-1),this.tweens.add({targets:t,duration:400,x:t.x+20,delay:s,repeat:n.length>2?2:4,yoyo:!0,callbackScope:this,onComplete:function(){o&&(n.length>2?(t.scaleX=1,t.x=n[2]*a,t.y=n[3]*h,this.tweens.add({targets:t,duration:400,x:t.x+20,delay:s,repeat:1,yoyo:!0,callbackScope:this,onComplete:function(){}},this)):t.destroy())}},this)}this.tweens.add({targets:d,duration:400,alpha:1,delay:s/4,repeat:1,callbackScope:this,onComplete:function(){if(!o)return;let e=o.create(d.x,d.y+d.height/2,"sprites","dialog.png");e.setDepth(10);let i=e.width/12,s=this.add.text(e.x,e.y-e.width/26/2,t,{fontFamily:"Source Code Pro",fontSize:i,color:"#000",align:"center"}).setOrigin(.5);s.setDepth(10),o.add(s)}},this)}destroyed(){for(let t=0;t<this.teamTroops.length;t++){let e=this.teamBuildings[t];e.runChildUpdate=!1;for(let t=e.getChildren().length-1;t>=0;t--){e.getChildren()[t].destroy(!0,!0)}(e=this.teamTroops[t]).runChildUpdate=!1;for(let t=e.getChildren().length-1;t>=0;t--){e.getChildren()[t].destroy(!0,!0)}(e=this.teamBullets[t]).runChildUpdate=!1;for(let t=e.getChildren().length-1;t>=0;t--){e.getChildren()[t].destroy(!0,!0)}}this.mapUnitGroup.runChildUpdate=!1;for(let t=this.mapUnitGroup.getChildren().length-1;t>=0;t--){this.mapUnitGroup.getChildren()[t].destroy(!0,!0)}this.eventQueue.destroy()}gameOver(){this.eventQueue.destroy(),this.time.removeAllEvents(),this.physics.world.colliders.destroy(),this.physics.pause(),this.tweens.killAll()}getHqUnits(t){return this.mapUnitGroup.getChildren().concat(this.teamBuildings[t.id].getChildren())}getUnits(t,e,i,s){let n=[],a=this.mapUnitGroup.getChildren();for(let s=a.length-1;s>=0;s--){let h=a[s];i?Phaser.Math.Distance.Squared(t,e,h.x,h.y)<i&&n.push(h):h.getBounds().contains(t,e)&&n.push(h)}if(s)for(let h=(a=this.teamBuildings[s.id].getChildren()).length-1;h>=0;h--){let s=a[h];i?Phaser.Math.Distance.Squared(t,e,s.x,s.y)<i&&n.push(s):s.getBounds().contains(t,e)&&n.push(s)}return n}getEnemyTroops(t){let e=[];for(let i=0;i<this.teamTroops.length;i++)t.team.id!==i&&e.push(this.teamTroops[i].getChildren());return e}getEnemyUnits(t,e,i,s){let n=[];for(let a=0;a<this.teamTroops.length;a++){if(s.id===a)continue;let h=this.teamTroops[a].getChildren();for(let s=h.length-1;s>=0;s--){let a=h[s];i?Phaser.Math.Distance.Squared(t,e,a.x,a.y)<i&&n.push(a):a.getBounds().contains(t,e)&&n.push(a)}}return n}addEvent(t,e,i){this.eventQueue.enqueue([t,this.time.now+e,i])}clearEvents(t){this.eventQueue.clear(t)}update(t,e){if(this.guardNotify(t),this.processUnitListeners(t),this.loser)return;let i=this.eventQueue.dequeueExpired(t);for(;null!==i;)i[0].call(i[2]),i=this.eventQueue.dequeueExpired(t)}}class MainGame extends Phaser.Game{constructor(t,e,i){let s=window.innerWidth,n=window.innerHeight;if(s<n){let t=s;s=n,n=t}window.devicePixelRatio>=2||window.devicePixelRatio;super({key:t.id,type:Phaser.AUTO,parent:t,width:s,height:n,backgroundColor:"#202f53",audio:{noAudio:!0},physics:{default:"arcade",arcade:{debug:!1,fps:60}},render:{},scale:{zoom:1,mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},input:{touch:{capture:!0},gamepad:!0},disableContextMenu:!0,scene:[new LoaderScene(e)]});let a=document.getElementsByTagName("html")[0].getAttribute("lang");a&&Text.setLang(a),this.registry.set("debug",!0),-1!==window.location.href.indexOf("localhost:8383")?(this.registry.set("debug",!0),this.registry.set("path","./")):-1!==window.location.href.indexOf("test/")?(this.registry.set("release",!0),this.registry.set("path","/test-"+Text.id+"/")):(this.registry.set("release",!0),this.registry.set("path","/"+Text.id+"/")),this.registry.set("gameid",i)}clear(t){window.localStorage.removeItem(this.registry.get("gameid")+t)}save(t,e){window.localStorage.setItem(this.registry.get("gameid")+t,e)}restore(t){return window.localStorage.getItem(this.registry.get("gameid")+t)}}const LEVEL="";function createGame(){var t=new URL(window.location).searchParams.get("id")||"";window.game=new MainGame(document.getElementById("canvas"),["level-0","level-1","level-2","level-3","level-4","level-5","level-6","end"],Text.id+t)}function setGameConfig(t,e,i){}function log(t){console.log(t)}