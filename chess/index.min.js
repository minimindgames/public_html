/*! Copyright chess 26-01-2021 */

class Unit extends Phaser.GameObjects.PathFollower{constructor(e,t,i,r,n,s){super(e,null,n,s,i,r),this.player=t,this.id=Unit.id++}getValidMoves(){let e=[];this.select();let t=this.scene.getBoard();for(let i=0;i<t.layer.layer.height;i++)for(let r=0;r<t.layer.layer.width;r++)if(65280===t.layer.getTileAt(r,i).tint){let t={sx:this.tile.x,sy:this.tile.y,tx:r,ty:i};this.check(t)&&e.push(t)}return t.deselect(),e}check(e){return!0}toString(){return this.id}static preload(e,t){}}Unit.id=1;class UnitChess extends Unit{constructor(e,t,i,r,n,s,a){super(e,t,i,r,n,s),this.piece=a,this.name=a,this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.tile}movePath(e,t){let i=new Phaser.Curves.Path(this.x,this.y);for(let t=0,r=e.length;t<r;t++)i.lineTo(e[t].x,e[t].y);this.setPath(i),this.startFollow({ease:"Power2",duration:500*e.length,onComplete:(e,i)=>{this.stopFollow(),t(this)}})}pointerDown(){}select(){this.scene.getBoard();return this}deselect(){this.scene.getBoard();return this.tile.tint=16777215,null}static preload(e,t){}}class Board extends Phaser.GameObjects.Group{constructor(e){super(e),this.auto=!1,this.depth=2*this.scene.level.moves-1,this.auto||this.depth--;let t=e.textures.get("board-squares").getSourceImage();let i=e.make.tilemap({data:[[1,0,1,0,1,0,1,0],[0,1,0,1,0,1,0,1],[1,0,1,0,1,0,1,0],[0,1,0,1,0,1,0,1],[1,0,1,0,1,0,1,0],[0,1,0,1,0,1,0,1],[1,0,1,0,1,0,1,0],[0,1,0,1,0,1,0,1]],tileWidth:t.height,tileHeight:t.height});var r=i.addTilesetImage("board-squares");this.layer=i.createDynamicLayer(0,r),this.layer.name="board",this.selected=null,e.input.on(Phaser.Input.Events.POINTER_UP,e=>{const{x:t,y:i}=e;let r=this.layer.worldToTileXY(t,i),n=this.layer.getTileAt(r.x,r.y);if(n&&(!this.selected||n!==this.selected.tile))if(this.auto)this.nextTurn();else if(this.selected)this.selected.tile.tint=16777215,this.selected=null,this.validTiles.forEach(function(e){e.tint=16777215}),this.validTiles.includes(n)&&this.do_move(n.move),this.validTiles=[];else if(n.unit){this.validTiles=[];let e=String.fromCharCode("a".charCodeAt(0)+n.x)+""+(7-n.y+1),t=this.chess.moves({square:e});t.length>0&&(this.selected=n.unit,this.selected.tile.tint=16711935),t.forEach(function(e){let t;for(let i=e.length-1;i>0;i--)if(e[i]>="0"&&e[i]<="9"){t=e[i-1]+e[i];break}const{x:i,y:r}=this.squareToXY(t);let n=this.layer.getTileAt(i,r);n.tint=65280,n.move=e,this.validTiles.push(n)},this)}},this),this.players=[],this.chess=new Chess,this.chess.clear(),this.moveCount=0}squareToXY(e){return{x:e.charCodeAt(0)-"a".charCodeAt(0),y:7-(e.charAt(1)-1)}}unitMoved(e){let t=e.tile;t.unit&&t.unit.destroy(),e.upgradePawn&&(e.setFrame(LevelFactory.getFrame(e.upgradePawn)),e.upgradePawn=null),t.unit=e,this.chess.game_over()||0===this.depth?this.isGameOver():"w"===this.chess.turn()?(this.moveCount++,EventDispatcher.getInstance().emit("GameStatus",{turn:this.chess.turn(),move:this.moveCount}),this.scene.input.enabled=!0):this.nextTurn()}do_move(e){"w"===this.chess.turn()&&EventDispatcher.getInstance().emit("GameStatus",{turn:"b",move:this.moveCount}),this.scene.input.enabled=!1,this.chess.move(e);let t=this.chess.history({verbose:!0}),i=t[t.length-1],r=this.squareToXY(i.from),n=this.layer.getTileAt(r.x,r.y),s=n.unit;s.depth=this.moveCount+1,n.unit=null;let a,o=this.squareToXY(i.to),l=this.layer.getTileAt(o.x,o.y),h=l.pixelX+l.width/2,u=l.pixelY+l.height/2;return"N"===e.charAt(0)?(a=Math.abs(h-s.x)>Math.abs(u-s.y)?[{x:h,y:s.y}]:[{x:s.x,y:u}]).push({x:h,y:u}):a=[{x:h,y:u}],s.tile=l,"="===e.charAt(e.length-2)&&(s.upgradePawn=e[e.length-1]),s.movePath(a,this.unitMoved.bind(this)),!this.chess.game_over()}load(e){this.chess.load(e)}deselect(){this.layer.forEachTile(function(e){e.tint=16777215},this),this.selected=null}addPlayer(e){this.players.push(e)}start(){this.player=this.players[0],"b"===this.chess.turn()&&this.nextTurn()}getPieceValue(e,t,i){if(null===e)return 0;var r=function(e){if("p"===e.type)return 10;if("r"===e.type)return 50;if("n"===e.type)return 30;if("b"===e.type)return 30;if("q"===e.type)return 90;if("k"===e.type)return 900;throw"Unknown piece type: "+e.type}(e);return"w"===e.color?r:-r}minimax(e,t,i,r,n){if(0===e){let e=0;return t.game_over()&&(e=n?-1:1),e}var s,a=t.moves();if(n){s=-9999;for(let o=0;o<a.length;o++)if(t.move(a[o]),s=Math.max(s,this.minimax(e-1,t,i,r,!n)),t.undo(),r<=(i=Math.max(i,s)))return s;return s}s=9999;for(let o=0;o<a.length;o++)if(t.move(a[o]),s=Math.min(s,this.minimax(e-1,t,i,r,!n)),t.undo(),(r=Math.min(r,s))<=i)return s;return s}minimaxRoot(e,t,i){var r,n=t.moves(),s=-9999;let a=[];for(var o=0;o<n.length;o++){this.positionCount=0;var l=n[o];t.move(l);var h=this.minimax(e-1,t,-1e4,1e4,!i);t.undo(),h>=s&&(a.push(l),s=h,r=l)}if(!r||s<=0){let e=[];a.forEach(function(t){-1!==t.indexOf("x")&&e.push(t)},this),e.length>0&&(r=e[Math.floor(Math.random()*e.length)]),r||(r=a[Math.floor(Math.random()*a.length)])}return r}isGameOver(){let e=EventDispatcher.getInstance(),t=null;return 0===this.depth?t="+":this.chess.game_over()&&(t=this.chess.in_draw()?"=":this.chess.in_threefold_repetition()?"3":this.chess.insufficient_material()?"-":"w"),!!t&&("w"===t?e.emit("GameOver",{result:t,moves:this.chess.history().length}):(e.emit("GameOver",{result:t}),this.scene.cameras.main.shake(100,.05)),!0)}nextTurn(){this.player=this.player===this.players[0]?this.players[1]:this.players[0];this.chess.moves();var e=this.minimaxRoot(this.depth,this.chess,!0);return this.depth--,this.do_move(e)}move_piece(e,t){e.x=t.pixelX+t.width/2,e.y=t.pixelY+t.height/2,e.tile.unit=null,e.tile=t,e.tile.unit=e}addUnit(e,t,i){e.tile&&(e.tile.unit=null,e.tile=null);let r=this.layer.getTileAt(t,i);e.x=r.pixelX+r.width/2,e.y=r.pixelY+r.height/2,r.unit=e,e.tile=r,this.add(e,!0)}selectUnit(e){this.selected=e}}class Button extends Phaser.GameObjects.Container{constructor(e,t){super(e),this.scene.add.existing(this),this.setData("states",t);let i=this.scene.add.image(this.x,this.y,"ui-button");this.buttonImage=i,i.setInteractive().on("pointerover",()=>this.pointerover()).on("pointerout",()=>this.pointerout()).on("pointerdown",()=>this.pointerdown()).on("pointerup",()=>this.pointerup()),i.setOrigin(.5),this.add(i);let r=this.scene.add.text(this.x,this.y,t[0],{fontSize:12*this.scene.game.resolution,color:"#fff",align:"center"});r.setShadow(2,2,"#000",2),r.setOrigin(.5),this.textLabel=r,this.add(r)}next(){let e=this.getData("states").indexOf(this.text());e+1>=this.getData("states").length?e=0:e++,this.set(this.getData("states")[e])}set tint(e){this.buttonImage.setTint(e)}get tint(){return this.getAt(0).getTint()}get label(){return this.getAt(1)?this.getAt(1).text:null}set label(e){this.textLabel.text=e}pointerover(){this.getAt(0).setTexture("ui-button-active")}pointerout(){this.getAt(0).setTexture("ui-button")}pointerdown(){}pointerup(){let e=Date.now();this.lastTime+200>e||(this.lastTime=e,EventDispatcher.getInstance().emit("Button",this.label))}get width(){return this.getBounds().width}get height(){return this.getBounds().height}}let instance=null;class EventDispatcher extends Phaser.Events.EventEmitter{constructor(){super()}static getInstance(){return null===instance&&(instance=new EventDispatcher),instance}}class GameOverScene extends Phaser.Scene{constructor(e){super({key:e})}init(){this.cameras.main.setRoundPixels(!0)}preload(){this.load.path=this.registry.get("path")}create(){this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,Text.gameName+"\n\n"+Text.gameOverCongratulations,{align:"center"}).setOrigin(.5).setColor("blue")}handleLoseFocus(){}}class GameScene extends Phaser.Scene{constructor(e,t){super({key:e})}init(){this.levelNo=parseInt(this.game.restore("levelNo")||1),this.level=this.registry.get("level")}preload(){this.load.path=this.registry.get("path");let e=this.scene.get("LoaderScene");e.loadImages(this,["board-squares"]),e.loadSpritesheets(this,[{name:"piece-whites",size:32},{name:"piece-blacks",size:32}])}create(e){this.eventDispather=EventDispatcher.getInstance();let t=this.input.keyboard.createCursorKeys();this.input.keyboard.on("keydown-SPACE",function(){this.openUI()},this),this.cursors=t,this.gamepad=null,this.input.gamepad.once("connected",function(e){this.gamepad=e,this.gamepad.on(Phaser.Input.Gamepad.Events.BUTTON_DOWN,function(e){this.gamepad.left||this.gamepad.right||this.openUI()},this)},this),this.level=this.registry.get("level"),this.board=new Board(this),this.levelFactory=new LevelFactory(this,this.level,this.board),this.board.start()}getBoard(){return this.board}update(){var e=this.input.activePointer;e.isDown&&(e.x,this.cameras.main.centerX),this.gamepad&&(this.gamepad.left||this.gamepad.leftStick.x<=-.5||this.gamepad.rightStick.x,this.gamepad.A||this.gamepad.B)}}class LevelFactory{constructor(e,t,i){t.data={players:[]};for(let r=0;r<t.players.length;r++)t.data.players[r]=new Player(r,e),t.data.players[r].id=r,i.addPlayer(t.data.players[r]);if(t.board)for(let r=0;r<8;r++)for(let n=0;n<8;n++){let s=t.board[r].charAt(n);if("."!==s){let a=LevelFactory.getFrame(s.toUpperCase()),o=s.toUpperCase()===s?"w":"b",l="w"===o?"piece-whites":"piece-blacks",h=i.layer.getTileAt(n,r),u=h.pixelX+h.width/2,c=h.pixelY+h.height/2,f=new UnitChess(e,"w"===o?t.data.players[0]:t.data.players[1],l,a,u,c,s);h.unit=f,f.tile=h,i.add(f,!0);let p=String.fromCharCode("a".charCodeAt(0)+n)+""+(7-r+1);i.chess.put({type:s.toLowerCase(),color:o},p)}}else if(t.fen){i.load(t.fen);let r=i.chess.board();for(let n=0;n<8;n++)for(let s=0;s<8;s++){let a=r[n][s];if(a){let r=-1;switch(a.type.toUpperCase()){case"P":r=0;break;case"K":r=1;break;case"Q":r=2;break;case"B":r=3;break;case"N":r=4;break;case"R":r=5}let o="w"===a.color?"piece-whites":"piece-blacks",l=i.layer.getTileAt(s,n),h=l.pixelX+l.width/2,u=l.pixelY+l.height/2,c=new UnitChess(e,"w"===a.color?t.data.players[0]:t.data.players[1],o,r,h,u,a);l.unit=c,c.tile=l,i.add(c,!0)}}}}static getFrame(e){let t=-1;switch(e){case"P":t=0;break;case"K":t=1;break;case"Q":t=2;break;case"B":t=3;break;case"N":t=4;break;case"R":t=5}return t}createUnits(e,t,i,r,n){let s=[];if(t)for(let a=0;a<t.length;a++){let o=new i(e,r,n,t[a]);s.push(o.sprite)}return s}static preload(e,t){}}class LoaderScene extends Phaser.Scene{constructor(e){super({key:"LoaderScene",visible:!1}),this.loadProgress=0,this.levelList=e}init(){}preload(){this.load.path=this.registry.get("path");this.game.getImage=this.getImage,this.game.config.width>=576?(this.res="res-hi",this.game.resolution=2):this.game.config.width>=432?(this.res="res-mid",this.game.resolution=1.5):(this.res="res-lo",this.game.resolution=1),this.game.res=this.res,this.levelNo=parseInt(this.game.restore("levelNo")||0);for(let e=0;e<this.levelList.length;e++)if(this.levelList[e]===LEVEL){this.levelNo=e,console.log("Level "+LEVEL);break}this.load.json("level/"+this.levelList[this.levelNo])}create(){EventDispatcher.getInstance();let e=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,Text.gameName,{font:"16px Arial",fill:"#000000"}).setOrigin(.5);this.load.on("loadProgress",function(t){e.text=Text.loading+" "+parseInt(100*t)+" %"},this),this.startLevel()}loadLevel(){this.levelList&&this.levelNo>=this.levelList.length||(this.registry.set("level",null),this.load.json("level/"+this.levelList[this.levelNo]),this.load.start())}closeLevel(){this.scene.setVisible(!0),this.scene.bringToTop(),this.cameras.main.alpha=1,this.cameras.main.once("camerafadeoutcomplete",()=>{this.startLevel()}),this.cameras.main.fadeOut(500,255,255,255)}startLevel(){let e=EventDispatcher.getInstance();if(e.shutdown(),e.once("Button",function(e){e===Text.next&&(this.levelNo++,this.game.save("levelNo",this.levelNo),this.loadLevel(this.levelNo),this.closeLevel()),e===Text.restart&&this.closeLevel()},this),this.scene.manager.scenes.length>1)return this.scene.manager.scenes.forEach(function(e){e!==this&&this.scene.remove(e)},this),void this.time.delayedCall(10,function(){this.startLevel()},[],this);let t=this.cache.json.get("level/"+this.levelList[this.levelNo]);if(!t)return this.load.once("complete",function(){this.startLevel()},this),this.load.json("level/"+this.levelList[this.levelNo]),void this.load.start();this.registry.set("level",t),this.scene.setVisible(!1),t.moves?this.scene.add("UIScene",new UIScene("UIScene"),!0):this.scene.add("GameOverScene",new GameOverScene("GameOverScene"),!0)}getImage(e,t,i,r){return this.cache.json.get("sprites").frames[r+".png"]?new Phaser.GameObjects.Image(e,t,i,"sprites",r):new Phaser.GameObjects.Image(e,t,i,r)}loadBitmap(e,t){this.bitmaps={frames:[]},t.forEach(function(t){e===this||this.sprites.frames[t+".png"]||(console.log("img/"+this.res+"/"+t+".png"),e.load.bitmapFont(t,"img/"+this.res+"/"+t+".png","img/"+this.res+"/"+t+".xml"))},this)}loadImages(e,t){this.sprites={frames:[]},t.forEach(function(t){e===this||this.sprites.frames[t+".png"]||e.load.image(t,"img/"+this.res+"/"+t+".png")},this)}loadSpritesheets(e,t){t.forEach(function(t){let i=t.width?t.width:t.size,r=t.height?t.height:t.size;e.load.spritesheet(t.name,"img/"+this.res+"/"+t.name+".png",{frameWidth:i*this.game.resolution,frameHeight:r*this.game.resolution})},this)}}class Player{constructor(e,t){}}var Text={id:"chess",gameName:"CHESS PUZZLE",loading:"Loading",next:"NEXT",play:"PLAY",quit:"QUIT",pause:"PAUSE",resume:"RESUME",restart:"TRY\nAGAIN",gameOverCongratulations:"All levels passed.\n\nCongratulations!",info:"White to play,\nmate in",moves:"moves",tooManyMoves:"Extra moves. Try again,\nplay perfect game.",draw:"Draw.",win:"YOU WIN\nGo to the next puzzle.",wait:"Wait for computer,\nmay take a minute.",setLang(e){"fi"===e&&(this.gameName="SHAKKIPULMA",this.loading="Ladataan",this.next="JATKA",this.play="PELAA",this.quit="POISTU",this.pause="PAUSE",this.resume="RESUME",this.restart="ALOITA\nALUSTA",this.gameOverCongratulations="Kaikki tasot selvitetty.\n\nOnnittelut!",this.info="Valkoinen pelaa,\nmatti",this.moves="siirrossa",this.tooManyMoves="Liikaa siirtoja. Yritä,\nuudelleen täydellistä peliä.",this.draw="TASAN",this.win="VOITIT\nJatka seuraavaan pulmaan.",this.wait="Odota tietokonetta,\nvoi kestää minuutin.")}};class UIScene extends Phaser.Scene{constructor(e){super({key:e})}init(){this.cameras.main.setRoundPixels(!0),this.firstGameToday=!1,parseInt(0|this.game.restore("lastPlayTime"))+43200<(Date.now()/1e3|0)&&(this.firstGameToday=!0)}preload(){this.load.path=this.registry.get("path"),this.scene.get("LoaderScene").loadImages(this,["ui-button","ui-button-active"])}gameStatus(e){let t=this.registry.get("level");if(e.turn){let i=t.moves-e.move;"w"===e.turn?this.info.text=t.id+". "+Text.info+" "+i+" "+Text.moves+".":this.info.text=Text.wait}}gameOver(e){let t,i;switch(e.result){case"+":t=Text.tooManyMoves,i=Text.restart;break;case"-":case"3":t=Text.draw,i=Text.restart;break;case"w":default:t=Text.win,i=Text.next}this.playButton.label=i,this.playButton.tint=255,this.info.setText(t),this.info.setColor("red")}create(){let e=EventDispatcher.getInstance();e.on("GameStatus",this.gameStatus.bind(this)),e.once("GameOver",this.gameOver.bind(this));this.scene.get("GameScene")||this.scene.add("GameScene",new GameScene("GameScene",this.gameEvent));let t=this.scene.get("GameScene");this.gameScene=t;this.scene.run(t,{layout:{y:4,x:4,h:this.cameras.main.height-4,w:this.cameras.main.width-4}});let i=new Button(this,[Text.restart,Text.continue]);i.x=this.cameras.main.width-i.getBounds().width/2-4,i.y=this.cameras.main.height-i.getBounds().height/2-4,i.tint=52428,this.playButton=i;let r=this.add.text((this.cameras.main.width-i.width)/2,0,"",{font:14*this.game.resolution+"px Arial",align:"center"}).setOrigin(.5,.5);r.y=i.y,this.info=r,this.info.setColor("green"),EventDispatcher.getInstance().emit("GameStatus",{turn:"w",move:0}),this.scene.sendToBack()}}var Chess=function(e){var t="b",i="w",r=-1,n="p",s="n",a="b",o="r",l="q",h="k",u="pnbrqkPNBRQK",c="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",f=["1-0","0-1","1/2-1/2","*"],p={b:[16,32,17,15],w:[-16,-32,-17,-15]},d={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},g=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],m=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],v={p:0,n:1,b:2,r:3,q:4,k:5},y={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},b={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},w=7,E=6,x=1,T=0,S={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},A={w:[{square:S.a1,flag:b.QSIDE_CASTLE},{square:S.h1,flag:b.KSIDE_CASTLE}],b:[{square:S.a8,flag:b.QSIDE_CASTLE},{square:S.h8,flag:b.KSIDE_CASTLE}]},C=new Array(128),I={w:r,b:r},P=i,_={w:0,b:0},L=r,O=0,k=1,N=[],U={},R={};function D(e){void 0===e&&(e=!1),C=new Array(128),I={w:r,b:r},P=i,_={w:0,b:0},L=r,O=0,k=1,N=[],e||(U={}),R={},j(K())}function G(){for(var e=[],t={},i=function(e){e in R&&(t[e]=R[e])};N.length>0;)e.push(ne());for(i(K());e.length>0;)re(e.pop()),i(K());R=t}function q(){B(c)}function B(e,n){void 0===n&&(n=!1);var s=e.split(/\s+/),a=s[0],o=0;if(!M(e).valid)return!1;D(n);for(var l=0;l<a.length;l++){var h=a.charAt(l);if("/"===h)o+=8;else if(-1!=="0123456789".indexOf(h))o+=parseInt(h,10);else{var u=h<"a"?i:t;Y({type:h.toLowerCase(),color:u},le(o)),o++}}return P=s[1],s[2].indexOf("K")>-1&&(_.w|=b.KSIDE_CASTLE),s[2].indexOf("Q")>-1&&(_.w|=b.QSIDE_CASTLE),s[2].indexOf("k")>-1&&(_.b|=b.KSIDE_CASTLE),s[2].indexOf("q")>-1&&(_.b|=b.QSIDE_CASTLE),L="-"===s[3]?r:S[s[3]],O=parseInt(s[4],10),k=parseInt(s[5],10),j(K()),!0}function M(e){var t="No errors.",i="FEN string must contain six space-delimited fields.",r="6th field (move number) must be a positive integer.",n="5th field (half move counter) must be a non-negative integer.",s="4th field (en-passant square) is invalid.",a="3rd field (castling availability) is invalid.",o="2nd field (side to move) is invalid.",l="1st field (piece positions) does not contain 8 '/'-delimited rows.",h="1st field (piece positions) is invalid [consecutive numbers].",u="1st field (piece positions) is invalid [invalid piece].",c="1st field (piece positions) is invalid [row too large].",f="Illegal en-passant square",p=e.split(/\s+/);if(6!==p.length)return{valid:!1,error_number:1,error:i};if(isNaN(p[5])||parseInt(p[5],10)<=0)return{valid:!1,error_number:2,error:r};if(isNaN(p[4])||parseInt(p[4],10)<0)return{valid:!1,error_number:3,error:n};if(!/^(-|[abcdefgh][36])$/.test(p[3]))return{valid:!1,error_number:4,error:s};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(p[2]))return{valid:!1,error_number:5,error:a};if(!/^(w|b)$/.test(p[1]))return{valid:!1,error_number:6,error:o};var d=p[0].split("/");if(8!==d.length)return{valid:!1,error_number:7,error:l};for(var g=0;g<d.length;g++){for(var m=0,v=!1,y=0;y<d[g].length;y++)if(isNaN(d[g][y])){if(!/^[prnbqkPRNBQK]$/.test(d[g][y]))return{valid:!1,error_number:9,error:u};m+=1,v=!1}else{if(v)return{valid:!1,error_number:8,error:h};m+=parseInt(d[g][y],10),v=!0}if(8!==m)return{valid:!1,error_number:10,error:c}}return"3"==p[3][1]&&"w"==p[1]||"6"==p[3][1]&&"b"==p[1]?{valid:!1,error_number:11,error:f}:{valid:!0,error_number:0,error:t}}function K(){for(var e=0,n="",s=S.a8;s<=S.h1;s++){if(null==C[s])e++;else{e>0&&(n+=e,e=0);var a=C[s].color,o=C[s].type;n+=a===i?o.toUpperCase():o.toLowerCase()}s+1&136&&(e>0&&(n+=e),s!==S.h1&&(n+="/"),e=0,s+=8)}var l="";_[i]&b.KSIDE_CASTLE&&(l+="K"),_[i]&b.QSIDE_CASTLE&&(l+="Q"),_[t]&b.KSIDE_CASTLE&&(l+="k"),_[t]&b.QSIDE_CASTLE&&(l+="q"),l=l||"-";var h=L===r?"-":le(L);return[n,P,l,h,O,k].join(" ")}function Q(e){for(var t=0;t<e.length;t+=2)"string"==typeof e[t]&&"string"==typeof e[t+1]&&(U[e[t]]=e[t+1]);return U}function j(e){N.length>0||(e!==c?(U.SetUp="1",U.FEN=e):(delete U.SetUp,delete U.FEN))}function F(e){var t=C[S[e]];return t?{type:t.type,color:t.color}:null}function Y(e,t){if(!("type"in e&&"color"in e))return!1;if(-1===u.indexOf(e.type.toLowerCase()))return!1;if(!(t in S))return!1;var i=S[t];return(e.type!=h||I[e.color]==r||I[e.color]==i)&&(C[i]={type:e.type,color:e.color},e.type===h&&(I[e.color]=i),j(K()),!0)}function $(e,t,i,r,s){var a={color:P,from:t,to:i,flags:r,piece:e[t].type};return s&&(a.flags|=b.PROMOTION,a.promotion=s),e[i]?a.captured=e[i].type:r&b.EP_CAPTURE&&(a.captured=n),a}function W(e){function t(e,t,i,r,h){if(e[i].type!==n||ae(r)!==T&&ae(r)!==w)t.push($(e,i,r,h));else for(var u=[l,o,a,s],c=0,f=u.length;c<f;c++)t.push($(e,i,r,h,u[c]))}var i=[],r=P,h=he(r),u={b:x,w:E},c=S.a8,f=S.h1,g=!1,m=!(void 0!==e&&"legal"in e)||e.legal;if(void 0!==e&&"square"in e){if(!(e.square in S))return[];c=f=S[e.square],g=!0}for(var v=c;v<=f;v++)if(136&v)v+=7;else{var y=C[v];if(null!=y&&y.color===r)if(y.type===n){var A=v+p[r][0];if(null==C[A]){t(C,i,v,A,b.NORMAL);A=v+p[r][1];u[r]===ae(v)&&null==C[A]&&t(C,i,v,A,b.BIG_PAWN)}for(O=2;O<4;O++){136&(A=v+p[r][O])||(null!=C[A]&&C[A].color===h?t(C,i,v,A,b.CAPTURE):A===L&&t(C,i,v,L,b.EP_CAPTURE))}}else for(var O=0,k=d[y.type].length;O<k;O++){var N=d[y.type][O];for(A=v;!(136&(A+=N));){if(null!=C[A]){if(C[A].color===r)break;t(C,i,v,A,b.CAPTURE);break}if(t(C,i,v,A,b.NORMAL),"n"===y.type||"k"===y.type)break}}}if(!g||f===I[r]){if(_[r]&b.KSIDE_CASTLE){var U=(R=I[r])+2;null!=C[R+1]||null!=C[U]||H(h,I[r])||H(h,R+1)||H(h,U)||t(C,i,I[r],U,b.KSIDE_CASTLE)}if(_[r]&b.QSIDE_CASTLE){var R;U=(R=I[r])-2;null!=C[R-1]||null!=C[R-2]||null!=C[R-3]||H(h,I[r])||H(h,R-1)||H(h,U)||t(C,i,I[r],U,b.QSIDE_CASTLE)}}if(!m)return i;var D=[];for(v=0,k=i.length;v<k;v++)re(i[v]),V(r)||D.push(i[v]),ne();return D}function X(e,t){var i="";if(e.flags&b.KSIDE_CASTLE)i="O-O";else if(e.flags&b.QSIDE_CASTLE)i="O-O-O";else{var r=function(e,t){for(var i=W({legal:!t}),r=e.from,n=e.to,s=e.piece,a=0,o=0,l=0,h=0,u=i.length;h<u;h++){var c=i[h].from,f=i[h].to,p=i[h].piece;s===p&&r!==c&&n===f&&(a++,ae(r)===ae(c)&&o++,oe(r)===oe(c)&&l++)}if(a>0)return o>0&&l>0?le(r):l>0?le(r).charAt(1):le(r).charAt(0);return""}(e,t);e.piece!==n&&(i+=e.piece.toUpperCase()+r),e.flags&(b.CAPTURE|b.EP_CAPTURE)&&(e.piece===n&&(i+=le(e.from)[0]),i+="x"),i+=le(e.to),e.flags&b.PROMOTION&&(i+="="+e.promotion.toUpperCase())}return re(e),Z()&&(J()?i+="#":i+="+"),ne(),i}function z(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}function H(e,r){for(var s=S.a8;s<=S.h1;s++)if(136&s)s+=7;else if(null!=C[s]&&C[s].color===e){var a=C[s],o=s-r,l=o+119;if(g[l]&1<<v[a.type]){if(a.type===n){if(o>0){if(a.color===i)return!0}else if(a.color===t)return!0;continue}if("n"===a.type||"k"===a.type)return!0;for(var h=m[l],u=s+h,c=!1;u!==r;){if(null!=C[u]){c=!0;break}u+=h}if(!c)return!0}}return!1}function V(e){return H(he(e),I[e])}function Z(){return V(P)}function J(){return Z()&&0===W().length}function ee(){return!Z()&&0===W().length}function te(){for(var e={},t=[],i=0,r=0,n=S.a8;n<=S.h1;n++)if(r=(r+1)%2,136&n)n+=7;else{var o=C[n];o&&(e[o.type]=o.type in e?e[o.type]+1:1,o.type===a&&t.push(r),i++)}if(2===i)return!0;if(3===i&&(1===e[a]||1===e[s]))return!0;if(i===e[a]+2){var l=0,h=t.length;for(n=0;n<h;n++)l+=t[n];if(0===l||l===h)return!0}return!1}function ie(){for(var e=[],t={},i=!1;;){var r=ne();if(!r)break;e.push(r)}for(;;){var n=K().split(" ").slice(0,4).join(" ");if(t[n]=n in t?t[n]+1:1,t[n]>=3&&(i=!0),!e.length)break;re(e.pop())}return i}function re(e){var i=P,s=he(i);if(function(e){N.push({move:e,kings:{b:I.b,w:I.w},turn:P,castling:{b:_.b,w:_.w},ep_square:L,half_moves:O,move_number:k})}(e),C[e.to]=C[e.from],C[e.from]=null,e.flags&b.EP_CAPTURE&&(P===t?C[e.to-16]=null:C[e.to+16]=null),e.flags&b.PROMOTION&&(C[e.to]={type:e.promotion,color:i}),C[e.to].type===h){if(I[C[e.to].color]=e.to,e.flags&b.KSIDE_CASTLE){var a=e.to-1,o=e.to+1;C[a]=C[o],C[o]=null}else if(e.flags&b.QSIDE_CASTLE){a=e.to+1,o=e.to-2;C[a]=C[o],C[o]=null}_[i]=""}if(_[i])for(var l=0,u=A[i].length;l<u;l++)if(e.from===A[i][l].square&&_[i]&A[i][l].flag){_[i]^=A[i][l].flag;break}if(_[s])for(l=0,u=A[s].length;l<u;l++)if(e.to===A[s][l].square&&_[s]&A[s][l].flag){_[s]^=A[s][l].flag;break}L=e.flags&b.BIG_PAWN?"b"===P?e.to-16:e.to+16:r,e.piece===n?O=0:e.flags&(b.CAPTURE|b.EP_CAPTURE)?O=0:O++,P===t&&k++,P=he(P)}function ne(){var e=N.pop();if(null==e)return null;var i=e.move;I=e.kings,P=e.turn,_=e.castling,L=e.ep_square,O=e.half_moves,k=e.move_number;var r,s,a=P,o=he(P);if(C[i.from]=C[i.to],C[i.from].type=i.piece,C[i.to]=null,i.flags&b.CAPTURE)C[i.to]={type:i.captured,color:o};else if(i.flags&b.EP_CAPTURE){var l;l=a===t?i.to-16:i.to+16,C[l]={type:n,color:o}}i.flags&(b.KSIDE_CASTLE|b.QSIDE_CASTLE)&&(i.flags&b.KSIDE_CASTLE?(r=i.to+1,s=i.to-1):i.flags&b.QSIDE_CASTLE&&(r=i.to-2,s=i.to+1),C[r]=C[s],C[s]=null);return i}function se(e,t){var i=z(e);if(t){var r=i.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/);if(r)var n=r[1],s=r[2],a=r[3],o=r[4]}for(var l=W(),h=0,u=l.length;h<u;h++){if(i===z(X(l[h]))||t&&i===z(X(l[h],!0)))return l[h];if(r&&(!n||n.toLowerCase()==l[h].piece)&&S[s]==l[h].from&&S[a]==l[h].to&&(!o||o.toLowerCase()==l[h].promotion))return l[h]}return null}function ae(e){return e>>4}function oe(e){return 15&e}function le(e){var t=oe(e),i=ae(e);return"abcdefgh".substring(t,t+1)+"87654321".substring(i,i+1)}function he(e){return e===i?t:i}function ue(e){var t=function e(t){var i=t instanceof Array?[]:{};for(var r in t)i[r]="object"==typeof r?e(t[r]):t[r];return i}(e);t.san=X(t,!1),t.to=le(t.to),t.from=le(t.from);var i="";for(var r in b)b[r]&t.flags&&(i+=y[r]);return t.flags=i,t}function ce(e){return e.replace(/^\s+|\s+$/g,"")}return B(void 0===e?c:e),{WHITE:i,BLACK:t,PAWN:n,KNIGHT:s,BISHOP:a,ROOK:o,QUEEN:l,KING:h,SQUARES:function(){for(var e=[],t=S.a8;t<=S.h1;t++)136&t?t+=7:e.push(le(t));return e}(),FLAGS:y,load:function(e){return B(e)},reset:function(){return q()},moves:function(e){for(var t=W(e),i=[],r=0,n=t.length;r<n;r++)void 0!==e&&"verbose"in e&&e.verbose?i.push(ue(t[r])):i.push(X(t[r],!1));return i},in_check:function(){return Z()},in_checkmate:function(){return J()},in_stalemate:function(){return ee()},in_draw:function(){return O>=100||ee()||te()||ie()},insufficient_material:function(){return te()},in_threefold_repetition:function(){return ie()},game_over:function(){return O>=100||J()||ee()||te()||ie()},validate_fen:function(e){return M(e)},fen:function(){return K()},board:function(){for(var e=[],t=[],i=S.a8;i<=S.h1;i++)null==C[i]?t.push(null):t.push({type:C[i].type,color:C[i].color}),i+1&136&&(e.push(t),t=[],i+=8);return e},pgn:function(e){var t="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\n",i="object"==typeof e&&"number"==typeof e.max_width?e.max_width:0,r=[],n=!1;for(var s in U)r.push("["+s+' "'+U[s]+'"]'+t),n=!0;n&&N.length&&r.push(t);for(var a=function(e){var t=R[K()];void 0!==t&&(e=`${e}${e.length>0?" ":""}{${t}}`);return e},o=[];N.length>0;)o.push(ne());var l=[],h="";for(0===o.length&&l.push(a(""));o.length>0;){h=a(h);var u=o.pop();N.length||"b"!==u.color?"w"===u.color&&(h.length&&l.push(h),h=k+"."):h=k+". ...",h=h+" "+X(u,!1),re(u)}if(h.length&&l.push(a(h)),void 0!==U.Result&&l.push(U.Result),0===i)return r.join("")+l.join(" ");var c=function(){return r.length>0&&" "===r[r.length-1]&&(r.pop(),!0)},f=function(e,n){for(var s of n.split(" "))if(s){if(e+s.length>i){for(;c();)e--;r.push(t),e=0}r.push(s),e+=s.length,r.push(" "),e++}return c()&&e--,e},p=0;for(s=0;s<l.length;s++)p+l[s].length>i&&l[s].includes("{")?p=f(p,l[s]):(p+l[s].length>i&&0!==s?(" "===r[r.length-1]&&r.pop(),r.push(t),p=0):0!==s&&(r.push(" "),p++),r.push(l[s]),p+=l[s].length);return r.join("")},load_pgn:function(e,t){var i=void 0!==t&&"sloppy"in t&&t.sloppy;function r(e){return e.replace(/\\/g,"\\")}var n="object"==typeof t&&"string"==typeof t.newline_char?t.newline_char:"\r?\n",s=new RegExp("^(\\[((?:"+r(n)+")|.)*\\])(?:"+r(n)+"){2}"),a=s.test(e)?s.exec(e)[1]:"";q();var o=function(e,t){for(var i="object"==typeof t&&"string"==typeof t.newline_char?t.newline_char:"\r?\n",n={},s=e.split(new RegExp(r(i))),a="",o="",l=0;l<s.length;l++)a=s[l].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),o=s[l].replace(/^\[[A-Za-z]+\s"(.*)"\ *\]$/,"$1"),ce(a).length>0&&(n[a]=o);return n}(a,t);for(var l in o)Q([l,o[l]]);if("1"===o.SetUp&&!("FEN"in o&&B(o.FEN,!0)))return!1;for(var h=function(e){return`{${function(e){return Array.from(e).map(function(e){return e.charCodeAt(0)<128?e.charCodeAt(0).toString(16):encodeURIComponent(e).replace(/\%/g,"").toLowerCase()}).join("")}((e=e.replace(new RegExp(r(n),"g")," ")).slice(1,e.length-1))}}`},u=function(e){if(e.startsWith("{")&&e.endsWith("}"))return function(e){return 0==e.length?"":decodeURIComponent("%"+e.match(/.{1,2}/g).join("%"))}(e.slice(1,e.length-1))},c=e.replace(a,"").replace(new RegExp(`({[^}]*})+?|;([^${r(n)}]*)`,"g"),function(e,t,i){return void 0!==t?h(t):" "+h(`{${i.slice(1)}}`)}).replace(new RegExp(r(n),"g")," "),p=/(\([^\(\)]+\))+?/g;p.test(c);)c=c.replace(p,"");var d=ce(c=(c=(c=c.replace(/\d+\.(\.\.)?/g,"")).replace(/\.\.\./g,"")).replace(/\$\d+/g,"")).split(new RegExp(/\s+/));d=d.join(",").replace(/,,+/g,",").split(",");for(var g="",m=0;m<d.length-1;m++){var v=u(d[m]);if(void 0===v){if(null==(g=se(d[m],i)))return!1;re(g)}else R[K()]=v}if(void 0!==(v=u(d[d.length-1]))&&(R[K()]=v,d.pop()),g=d[d.length-1],f.indexOf(g)>-1)(function(e){for(var t in e)return!0;return!1})(U)&&void 0===U.Result&&Q(["Result",g]);else{if(null==(g=se(g,i)))return!1;re(g)}return!0},header:function(){return Q(arguments)},ascii:function(){return function(){for(var e="   +------------------------+\n",t=S.a8;t<=S.h1;t++){if(0===oe(t)&&(e+=" "+"87654321"[ae(t)]+" |"),null==C[t])e+=" . ";else{var r=C[t].type;e+=" "+(C[t].color===i?r.toUpperCase():r.toLowerCase())+" "}t+1&136&&(e+="|\n",t+=8)}return e+="   +------------------------+\n",e+="     a  b  c  d  e  f  g  h\n"}()},turn:function(){return P},move:function(e,t){var i=void 0!==t&&"sloppy"in t&&t.sloppy,r=null;if("string"==typeof e)r=se(e,i);else if("object"==typeof e)for(var n=W(),s=0,a=n.length;s<a;s++)if(!(e.from!==le(n[s].from)||e.to!==le(n[s].to)||"promotion"in n[s]&&e.promotion!==n[s].promotion)){r=n[s];break}if(!r)return null;var o=ue(r);return re(r),o},undo:function(){var e=ne();return e?ue(e):null},clear:function(){return D()},put:function(e,t){return Y(e,t)},get:function(e){return F(e)},remove:function(e){return function(e){var t=F(e);return C[S[e]]=null,t&&t.type===h&&(I[t.color]=r),j(K()),t}(e)},perft:function(e){return function e(t){for(var i=W({legal:!1}),r=0,n=P,s=0,a=i.length;s<a;s++)re(i[s]),V(n)||(t-1>0?r+=e(t-1):r++),ne();return r}(e)},square_color:function(e){if(e in S){var t=S[e];return(ae(t)+oe(t))%2==0?"light":"dark"}return null},history:function(e){for(var t=[],i=[],r=(void 0!==e&&"verbose"in e&&e.verbose);N.length>0;)t.push(ne());for(;t.length>0;){var n=t.pop();r?i.push(ue(n)):i.push(X(n)),re(n)}return i},get_comment:function(){return R[K()]},set_comment:function(e){R[K()]=e.replace("{","[").replace("}","]")},delete_comment:function(){var e=R[K()];return delete R[K()],e},get_comments:function(){return G(),Object.keys(R).map(function(e){return{fen:e,comment:R[e]}})},delete_comments:function(){return G(),Object.keys(R).map(function(e){var t=R[e];return delete R[e],{fen:e,comment:t}})}}};"undefined"!=typeof exports&&(exports.Chess=Chess),"undefined"!=typeof define&&define(function(){return Chess});class MainGame extends Phaser.Game{constructor(e,t,i){let r=!1;window.innerWidth>=1200&&window.innerHeight>=800&&(r=!0);let n=e.offsetWidth,s=e.offsetHeight,a=window.devicePixelRatio>=2?2:window.devicePixelRatio>=1.5?1.5:1;super({key:e.id,type:Phaser.AUTO,parent:e,width:n,height:s,backgroundColor:"#fefefe",audio:{noAudio:!0},physics:{arcade:{debug:!1,fps:60}},render:{},scale:{zoom:1/a,mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},input:{touch:{capture:!1},gamepad:!0},disableContextMenu:!0,scene:[new LoaderScene(t)]});let o=document.getElementsByTagName("html")[0].getAttribute("lang");o&&Text.setLang(o),-1!==window.location.href.indexOf("localhost:8383")?(this.registry.set("debug",!0),this.registry.set("path","./")):(this.registry.set("release",!0),this.registry.set("path","/"+Text.id+"/")),this.registry.set("gameid",i)}clear(e){window.localStorage.removeItem(this.registry.get("gameid")+e)}save(e,t){window.localStorage.setItem(this.registry.get("gameid")+e,t)}restore(e){return window.localStorage.getItem(this.registry.get("gameid")+e)}}const LEVEL="";function createGame(){var e=new URL(window.location).searchParams.get("id")||"";window.game=new MainGame(document.getElementById("canvas"),["100-01","100-02","100-03","100-04","100-05","100-06","100-07","100-08","100-09","100-10","100-11","100-12","700-01","700-02","700-03","700-04","700-05","700-06","gratz"],Text.id+e)}function setGameConfig(e,t,i){}