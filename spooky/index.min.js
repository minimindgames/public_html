/*! Copyright spooky 02-01-2023 */

class EventDispatcher extends Phaser.Events.EventEmitter{constructor(){super()}static getInstance(){return null===EventDispatcher.instance&&(EventDispatcher.instance=new EventDispatcher),EventDispatcher.instance}}EventDispatcher.instance=null;class GameScene extends Phaser.Scene{constructor(e){super({key:e}),this.teleports=[[0,1],[1,2],[2,3],[3,4],[4,5],[5,0]],this.random=Date.now()}init(){this.firstGameToday=!1,parseInt(0|this.game.restore("lastPlayTime"))+43200<(Date.now()/1e3|0)&&(this.firstGameToday=!0)}preload(){this.load.path=this.registry.get("path");this.scene.get("LoaderScene")}create(){this.debugInfo=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY/2,"",{font:16*this.game.resolution+"px Arial",fill:"#ffffff"}).setOrigin(.5),EventDispatcher.getInstance().on("GameStatus",this.gameStatus.bind(this)),this.startLevel(),this.level.end||this.startGame()}startGame(){let e=this.registry.get("level");this.level=e,e.players&&this.startUIScene()}startLevel(){let e=this.registry.get("level");this.level=e,e.end}startUIScene(){let e=this.scene.get("UIScene");e=this.scene.add("UIScene",new UIScene("UIScene"));this.scene.run(e,{sceneCreated:this.uiSceneCreated.bind(this),layout:{y:0,x:0,h:this.cameras.main.height-0,w:this.cameras.main.width-0}}),this.uiScene=e}startScene(e,t){let s=this.scene.get(e);s?(this.scene.run(s,t),this.unitScene=s):this.time.delayedCall(100,function(){this.startScene(e,t)},[],this)}getUnitScene(e,t){return"tech"===t?(this.techScene=new TechScene(e,this.uiScene),this.techScene):"tictactoe"===t?new TictactoeUnitScene(e,this.uiScene):new UnitScene(e,this.uiScene)}uiSceneCreated(){this.level.teleport=this.teleport;let e=this.level,t="UnitScene-"+e.id,s=this.scene.get(t);s?(s.scene.wake(),this.uiScene.setUnitSceneLevel(s,this.level),this.uiScene.setPlayer(e.data.players[0]),this.unitScene=s):(s=this.scene.add(t,this.getUnitScene(t,e.name)),e.sceneCreated=this.sceneCreated.bind(this),this.startScene(t,e)),this.unitScene===this.techScene&&this.techScene.updateItems()}sceneCreated(e){this.level.teleport=this.teleport,this.uiScene.setUnitSceneLevel(e,this.level),this.unitScene.levelFactory||(this.unitScene.levelFactory=new LevelFactory(this.uiScene,this.unitScene,this.level,this.teleports))}gameStatus(e){if(e.shutdown&&(this.scene.wake(),this.cameras.main.fadeOut(150,255,255,255,function(e,t){1===t&&this.cameras.main.fadeIn(1e3,255,255,255,function(e,t){})},this),this.scene.manager.scenes.forEach(function(e){e instanceof LoaderScene||e instanceof GameScene||e.gameOver&&e.gameOver()}),this.time.delayedCall(3e3,function(){this.scene.manager.scenes.forEach(function(e){e instanceof LoaderScene||e instanceof GameScene||e.destroyed&&e.destroyed()}),this.time.delayedCall(100,function(){EventDispatcher.getInstance().emit("GameStatus",{gameover:!0})},[],this)},[],this)),e.start&&this.scene.setVisible(!1),e.minigameComplete&&(this.startLevel(),this.uiSceneCreated(),this.uiScene.player.bot.minigameStop()),e.teleportComplete&&(this.startLevel(),this.uiSceneCreated(),this.uiScene.player.bot.travelStop()),e.minigame&&(this.teleport=null),e.tech){if(e.close)return this.startLevel(),this.uiSceneCreated(),void this.uiScene.player.bot.techStop(e);this.techLevel||(this.techLevel={name:"tech",minigame:!0,id:1e3,grid:{size:1,x:0,y:0,w:0,h:0},units:[],players:[{bot:[{position:-1}]},{}]}),this.techLevel.type=e.type,this.techLevel.state=e,this.level=this.techLevel,this.uiSceneCreated()}e.teleport&&(this.teleport=e.from.teleport),e.gameover}handleLoseFocus(){console.log("handleLoseFocus")}}class LoaderScene extends Phaser.Scene{constructor(e){super({key:"LoaderScene",visible:!1}),this.loadProgress=0,this.levelList=e,this.minigame=!1,this.minigameLevelNo=-1}init(){}preload(){this.load.path=this.registry.get("path"),this.game.getImage=this.getImage,this.game.config.width>=2560&&this.game.config.height>=1440?(this.res="",this.game.resolution=4):this.game.config.width>=1920&&this.game.config.height>=1080?(this.res="-L",this.game.resolution=3):this.game.config.width>=1280&&this.game.config.height>=720?(this.res="-M",this.game.resolution=2):(this.res="-S",this.game.resolution=1),this.game.resolutionSquared=this.game.resolution*this.game.resolution,this.game.res=this.res,this.levelNo=parseInt(this.game.restore("levelNo")||0),this.getLevelNo(LEVEL),this.levelNo=1,this.load.json("json/"+this.levelList[this.levelNo])}getLevelNo(e){for(let t=0;t<this.levelList.length;t++)if(this.levelList[t]===e){this.levelNo=t;break}}gameStatus(e){e.gameover&&this.restartLevel(1e3,!0),e.teleport&&(this.levelNo=e.from.teleport.to,this.restartLevel(e.teleport.time,!1)),e.tech,e.minigame&&(this.minigame=!0,e.level?(this.minigameLevelNo=this.levelNo,this.getLevelNo(e.level),this.restartLevel(e.minigame.time,!1)):(this.levelNo=this.minigameLevelNo,this.minigameLevelNo=-1,this.restartLevel(e.minigame.time,!1)))}create(){this.debugInfo=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY/2,"",{font:16*this.game.resolution+"px Arial",fill:"#ffff00"}).setOrigin(.5);let e=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,Text.loading,{font:16*this.game.resolution+"px Arial",fill:"#000000"}).setOrigin(.5);this.load.on("loadProgress",function(t){e.text=Text.loading+" "+parseInt(100*t)+" %"},this),EventDispatcher.getInstance().on("GameStatus",this.gameStatus.bind(this)),this.startLevel()}loadLevel(){this.levelList&&this.levelNo>=this.levelList.length||(this.registry.set("level",null),this.load.json("json/"+this.levelList[this.levelNo]),this.load.start())}restartLevel(e,t){if(t){let e=EventDispatcher.getInstance();e.shutdown(),e.on("GameStatus",this.gameStatus.bind(this))}this.scene.setVisible(!0),this.scene.bringToTop(),this.cameras.main.alpha=1,this.cameras.main.once("camerafadeoutcomplete",()=>{t&&this.scene.manager.scenes.forEach(function(e){e!==this&&this.scene.remove(e)},this),this.time.delayedCall(100,function(){this.startLevel()},[],this)}),this.cameras.main.fadeOut(e,255,255,255)}startLevel(){let e=this.cache.json.get("json/"+this.levelList[this.levelNo]);if(!e)return this.load.once("complete",function(){this.startLevel()},this),this.load.json("json/"+this.levelList[this.levelNo]),void this.load.start();this.registry.set("level",e),this.scene.setVisible(!1),this.scene.get("GameScene")?this.minigame?(this.minigame=!1,EventDispatcher.getInstance().emit("GameStatus",{minigameComplete:!0})):EventDispatcher.getInstance().emit("GameStatus",{teleportComplete:!0}):this.scene.add("GameScene",new GameScene("GameScene"),!0)}getImage(e,t,s,i){return this.cache.json.get("sprites").frames[i+".png"]?new Phaser.GameObjects.Image(e,t,s,"sprites-doodd",i):new Phaser.GameObjects.Image(e,t,s,i)}loadBitmap2(e,t){this.bitmaps={frames:[]},t.forEach(function(t){e===this||this.sprites.frames[t+".png"]||e.load.bitmapFont(t,"img/"+t+this.res+".png","img/"+t+this.res+".xml")},this)}loadImages(e,t,s="png"){this.sprites={frames:[]},t.forEach(function(t){if(e!==this&&!this.sprites.frames[t+"."+s]){let i="";this.registry.get("debug")&&(i="?t="+Date.now()),e.load.image(t,"img/"+t+this.res+"."+s+i)}},this)}loadSpritesheets(e,t){t.forEach(function(t){let s=t.width?t.width:t.size,i=t.height?t.height:t.size,a="";this.registry.get("debug")&&(a="?t="+Date.now());let n=t.sub?t.sub:"";e.load.spritesheet(t.name,"img/"+t.name+n+this.res+".png"+a,{frameWidth:s*this.game.resolution,frameHeight:i*this.game.resolution})},this)}}var Text={id:"spooky",gameName:"spooky",loading:"Loading",next:"NEXT",play:"PLAY",quit:"QUIT",pause:"PAUSE",resume:"RESUME",restart:"TRY\nAGAIN",gameOverCongratulations:"All levels passed.\n\nCongratulations!",win:"YOU WIN",wait:"Wait for computer,\nmay take a minute.",setLang(e){"fi"===e&&(this.gameName="NANOBOT LIFE",this.loading="Ladataan",this.next="JATKA",this.play="PELAA",this.quit="POISTU",this.pause="PAUSE",this.resume="RESUME",this.restart="ALOITA\nALUSTA",this.gameOverCongratulations="Kaikki tasot selvitetty.\n\nOnnittelut!",this.draw="TASAN",this.win="VOITIT",this.wait="Odota tietokonetta,\nvoi kestää minuutin.")}};