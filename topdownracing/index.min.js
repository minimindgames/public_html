/*! Copyright topdownracing 26-01-2021 */

class Achievement{constructor(t){this.scene=t,this.game=this.scene.game;this.goalVal=0|this.game.restore("goal-val"),this.drivingVal=0|this.game.restore("driving-val"),this.currentGoal=null,this.currentDriving=null;let e=this.scene.starIcon=this.scene.createIcon(1,"star-icon","left");e.setInteractive().on("pointerup",function(){},this),e.label.text=0|this.game.restore("coins-collected"),(e=this.scene.goalIcon=this.scene.createIcon(0,"goal-icon",e)).setInteractive().on("pointerup",function(){},this),e.label.text=0|this.game.restore("total-wins"),e.info.text="CHAMPIONSHIP",(e=this.scene.winsInRow=this.scene.createIcon(2,"wins-in-row",e)).setInteractive().on("pointerup",function(){},this),e.label.text=0|this.game.restore("wins-in-row"),this.scene.winsInRow.label.visible=!1,e.info.text="AWARDS",this.update()}addAchievement(t,e,i,s){let a=null;for(let n=0;n<e.length;n++){let r=e[n];if(0===i&&s.achievement&&(s.achievement.text=r.achievement,s.challenge.text=r.challenge,i=-1,a=r),t&&1e3!==r.val){let e=document.createElement("tr"),s=document.createElement("td"),a=document.createElement("img");a.src=i>0?"/topdownracing/img/res-hi/check.png":"/topdownracing/img/res-hi/nocheck.png",a.alt="status",a.id="ach-"+r.category+"-"+r.val,s.appendChild(a),e.appendChild(s);let h=document.createElement("td");h.appendChild(document.createTextNode(r.achievement)),e.appendChild(h);let n=document.createElement("td");n.appendChild(document.createTextNode(r.challenge)),e.appendChild(n),t.appendChild(e)}else if(i>0)for(var h=this.table.getElementsByTagName("tr").length-1;h>0;h--);i===r.val&&(i=0)}return null===a&&s.achievement&&(s.achievement.text="All completed!"),a}update(t){let e=!1;t&&0===t.id&&(e=!0),this.table?(this.evalGoal(null,e),this.evalDriving(null,e)):(this.table=document.getElementById("game-achievements"),this.evalGoal(this.table,e),this.evalDriving(this.table,e))}evalGoal(t,e){let i=!1,s=-1;if(null!==this.currentGoal&&(s=this.currentGoal.val),s>=1&&parseInt(this.scene.goalIcon.label.text)>=s&&(i=!0),i){let t="ach-"+this.currentGoal.category+"-"+s;if(document.getElementById(t).src="/topdownracing/img/res-hi/check.png",this.game.save("goal-val",s),this.goalVal=s,this.currentGoal.val<=100){let t=this.currentGoal.val;t<10&&(t=10);let e=""+(parseInt(this.scene.starIcon.label.text)+t);this.scene.starIcon.label.text=e,this.game.save("coins-collected",e)}}if(this.currentGoal=this.addAchievement(t,[{category:1,achievement:"Born to win",challenge:"Win your first race",val:1},{category:1,achievement:"Sunday driver",challenge:"Win 5 races",val:5},{category:1,achievement:"Club racer",challenge:"Win 10 races",val:10},{category:1,achievement:"City champion",challenge:"Win 25 races",val:25},{category:1,achievement:"Grand champion",challenge:"Win 50 races",val:50},{category:1,achievement:"World champion",challenge:"Win 100 races",val:100},{category:1,achievement:"All completed!",challenge:"",val:1e3}],this.goalVal,this.scene.goalIcon),this.currentGoal&&this.currentGoal.val<=100){let t=this.currentGoal.val;t<10&&(t=10),this.scene.goalIcon.reward.text="Reward +"+t}}evalDriving(t,e){let i=!1,s=-1;if(null!==this.currentDriving&&(s=this.currentDriving.val),1===s&&(e||(i=!0)),2===s&&this.scene.coneHit>0&&(i=!0),3===s&&e&&this.scene.coneHit>0&&(i=!0),4===s&&e&&this.scene.carHit.length>0&&(i=!0),5===s&&this.scene.carHit.length>=3&&(i=!0),6===s&&e&&this.scene.carHit.length>=3&&(i=!0),7===s&&this.scene.carHit.length>0&&(i=!0),8===s&&e&&this.scene.bulletHitCount>0&&(i=!0),9===s&&this.scene.bulletHitCount>0&&(i=!0),10===s&&(i=!0),11===s&&(i=!0),12===s&&e&&(i=!0),(13===s||14===s||15===s)&&e){let t;13===s&&(t=3),14===s&&(t=2),15===s&&(t=1);for(let e=0;e<this.scene.carHit.length;e++)if(this.scene.carHit[e].id===t){i=!0;break}}if(16===s&&this.scene.bulletHitCount>1&&(i=!0),17===s&&0===this.scene.carHit.length&&0===this.scene.bulletHitCount&&0===this.scene.coneHit&&(i=!0),20===s&&e&&(i=!0),31===s&&parseInt(this.scene.starIcon.label.text)>=1&&(i=!0),33===s&&this.scene.starHit>=2&&(i=!0),34===s&&parseInt(this.scene.starIcon.label.text)>=10&&(i=!0),35===s&&e&&this.scene.starHit>=2&&(i=!0),36===s&&parseInt(this.scene.starIcon.label.text)>=50&&(i=!0),37===s&&this.scene.starHit>=3&&(i=!0),38===s&&e&&this.scene.starHit>=3&&(i=!0),39===s&&parseInt(this.scene.starIcon.label.text)>=100&&(i=!0),40===s&&e&&this.scene.starHit>=1&&(i=!0),41===s&&parseInt(this.scene.starIcon.label.text)>=25&&(i=!0),42===s&&parseInt(this.scene.starIcon.label.text)>=3&&(i=!0),43===s&&parseInt(this.scene.starIcon.label.text)>=7&&(i=!0),50===s&&e&&this.scene.starHit>=4&&(i=!0),99===s&&null!==this.currentDriving&&1e3===this.currentDriving.val&&null!==this.currentGoal&&1e3===this.currentGoal.val&&(i=!0),100===s&&(i=!0),i){let t="ach-"+this.currentDriving.category+"-"+s;if(document.getElementById(t).src="/topdownracing/img/res-hi/check.png",this.game.save("driving-val",s),this.drivingVal=s,this.currentDriving.val<=100){let t=""+(parseInt(this.scene.starIcon.label.text)+10);this.scene.starIcon.label.text=t,this.game.save("coins-collected",t)}}this.currentDriving=this.addAchievement(t,[{category:3,achievement:"My first award",challenge:"Start a race",val:10},{category:3,achievement:"Driver's license",challenge:"Turn left/right",val:11},{category:3,achievement:"A rising star",challenge:"Win a race",val:20},{category:2,achievement:"I'm rich!",challenge:"Collect a coin",val:31},{category:3,achievement:"Bad driver",challenge:"Collide with a cone",val:2},{category:3,achievement:"Destructor",challenge:"Crash into another car",val:7},{category:2,achievement:"Binary cash",challenge:"Get 2 coins in a race",val:33},{category:3,achievement:"Kick ass",challenge:"Crash a car and win",val:4},{category:3,achievement:"Good driver",challenge:"Hit a cone and win",val:3},{category:2,achievement:"Double winner",challenge:"Get 2 coins and win",val:35},{category:3,achievement:"Eat more greens",challenge:"Crash Tank and win",val:13},{category:3,achievement:"Yellow sub",challenge:"Crash yellow and win",val:14},{category:3,achievement:"Feeling blue",challenge:"Crash blue and win",val:15},{category:2,achievement:"A hat trick",challenge:"Get 3 coins in race",val:37},{category:3,achievement:"Play chicken",challenge:"Win without collision",val:17},{category:3,achievement:"Be a bully",challenge:"Crash into all cars",val:5},{category:2,achievement:"Triple winner",challenge:"Get 3 coins and win",val:38},{category:3,achievement:"Street king",challenge:"Crash all cars and win",val:6},{category:3,achievement:"Quad drive",challenge:"Get 4 coins in race",val:50},{category:3,achievement:"Under fire",challenge:"Get fired by Tank",val:9},{category:3,achievement:"Learn to lose",challenge:"Lose a race",val:1},{category:3,achievement:"Never give up",challenge:"Win after losing",val:12},{category:3,achievement:"In line of fire",challenge:"Get fired and win",val:8},{category:3,achievement:"Hurt me plenty",challenge:"Get fired by tank twice",val:16},{category:3,achievement:"Greedy",challenge:"Get 100 coins",val:39},{category:3,achievement:"No more awards",challenge:"Achieve everything else",val:99},{category:3,achievement:"Overachiever",challenge:"All achievements then one",val:100},{category:3,achievement:"All completed!",challenge:"",val:1e3}],this.drivingVal,this.scene.winsInRow),this.currentDriving&&this.currentDriving.val<=100&&(this.scene.winsInRow.reward.text="Reward +10")}}class AI{constructor(t){this.players=t,this.reset()}reset(){this.player=0,this.board=[],this.wins=[],this.forks=[],this.centers=[],this.corners=[],this.edges=[],this.win=[],this.fork=[],this.center=[],this.corner=[],this.edge=[]}setPlayer(t){this.player=t}fuzzify(){this.players.each(function(t){this.wins[t]=this.findWins(t),this.forks[t]=this.findForks(t),this.center[t]=this.findCenter(t),this.corners[t]=this.findCorners(t),this.edges[t]=this.findEdges(t)},this)}decide(){this.players.each(function(t){this.win[t]=Phaser.Utils.Array.GetRandom(this.wins[t]),this.fork[t]=Phaser.Utils.Array.GetRandom(this.forks[t]),this.center[t]=Phaser.Utils.Array.GetRandom(this.center[t]),this.corner[t]=Phaser.Utils.Array.GetRandom(this.corners[t]),this.edge[t]=Phaser.Utils.Array.GetRandom(this.edges[t])},this)}action(){this.players.each(function(t){this.win[t]||this.fork[t]||this.center[t]||this.corner[t]||this.edge[t]},this)}findWins(t){let e=[];var i=this.board;let s=0,a=0,h=0,n=0;for(let r=0;r<3;r++){let l=0,o=-1,c=0,d=-1;for(let e=0;e<3;e++)i[r][e]===t?l++:o=-1===i[r][e]?e:-1,i[e][r]===t?c++:d=-1===i[r][e]?e:-1;2===l&&-1!==o&&e.push({x:o,y:r}),2===c&&-1!==d&&e.push({x:r,y:d}),i[r][r]===t?s++:a=-1===i[r][r]?r:-1,i[2-r][r]===t?h++:n=-1===i[r][r]?r:-1}return 2===s&&-1!==a&&e.push({x:a,y:a}),2===h&&-1!==n&&e.push({x:n,y:2-n}),e}findForks(t){let e=[];return e.push({x:1,y:1}),e}findCenter(t){let e=[];return e.push({x:1,y:1}),e}findCorners(t){let e=[];return e.push({x:1,y:1}),e}findEdges(t){let e=[];return e.push({x:1,y:1}),e}}var BULLET_LOADING=100;class Bullet extends Phaser.Physics.Arcade.Sprite{constructor(t,e,i){super(t,e,i,"bullet")}fire(t){this.body.reset(t.x,t.y),this.scene.physics.velocityFromRotation(t.rotation-Math.PI/2,t.body.speed+100*this.scene.resmult,this.body.velocity),this.setActive(!0),this.setVisible(!0),this.timeToLive=1e3,this.body.setAllowDrag(!1),this.body.setAllowRotation(!1),this.body.setAllowGravity(!1)}preUpdate(t,e){super.preUpdate(t,e),this.timeToLive-=e,this.timeToLive<=0&&(this.setActive(!1),this.setVisible(!1))}}class Bullets extends Phaser.Physics.Arcade.Group{constructor(t){super(t.physics.world,t),this.createMultiple({frameQuantity:1,key:"bullet",active:!1,visible:!1,classType:Bullet})}fireBullet(t){let e=this.getFirstDead(!1);e&&e.fire(t)}}class Button extends Phaser.GameObjects.Container{constructor(t,e,i,s,a,h){super(t),this.scene.add.existing(this);let n=this.scene.add.image(this.x,this.y,"ui-button");n.setInteractive().on("pointerover",()=>this.pointerover()).on("pointerout",()=>this.pointerout()).on("pointerdown",()=>this.pointerdown()).on("pointerup",()=>this.pointerup()),n.setOrigin(.5),this.add(n),n.isButton=!0;let r=20*t.resmult|0,l=this.scene.add.text(this.x,this.y,e,{fontFamily:"Source Code Pro",fontSize:r,color:"#fff",align:"center"});if(l.setShadow(2,2,"#000",2),l.setOrigin(.5),this.add(l),h){r=14*t.resmult|0;let e=this.scene.add.text(this.x,this.y,h,{fontFamily:"Source Code Pro",fontSize:r,color:"#fff",align:"center"});e.setShadow(2,2,"#000",2),e.setOrigin(.5),this.add(e),e.y+=l.height/2,l.y-=e.height/2}this.tint=i,this.gameEvent=s,this.event=a}set tint(t){this.getAt(0).setTint(t)}get tint(){return this.getAt(0).getTint()}get text(){return this.getAt(1)?this.getAt(1).text:null}set text(t){this.getAt(1).text=t}get subtitle(){return this.getAt(2).text}set subtitle(t){this.getAt(2).text=t}pointerover(){this.getAt(0).setTexture("ui-button-active")}pointerout(){this.getAt(0).setTexture("ui-button")}pointerdown(){return!1}pointerup(){let t=Date.now();if(!(this.lastTime+100>t))return this.lastTime=t,this.event?this.gameEvent.emit(this.event,this.text):this.gameEvent&&this.gameEvent.emit(this.text),!1}get width(){return this.getBounds().width}get height(){return this.getBounds().height}}var FlyingStar=new Phaser.Class({Extends:Phaser.Physics.Arcade.Sprite,initialize:function(t,e,i,s,a,h,n,r){Phaser.Physics.Arcade.Sprite.call(this,t,e,i,"star"),r?this.spin=.025:(this.spin=0,this.path=new Phaser.Curves.Ellipse(e,i,s,a),this.pathIndex=n,this.pathSpeed=h,this.pathVector=new Phaser.Math.Vector2,this.path.getPoint(0,this.pathVector),this.setPosition(this.pathVector.x,this.pathVector.y))},preUpdate:function(t,e){0===this.spin?(this.anims.update(t,e),this.path.getPoint(this.pathIndex,this.pathVector),this.setPosition(this.pathVector.x,this.pathVector.y),this.pathIndex=Phaser.Math.Wrap(this.pathIndex+this.pathSpeed,0,1)):this.spin>=0?(this.scaleX-=this.spin,this.scaleX<=0&&(this.spin=-this.spin)):(this.scaleX-=this.spin,this.scaleX>=1&&(this.spin=-this.spin))}});class GameEvent extends Phaser.Events.EventEmitter{constructor(){super()}static get play(){return"play"}static get gameOver(){return"gameOver"}static get nextLevel(){return"nextLevel"}static get skill(){return"skill"}}class GameOverScene extends Phaser.Scene{constructor(t){super({key:t})}init(){}preload(){["ui-button","ui-button-active"].forEach(function(t){this.load.image(t,"img/"+t+".png")},this)}create(){let t=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,Text.ticTacToeMaster,{fontFamily:"Source Code Pro",fontSize:28,color:"#000000",fill:"#080",align:"center"}).setShadow(2,2,"rgba(255,255,255,1)",3).setOrigin(.5,2),e=(this.add.text(t.x,t.y,Text.allLevelsPassedRestartGame,{fontFamily:"Source Code Pro",fontSize:22,color:"#000000",align:"center",wordWrap:{width:this.cameras.main.width-40}}).setShadow(2,2,"rgba(255,255,255,1)",3).setOrigin(.5),new Button(this,Text.restart,39168,this.events));e.x=this.cameras.main.centerX-e.width,e.y=this.cameras.main.height-e.getBounds().height/2-10,this.events.on(Text.restart,function(){this.input.enabled=!1,this.game.events.emit(Text.restart)},this),this.scene.sendToBack()}}class GameScene extends Phaser.Scene{constructor(t,e){super({key:t}),this.gameEvent=e,this.debugSpline=!1,this.level=null,this.gridContainer=null,this.tictactoe=null,this.objectLayer=null,this.objectLayerNext=null,this.groundLayer=null,this.groundLayerNext=null,this.cones=null,this.conesNext=null,this.stars=null,this.starsNext=null,this.ongoalState=!1,this.carsButtonTween=null}init(){this.levelNo=parseInt(this.game.restore("levelNo")||1),this.level=this.registry.get("level")}preload(){this.load.path=this.registry.get("path");let t,e;this.game.config.width>=1200?(t="res-hi",e=2,this.resmult=e):this.game.config.width>=900?(t="res-mid",e=1.5,this.resmult=e):(t="res-lo",e=1,this.resmult=e),this.game&&["cone","star","ui-button","ui-button-active","bullet"].forEach(function(e){this.load.image(e,"img/"+t+"/"+e+".png?v=31")},this),this.load.spritesheet("cars","img/"+t+"/cars.png?v=31",{frameWidth:10*e,frameHeight:12*e}),this.load.image("tiles","img/"+t+"/tileset.png?v=31"),this.load.spritesheet("icons","img/"+t+"/icons.png?v=31",{frameWidth:200*e,frameHeight:40*e})}create(t){this.cameras.main.roundPixels=!0,this.gameEvent.on(GameEvent.play,function(t){"MY CARS"===t&&(null!==this.carsButtonTween&&(this.carsButtonTween.remove(),this.carsButtonTween=null),parseInt(this.starIcon.label.text)>=42?(this.carsButton.text="SPIN",this.carsButton.subtitle="Get a new car!"):(this.carsButton.text="RACE",this.carsButton.subtitle="Start a race")),"RACE"===t&&(this.carsButton.text="MY CARS",this.carsButton.subtitle="Collect all cars",this.carsButton.visible=!1,this.startLabel.visible=!0)},this),this.cars=this.physics.add.group(),this.cars.name="carsGroup";for(var e=0;e<4;e++)this.cars.add(new Car(this,e));this.player=this.cars.getChildren()[0];let i=this.game.restore("cars");i||(i=[6]),this.setCar(i[0]);let s=this.input.keyboard.createCursorKeys();this.input.keyboard.on("keydown-SPACE",function(){this.openUI()},this),this.cursors=s,this.gamepad=null,this.input.gamepad.once("connected",function(t){this.gamepad=t,this.gamepad.on(Phaser.Input.Gamepad.Events.BUTTON_DOWN,function(t){this.gamepad.left||this.gamepad.right||this.openUI()},this)},this),this.achievements=new Achievement(this),this.nextRace(!0),this.bullets=new Bullets(this).setDepth(5),this.startRace(0)}bulletHit(t,e){3!==e.id&&(e.hitFactor>0||!t.active||(0===e.id&&this.bulletHitCount++,e.hitFactor=1e3,this.tweens.add({targets:e,ease:Phaser.Math.Easing.Sine,duration:150,rotation:e.rotation+2*Math.PI+Phaser.Math.FloatBetween(-Math.PI/4,Math.PI/4),callbackScope:this,onComplete:function(t){e.hitFactor=0}}),t.setActive(!1),t.setVisible(!1),this.cars.getChildren()[3].loading=BULLET_LOADING))}createIcon(t,e,i){let s=this.add.image(0,0,"icons").setDepth(10);s.scrollFactorX=0,s.setFrame(t),s.name=e;let a=s.width;if("left"===i){s.x=s.width/2,s.y=s.height/2;let t=24*this.resmult|0,e=24*this.resmult|0,i=this.add.text(s.x+0*this.resmult|0,s.y,"",{fontFamily:"Source Code Pro",fontSize:t,color:"#000000",align:"center",lineHeight:e+"px"}).setDepth(10).setOrigin(.5,.5);return i.scrollFactorX=0,s.label=i,s}"right"===i?(s.x=this.cameras.main.width-s.width/2,s.y=s.height/2):(s.x=i.x+a,s.y=i.y);let h=11*this.resmult|0,n=11*this.resmult|0,r=this.add.text(s.x-s.width/2+18*this.resmult|0,s.y,"",{fontFamily:"Source Code Pro",fontSize:h,color:"#000000",align:"center",lineHeight:n+"px"}).setDepth(10).setOrigin(.5,.5);r.scrollFactorX=0,s.label=r,h=10*this.resmult|0,(r=this.add.text(s.x-s.width/2+40*this.resmult|0,s.y-1.5*n,"",{fontFamily:"Source Code Pro",fontSize:h,color:"#333",align:"left",wordWrap:{width:a-s.width}}).setDepth(10)).scrollFactorX=0,s.info=r,h=10*this.resmult|0,(r=this.add.text(s.x-s.width/2+40*this.resmult|0,s.y-.5*n,"",{fontFamily:"Source Code Pro",fontSize:h,color:"#900",align:"left",wordWrap:{width:a-s.width}}).setDepth(10)).scrollFactorX=0,s.achievement=r,h=8*this.resmult|0;let l=this.add.text(a/2+s.x-s.width/2+38*this.resmult|0,s.y+2-.5*n,"",{fontFamily:"Source Code Pro",fontSize:h,color:"orange",align:"right",wordWrap:{width:a-s.width}}).setDepth(10);return l.scrollFactorX=0,s.reward=l,h=10*this.resmult|0,(r=this.add.text(r.x,r.y+n,"",{fontFamily:"Source Code Pro",fontSize:h,color:"#060",align:"left",wordWrap:{width:a-s.width}}).setDepth(10)).scrollFactorX=0,s.challenge=r,s}startRace(t){let e=this.groundLayer.getTileAt(0,0),i=this.startTile.pixelY+this.groundLayer.y+e.y+e.height/2,s=this.cars.getChildren();s.forEach(function(t){t.reset(t.id),t.x=0,t.y=i}),s[0].x+=this.startTile.width,s[0].y-=2*this.startTile.height,s[2].x+=5*this.startTile.width,s[2].y-=2*this.startTile.height,s[1].x+=this.startTile.width,s[1].y+=2*this.startTile.height,s[3].x+=5*this.startTile.width,s[3].y+=2*this.startTile.height;for(let e=0;e<s.length;e++){s[e].x+=this.startTile.width/2+t}this.physics.add.collider(s,s,this.collideCar),this.physics.add.overlap(this.bullets,this.cars,this.bulletHit,null,this),this.cars.children.each(function(t){t.body.onWorldBounds=!0}),this.physics.world.on("worldbounds",this.collideWorldBounds)}collideWorldBounds(t){t.gameObject.bumperFactor=500}collectStar(t,e){e.active&&(this.starHit++,e.disableBody(),this.tweens.add({targets:e,ease:"Linear",duration:500,x:this.starIcon.x-this.starIcon.width/2+40*this.resmult,y:this.starIcon.y,callbackScope:this,onComplete:function(t){e.destroy()}},this),this.game.save("coins-collected",parseInt(this.starIcon.label.text)+1),this.starIcon.label.text=this.game.restore("coins-collected"))}createLevel(t){var e=[];for(let t=0;t<60;t++){e[t]=[];for(let i=0;i<150;i++)e[t][i]=6}this.prevGoalY=t.integerInRange(4,55),t.sow([this.levelNo,window.raceId]),this.goalY=t.integerInRange(4,55),this.goalX=149;let i=0,s=this.prevGoalY,a=(this.mapWidthInPixels,this.mapTileWidth,this.mapHeightInPixels);var h=new Phaser.Math.Vector2(i*this.mapTileWidth+this.mapTileWidth/2,this.prevGoalY*this.mapTileWidth+this.mapTileWidth/2);i=h.x+t.between(20*this.mapTileWidth,30*this.mapTileWidth);let n=t.between(10*this.mapTileWidth,20*this.mapTileWidth);s*=this.mapTileWidth,s+=s<this.mapHeightInPixels/2?n:-n,i=i<this.mapWidthInPixels-this.mapTileWidth?i:this.mapWidthInPixels-this.mapTileWidth,s=(s=s>0?s:0)<this.mapHeightInPixels?s:this.mapHeightInPixels;var r=new Phaser.Math.Vector2(i,s);i+=t.between(20*this.mapTileWidth,40*this.mapTileWidth),n=t.between(a/3,a/2),s+=s<this.mapHeightInPixels/2?n:-n,i=i<this.mapWidthInPixels-this.mapTileWidth?i:this.mapWidthInPixels-this.mapTileWidth,s=(s=s>0?s:0)<this.mapHeightInPixels?s:this.mapHeightInPixels;var l=new Phaser.Math.Vector2(i,s);let o,c;i+=t.between(30*this.mapTileWidth,40*this.mapTileWidth);let d=30;do{if(n=t.between(a/3,a/2),c=(s+(o=s<this.mapHeightInPixels/2?n:-n))/this.mapTileWidth|0,d<0)break;d--}while(c===this.goalY);s+=o,i=i<this.mapWidthInPixels-this.mapTileWidth?i:this.mapWidthInPixels-this.mapTileWidth,s=(s=s>0?s:0)<this.mapHeightInPixels?s:this.mapHeightInPixels;var g=new Phaser.Math.Vector2(i,s);let m=new Phaser.Math.Vector2(this.mapWidthInPixels-this.mapTileWidth/2,this.goalY*this.mapTileWidth+this.mapTileWidth/2),u=[h.x,h.y,r.x,r.y,l.x,l.y,g.x,g.y,m.x,m.y];for(let t=0;t<u.length;t+=2){let e=u[t]/this.mapTileWidth|0,i=u[t+1]/this.mapTileWidth|0;u[t]=e*this.mapTileWidth+this.mapTileWidth/2,u[t+1]=i*this.mapTileWidth+this.mapTileWidth/2}let p=new Phaser.Curves.Spline(u),y=this.add.graphics();y.name="graphics",y.setDepth(10);let v=p.getDistancePoints(this.mapTileWidth/2);this.curve=p,this.graphics&&this.graphics.destroy(),this.graphics=y,this.points=v,this.path={t:0,vec:new Phaser.Math.Vector2};let f=Math.PI/2,x=1,w=1;x=v[0].y-10*this.mapTileWidth,w=v[0].y+10*this.mapTileWidth;let b=0,T=0;for(let t=0;t<v.length;t++){let i=v[t].x/this.mapTileWidth|0;if(e[v[t].y/this.mapTileWidth|0][i]=2,t>=0){let s,a=(s=0===t?0:Phaser.Math.Angle.BetweenPoints(v[t-1],v[t]))-f;f=s;let h=v[t].y-10*this.mapTileWidth,n=v[t].y+10*this.mapTileWidth;0===i&&(h=v[t].y-8*this.mapTileWidth,n=v[t].y+8*this.mapTileWidth);let r=150;1===i&&(h=v[t].y-9*this.mapTileWidth,n=v[t].y+9*this.mapTileWidth),149===i&&(h=v[t].y-8*this.mapTileWidth,n=v[t].y+8*this.mapTileWidth),i===r-2&&(h=v[t].y-9*this.mapTileWidth,n=v[t].y+9*this.mapTileWidth);let l=75;a>.05&&(b=l),a<.05&&(T=l),b>0?(x-=(x-h)/b,b--):x=h,T>0?(x=h,w+=(n-w)/T,T--):w=n,x>h&&(x=h),w<n&&(w=n);let o=60;if(t>=1)for(let t=x/this.mapTileWidth|0;t<w/this.mapTileWidth|0;t++)t>=0&&t<o&&(e[t][i]=2)}}v[v.length-1].x,this.mapTileWidth,v[v.length-1].y,this.mapTileWidth;for(let t=0;t<=1;t++)for(let i=-4;i<=4;i++)0===t&&i%2==0||1===t&&i%2==0?(e[this.goalY+i][this.goalX+1-2*t]=1,e[this.goalY+i][this.goalX-2*t]=9):(e[this.goalY+i][this.goalX+1-2*t]=9,e[this.goalY+i][this.goalX-2*t]=1);return e[this.prevGoalY][3]=0,e}createTiles(t,e){let i=this.make.tilemap({data:t,tileWidth:4*this.resmult,tileHeight:4*this.resmult});var s=i.addTilesetImage("tiles");let a=i.createStaticLayer(0,s);a.y=40*this.resmult,this.physics.world.setBounds(a.x,a.y,a.width,a.height),a.name="groundLayer",e?(this.groundLayer=a,this.cars.children.each(function(t){t.setCollideWorldBounds(!0)})):(a.x=this.cameras.main.width,this.cameraOffset=Math.PI,this.groundLayerNext=a),this.groundLayer;let h=i.createBlankDynamicLayer("Object Layer",s);return h.y=a.y,h.name="objectLayer",e?this.objectLayer=h:(h.x=this.cameras.main.width,this.objectLayerNext=h),this.objectLayer,this.startTile=a.getTileAt(3,this.prevGoalY),this.startTile.rotation=Math.PI/2,[a,h]}getPlayer(){return this.cars.getChildren()[0]}setCar(t){let e=this.cars.getChildren()[0],i=parseInt(t);i<6?i+=4:i>6?i+=3:i=0,e.setFrame(i)}nextRace(t){t&&this.destroyLevel();let e=20*this.resmult;this.startLabel=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,"Press LEFT/RIGHT to start!",{fontFamily:"Source Code Pro",fontSize:e,color:"#000000",backgroundColor:"#ffff00",align:"center"}).setOrigin(.5,.5).setShadow(2,2,"rgba(255,255,255,1)",3).setDepth(2),this.startLabel.name="startLabel",this.startLabel.scrollFactorX=0,this.startDelay=!0,this.carsButton=new Button(this,"MY CARS",3381555,this.gameEvent,GameEvent.play,"Collect all cars"),this.carsButton.setDepth(10),this.carsButton.x=this.cameras.main.centerX,this.carsButton.y=this.cameras.main.height-this.carsButton.height,this.carsButton.scrollFactorX=0;let i=new Phaser.Math.RandomDataGenerator([this.levelNo-1,window.raceId]);this.rnd=i,this.mapWidthInPixels=this.cameras.main.width,this.mapHeightInPixels=this.cameras.main.height-40*this.resmult,this.mapTileWidth=4*this.resmult,this.mapTileHeight=4*this.resmult;let s=this.createTiles(this.createLevel(i),t),a=s[0],h=s[1];this.coneHit=0,this.carHit=[],this.bulletHitCount=0,this.physics.world.colliders.destroy();for(let t=0;t<this.curve.points.length;t++)this.curve.points[t].y+=40*this.resmult;for(let t=0;t<this.points.length;t++)this.points[t].y+=40*this.resmult;let n=this.physics.add.group();n.name="conesGroup",n.maxSize=6,null===this.cones?this.cones=n:this.conesNext=n,this.border=!0;if(this.border)for(let t=0;t<60;t++)for(let e=0;e<150;e++){let i=a.getTileAt(e,t);if(i.index<2||i.index>7)continue;let s=i.index,n=a.getTileAt(e-1,t),r=a.getTileAt(e+1,t),l=a.getTileAt(e,t-1),o=a.getTileAt(e,t+1),c=a.getTileAt(e-1,t-1),d=a.getTileAt(e+1,t-1),g=a.getTileAt(e-1,t+1),m=a.getTileAt(e+1,t+1);n=n?n.index:-1,r=r?r.index:-1,l=l?l.index:-1,o=o?o.index:-1,c=c?c.index:-1,d=d?d.index:-1,g=g?g.index:-1,m=m?m.index:-1;let u=-1,p=0;2===s?(2!==l&&2!==n&&(u=11,p=Math.PI/2),2!==l&&2!==r&&(u=11,p=-Math.PI),2!==o&&2!==n&&(u=11),2!==o&&2!==r&&(u=11,p=-Math.PI/2)):(2===o&&2===g&&2===m&&(u=10),2===o&&2!==m&&(u=11),2===o&&2!==g&&(u=11,p=-Math.PI/2),2===l&&2===c&&2===d&&(u=10,p=Math.PI),2===l&&2!==d&&(u=11,p=Math.PI/2),2===l&&2!==c&&(u=11,p=Math.PI)),-1!==u&&(h.putTileAt(u,e,t).rotation=p)}for(let t=this.goalY+10;t<60;t++)2===a.getTileAt(149,t).index&&(t===this.goalY+10?h.putTileAt(11,149,t).rotation=-Math.PI/2:h.putTileAt(10,149,t).rotation=Math.PI/2);for(let t=0;t<100;t++){let t=i.integerInRange(10,140),e=i.integerInRange(0,59),s=a.getTileAt(t,e);if(2!==s.index){i.integerInRange(0,100)}else{if(i.integerInRange(0,100)<6){let t=!1,e=a.x+s.pixelX+s.width/2,i=a.y+s.pixelY+s.height/2;for(let s=0;s<n.getChildren().length;s++){let a=n.getChildren()[s].width,h=n.getChildren()[s].x,r=n.getChildren()[s].y;if(!(e+a<h||e-a>h||i+a<r||i-a>r)){t=!0;break}}if(!t){var r=n.create(a.x+s.pixelX+s.width/2,a.y+s.pixelY+s.height/2,"cone");r&&(r.name="block",r.setDrag(200*this.resmult),r.setMass(.4))}}}}this.createPond(i,h,0,0,a,12,64),this.createPond(i,h,0,0,a,16,128),this.stars,this.border,h.setCollisionBetween(3,3),this.border,this.physics.add.collider(this.cars,h),this.physics.add.collider(this.cars,n,this.coneCollision),this.physics.add.collider(n),t&&this.addStars(),this.createCity(i,a),this.scene.sendToBack()}groundCollision(t,e){t.coneFactor=1e3}coneCollision(t,e){0===t.id&&t.scene.coneHit++}collideCar(t,e){if(0===t.id){for(let i=0;i<t.scene.carHit.length;i++)if(t.scene.carHit[i].id===e.id)return;t.scene.carHit.push(e)}}collide2(t,e){}onGoal(t,e){if(this.ongoalState)return;let i;this.ongoalState=!0,this.physics.pause(),this.cars.children.each(function(t){t.setCollideWorldBounds(!1),t.stop()});if(i=["YOU WIN!","BLUE WINS!","YELLOW WINS!","GREEN WINS!"][t.id],0===t.id){this.levelNo++,this.game.save("levelNo",this.levelNo),this.goalIcon.label.text=""+(parseInt(this.goalIcon.label.text)+1),this.game.save("total-wins",this.goalIcon.label.text);let t=parseInt(this.winsInRow.label.text);t<3&&t++,this.winsInRow.label.text=""+t,this.game.save("wins-in-row",this.winsInRow.label.text)}else{let t=parseInt(this.winsInRow.label.text);t>0?t--:t=0,this.winsInRow.label.text=""+t,this.game.save("wins-in-row",this.winsInRow.label.text)}this.achievements.update(t);var s=this.add.text(t.x-20,t.y,i,{fontFamily:"Source Code Pro",fontSize:20,color:"#000000",backgroundColor:"#ffff00",align:"right"}).setOrigin(1,.5).setShadow(2,2,"rgba(255,255,255,1)",3).setDepth(2);s.name="goalLabel",this.time.delayedCall(1e3,function(){this.stars.children.each(function(t){t.destroy()}),this.ongoalState=!1,this.nextRace(0!==t.id),s.destroy(),this.startRace(0===t.id?this.groundLayer.width:0),this.go(),parseInt(this.starIcon.label.text)>=42&&(this.carsButtonTween=this.tweens.add({targets:this.carsButton,ease:Phaser.Math.Easing.Sine.In,duration:500,scaleX:.95,scaleY:.9,repeat:-1,yoyo:!0}))},[],this),this.tweens.add({targets:t,ease:"Linear",scale:2*t.scale,duration:150,yoyo:!0,callbackScope:this,onComplete:function(e){t.scale=1}},this)}destroyLevel(){this.objectLayer&&(this.objectLayer.destroy(),this.objectLayer=null),this.groundLayer&&(this.groundLayer.destroy(),this.groundLayer=null),this.cones&&(this.cones.children.each(function(t){t.destroy()},this),this.cones.destroy(),this.cones=null)}openUI(){this.carsButton.visible&&this.gameEvent.emit(GameEvent.play,this.carsButton.text)}update(){this.debugSpline&&(this.graphics.clear(),this.graphics.lineStyle(1,16711935,1),this.curve.draw(this.graphics),this.curve.getPoint(this.path.t,this.path.vec),this.graphics.fillStyle(16776960,1),this.graphics.fillCircle(this.path.vec.x,this.path.vec.y,16));var t=this.input.activePointer;let e=!1,i=!1;if(t.isDown){if(Phaser.Geom.Rectangle.ContainsPoint(this.carsButton.getBounds(),t))return;t.x<this.cameras.main.centerX?e=!0:i=!0}if(this.cursors.left.isDown&&(e=!0),this.cursors.right.isDown&&(i=!0),this.gamepad&&((this.gamepad.left||this.gamepad.leftStick.x<=-.5||this.gamepad.rightStick.x<=-.5)&&(e=!0),(this.gamepad.right||this.gamepad.leftStick.x>=.5||this.gamepad.rightStick.x>=.5)&&(i=!0)),this.cameraOffset>0){var s=this.cameras.main.width,a=s/2;return this.cameras.main.scrollX=s-a+Math.cos(this.cameraOffset)*a|0,this.cameraOffset-=.08,void(this.cameraOffset<=0&&(this.cameraOffset=0,this.cameras.main.scrollX=0,this.cars.children.each(function(t){t.x-=this.cameras.main.width,t.setCollideWorldBounds(!0)},this),this.destroyLevel(),this.objectLayer=this.objectLayerNext,this.groundLayer=this.groundLayerNext,this.objectLayer.x-=this.cameras.main.width,this.groundLayer.x-=this.cameras.main.width,this.cones=this.conesNext,this.cones.children.each(function(t){t.x-=this.cameras.main.width},this),this.eiffel&&(this.eiffel.destroy(),this.eiffel=null),this.addStars()))}if(this.startDelay){if("RACE"===this.carsButton.text)return;if(i||e){if("SPIN"===this.carsButton.text)return;this.startDelay=!1,this.startLabel.destroy(),this.carsButton.destroy(),this.go()}return}if(this.physics.world.isPaused)return;let h=this.cars.getChildren();for(let t=0,s=h.length;t<s;t++){let s=h[t];if(t>0){3===s.id&&s.loading>0&&(s.loading--,s.loading<=0&&(this.bullets.fireBullet(s),s.loading=BULLET_LOADING));let t=1e4,a=this.points[this.points.length-1];for(let e=0;e<this.points.length;e+=2){let i=Phaser.Math.Distance.Between(s.x,s.y,this.points[e].x,this.points[e].y);if(i<t){t=i;let h=20,n=50;1===s.id&&(h*=2,n*=2),2===s.id&&(h*=1.5,n*=1.5);let r=Phaser.Math.Between(h,n),l=e+r<this.points.length?e+r:this.points.length-1;(a=this.points[l]).y<s.height/2&&(a.y=s.height/2),a.x<s.width/2&&(a.x=s.width/2),a.y>this.cameras.main.height-s.height/2&&(a.y=this.cameras.main.height-s.height/2),a.x>this.cameras.main.width-s.width/2&&(a.x=this.cameras.main.width-s.width/2)}}e=!1,i=!1;let h=Phaser.Math.Angle.ShortestBetween(s.rotation,Phaser.Math.Angle.Between(s.x,s.y,a.x,a.y)+Math.PI/2),n=Math.PI/20;h<-n&&(e=!0),h>n&&(i=!0)}let a=this.groundLayer.getTileAtWorldXY(s.x,s.y),n=this.objectLayer.getTileAtWorldXY(s.x,s.y);s.onMove(this,a,n,e,i)}}addStars(){var t;null===this.stars?(t=this.physics.add.group()).name="starsGroup":(t=this.stars).children.each(function(t){t.destroy()}),this.stars=t;let e=parseInt(this.winsInRow.label.text);1===e?e=2:2===e?e=3:e>=3&&(e=4);for(let i=1;i<e;i++){let s=this.curve.getPoint(1/e*i),a=this.rnd.between(20*this.resmult,30*this.resmult);t.add(new FlyingStar(this,s.x,s.y,a,a,this.rnd.realInRange(.001,.003),this.rnd.frac(),!0),!0)}let i=this.points[this.points.length-1];t.add(new FlyingStar(this,i.x-5*this.resmult,i.y,0,0,0,0,!0),!0),this.starHit=0,this.physics.add.overlap(this.player,this.stars,this.collectStar,null,this)}go(){this.physics.resume();for(let t=0;t<this.cars.getChildren().length;t++)this.cars.getChildren()[t].go(this.cars.getChildren().length-t)}createPond(t,e,i,s,a,h,n){let r=h+1,l=r+1,o=l+1;for(let i=0;i<n;i++){let i=t.integerInRange(3,8);if(i<=4)continue;let s=8,a=5,n=[];for(let e=0;e<i;e++)n.push({x:t.between(-s,s),y:t.between(-a,a)});var c=new Phaser.Geom.Polygon(n);if(c.calculateArea()<10)continue;let r=t.integerInRange(10,e.layer.width-10),l=t.integerInRange(0,e.layer.height-1);for(let t=-a;t<=a;t++)for(let i=-s;i<=s;i++)c.contains(i,t)&&null===e.getTileAt(r+i,l+t)&&e.putTileAt(h,r+i,l+t)}for(let t=0;t<e.layer.height;t++)for(let i=0;i<e.layer.width;i++){let s=e.getTileAt(i,t),a=-1;if(null===s)continue;if(a=s.index,s.index!==h)continue;let n=e.getTileAt(i-1,t),c=e.getTileAt(i+1,t),d=e.getTileAt(i,t-1),g=e.getTileAt(i,t+1),m=e.getTileAt(i-1,t-1),u=e.getTileAt(i+1,t-1),p=e.getTileAt(i-1,t+1),y=e.getTileAt(i+1,t+1);n=n?n.index:-1,c=c?c.index:-1,d=d?d.index:-1,g=g?g.index:-1,m=m?m.index:-1,u=u?u.index:-1,p=p?p.index:-1,y=y?y.index:-1;let v=-1,f=0;a===h&&(d<h?n<h?c<h?g<h?v=o:(v=l,f=-Math.PI/2):g<h?(v=l,f=Math.PI):(v=r,f=-Math.PI/2):c<h&&(v=g<h?l:r):g<h&&(n<h?c<h?(v=l,f=Math.PI/2):(v=r,f=Math.PI):c<h&&(d<h?v=l:(v=r,f=Math.PI/2)))),-1!==v&&(e.putTileAt(v,i,t).rotation=f)}}createCity(t,e){}}class GridContainer extends Phaser.GameObjects.Container{constructor(t,e,i,s,a,h=0,n=0){super(t),this.scene.add.existing(this);let r=this.scene.textures.getFrame(e+"-0");this.cellWidth=r.width,this.cellHeight=r.height,this.name=e,this.grid=i,this.cols=s,this.rows=a,this.cells=[];for(let t=0;t<this.rows;t++)this.cells[t]=[];this.paddingX=h,this.paddingY=n}setGrid(t){let e=[];for(let t=0;t<this.rows;t++){e[t]=[];for(let i=0;i<this.cols;i++)e[t][i]=this.cells[t][i].getData("value")}}addCell(t,e,i){let s=this.scene.add.image(0,0,this.name+"-"+i);return this.add(s),s.name=this.name,s.x=(t-this.cols/2+.5)*(this.cellWidth+this.paddingX/(this.cols%2==0?2:1)),s.y=(e-this.rows/2+.5)*(this.cellHeight+this.paddingY/(this.rows%2==0?2:1)),s.setData("col",t),s.setData("row",e),s.setData("value",i),s.on("changedata",this.cellDataChanged,this),this.cells[e][t]=s,s}cellDataChanged(t,e,i){"value"===e&&(t.setTexture(this.name+"-"+i),this.grid[t.getData("row")][t.getData("col")]=i)}getCell(t,e){return this.cells[e][t]}getCells(){return this.cells}copyValueGrid(){let t=[];for(let e=0;e<this.rows;e++){t[e]=[];for(let i=0;i<this.cols;i++)t[e][i]=this.cells[e][i].getData("value")}return t}copyValues(){let t=[];for(let e=0;e<this.rows;e++)for(let i=0;i<this.cols;i++)t.push({x:i,y:e,value:this.cells[e][i].getData("value")});return t}firstCell(){return this.getAt(0)}nextCell(t){return this.getAt(this.getIndex(t)+1)}setOrigin(t,e){}get height(){return this.rows*(this.cellHeight+this.paddingY)-this.paddingY}}class LoaderScene extends Phaser.Scene{constructor(t){super({key:"LoaderScene",visible:!1}),this.loadProgress=0,this.levelList=null}init(){}preload(){this.load.path=this.registry.get("path")}create(){let t=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,Text.tictactoe,{font:"48px Arial",fill:"#000000"}).setOrigin(.5);this.game.events.on(Text.nextLevel,function(){this.levelNo=this.levelNo+1,this.closeLevel()},this).on(Text.restart,function(){this.levelNo=0,this.closeLevel()},this),this.load.on("loadProgress",function(e){t.text=Text.loading+" "+parseInt(100*e)+" %"},this).on("complete",function(){t.text=Text.tictactoe,this.nextLevel("loaded")},this),this.cameras.main.setBackgroundColor("#f4f4f4"),this.scene.setVisible(!1),this.registry.set("startCounter",0),this.loadLevel()}facebookReady(){console.log("fb")}closeLevel(){this.registry.set("startCounter",parseInt(this.registry.get("startCounter"))+1),this.loadLevel(this.levelNo),this.cameras.main.x=this.cameras.main.width,this.scene.setVisible(!0),this.tweens.add({targets:this.cameras.main,x:{value:0,duration:500,ease:Phaser.Math.Easing.Sine.Out,yoyo:!1},callbackScope:this,onComplete:function(t){this.scene.manager.scenes.forEach(function(t){t!==this&&this.scene.remove(t)},this),this.time.delayedCall(100,function(){this.nextLevel("closed")},[],this)}},this)}loadLevel(){this.levelList&&this.levelNo>=this.levelList.length||(this.registry.set("level",null),this.load.start())}nextLevel(t){(!this.levelList||this.levelNo>=this.levelList.length||"closed"===t&&this.registry.get("level")||"loaded"===t&&1===this.scene.manager.scenes.length)&&(this.levelList&&this.levelNo>=this.levelList.length?this.scene.add("GameOverScene",new GameOverScene("GameOverScene"),!0):this.scene.add("UIScene",new UIScene("UIScene"),!0),this.tweens.add({targets:this.cameras.main,x:{value:-this.cameras.main.width,duration:500,ease:Phaser.Math.Easing.Sine.Out,yoyo:!1},callbackScope:this,onComplete:function(t){this.scene.setVisible(!1)}},this))}set levelNo(t){this.game.save("levelNo",t)}get levelNo(){return parseInt(this.game.restore("levelNo")||0)}}class Negamax{constructor(t,e){this.evaluateValue=t,this.evaluateTerminal=e,this.depthMax=-1}negamax(t,e,i,s,a,h,n,r){if(i>this.depthMax)return 0;if(i===this.depthMax||this.evaluateTerminal(e,s,!1))return r*this.evaluateValue(e,s,i);let l=Number.NEGATIVE_INFINITY;for(let o=0;o<e.length;o++)for(let c=0;c<e[0].length;c++)if(0===e[o][c]&&(e[o][c]=s,l=Math.max(l,-this.negamax(t,e,i+1,a,s,-n,-h,-r)),h=Math.max(h,l),e[o][c]=0,h>=n))return h;return l}minimax(t,e,i,s,a,h,n,r){if(i===this.depthMax||null!==this.evaluateTerminal(e,s,!1)){return this.evaluateValue(e,s,i)}let l;l=1===r?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY;for(let o=0;o<e.length;o++)for(let c=0;c<e[0].length;c++)if(0===e[o][c]&&(e[o][c]=s,l=1===r?Math.max(l,this.minimax(t,e,i+1,a,s,-n,-h,-r)):Math.min(l,this.minimax(t,e,i+1,a,s,-n,-h,-r)),h=Math.max(h,l),e[o][c]=0,h>=n))return h;return l}getMoves(t,e,i,s){let a=[];this.players=e,this.depthMax=this.players[i-1].ai.skill;for(let e=0;e<3;e++)for(let h=0;h<3;h++)if(0===t[e][h]){let n={col:h,row:e,value:0};this.depthMax>0?(t[e][h]=i,n.value=-this.negamax(n,t,1,s,i,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,-1),t[e][h]=0):this.evaluateValue(t,i,0),a.push(n)}return a}}class Car extends Phaser.Physics.Arcade.Sprite{constructor(t,e){switch(super(t,0,0,"cars"),this.id=e,this.resmult=t.resmult,e){case 1:this.resmult*=.775;break;case 2:this.resmult*=.7;break;case 3:this.resmult*=.6,this.loading=BULLET_LOADING}t.add.existing(this),t.physics.add.existing(this),this.setDepth(1),this.reset(e);let i=e;0===e&&(i=0|parseInt(this.scene.game.restore("car"))),this.setFrame(i)}reset(t){if(0===this.id&&this.scene.rnd){let t=this.id;t=this.scene.rnd.integerInRange(4,15)}this.body.reset(),this.setBounce(.1,.1),this.setDamping(!0),this.setAngularDrag(1e3),this.setMaxVelocity(200*this.resmult),this.rotation=Math.PI/2,this.setSize(.75*this.width,.75*this.height),this.collideFactor=0,this.bumperFactor=0,this.hitFactor=0,this.turbo=!1,this.rotation=Math.PI/2,this.maxSpeed=175*this.resmult*.85,this.setMass(.5+this.id/10),3===this.id&&(this.loading=BULLET_LOADING)}start(){this.body.setEnable(!0)}stop(){this.body.setEnable(!1),this.body.stop(),this.setVelocity(0,0),this.setAcceleration(0,0),this.setAngularVelocity(0),this.setAngularAcceleration(0)}onMove(t,e,i,s,a){this.body.maxSpeed=this.maxSpeed;let h=.06+.0125*this.id;if(null===e)this.body.maxSpeed*=.4;else if(6===e.index&&(this.body.maxSpeed*=.4),1===e.index||9===e.index)return void t.onGoal(this);null!==i&&(i.index>=12&&i.index<=16&&(this.collideFactor=1e3),i.index>=16&&i.index<=20&&(h*=.75,this.body.maxSpeed=.85*this.maxSpeed)),this.collideFactor>0&&(this.collideFactor-=100,(h-=this.collideFactor/5e4)<0&&(h=0)),!0===this.turbo&&(this.body.maxSpeed*=2);let n=this.body.speed/this.resmult*.95;n<100&&(n=100),s?this.setAngularVelocity(-n):a?this.setAngularVelocity(n):this.setAngularAcceleration(0),this.body.velocity.x+=(Math.sin(this.rotation)*this.body.speed-this.body.velocity.x)*h,this.body.velocity.y+=(-Math.cos(this.rotation)*this.body.speed-this.body.velocity.y)*h;let r=this.body.maxSpeed;t.physics.velocityFromRotation(this.rotation-Math.PI/2,r,this.body.acceleration),this.bumperFactor>0&&(this.bumperFactor-=100,this.body.velocity.x*=.9,this.body.velocity.y*=.9),this.hitFactor>0&&(this.hitFactor-=100,this.body.velocity.x*=.8,this.body.velocity.y*=.8)}go(t){this.scene.time.delayedCall(450*t,function(){this.body.setEnable(!0)},[],this)}}class Player{constructor(t,e){this.id=t,this.ai=e}}var Text={i:0,tictactoe:"Tic Tac Toe",lang:"en",loading:"Loading",time:"TIME",score:"SCORE",skill:"DEPTH",wait:"WAIT...",yourTurn:"YOUR TURN",play:"PLAY",pause:"PAUSE",continue:"CONTINUE",start:"RACE",restart:"RESTART",nextLevel:"NEXT LEVEL",playAgain:"PLAY AGAIN",gameDraw:"GAME DRAW",youLose:"YOU LOSE",youWin:"YOU WIN",ticTacToeMaster:"TIC TAC TOE MASTER!",allLevelsPassedRestartGame:"All levels passed!",fi(){this.i=1,this.tictactoe="Tic Tac Toe",this.lang="fi",this.loading="Ladataan",this.time="AIKA",this.score="PISTEET",this.skill="SYVYYS",this.wait="ODOTA...",this.yourTurn="SINUN VUORO",this.play="PELAA",this.pause="TAUKO",this.continue="JATKA",this.start="ALOITA",this.restart="UUDESTAAN",this.nextLevel="SEURAAVA TASO",this.playAgain="PELAA UUDELLEEN",this.gameDraw="TASAPELI",this.youLose="HÄVISIT",this.youWin="VOITIT",this.ticTacToeMaster="RISTINOLLA MESTARI!",this.allLevelsPassedRestartGame="Kaikki tasot läpi!"}};class UIScene extends Phaser.Scene{constructor(t){super({key:t}),this.gameEvent=new GameEvent,this.spin=0,this.spinTarget=null,this.move=0,this.spinCostMin=42,this.spinCost=this.spinCostMin,this.freeSpin=0,this.spinLabel=null,this.collectedLength=0}init(){parseInt(0|this.game.restore("lastPlayTime"))+43200<(Date.now()/1e3|0)&&(this.freeSpin=1);let t=this.game.restore("cars");t=t?t.split(","):[],this.collectedLength=t.length,this.collectedLength>=13&&(this.freeSpin=1),this.level=this.registry.get("level")}preload(){this.load.path=this.registry.get("path");let t,e;this.game.config.width>=1200?(t="res-hi",e=2,this.resmult=e):this.game.config.width>=900?(t="res-mid",e=1.5,this.resmult=e):(t="res-lo",e=1,this.resmult=e),["sports-cars-bg","header-info"].forEach(function(e){this.load.image(e,"img/"+t+"/"+e+".png?v=30")},this),this.load.spritesheet("sports-cars","img/"+t+"/sports-cars.png?v=30",{frameWidth:40*e,frameHeight:86*e})}addCar(t,e,i){let s=this.add.image(0,0,"sports-cars").setDepth(10).setInteractive();s.setFrame(t),s.name=t;let a=1*s.width,h=t-6;return s.x=e.x+h*a,s.y=e.y,i||(s.tint=0),s.scale=.5,s}countCollected(){let t=0;for(let e=0;e<this.cars.getChildren().length;e++)0!==this.cars.getChildren()[e].tintTopLeft&&t++;return t}create(){this.gameEvent.on(GameEvent.play,function(t){if("MY CARS"===t){this.cars=this.add.group(),this.bg=this.add.image(this.cameras.main.centerX,this.cameras.main.centerY,"sports-cars-bg").setDepth(9);let t=this.game.restore("cars");t=t?t.split(","):[];for(let e=0;e<13;e++){let i=!1;for(let s=0;s<t.length;s++){let a=t[s];if(parseInt(a)===e){i=!0;break}}let s=this.addCar(e,this.bg,i);this.cars.add(s)}t.length>0&&(this.spinTarget=this.cars.getChildren()[parseInt(t[0])],this.spinTarget&&(this.move=this.spinTarget.x-this.bg.x)),this.info=this.add.image(this.gameScene.carsButton.x+1.125*this.gameScene.carsButton.width,this.gameScene.carsButton.y,"header-info"),this.info.setInteractive().on("pointerup",()=>this.showInfo());let e=this.gameScene.starIcon;parseInt(e.label.text)>=42&&t<13&&this.tweens.add({targets:button,ease:Phaser.Math.Easing.Sine.In,duration:500,scaleX:.95,scaleY:.9,repeat:-1,yoyo:!0})}if(t===Text.start&&this.bg&&(this.bg.destroy(),this.bg=null,this.cars.destroy(!0),this.info.destroy(),this.congratulations&&(this.congratulations.destroy(),this.congratulations=null),this.spinLabel&&(this.spinLabel.destroy(),this.spinLabel=null)),"SPIN"===t&&0===this.spin){if(13===this.countCollected()){this.resmult;return}let t=parseInt(this.gameScene.starIcon.label.text);if(t<this.spinCost){this.resmult;return}this.info.destroy(),this.spinLabel&&(this.spinLabel.destroy(),this.spinLabel=null),this.gameScene.carsButton&&(this.gameScene.carsButton.visible=!1),this.gameScene.getPlayer()&&(this.gameScene.getPlayer().visible=!1),t-=this.spinCost,this.spinCost=this.spinCostMin,this.gameScene.starIcon.label.text=""+t,this.game.save("coins-collected",t),this.spinTarget&&(this.spinTarget.scale=.5);let e,i=[],s=[];for(let t=0;t<this.cars.getChildren().length;t++){let e=this.cars.getChildren()[t];0===e.tintTopLeft?s.push(e):i.push(e)}let a=Phaser.Math.Between(1,4);e=i.length<=6||a>=1?Phaser.Utils.Array.GetRandom(s):Phaser.Utils.Array.GetRandom(i),this.spinTarget=e,this.spin=this.spinTarget.x-this.bg.x,this.spin+=13*this.spinTarget.width*2}},this),this.input.on("gameobjectup",function(t,e,i){if(0===this.spin&&!e.isButton)if(0!==e.tintTopLeft)e!==this.spinTarget&&(this.spinTarget&&(this.spinTarget.scale=.5),this.move=e.x-this.bg.x,this.spinTarget=e);else{let t=16*this.resmult,i=this.add.text(e.x,e.y-e.height/2,"SPIN for new cars.",{fontFamily:"Source Code Pro",fontSize:t,color:"#000000",backgroundColor:"#ffff00",align:"center"}).setOrigin(.5,.5).setShadow(2,2,"rgba(255,255,255,1)",3).setDepth(100);this.time.addEvent({delay:1500,callback:function(){i.destroy()}})}},this);this.scene.get("GameScene")||this.scene.add("GameScene",new GameScene("GameScene",this.gameEvent));let t=this.scene.get("GameScene");this.gameScene=t,this.scene.run(t,{autostart:this.registry.get("startCounter")>0,layout:{y:0,x:0,h:this.cameras.main.height-0,w:this.cameras.main.width-0}}),this.registry.get("startCounter")>0&&this.gameEvent.emit(GameEvent.play,Text.start),this.scene.sendToBack()}showInfo(){alert("HTML5 game framework Phaser 3 - phaser.io\nRacing pack created by Kenney at www.kenney.nl\nCollectible sports cars vectors created by macrovector at www.freepik.com")}pointerover(t,e,i,s){}pointerout(){}pointerdown(){}pointerup(t,e,i,s){return!1}update(){if(0!==this.move&&(Phaser.Actions.Call(this.cars.getChildren(),function(t){t.x-=this.move,t.x>=this.bg.x+6.5*t.width&&(t.x-=13*t.width),t.x<=this.bg.x-6.5*t.width&&(t.x+=13*t.width)},this),this.openCar(this.spinTarget,!1),this.move=0),0!==this.spin){let t=this.spin/20;if(t>this.spinTarget.width/2&&(t=this.spinTarget.width/2),this.spin-=t,Math.abs(this.spin)<1){if(t=this.spin,this.spin=0,0!==this.spinTarget.tintTopLeft){let t=16*this.resmult,e=this.add.text(this.spinTarget.x,this.spinTarget.y-this.spinTarget.height/2-t,"Bummer.\nYou already have it.",{fontFamily:"Source Code Pro",fontSize:t,color:"#000000",backgroundColor:"#ffff00",align:"center"}).setOrigin(.5,.5).setShadow(2,2,"rgba(255,255,255,1)",3).setDepth(100);this.time.addEvent({delay:1500,callback:function(){e.destroy()}})}null!==this.spinLabel&&(this.spinLabel.destroy(),this.spinLabel=null),this.openCar(this.spinTarget,!0);let e=parseInt(0|this.game.restore("lastPlayTime")),i=Date.now()/1e3|0;e+43200<i&&this.game.save("lastPlayTime",""+i)}Phaser.Actions.Call(this.cars.getChildren(),function(e){e.x-=t,e.x>=this.bg.x+6.5*e.width&&(e.x-=13*e.width),e.x<=this.bg.x-6.5*e.width&&(e.x+=13*e.width)},this)}if(this.freeSpin>0&&(this.freeSpin--,0===this.freeSpin)){if(!this.gameScene||!this.gameScene.carsButton)return void(this.freeSpin=1);if(this.gameEvent.emit(GameEvent.play,"MY CARS"),this.collectedLength<13){this.resmult;this.spinCost=0,this.gameScene.carsButton.text="SPIN",this.gameScene.carsButton.subtitle="Get a new car!"}}}openCar(t,e){t.tint=16777215;let i=[this.spinTarget.name];for(let t=0;t<this.cars.getChildren().length;t++){let e=this.cars.getChildren()[t];0!==e.tintTopLeft&&e.name!=this.spinTarget.name&&i.push(e.name)}if(this.game.save("cars",i.join()),i.length>=13){let e=14*this.resmult;this.congratulations=this.add.text(t.x,t.y-t.height-8*this.resmult,"CONGRATULATIONS\nYou've got 'em all!",{fontFamily:"Source Code Pro",fontSize:e,color:"#000000",backgroundColor:"#ffff00",align:"center"}).setOrigin(.5,0).setShadow(2,2,"rgba(255,255,255,1)",3).setDepth(100)}this.gameScene.setCar(t.name),this.gameScene.startLabel.visible=!1,t.scale=1;let s=this.gameScene.getPlayer();if(e){let e=this.addCar(t.name,t,!0);e.x=t.x,e.y=t.y,e.scale=1;let i=this.cars.getChildren().slice();i.push(this.bg),this.tweens.add({targets:i,ease:"Linear",duration:1e3,alpha:0,delay:0,callbackScope:this,onComplete:function(t){this.tweens.add({targets:e,ease:"Linear",duration:350,x:s.x,y:s.y,rotation:Math.PI/2,scale:.1,delay:0,callbackScope:this,onComplete:function(t){e.destroy(),this.gameScene.getPlayer().visible=!0,this.gameEvent.emit(GameEvent.play,Text.start),this.gameScene.startLabel.visible=!0,this.gameScene.carsButton&&(this.gameScene.carsButton.text="MY CARS",this.gameScene.carsButton.subtitle="Collect all cars")}},this)}},this)}}}class MainGame extends Phaser.Game{constructor(t,e,i){let s=!1;window.innerWidth>=1200&&window.innerHeight>=800&&(s=!0);let a=t.offsetWidth,h=t.offsetHeight;a>=1200?(a=1200,h=560):a>=900?(a=900,h=420):(a=600,h=280),super({key:t.id,type:Phaser.AUTO,parent:t,width:a,height:h,backgroundColor:i,transparent:!1,physics:{default:"arcade",arcade:{debug:!1,fps:60}},render:{antialias:s},scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},input:{touch:{capture:!1},gamepad:!0},disableContextMenu:!0,scene:[new LoaderScene(e)]});document.getElementsByTagName("html")[0].getAttribute("lang");-1!==window.location.href.indexOf("localhost:8383")?(this.registry.set("debug",!0),this.registry.set("path","./")):(this.registry.set("release",!0),this.registry.set("path","/topdownracing/"));let n={play:Text.play,pause:Text.pause};this.registry.set("events",n)}clear(t){let e="A"+window.raceId;window.localStorage.removeItem(e+t)}save(t,e){let i="A"+window.raceId;window.localStorage.setItem(i+t,e)}restore(t){let e="A"+window.raceId;return window.localStorage.getItem(e+t)}}function createGame(){var t=new URL(window.location).searchParams.get("race");t||(t="Grand Prix "+(new Date).getFullYear());window.raceId=t,window.game=new MainGame(document.getElementById("canvas"),["win","lose","win-15","win-draw","draw-win"],"rgba(255, 255, 255, 255)")}function setGameConfig(t,e,i){}