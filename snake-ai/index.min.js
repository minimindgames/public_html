/*! Copyright minimindgames.com 25-09-2023 */

class Bug extends Phaser.Physics.Arcade.Sprite{constructor(e,t,i,s){super(e,t,i,s),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed),this.updateTime=0}destroyed(){2===this.type&&this.explode()}explode(){let e=150*Config.scale;const t=this.scene.add.particles(this.x,this.y,"EffectExplode",{frame:[2],speed:{start:e,end:-e},quantity:5,ease:"Power2",lifespan:1500,maxParticles:50,blendMode:"ADD",alpha:{start:1,end:0}});this.scene.time.delayedCall(2e3,function(){t.destroy()},this)}initMove(){this.setBounce(1,1),this.rotation=Phaser.Math.Angle.Random(),this.body.setVelocity(Phaser.Math.Between(50*Config.scale,150*Config.scale)),this.body.angularVelocity=Phaser.Math.Between(-50,50),this.scene.physics.velocityFromRotation(this.rotation,this.body.speed,this.body.velocity)}update(e){e>this.updateTime&&(this.updateTime=e+1e3)}}class Config{static initGame(e){let t=e.config.width,i=e.config.height;if(t<i){let e=t;t=i,i=e}console.log(t+"x"+i),Config.resolution=t>=2560&&i>=1440?4:t>=1920&&i>=1080?3:t>=1280&&i>=720?2:1,Config.scale=Config.resolution/4,Config.width=640*Config.resolution,Config.height=360*Config.resolution,Config.centerX=640*Config.resolution,Config.height=360*Config.resolution,-1===window.location.href.indexOf("localhost:8383")&&(Config.loadPath="/snake-ai/img/")}static setScale(e){e.scale.resize(Config.width,Config.height)}}Config.resolution=1,Config.width=640,Config.height=360,Config.loadPath="img/",Config.highScore=0;class LoaderScene extends Phaser.Scene{constructor(){super({key:"LoaderScene",visible:!1}),this.loadProgress=0}preload(){this.load.path=Config.loadPath,this.resname=["-1","-2","-3",""][Config.resolution-1],this.loadSpriteSheet("asteroids",32,32),this.loadImage("snakehead"),this.loadImage("snakebite"),this.loadImage("snakebody"),this.loadImage("snakebody-bullet"),this.loadImage("bug"),this.loadImage("pepper3"),this.loadImage("moon"),this.loadSpriteSheet("EffectExplode",64,64),this.loadSpriteSheet("virus",64,64)}create(){Config.setScale(this),this.snap=this.textures.get("asteroids").getSourceImage().height,this.width=2560*Config.scale/this.snap,this.height=2560*Config.scale/this.snap,this.barrierGroup=this.physics.add.staticGroup(),this.enemyGroup=this.physics.add.group({runChildUpdate:!0});let e=this.snap,t=e/2,i=this.textures.get("asteroids").frameTotal-2;for(let e=0;e<5;e++){this.barrierGroup.create(this.randomX(),this.randomY(),"moon",Phaser.Math.Between(0,i))}for(let s=0;s<this.width;s++)this.barrierGroup.create(t+e*s,t,"asteroids",Phaser.Math.Between(0,i)),this.barrierGroup.create(t+e*s,e*this.height-t,"asteroids",Phaser.Math.Between(0,i));for(let s=0;s<this.height;s++)this.barrierGroup.create(t,t+e*s,"asteroids",Phaser.Math.Between(0,i)),this.barrierGroup.create(e*this.width-t,t+e*s,"asteroids",Phaser.Math.Between(0,i));this.player=new Player(this),this.time.delayedCall(100,this.addBug,[],this),this.cursors=this.input.keyboard.createCursorKeys(),this.cursorsLeftHand=this.input.keyboard.addKeys("A,D"),this.gamepad=null,this.input.gamepad.once("connected",function(e){this.gamepad=e,this.gamepad.on(Phaser.Input.Gamepad.Events.BUTTON_DOWN,function(e){console.log("gamepad")},this)},this),this.input.mouse&&this.input.mouse.disableContextMenu(),this.pointer={left:!1,right:!1},this.text=this.add.text(10,10,"Cursors to move",{font:64*Config.scale+"px Courier",fill:"#00ff00"}).setScrollFactor(0);let s=this.snap*this.width;this.cameras.main.setBounds(0,0,s,s),this.physics.world.setBounds(0,0,s,s),this.physics.add.collider(this.enemyGroup,this.barrierGroup),this.score=0,this.scoreTimer=this.time.addEvent({delay:1e3,callback:function(){this.score++},callbackScope:this,loop:!0}),this.anims.exists("virus")||this.anims.create({key:"virus",frameRate:7,frames:this.anims.generateFrameNumbers("virus"),repeat:-1})}update(e,t){var i=this.input.activePointer;i.isDown?i.x<this.cameras.main.centerX?(this.pointer.left=!0,this.pointer.right=!1):(this.pointer.left=!1,this.pointer.right=!0):(this.pointer.left=!1,this.pointer.right=!1),this.player.update(t,this.cursors,this.cursorsLeftHand,this.pointer),this.text.setText([`Hiscore: ${Config.highScore}`,`Score: ${this.score}`])}gameOver(){this.time.removeEvent(this.addCallback),this.time.removeEvent(this.scoreTimer),this.score>Config.highScore&&(Config.highScore=this.score)}loadSpriteSheet(e,t,i){let s=Config.scale*t,a=Config.scale*i;this.load.spritesheet(e,e+this.resname+".png",{frameWidth:s,frameHeight:a})}loadImage(e){this.load.image(e,e+this.resname+".png")}randomX(e){const t=this.snap,i=t/2;return Phaser.Math.Between(1,this.width-1)*t+i}randomY(e){const t=this.snap,i=t/2;return Phaser.Math.Between(1,this.height-1)*t+i}addBug(){var e=Phaser.Math.Between(1,2);let t=new Bug(this,this.randomX(),this.randomY(),1===e?"virus":"pepper3");t.type=e,1===e&&t.play("virus"),this.enemyGroup.add(t,!0),t.initMove(),this.addCallback=this.time.delayedCall(300,this.addBug,[t],this)}removeBug(e){1===e.type&&(this.score+=10),this.time.removeEvent(e.moveCallback),e.destroy()}moveBug(e){}}class Player{constructor(e){this.scene=e;let t=e.physics.add.sprite(e.randomX(),e.randomY(),"snakehead");t.rotation=Phaser.Math.Angle.Random(),e.cameras.main.startFollow(t,!0,0,.05),t.setCollideWorldBounds(!0),t.body.setVelocity(300*Config.scale),t.body.setSize(t.width/2,t.height/2),this.head=t,this.bodyGroup=e.physics.add.group(),this.bulletGroup=e.physics.add.group(),this.path=[],this.pathRotation=[],this.path.push(new Phaser.Geom.Point(this.head.x,this.head.y)),this.pathRotation.push(this.head.rotation),this.pathSpacer=8;for(let e=0;e<15;e++)this.addBody();e.physics.add.collider(this.head,this.bodyGroup,this.collideHeadBody,null,this),e.physics.add.collider(this.head,e.barrierGroup,this.collideHeadBarrier,null,this),e.physics.add.collider(this.head,this.bulletGroup),e.physics.add.overlap(this.head,e.enemyGroup,this.collideHeadEnemy,null,this),e.physics.add.collider(this.bodyGroup,e.enemyGroup,this.collideBodyEnemy,null,this),e.physics.add.collider(this.bulletGroup,e.enemyGroup,this.collideBulletEnemy,null,this),this.delta=0,this.collideBarrierTimeout=0}explode(e){let t=150*Config.scale;const i=this.scene.add.particles(e.x,e.y,"EffectExplode",{frame:[0],speed:{start:.67*t,end:.67*-t},quantity:5,ease:"Power2",lifespan:1e3,maxParticles:100,blendMode:"ADD",alpha:{start:1,end:0}});this.scene.time.delayedCall(2e3,function(){i.destroy()},this)}addBody(){let e=this.bodyGroup.getLast()||this.head,t=this.scene.physics.add.sprite(e.x,e.y,"snakebody");t.body.setSize(t.width/2,t.height/2),this.scene.time.delayedCall(200,function(){this.bodyGroup.add(t)},[t],this);for(let e=0;e<this.pathSpacer;e++)this.path.push(new Phaser.Geom.Point(t.x,t.y)),this.pathRotation.push(this.head.rotation)}cutTail(e){for(let t=null;t!==e;){t=this.bodyGroup.getChildren().pop(),this.bulletGroup.add(t);for(let e=0;e<this.pathSpacer;e++)this.path.pop(),this.pathRotation.pop();t.setTexture("snakebody-bullet"),t.body.setVelocity(Phaser.Math.Between(50*Config.scale,150*Config.scale)),t.rotation=Phaser.Math.Angle.Random();this.scene.tweens.add({targets:t,duration:3e3,scale:0,ease:"Cubic.easeIn",callbackScope:this,onComplete:e=>{e.destroy()}})}0===this.bodyGroup.getChildren().length&&(this.head.visible=!1,this.explode(this.head),this.scene.gameOver())}collideHeadBody(e,t){0!==this.bodyGroup.getChildren().indexOf(t)&&this.cutTail(t)}collideHeadBarrier(e,t){0===this.bodyGroup.getLength()||this.scene.time.now<this.collideBarrierTimeout||(this.collideBarrierTimeout=this.scene.time.now+100,this.cutTail(this.bodyGroup.getChildren()[this.bodyGroup.getChildren().length-1]))}collideHeadEnemy(e,t){if(this.head.visible)if(1===t.type)this.scene.removeBug(t),this.addBody(),this.head.setScale(.6666),this.head.setTexture("snakebite"),this.scene.tweens.add({targets:this.head,duration:75,scale:1,yoyo:!0,callbackScope:this,onComplete:function(){this.head.setTexture("snakehead"),this.head.setScale(1)}});else{let e=this.bodyGroup.getChildren().length-5;e<=0&&(e=0),this.cutTail(this.bodyGroup.getChildren()[e]),t.destroy()}}collideBodyEnemy(e,t){2===t.type&&this.scene.removeBug(t)}collideBulletEnemy(e,t){2===t.type&&(e.destroy(),this.scene.removeBug(t))}update(e,t,i,s){this.head.visible||(this.scene.physics.world.timeScale+=.2,this.scene.physics.world.timeScale>30&&(this.scene.physics.world.timeScale=1,this.scene.scene.restart()));let a=this.head,o=this.path,h=this.pathSpacer;if(a.setAcceleration(0),a.setDrag(0),a.body.angularVelocity=0,this.head.visible&&((t.left.isDown||i.A.isDown||s.left)&&(a.body.angularVelocity=-200),(t.right.isDown||i.D.isDown||s.right)&&(a.body.angularVelocity=200)),this.scene.physics.velocityFromRotation(a.rotation,a.body.speed,a.body.velocity),this.delta+=e,this.delta>16*this.scene.physics.world.timeScale){this.delta-=16*this.scene.physics.world.timeScale;let e=this.path.pop();e.x=a.x,e.y=a.y,this.path.unshift(e);let t=this.pathRotation.pop();t=a.rotation,this.pathRotation.unshift(t);let i=this.bodyGroup.getChildren();for(let e=0,t=i.length;e<t;e++)i[e].x=o[(e+1)*h].x,i[e].y=o[(e+1)*h].y,i[e].rotation=this.pathRotation[(e+1)*h]}}}class MainGame extends Phaser.Game{constructor(e){let t=window.innerWidth,i=window.innerHeight;if(t<i){let e=t;t=i,i=e}super({key:e.id,type:Phaser.AUTO,parent:e,width:t,height:i,backgroundColor:"#202f53",audio:{noAudio:!0},physics:{default:"arcade",arcade:{}},scale:{mode:Phaser.Scale.NO_SCALE},input:{touch:{capture:!0},gamepad:!0},disableContextMenu:!0,scene:[new LoaderScene]})}}function createGame(){window.game=new MainGame(document.getElementById("canvas")),Config.initGame(window.game)}function log(e){console.log(e)}