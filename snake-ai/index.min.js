/*! Copyright minimindgames.com 11-10-2023 */

class Bug extends Phaser.Physics.Arcade.Sprite{constructor(e,t,i,s){super(e,t,i,s),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed),this.updateTime=0}destroyed(){2===this.type&&this.explode(),this.moveCallback&&this.scene.time.removeEvent(this.moveCallback)}explode(){let e=150*Config.scale;const t=this.scene.add.particles(this.x,this.y,"EffectExplode",{frame:[2],speed:{start:e,end:-e},quantity:5,ease:"Power2",lifespan:1500,maxParticles:50,blendMode:"ADD",alpha:{start:1,end:0}});this.scene.time.delayedCall(2e3,function(){t.destroy()},this)}initMove(){if(this.setBounce(1,1),this.moving=!0,this.rotation=Phaser.Math.Angle.Random(),3===this.type){this.scene.physics.velocityFromRotation(this.rotation,this.body.speed,this.body.velocity),this.body.angularVelocity=300;let e=100*Config.scale;this.body.setMaxSpeed(Phaser.Math.Between(e,1.25*e)),this.moveCallback=this.scene.time.delayedCall(1e3,this.doMove,[],this)}else{this.body.setVelocity(Phaser.Math.Between(50*Config.scale,150*Config.scale));let e=100;1===this.type&&(e+=100),this.body.angularVelocity=Phaser.Math.Between(-e,e),this.scene.physics.velocityFromRotation(this.rotation,this.body.speed,this.body.velocity)}}doMove(){let e=Phaser.Math.Angle.BetweenPoints(this,this.moveToUnit);this.scene.physics.velocityFromRotation(e,this.speed,this.body.acceleration),this.moveCallback=this.scene.time.delayedCall(500,this.doMove,[],this)}update(e){e>this.updateTime&&(this.updateTime=e+1e3)}}class Config{static initGame(e){let t=e.config.width,i=e.config.height;if(t<i){let e=t;t=i,i=e}console.log(t+"x"+i),Config.resolution=t>=2560&&i>=1440?4:t>=1920&&i>=1080?3:t>=1280&&i>=720?2:1,Config.scale=Config.resolution/4,Config.width=640*Config.resolution,Config.height=360*Config.resolution,Config.centerX=640*Config.resolution,Config.height=360*Config.resolution,Config.titleTextStyle={font:48*Config.scale+"px Courier",fill:"#00ff00",align:"center",backgroundColor:"rgba(0,0,0,0.0)",padding:16*Config.resolution},Config.textStyle={font:64*Config.scale+"px Courier",fill:"#00ff00",align:"center",backgroundColor:"rgba(0,0,0,0.25)",padding:16*Config.resolution},-1===window.location.href.indexOf("localhost:8383")&&(Config.loadPath="/snake-ai/img/"),Config.reset()}static setScale(e){e.scale.resize(Config.width,Config.height)}static addLevels(e){Phaser.Utils.Array.Add(Config.levels,Phaser.Utils.Array.Shuffle(e)),Config.levels.push(0)}static reset(){Config.allMissions=[{id:1,desc:"Eat to grow",goalSnakeLength:!0,progress:0,target:1,tail:1,revenge:1,enemies:[1,2],status(e,t){return this.progress=e.player.bodyGroup.getLength(),t.type===this.target&&e.showProgress(this.progress+" / "+this.goal),this.progress>=this.goal}},{id:2,desc:"Boom bombs",goal:6,progress:0,target:2,enemies:[1,2],status(e,t){return t.type===this.target&&(this.progress++,e.showProgress(this.progress+" / "+this.goal)),this.progress>=this.goal}},{id:3,desc:"Go GREEN",goalSnakeLength:!0,grayscale:!0,progress:0,target:1,enemies:[1,1,2,2,5],status(e,t){return t.eatable&&e.showProgress(this.progress+" / "+this.goal),this.progress>=this.goal}},{id:4,desc:"Explode BLADE",goal:1,progress:0,target:3,blade:1,revenge:1,enemies:[1,1,2],status(e,t){return t.type===this.target&&(this.progress++,e.showProgress(this.progress+" / "+this.goal)),this.progress>=this.goal}}],Config.levels=[],Config.addLevels([1]);let e=[2,3,4];Phaser.Utils.Array.Shuffle(e),Config.addLevels(e.splice(0,2)),Config.addLevels(e.splice(0,1)),console.log(Config.levels),Config.missions=[];let t=0;for(let e=0;e<Config.levels.length;e++){let i=Config.levels[e];if(0!==i){t++;for(let e=0;e<Config.allMissions.length;e++){let t=Config.allMissions[e];t.id===i&&Config.missions.push(t)}}else{let e=0;for(let i=Config.missions.length-t;i<Config.missions.length;i++)Config.missions[i].index=++e,Config.missions[i].indexTotal=t;t=0,Config.missions[Config.missions.length-1].showMap=!0}}Config.missions.push({id:0,desc:"All Missions Complete",end:!0}),Config.headRewards=[{id:"Health"},{id:"Shield"}],Config.bodyRewards=[{id:"Length"},{id:"Heal"}],Phaser.Utils.Array.Shuffle(Config.headRewards),Phaser.Utils.Array.Shuffle(Config.bodyRewards),Config.rewards=[];for(let e=0;e<Config.headRewards.length;e++)Config.rewards.push(Config.headRewards[e]),Config.rewards.push(Config.bodyRewards[e]);console.log(Config.rewards),Config.missionsComplete=0,Config.missionsTotal=Config.missions.length,Config.snakeLife=0,Config.snakeLength=6,Config.snakeShield=0,Config.snakeHeal=0,Config.updateMissions(),Config.currentLength=1}static addReward(e,t){let i;switch(t[e?0:1].id){case"Health":Config.snakeLife++,i=`Snake Lifes ${Config.snakeLife+1}`;break;case"Length":Config.snakeLength++,i=`Snake Length ${Config.snakeLength}`;break;case"Shield":Config.snakeShield+=5,i=`Start Shield ${Config.snakeShield} sec`;break;case"Heal":Config.snakeHeal+=3,i=`Start Healing ${Config.snakeHeal}`}return Config.updateMissions(),i}static updateMissions(){for(let e=0;e<Config.allMissions.length;e++){let t=Config.allMissions[e];t.goalSnakeLength&&(t.goal=Config.snakeLength),t.progress=0}}}Config.resolution=1,Config.width=640,Config.height=360,Config.loadPath="img/",Config.highScore=0,Config.missions=null,Config.missionsTotal=0,Config.missionsComplete=0,Config.titleTextStyle=null,Config.textStyle=null,Config.snakeLife=0,Config.snakeLength=6,Config.snakeShield=0,Config.snakeHeal=0,Config.refreshLoad="?t="+Date.now(),Config.currentLength=1;class MapScene extends Phaser.Scene{constructor(){super({key:"MapScene"})}preload(){this.load.path=Config.loadPath,this.resname=["-1","-2","-3",""][Config.resolution-1]}create(){this.input.keyboard.resetKeys(),this.cursors=this.input.keyboard.createCursorKeys(),this.cursorsLeftHand=this.input.keyboard.addKeys("A,D"),this.cameras.main.setRoundPixels(!0),this.missionTitle=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY/3,"",Config.titleTextStyle).setScrollFactor(0).setOrigin(.5);this.pressStartText=this.add.text(this.cameras.main.centerX,.8*this.cameras.main.height,"Press [Left/Right] to CONTINUE",Config.titleTextStyle).setScrollFactor(0).setOrigin(.5),this.pressStartText.visible=!1,this.events.on(Phaser.Scenes.Events.WAKE,()=>{this.showMap()}),this.showMap(!0)}startGame(e){this.pressStartText.visible=!1,this.time.delayedCall(300,()=>{this.scene.switch("MissionScene")},[],this),this.missionTitle.visible=!1}update(){if(this.pressStartText.visible){var e=this.input.activePointer;if(this.cursors.left.isDown||this.cursorsLeftHand.A.isDown||e.isDown||this.cursors.right.isDown||this.cursorsLeftHand.D.isDown)e.isDown?this.usepointer=!0:this.keyleft=this.cursors.left.isDown|this.cursorsLeftHand.A.isDown,this.isStartGame=!0;else if(this.isStartGame){this.isStartGame=!1;let t=!1;this.usepointer?e.x<this.cameras.main.centerX&&(t=!0):t=this.keyleft,this.startGame(t),this.usepointer=!1,this.keyleft=!1}}}loadImage(e){this.load.image(e,e+this.resname+".png"+Config.refreshLoad)}showMap(e){let t="Mission "+(Config.allMissions.length-1-(Config.missions.length-3))+" / "+Config.allMissions.length,i=Config.missions[0];i.end&&(t="Snake Revenge Complete"),this.missionTitle.text=t,this.missionTitle.visible=!0,i.end||this.time.delayedCall(1e3,()=>{this.pressStartText.visible=!0},[],this)}}class RevengeScene extends Phaser.Scene{constructor(){super({key:"RevengeScene"})}preload(){this.load.path=Config.loadPath,this.resname=["-1","-2","-3",""][Config.resolution-1],this.loadImage("CardHealth"),this.loadImage("CardLength"),this.loadImage("CardShield"),this.loadImage("CardHeal")}create(){this.input.keyboard.resetKeys(),this.cursors=this.input.keyboard.createCursorKeys(),this.cursorsLeftHand=this.input.keyboard.addKeys("A,D"),this.cameras.main.setRoundPixels(!0);this.missionTitle=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY/3,"Start Reward",Config.titleTextStyle).setScrollFactor(0).setOrigin(.5),this.missionTitle.setFontSize(128*Config.scale),this.missionTitle.visible=!1;let e=.33*this.cameras.main.width,t=this.cameras.main.centerY;this.cardHead=this.add.image(e,t,"CardHealth"),this.cardHead.visible=!1,this.cardBody=this.add.image(2*e,t,"CardLength"),this.cardBody.visible=!1;this.pressStartText=this.add.text(this.cameras.main.centerX,.8*this.cameras.main.height,"Press [Left/Right] to SELECT",Config.titleTextStyle).setScrollFactor(0).setOrigin(.5),this.showRevenge(!0),this.events.on(Phaser.Scenes.Events.WAKE,()=>{this.showRevenge()}),this.startTitle=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY/2,"",Config.titleTextStyle).setScrollFactor(0).setOrigin(.5),this.startText=this.add.text(this.cameras.main.centerX,this.missionTitle.y+this.missionTitle.height,"",Config.textStyle).setScrollFactor(0).setOrigin(.5)}startGame(e){const t=Config.addReward(e,this.rewards);let i;this.perkSelected=!0,this.pressStartText.visible=!1,this.time.delayedCall(3e3,()=>{this.startTitle.visible=!1,this.startText.visible=!1,this.scene.switch("MissionScene"),this.cardHead.visible=!1,this.cardBody.visible=!1},[],this),this.missionTitle.visible=!1,i=e?this.cardBody:this.cardHead,this.startTitle.text="Revenge Reward",this.startText.text=t,this.startTitle.x=i.x,this.startTitle.y=i.y-this.startTitle.height,this.startTitle.visible=!0,this.startText.x=i.x,this.startText.y=this.startTitle.y+this.startTitle.height,this.startText.visible=!0,this.tweens.add({targets:[i],duration:200,alpha:0,callbackScope:this,onComplete:e=>{e.visible=!1,e.alpha=1}})}update(){if(!this.perkSelected){var e=this.input.activePointer;if(this.cursors.left.isDown||this.cursorsLeftHand.A.isDown||e.isDown||this.cursors.right.isDown||this.cursorsLeftHand.D.isDown)e.isDown?this.usepointer=!0:this.keyleft=this.cursors.left.isDown|this.cursorsLeftHand.A.isDown,this.isStartGame=!0;else if(this.isStartGame){this.isStartGame=!1;let t=!1;this.usepointer?e.x<this.cameras.main.centerX&&(t=!0):t=this.keyleft,this.startGame(t),this.usepointer=!1,this.keyleft=!1}}}loadImage(e){this.load.image(e,e+this.resname+".png"+Config.refreshLoad)}showRevenge(e){this.missionTitle.text=e?"Start Reward":"Select Reward";let t=Config.missions[0];this.pressStartText.visible=!0,this.isStartGame=!1,this.usepointer=!1,this.keyleft=!1,this.perkSelected=!1,this.rewards=Config.rewards.splice(0,2);let[i,s]=this.rewards;this.cardHead.setTexture("Card"+i.id),this.cardBody.setTexture("Card"+s.id),t.end||(this.missionTitle.visible=!0,this.cardHead.visible=!0,this.cardHead.alpha=1,this.cardBody.visible=!0,this.cardBody.alpha=1)}}class MissionScene extends Phaser.Scene{constructor(){super({key:"MissionScene"})}preload(){}create(){let e,t,i,s=this.scene.get("LoaderScene").mission;this.restartGame=s.end,s.end?(e=s.desc,t="Snake Revenge!"):(e=Config.missions.length===Config.missionsTotal-1?"Snake Revenge Begins":s.revenge?"Revenge Mission "+s.index+" / "+s.indexTotal:"Escape Mission "+s.index+" / "+s.indexTotal,t=s.revenge?s.desc:s.desc+" and escape"),this.missionTitle=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY/2,e,Config.titleTextStyle).setScrollFactor(0).setOrigin(.5),this.missionText=this.add.text(this.cameras.main.centerX,this.missionTitle.y+this.missionTitle.height,t,Config.textStyle).setScrollFactor(0).setOrigin(.5),this.isGameOver=!0,this.isGameOverTime=0,s.end?(i="Reload to restart",this.isGameOver=!1):(i="Press [Left/Right] to START",this.isGameOver=!0),this.startText=this.add.text(this.cameras.main.centerX,.75*this.cameras.main.height,i,Config.titleTextStyle).setScrollFactor(0).setOrigin(.5),this.input.keyboard.resetKeys(),this.cursors=this.input.keyboard.createCursorKeys(),this.cursorsLeftHand=this.input.keyboard.addKeys("A,D"),this.cameras.main.setRoundPixels(!0),this.disableInputTime=this.time.now,this.events.on(Phaser.Scenes.Events.WAKE,()=>{this.disableInputTime=this.time.now})}startGame(){this.isGameOver=!1,this.missionTitle.visible=!1,this.missionText.visible=!1,this.startText.visible=!1,this.input.keyboard.removeAllKeys(!0),this.input.keyboard.resetKeys(),0===this.isGameOverTime?this.scene.resume("LoaderScene"):this.scene.get("LoaderScene").scene.restart()}gameOver(e,t,i,s,a){e&&!Config.missions[0].end&&(this.revenge=s.revenge),e&&1!==s.id&&(this.showMap=s.showMap),this.extralife=a,this.isGameOver=!0,this.isWin=e,this.showMission(t,i)}update(){if(!(this.disableInputTime+500>this.time.now))if(this.revenge)this.isGameOverTime<this.time.now&&(this.scene.switch("RevengeScene"),this.revenge=!1);else if(this.showMap)this.isGameOverTime<this.time.now&&(this.scene.switch("MapScene"),this.showMap=!1);else if(this.isGameOver&&!(this.isGameOverTime>this.time.now)){if(this.isGameOverTime>0)return this.extralife||this.isWin||Config.reset(),Config.missions.length<=1&&(this.isGameOver=!1),void this.startGame();var e=this.input.activePointer;(this.cursors.left.isDown||this.cursorsLeftHand.A.isDown||e.isDown||this.cursors.right.isDown||this.cursorsLeftHand.D.isDown)&&this.startGame()}}showMission(e,t){if(this.missionTween&&(this.tweens.remove(this.missionTween),this.missionTitle.alpha=1,this.missionText.alpha=1),t?(this.missionTitle.text=e,this.missionTitle.visible=!0):(this.missionTitle.visible=!1,t=e),this.missionText.text=t,this.missionText.visible=!0,this.isGameOver){let e=this.isWin?3e3:5e3;this.isGameOverTime=this.time.now+e}else this.missionTween=this.tweens.add({targets:[this.missionTitle,this.missionText],duration:2e3,alpha:0,ease:"Cubic.easeIn",callbackScope:this,onComplete:e=>{this.missionTween=null,this.missionTitle.visible=!1,this.missionTitle.alpha=1,this.missionText.visible=!1,this.missionText.alpha=1}})}}class LoaderScene extends Phaser.Scene{constructor(){super({key:"LoaderScene",visible:!1}),this.loadProgress=0}preload(){this.load.path=Config.loadPath,this.resname=["-1","-2","-3",""][Config.resolution-1];let e=-1;Config.origLength=Config.currentLength;this.mission=Config.missions[0],e=this.mission.id,Config.missions.splice(0,1),this.loadSpriteSheet("asteroids",32,32),this.loadImage("snakehead"),this.loadImage("snakebite"),this.loadImage("snakebody"),this.loadImage("snaketail"),this.loadImage("snakeshield"),this.loadImage("Blade"),this.loadImage("Bomb");for(let e=1;e<=3;e++)this.loadImage("planet"+e);1===e&&(this.loadImage("left"),this.loadImage("right")),this.loadImage("EffectTeleport"),this.loadSpriteSheet("EffectExplode",64,64),this.loadSpriteSheet("virus",64,64),this.loadSpriteSheet("virus2",64,64),this.loadSpriteSheet("Green",80,80),this.loadSpriteSheet("teleport",128,128)}create(){Config.setScale(this),this.snap=this.textures.get("asteroids").getSourceImage().height,this.width=2560*Config.scale/this.snap,this.height=2560*Config.scale/this.snap;let e=this.snap*this.width,t=this.snap*this.height;this.w=e,this.h=t,this.overlapColliders=[],this.missionHelper=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,"",Config.titleTextStyle).setScrollFactor(0).setOrigin(.5),this.missionHelper.visible=!1,this.buildingGroup=this.physics.add.staticGroup(),this.barrierGroup=this.physics.add.staticGroup(),this.enemyGroup=this.physics.add.group({runChildUpdate:!0}),this.teleport=this.buildingGroup.create(e/2,t/2,"teleport"),this.teleport.visible=!1;let i=[];i.push(this.teleport);for(let s=1;s<=3;s++){let a=3*this.teleport.width;const h=new Phaser.Geom.Rectangle(a,a,e-a,t-a),n=[[1,11639188],[.8,9664102],[.6,13877453]];for(;n.length>0;){let e=this.randomXY(i,a,h),t=this.barrierGroup.create(e.x,e.y,"planet"+s);const o=n.pop();t.setTint(o.pop()),t.setScale(o.pop()),t.body.setSize(t.width/2,t.height/2),i.push(t)}}i.unshift();let s=this.snap,a=s/2,h=this.textures.get("asteroids").frameTotal-2;for(let e=0;e<this.width;e++)this.barrierGroup.create(a+s*e,a,"asteroids",Phaser.Math.Between(0,h)),this.barrierGroup.create(a+s*e,s*this.height-a,"asteroids",Phaser.Math.Between(0,h));for(let e=0;e<this.height;e++)this.barrierGroup.create(a,a+s*e,"asteroids",Phaser.Math.Between(0,h)),this.barrierGroup.create(s*this.width-a,a+s*e,"asteroids",Phaser.Math.Between(0,h));new Phaser.Geom.Rectangle(.2*e,.2*t,.6*e,.6*t);let n=new Phaser.Geom.Point(e/2,t/2);this.player=new Player(this),this.time.delayedCall(100,this.addBug,[],this),this.input.keyboard.resetKeys(),this.cursors=this.input.keyboard.createCursorKeys(),this.cursorsLeftHand=this.input.keyboard.addKeys("A,D"),this.input.mouse&&this.input.mouse.disableContextMenu(),this.pointer={left:!1,right:!1},this.text=this.add.text(10,10,"",{font:64*Config.scale+"px Courier",fill:"#00ff00"}).setScrollFactor(0),this.cameras.main.setBounds(0,0,e,t),this.physics.world.setBounds(0,0,e,t),this.addOverlapCollider(this.physics.add.collider(this.enemyGroup,this.barrierGroup)),this.score=0,this.scoreTimer=this.time.addEvent({delay:1e3,callback:function(){this.score++},callbackScope:this,loop:!0}),this.anims.exists("virus")||this.anims.create({key:"virus",frameRate:7,frames:this.anims.generateFrameNumbers("virus"),repeat:-1}),this.anims.exists("Green")||this.anims.create({key:"Green",frameRate:7,frames:this.anims.generateFrameNumbers("Green"),repeat:-1}),this.anims.exists("teleport")||this.anims.create({key:"teleport",frameRate:30,frames:this.anims.generateFrameNumbers("teleport"),repeat:-1}),this.physics.world.timeScale=1,this.player.init(n),this.scene.pause(),this.scene.run("MissionScene"),this.missionScene=this.scene.get("MissionScene"),this.snakeShield=0,this.events.on("resume",()=>{this.time.delayedCall(0,()=>{this.anims.resumeAll(),0===this.snakeShield&&(this.snakeShield=1e3*Config.snakeShield,this.snakeShield+=this.time.now,this.snakeShield>0&&(this.headShield=this.physics.add.sprite(n.x,n.y,"snakeshield"),this.tweens.add({targets:this.headShield,duration:1e3*Config.snakeShield,alpha:0,ease:"Cubic.easeIn"}),this.headShield.preUpdate=(()=>{if(this.player.head){if(!this.player.head.visible||this.snakeShield<this.time.now)return void this.headShield.destroy();this.headShield.x=this.player.head.x,this.headShield.y=this.player.head.y}})))},this)}),this.mission.complete=!1,this.isGameOver=!1,this.mission.blade&&(this.blade=this.createBug(3,this.player.head.x,this.player.head.y),this.blade.moveToUnit=this.player.head)}showProgress(e){this.missionHelperTween&&(this.tweens.remove(this.missionHelperTween),this.missionHelper.alpha=1),this.missionHelper.x=this.player.head.x-this.cameras.main.worldView.x,this.missionHelper.y=this.player.head.y-this.cameras.main.worldView.y,this.player.head.y>this.cameras.main.centerY?this.missionHelper.y-=this.player.head.height:this.missionHelper.y+=this.player.head.height,this.missionHelper.text=e,this.missionHelper.visible=!0,this.missionHelperTween=this.tweens.add({targets:this.missionHelper,duration:1500,alpha:0,ease:"Cubic.easeIn",callbackScope:this,onComplete:e=>{this.missionTween=null,this.missionHelper.visible=!1,this.missionHelper.alpha=1}})}addOverlapCollider(e){if(null===e)for(const e of this.overlapColliders)this.physics.world.removeCollider(e);this.overlapColliders.push(e)}teleportEffect(e,t=2500,i=3){let s,a=this.add.image(e.x,e.y,"EffectTeleport");switch(e.type){case-1:s=11206604;break;case 1:s=10066431;break;case 2:s=16751001;break;case 3:s=16711680;break;case 4:s=10092441;break;default:s=16777215}a.setTint(s),a.scale=0,this.tweens.add({targets:a,scale:i,ease:"Linear",duration:t,alpha:0,rotation:2*Math.PI,callbackScope:this,onComplete:function(){a.destroy()}}),e.scale=0,e.alpha=0,e.visible=!0,this.tweens.add({targets:e,scale:1,ease:"Linear",duration:1500,alpha:1,delay:150,rotation:2*Math.PI,callbackScope:this,onComplete:function(){}})}update(e,t){var i=this.input.activePointer;i.isDown?i.x<this.cameras.main.centerX?(this.pointer.left=!0,this.pointer.right=!1):(this.pointer.left=!1,this.pointer.right=!0):(this.pointer.left=!1,this.pointer.right=!1),this.player.update(t,this.cursors,this.cursorsLeftHand,this.pointer),this.text.visible=!1}gameOver(e){if(this.isGameOver)return;Config.currentLength=this.player.bodyGroup.getLength(),Config.currentLength>Config.snakeLength&&(Config.currentLength=Config.snakeLength),this.isGameOver=!0,this.addOverlapCollider(null),this.time.removeEvent(this.addCallback),this.time.removeEvent(this.scoreTimer);let t,i=null,s=!1;if(e&&this.mission.revenge)t="Mission complete",i="Snake Revenge!",this.cameras.main.fadeOut(4e3),this.player.isGameOver=!0;else if(e){this.cameras.main.fadeOut(4e3);let e=this.teleport;this.tweens.add({targets:e,scale:0,ease:"Cubic.easeIn",duration:3e3,alpha:0,rotation:2*Math.PI,onComplete:function(){e.destroy()}}),this.tweens.add({targets:this.player.bodyGroup.getChildren(),ease:"Cubic.easeIn",duration:2e3,alpha:0,x:this.teleport.x,y:this.teleport.y,rotation:2*Math.PI,onComplete:function(){}}),this.tweens.add({targets:this.player.head,ease:"Cubic.easeIn",duration:2e3,alpha:0,x:this.teleport.x,y:this.teleport.y,rotation:2*Math.PI,onComplete:function(){}}),t="Snake Escape!",i=null}else this.cameras.main.fadeOut(6e3),t="Lost in Mission",Config.snakeLife>0?(Config.missions.unshift(this.mission),this.mission.progress=0,i=`Snake Life 1/${Config.snakeLife} to RETRY`,Config.snakeLife--,s=!0,Config.currentLength=Config.origLength):i="GAME OVER";this.missionScene.gameOver(e,t,i,this.mission,s);let a=(this.mission.revenge,2500);e||(a=5e3),this.time.delayedCall(a,()=>{this.physics.pause(),this.anims.pauseAll()},this)}gameOverRestart(){Config.missions.length>0?this.scene.restart():this.time.delayedCall(5e3,()=>{Config.restart(),this.scene.restart()},this)}loadSpriteSheet(e,t,i){let s=Config.scale*t,a=Config.scale*i;this.load.spritesheet(e,e+this.resname+".png"+Config.refreshLoad,{frameWidth:s,frameHeight:a})}loadImage(e){this.load.image(e,e+this.resname+".png"+Config.refreshLoad)}randomX(){const e=this.snap,t=e/2;return Phaser.Math.Between(1,this.width-1)*e+t}randomY(){const e=this.snap,t=e/2;return Phaser.Math.Between(1,this.height-1)*e+t}randomXY(e,t,i){let s=new Phaser.Geom.Point;t*=t;for(let a=0;a<100;a++){if(s.x=this.randomX(),s.y=this.randomY(),i&&!Phaser.Geom.Rectangle.ContainsPoint(i,s))continue;let a;for(a=0;a<e.length;a++){let i=e[a];if(Phaser.Math.Distance.BetweenPointsSquared(s,i)<t)break}if(a===e.length)break}return s}createBug(e,t,i){var s=e;let a;e||(s=Phaser.Math.RND.pick(this.mission.enemies)),a=t?new Phaser.Geom.Point(t,i):this.randomXY([this.player.head],10*this.snap);let h=new Bug(this,a.x,a.y,["virus","Bomb","Blade","Green","virus2"][s-1]);h.type=s;let n=1;return 1===s&&h.play("virus"),4===s&&h.play("Green"),1!==s&&4!==s&&5!==s||(h.eatable=!0),3===s&&(n=3),this.enemyGroup.add(h,!0),this.teleportEffect(h,1500,n),h.moveCallback=this.time.delayedCall(1500,()=>{h.initMove()},[],this),h}addBug(e){if(this.mission.complete)return;this.createBug(e);this.addCallback=this.time.delayedCall(300,this.addBug,[],this)}removeBug(e){if(!this.isGameOver){if(!this.mission.complete){if(!1||this.mission.status(this,e))if(this.mission.complete=!0,this.mission.revenge){this.player.overlapBuilding(),this.time.delayedCall(200,function(){this.cameras.main.flash(2500)},[this],this);let t=this.player.bodyGroup.getChildren();t.length>Config.snakeLength+1&&this.player.cutTail(t[Config.snakeLength]);let i=this.enemyGroup.getChildren();for(let t=i.length-1;t>=0;t--)i[t]!==e&&(i[t].type=-1,i[t].destroy())}else this.missionScene.showMission("Mission complete","Teleport to ESCAPE"),this.teleport.visible||(this.teleport.type=-1,this.teleportEffect(this.teleport),this.teleport.play("teleport"),this.teleport.scale=0,this.teleport.alpha=0,this.tweens.add({targets:this.teleport,ease:"Linear",duration:2e3,scale:1,alpha:1,onComplete:function(){}}),this.tweens.add({targets:this.teleport,ease:"Linear",duration:2500,repeat:-1,rotation:2*Math.PI,onComplete:function(){}}),this.time.delayedCall(2e3,()=>{this.addOverlapCollider(this.physics.add.overlap(this.player.head,this.teleport,this.player.overlapBuilding,null,this.player))},[],this))}e.destroy()}}}class Player{constructor(e){this.scene=e,this.bodyGroup=e.physics.add.group(),this.bulletGroup=e.physics.add.group()}init(e){let t=this.scene;this.path=[],this.pathRotation=[],this.path.push(new Phaser.Geom.Point(e.x,e.y)),this.pathRotation.push(0),this.pathSpacer=10,Config.currentLength+=Config.snakeHeal,Config.currentLength>Config.snakeLength&&(Config.currentLength=Config.snakeLength);let i=Config.currentLength;for(let t=0;t<i;t++){let t=this.addBody(e);this.scene.mission.grayscale&&t.setTexture("snaketail")}let s=t.physics.add.sprite(e.x,e.y,"snakehead");s.rotation=Phaser.Math.Angle.Random(),t.cameras.main.startFollow(s,!0,0,.05),s.setCollideWorldBounds(!0),s.body.setVelocity(300*Config.scale),s.body.setSize(s.width/2,s.height/2),s.setDepth(1),this.head=s,1===t.mission.id&&(this.head.rotation=-Math.PI/2,this.leftSprite=t.add.sprite(e.x,e.y,"left",0,!0),this.leftSprite.setOrigin(2,0),this.leftSprite.rotation=this.head.rotation+Math.PI/2,this.leftSprite.preUpdate=(()=>{this.leftSprite.visible=!this.isGameOver,this.leftSprite.x=this.head.x,this.leftSprite.y=this.head.y,this.leftSprite.rotation=this.head.rotation+Math.PI/2}),this.rightSprite=t.add.sprite(e.x,e.y,"right",0,!0),this.rightSprite.preUpdate=(()=>{this.rightSprite.visible=!this.isGameOver,this.rightSprite.x=this.head.x,this.rightSprite.y=this.head.y,this.rightSprite.rotation=this.head.rotation+Math.PI/2}),this.rightSprite.setOrigin(-1,0),this.rightSprite.rotation=this.head.rotation+Math.PI/2,this.scene.time.delayedCall(1e4,function(){this.leftSprite.destroy(),this.rightSprite.destroy()},[this],this)),t.addOverlapCollider(t.physics.add.collider(this.head,this.bodyGroup,this.collideHeadBody,null,this)),t.addOverlapCollider(t.physics.add.collider(this.head,t.barrierGroup,this.collideHeadBarrier,null,this)),t.addOverlapCollider(t.physics.add.collider(this.head,this.bulletGroup)),t.addOverlapCollider(t.physics.add.overlap(this.head,t.enemyGroup,this.collideHeadEnemy,null,this)),t.addOverlapCollider(t.physics.add.collider(this.bodyGroup,t.enemyGroup,this.collideBodyEnemy,null,this)),t.addOverlapCollider(t.physics.add.collider(this.bulletGroup,t.enemyGroup,this.collideBulletEnemy,null,this)),this.delta=0,this.collideBarrierTimeout=0,this.collideHeadBodyTime=0,this.isGameOver=!1,this.gameOvertime=1e3}explodeHead(e){let t=150*Config.scale;const i=this.scene.add.particles(e.x,e.y,"EffectExplode",{frame:[0],speed:{start:.67*t,end:.67*-t},quantity:5,ease:"Power2",lifespan:1e3,maxParticles:100,blendMode:"ADD",alpha:{start:1,end:0}});this.scene.time.delayedCall(2e3,function(){i.destroy()},this)}explode(e){let t=150*Config.scale;const i=this.scene.add.particles(e.x,e.y,"EffectExplode",{frame:[3],speed:{start:t,end:-t},quantity:1,ease:"Power2",lifespan:500,maxParticles:5,blendMode:"ADD",alpha:{start:1,end:0}});this.scene.time.delayedCall(2e3,function(){i.destroy()},this)}addBody(e){let t=this.bodyGroup.getLength()<Config.snakeLength?"snakebody":"snaketail",i=this.scene.physics.add.sprite(e.x,e.y,t);this.head?i.rotation=this.head.rotation:i.rotation=-Math.PI/2,i.body.setSize(i.width/2,i.height/2),i.collideTime=this.scene.time.now+200,this.bodyGroup.add(i);for(let e=0;e<this.pathSpacer;e++)this.path.push(new Phaser.Geom.Point(i.x,i.y)),this.pathRotation.push(0);return i}cutTail(e){for(let t=null;t!==e;){t=this.bodyGroup.getChildren().pop(),this.scene.mission.goalSnakeLength&&this.scene.mission.progress>this.bodyGroup.getLength()&&(this.scene.mission.progress=this.bodyGroup.getChildren().length),this.bulletGroup.add(t);for(let e=0;e<this.pathSpacer;e++)this.path.pop(),this.pathRotation.pop();t.setTexture("snaketail"),t.body.setVelocity(Phaser.Math.Between(100*Config.scale,200*Config.scale)),t.rotation=Phaser.Math.Angle.Random(),this.scene.physics.velocityFromRotation(t.rotation,t.body.speed,t.body.velocity),this.scene.tweens.add({targets:t,duration:Phaser.Math.Between(2e3,3500),scale:0,ease:"Cubic.easeIn",callbackScope:this,onComplete:e=>{e.effectTimer&&this.scene.time.removeEvent(e.effectTimer),e.destroy()}})}if(0===this.bodyGroup.getChildren().length){if(this.isGameOver)return;this.isGameOver=!0,this.head.visible=!1,this.explodeHead(this.head),this.scene.gameOver(!1)}}collideHeadBody(e,t){if(this.collideHeadBodyTime>this.scene.time.now)return;if(this.scene.snakeShield>this.scene.time.now)return;if(this.collideHeadBodyTime=this.scene.time.now+200,t.collideTime>this.scene.time.now)return;let i=this.bodyGroup.getChildren().indexOf(t);if(0===i)return;let s=new Phaser.Geom.Point(this.head.x,this.head.y),a=Math.floor((i+1)/2),h=2*this.scene.snap*(2*this.scene.snap);for(let e=-1;e<a;e++){let t,n;-1===e?(t=this.head,n=this.bodyGroup.getChildren()[i]):(t=this.bodyGroup.getChildren()[e],n=this.bodyGroup.getChildren()[e+a]),s.x=(t.x+n.x)/2,s.y=(t.y+n.y)/2;let o=new Phaser.Geom.Line(t.x,t.y,n.x,n.y).getPoints(0,2*this.scene.snap);for(let e=0;e<o.length;e++)if(this.explode(o[e]),this.explodeEnemies(o[e],h),this.scene.isGameOver)return}this.cutTail(t)}explodeEnemies(e,t){for(let i=this.scene.enemyGroup.getChildren().length-1;i>=0;i--){let s=this.scene.enemyGroup.getChildren()[i];Phaser.Math.Distance.BetweenPointsSquared(s,e)<t&&this.scene.removeBug(s)}}collideHeadBarrier(e,t){this.scene.snakeShield>this.scene.time.now||0===this.bodyGroup.getLength()||this.scene.time.now<this.collideBarrierTimeout||(this.collideBarrierTimeout=this.scene.time.now+100,this.cutTail(this.bodyGroup.getChildren()[this.bodyGroup.getChildren().length-1]),this.scene.cameras.main.shake(200,.01))}collideHeadEnemy(e,t){if(!t.moving)return;if(!this.head.visible)return;let i=!0;if(this.scene.mission.grayscale&&t.eatable&&(t.type===this.scene.mission.target?this.scene.mission.progress<this.scene.mission.goal&&(this.scene.mission.progress<this.bodyGroup.getLength()&&(this.bodyGroup.getChildren()[this.scene.mission.progress].setTexture("snakebody"),i=!1),this.scene.mission.progress++):(this.scene.mission.progress>0&&(this.scene.mission.progress--,this.bodyGroup.getChildren()[this.scene.mission.progress].setTexture("snaketail")),i=!1)),t.eatable)i&&this.addBody(this.bodyGroup.getLast()||this.head),this.head.setScale(.6666),this.head.setTexture("snakebite"),this.scene.tweens.add({targets:this.head,duration:75,scale:1,yoyo:!0,callbackScope:this,onComplete:function(){this.head.setTexture("snakehead"),this.head.setScale(1)}});else if(this.scene.snakeShield<this.scene.time.now){let e=this.bodyGroup.getChildren().length-Phaser.Math.Between(3,4);e<=0&&(e=0),this.cutTail(this.bodyGroup.getChildren()[e]),this.scene.cameras.main.shake(200,.01)}3!==t.type&&this.scene.removeBug(t)}collideBodyEnemy(e,t){if(t.moving&&(2===t.type&&this.scene.removeBug(t),3===t.type)){let e=this.bodyGroup.getChildren();for(let t=0;t<e.length;t++)this.flashColor(e[t],65280)}}collideBulletEnemy(e,t){t.moving&&2===t.type&&(e.destroy(),this.scene.removeBug(t))}overlapBuilding(e,t){if(this.isGameOver)return;this.isGameOver=!0,this.bodyGroup.getChildren().length-1>=Config.snakeLength&&this.cutTail(this.bodyGroup.getChildren()[Config.snakeLength]),this.scene.gameOver(!0)}update(e,t,i,s){this.isGameOver&&(this.gameOvertime+=e,this.scene.physics.world.timeScale+=this.gameOvertime/1e3/20);let a=this.head,h=this.path,n=this.pathSpacer;if(a.setAcceleration(0),a.setDrag(0),a.body.angularVelocity=0,this.head.visible&&((t.left.isDown||i.A.isDown||s.left)&&(a.body.angularVelocity=-200),(t.right.isDown||i.D.isDown||s.right)&&(a.body.angularVelocity=200)),(!this.isGameOver||this.scene.mission.revenge)&&(this.scene.physics.velocityFromRotation(a.rotation,a.body.speed,a.body.velocity),this.delta+=e,this.delta>16*this.scene.physics.world.timeScale)){this.delta-=16*this.scene.physics.world.timeScale;let e=this.path.pop();e.x=a.x,e.y=a.y,this.path.unshift(e);let t=this.pathRotation.pop();t=a.rotation,this.pathRotation.unshift(t);let i=this.bodyGroup.getChildren();for(let e=0,t=i.length;e<t;e++)i[e].x=h[(e+1)*n].x,i[e].y=h[(e+1)*n].y,i[e].rotation=this.pathRotation[(e+1)*n]}}flashColor(e,t){e.effectTimer||(e.setTint(t),e.effectTimer=this.scene.time.delayedCall(250,function(){e.setTint(16777215),e.effectTimer=null},this))}}class MainGame extends Phaser.Game{constructor(e){let t=window.innerWidth,i=window.innerHeight;if(t<i){let e=t;t=i,i=e}super({key:e.id,type:Phaser.AUTO,parent:e,width:t,height:i,backgroundColor:"#202f53",audio:{noAudio:!0},physics:{default:"arcade",arcade:{}},scale:{mode:Phaser.Scale.NO_SCALE},input:{touch:{capture:!0},gamepad:!0},disableContextMenu:!0,scene:[new LoaderScene,MissionScene,RevengeScene,MapScene]})}}function createGame(){window.game=new MainGame(document.getElementById("canvas")),Config.initGame(window.game)}function log(e){console.log(e)}