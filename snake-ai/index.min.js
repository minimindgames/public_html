/*! Copyright minimindgames.com 20-10-2023 */

class Bug extends Phaser.Physics.Arcade.Sprite{constructor(e,t,s,i){super(e,t,s,i),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed),this.updateTime=0}destroyed(){if(this.moveToUnits){for(let e=0;e<this.moveToUnits.length;e++)this.moveToUnits[e].moveToUnit=null;this.moveToUnits=[],this.damage.destroy()}2===this.type&&this.explode(),this.moveCallback&&this.scene.time.removeEvent(this.moveCallback)}removeTarget(e){for(let t=0;t<this.moveToUnits.length;t++)if(this.moveToUnits[t]===e){this.moveToUnits.splice(t,1);break}}explode(){let e=150*Config.scale;const t=this.scene.add.particles(this.x,this.y,"EffectExplode",{frame:[2],speed:{start:e,end:-e},quantity:5,ease:"Power2",lifespan:1500,maxParticles:50,blendMode:"ADD",alpha:{start:1,end:0}});this.scene.time.delayedCall(2e3,function(){t.destroy()},this)}initMove(){if(5!==this.type&&6!==this.type){if(7===this.type&&this.scene.tweens.add({targets:this,duration:Phaser.Math.Between(5e3,7500),scale:0,ease:"Cubic.easeIn",callbackScope:this,onComplete:()=>{this.destroy()}}),this.setBounce(1,1),this.moving=!0,this.collideDelay=0,this.rotation=Phaser.Math.Angle.Random(),3===this.type||4===this.type||8===this.type){this.actionTime=this.scene.time.now,this.action=1,this.scene.physics.velocityFromRotation(this.rotation,this.body.speed,this.body.velocity),8!==this.type&&(this.body.angularVelocity=300);let e=100*Config.scale;this.body.setMaxSpeed(Phaser.Math.Between(e,1.25*e)),4===this.type&&this.body.setMaxSpeed(Phaser.Math.Between(2*e,2*e*1.25)),8===this.type&&this.body.setMaxSpeed(Phaser.Math.Between(.5*e,.75*e)),this.moveCallback=this.scene.time.delayedCall(1e3,this.doMove,[],this)}else{let e=Phaser.Math.Between(50*Config.scale,150*Config.scale);this.body.setMaxSpeed(e),this.body.setVelocity(e);let t=100;1===this.type&&(t+=100),this.body.angularVelocity=Phaser.Math.Between(-t,t),this.scene.physics.velocityFromRotation(this.rotation,this.body.speed,this.body.velocity)}8===this.type&&this.body.setSize(this.width/2,this.height/2)}else this.moving=!0}doMove(){if(this.collideDelay>this.scene.time.now)return void(this.moveCallback=this.scene.time.delayedCall(500,this.doMove,[],this));let e=this.moveToUnit;if(e&&8===e.type&&0!==this.action&&(e=this.escapeUnit),e){let t=Phaser.Math.Angle.BetweenPoints(this,e);this.scene.physics.velocityFromRotation(t,this.speed,this.body.acceleration),this.moveCallback=this.scene.time.delayedCall(500,this.doMove,[],this)}else{e=this.escapeUnit;const t=this.scene.w/4*(this.scene.w/4);let s,i=Phaser.Math.Distance.BetweenPointsSquared(this,e),a=350*Config.scale;s=i<t?Phaser.Math.Angle.BetweenPoints(this,e)+Math.PI:i>2*t?Phaser.Math.Angle.BetweenPoints(this,e):Phaser.Math.Angle.Random(),this.scene.physics.velocityFromRotation(s,a,this.body.acceleration),this.moveCallback=this.scene.time.delayedCall(100,this.doMove,[],this)}if(8===this.type){if(this.actionTime>0&&this.actionTime<this.scene.time.now&&(this.actionTime=this.scene.time.now+Phaser.Math.Between(2e3,3e3),this.action=Phaser.Math.Between(0,3),0===this.action&&0===this.scene.mission.level&&(this.action=2),1===this.action&&this.scene.mission.level<2&&(this.action=0),0===this.action?this.setTint(16711680):1===this.action?this.setTint(65280):2===this.action?this.setTint(255):this.clearTint()),0===this.action){let e=this.scene.enemyGroup.getChildren();for(let t=e.length-1;t>=0;t--){let s=e[t];{let e=Phaser.Math.Angle.BetweenPoints(s,this);this.scene.physics.velocityFromRotation(e,s.body.speed,s.body.acceleration)}}}if(1===this.action){let e=this.scene.enemyGroup.getChildren();for(let t=e.length-1;t>=0;t--){let s=e[t];{let e=Phaser.Math.Angle.BetweenPoints(s,this.escapeUnit);this.scene.physics.velocityFromRotation(e,s.body.speed,s.body.acceleration)}}}if(2===this.action){let e=this.scene.enemyGroup.getChildren();for(let t=e.length-1;t>=0;t--){let s=e[t];if(1===s.type){Phaser.Math.Distance.BetweenPointsSquared(s,this)<4*(this.width*this.width)&&(s.moving=!1,this.pullSprite(s))}}}}}pullSprite(e){this.scene.tweens.add({targets:e,duration:300,x:this.x,y:this.y,callbackScope:this,onComplete:()=>{e.destroy()}})}update(e){e>this.updateTime&&(this.updateTime=e+1e3)}}class Card extends Phaser.GameObjects.Container{constructor(e,t,s,i,a){super(e,t,s),e.add.existing(this),this.containerImage=e.add.image(0,0,"Card"),this.setSize(this.containerImage.width,this.containerImage.height),this.add(this.containerImage);let h=e.add.image(0,0,"Card"+(a?"Head":"Body")).setOrigin(2.25,2.35);this.add(h),this.costText=this.scene.add.text(0,0,i.id,Config.cardTextStyle).setOrigin(.5,-1.55),this.add(this.costText);let n=e.add.image(0,0,"CardIcons",i.frame).setOrigin(2.25,2.35).setOrigin(.5);this.add(n),this.icon=n}setReward(e){this.icon.setFrame(e.frame),this.costText.text=e.id}setCard(e){if(null===e){for(;this.getAt(1);)this.removeAt(1,!0);this.card=null}else this.card=e,this.add(new Phaser.GameObjects.Image(this.scene,0,0,"sprites",this.card.name+".png")),this.card.container=this,this.card.costImage=this.scene.add.image(this.width/2,this.height/2,"Card-costs",this.card.cost),this.card.costImage.x-=this.card.costImage.width/2,this.card.costImage.y-=this.card.costImage.height/2,this.add(this.card.costImage),this.card.costImage.visible=!0;this.active=null!==e}}class Config{static initGame(e){let t=e.config.width,s=e.config.height;if(t<s){let e=t;t=s,s=e}Config.resolution=t>=2560&&s>=1440?4:t>=1920&&s>=1080?3:t>=1280&&s>=720?2:1,Config.scale=Config.resolution/4,Config.width=640*Config.resolution,Config.height=360*Config.resolution,Config.centerX=640*Config.resolution,Config.height=360*Config.resolution,Config.titleTextStyle={font:48*Config.scale+"px Courier",fill:"#00ff00",align:"center",backgroundColor:"rgba(0,0,0,0.0)",padding:16*Config.resolution},Config.textStyle={font:64*Config.scale+"px Courier",fill:"#00ff00",align:"center",backgroundColor:"rgba(0,0,0,0.25)",padding:16*Config.resolution},Config.cardTextStyle={font:128*Config.scale+"px Courier",fill:"#ffffff",align:"center"},-1===window.location.href.indexOf("localhost:8383")&&(Config.loadPath="/snake-ai/img/"),Config.reset()}static setScale(e){e.scale.resize(Config.width,Config.height)}static addLevels(e,t){Config.levels=Config.levels.concat(e),this.prevLevel=this.lastLevel,this.lastLevel=Config.levels[Config.levels.length-1],t&&Config.levels.push(0)}static reset(){Config.allMissions=[{id:1,do:"bite",desc:"Eat to Grow",goalSnakeLength:!0,progress:0,target:1,levels:[{enemies:[1,2]},{enemies:[1,2,2]},{enemies:[1,2,2,2]},{enemies:[1,2,2,2,2]}],status(e,t){return this.progress=e.player.bodyGroup.getLength(),t.type===this.target&&e.showProgress(this.progress+" / "+this.goal),this.progress>=this.goal}},{id:2,do:"explode",desc:"Boom Bombs",goalOriginal:6,progress:0,target:2,levels:[{enemies:[1,2,2]},{enemies:[1,2,2,2]},{enemies:[1,2,2,2]},{enemies:[1,2,2,2,2]}],status(e,t){return t.type===this.target&&(this.progress++,e.showProgress(this.progress+" / "+this.goal)),this.progress>=this.goal}},{id:3,do:"bite",desc:"Back to Green",goalSnakeLength:!0,grayscale:!0,progress:0,target:1,levels:[{enemies:[1,1,2,2,7]},{enemies:[1,2,7]},{enemies:[1,2,5,7]},{enemies:[1,2,2,7]}],status(e,t){return t.eatable&&e.showProgress(this.progress+" / "+this.goal),this.progress>=this.goal}},{id:4,do:"explode",desc:"Destroy Blade",goalLevel:!0,progress:0,target:3,blade:1,levels:[{enemies:[1,2]},{enemies:[1,2]},{enemies:[1,2]},{enemies:[1,2]}],status(e,t){return t.type===this.target&&(this.progress++,e.showProgress(this.progress+" / "+this.goal),e.destroyBot(t)),this.progress>=this.goal}},{id:5,do:"bite",desc:"Recharge Teleport",goalOriginal:8,progress:0,target:5,levels:[{enemies:[1,2]}],status(e,t){return t.type===this.target&&e.player.bodyGroup.getLength()<=Config.snakeLength&&e.showProgress("Grow more Tail"),this.progress>=this.goal&&(e.teleportDamage.visible=!1,e.teleportDamaged.visible=!1,e.missionComplete(null),!0)}},{id:6,do:"bite",desc:"Get more Speed",goalOriginal:2,progress:0,target:6,levels:[{enemies:[1,1,2]}],status(e,t){return t.type===this.target&&(this.progress++,e.showProgress(this.progress+" / "+this.goal)),this.progress>=this.goal}},{id:7,do:"bite",desc:"Chase Bugs",goalOriginal:4,goalMultiply:1,progress:0,target:4,levels:[{enemies:[1,2]},{enemies:[1,2,2]},{enemies:[1,2,2,2]},{enemies:[1,2,2,2,2]}],status(e,t){return t.type===this.target&&(this.progress++,e.createBug(4)),e.showProgress(this.progress+" / "+this.goal),this.progress>=this.goal}},{id:8,do:"expload",desc:"Destroy Master",goalOriginal:1,progress:0,target:8,levels:[{enemies:[1,2]},{enemies:[1,2,2]},{enemies:[1,2,2,2]},{enemies:[1,2,2,2,2]}],status(e,t){return t.type===this.target&&this.progress++,this.progress>=this.goal}}],Config.levels=[],this.lastLevel=-1,Config.addLevels([1]);let e=[];const t=[1,2,3,5,6,7],s=[4,8];let i=[...t];i.splice(0,1),Phaser.Utils.Array.Shuffle(i),Config.addLevels(i.splice(0,2));let a=[...s];Phaser.Utils.Array.Shuffle(a),Config.addLevels(a.splice(0,1),!0),Config.addLevels(i.splice(0,3)),a=[...s],Phaser.Utils.Array.Shuffle(a),Config.addLevels(a.splice(0,1),!0),e=[];for(let e=2;e<=3;e++){let e=[...t];do{Phaser.Utils.Array.Shuffle(e)}while(this.prevLevel===e[0]||this.prevLevel===e[1]||this.lastLevel===e[0]||this.lastLevel===e[1]);Config.addLevels(e.splice(0,3));let i=[...s];Phaser.Utils.Array.Shuffle(i),Config.addLevels(i.splice(0,1),!0),Config.addLevels(e.splice(0,3)),i=[...s],Phaser.Utils.Array.Shuffle(i),Config.addLevels(i.splice(0,1),!0)}Config.missions=[];let h=0,n=0,o=-1;for(let e=0;e<Config.levels.length;e++){let t,s=Config.levels[e];if(0!==s){for(h++,t=0;t<Config.allMissions.length;t++){let e=Config.allMissions[t];if(e.id===s){let t=Object.assign({},e);8===++o&&(o=0,n++),t.level=n,Config.missions.push(t);break}}t===Config.allMissions.length&&console.log("Not found "+t)}else{let e=0;for(let t=Config.missions.length-h;t<Config.missions.length;t++)Config.missions[t].index=++e,Config.missions[t].indexTotal=h;h=0,Config.missions[Config.missions.length-1].showMap=!0}}Config.missions[0].level=0,Config.missions[0].begin=!0;for(let e=0;e<Config.missions.length-3;e+=4)Config.missions[e+3].revenge=!0;for(let e=0;e<Config.missions.length;e++)Config.missions[e].index=e;Config.missions[Config.missions.length-1].last=!0,Config.missions.push({id:0,desc:"All Missions Complete",end:!0});Config.beginHeadReward={id:"Life",frame:0},Config.beginBodyReward={id:"Heal",frame:4},Config.headRewards=[{id:"Shield",frame:1},{id:"Helmet",frame:2},{id:"Speed",frame:3}],Config.bodyRewards=[{id:"Length",frame:5},{id:"Tail",frame:6},{id:"Agility",frame:7}],Config.rewards=[],Config.rewards.push(Object.assign({},Config.beginHeadReward)),Config.rewards.push(Object.assign({},Config.beginBodyReward));let r=null,l=null;for(let e=0;e<Config.missions.length-1;e+=6*Config.headRewards.length){do{Phaser.Utils.Array.Shuffle(Config.headRewards)}while(r&&r.id===Config.headRewards[0].id);do{Phaser.Utils.Array.Shuffle(Config.bodyRewards)}while(l&&l.id===Config.bodyRewards[0].id);for(let e=0;e<Config.headRewards.length;e++)Config.rewards.push(Object.assign({},Config.headRewards[e])),r=Config.rewards[Config.rewards.length-1],Config.rewards.push(Object.assign({},Config.bodyRewards[e])),l=Config.rewards[Config.rewards.length-1]}Config.missionsComplete=0,Config.missionsTotal=Config.missions.length,Config.snakeLife=0,Config.snakeLength=6,Config.snakeShield=0,Config.snakeHeal=0,Config.snakeSpeed=0,Config.snakeHelmet=0,Config.snakeTail=0,Config.snakeAgility=0,Config.escapePath=!1,Config.missionsPassed=[],Config.currentLength=1,Config.extraLife=0,Config.updateMissions()}static addReward(e,t){let s="";switch(t[e?0:1].id){case"Life":Config.snakeLife++,s+="Snake Life\nto retry mission";break;case"Shield":Config.snakeShield+=5,s+=`Snake Shield\nfor ${Config.snakeShield} seconds`;break;case"Helmet":Config.snakeHelmet+=5,s+=`Snake Helmet\nfor ${Config.snakeHelmet} crashes`;break;case"Speed":Config.snakeSpeed++,s+=`Snake Speed\nmove ${25*Config.snakeSpeed} % faster`;break;case"Heal":Config.snakeHeal++,s+="Snake Heal\nfor each mission";break;case"Length":Config.snakeLength++,s+=`Snake Length\nincrease to ${Config.snakeLength}`;break;case"Tail":Config.snakeTail++,s+=`Extra Tail\nadd tail +${Config.snakeTail}`;break;case"Agility":Config.snakeAgility++,s+=`Snake Agility\nturn +${25*Config.snakeAgility} % faster`}return Config.updateMissions(),s}static updateMissions(){for(let e=0;e<Config.missions.length-1;e++){let t=Config.missions[e],s=t.level;s||(s=0),t.goalOriginal||(t.goalOriginal=1),t.goalSnakeLength?t.goal=Config.snakeLength*(1+s):t.goalLevel?(t.goal=1+s,t.goalMultiply&&(t.goal*=t.goalMultiply)):t.goalMultiply?t.goal=t.goalOriginal*t.goalMultiply:t.goal=t.goalOriginal*(s+1),t.progress=0}}}Config.resolution=1,Config.width=640,Config.height=360,Config.loadPath="img/",Config.highScore=0,Config.missions=null,Config.missionsTotal=0,Config.missionsComplete=0,Config.titleTextStyle=null,Config.textStyle=null,Config.cardStyle=null,Config.snakeLife=0,Config.snakeLength=6,Config.snakeShield=0,Config.snakeHeal=0,Config.snakeSpeed=0,Config.snakeHelmet=0,Config.snakeTail=0,Config.snakeAgility=0,Config.extraLife=0,Config.refreshLoad="?t="+Date.now(),Config.currentLength=1,Config.escapePath=!1,Config.missionsPassed=[];class Element extends Phaser.Physics.Arcade.Sprite{constructor(e,t,s,i){super(e,t,s,i),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed),this.scene.tweens.add({targets:this,duration:Phaser.Math.Between(5e3,7500),scale:0,ease:"Cubic.easeIn",callbackScope:this,onComplete:()=>{this.destroy()}}),this.updateTime=0,this.moveToUnit=null}destroyed(){this.moveToUnit&&(this.moveToUnit.removeTarget(this),this.moveToUnit=null),this.moveCallback&&this.scene.time.removeEvent(this.moveCallback);let e=this.scene.add.image(this.x,this.y,"UnitElement-flash");this.scene.tweens.add({targets:e,duration:.5,alpha:0,onComplete:function(){e.destroy()}},this)}doMove(){if(!this.moveToUnit){let e=this.scene.enemyGroup.getChildren();for(let t=e.length-1;t>=0;t--){let s=e[t];if(s.type===this.scene.mission.target){if(Phaser.Math.Distance.BetweenPointsSquared(s,this)<16*(s.width*s.width)){this.moveToUnit=s,s.moveToUnits.push(this);break}}}}if(!this.moveToUnit)return;if(this.moveToUnit.type>0&&Phaser.Geom.Intersects.RectangleToRectangle(this.getBounds(),this.moveToUnit.getBounds())){if(this.moveToUnit.damage.visible=!0,this.moveToUnit.damage.timeout=this.scene.time.now+1500,this.moveToUnit.hitpoints--,0===this.moveToUnit.hitpoints)return this.scene.removeBug(this.moveToUnit),void(this.moveToUnit=null);let e=Math.floor(this.moveToUnit.hitpoints/4);return this.moveToUnit.damage.setFrame(e),void this.destroy()}let e=Phaser.Math.Angle.BetweenPoints(this,this.moveToUnit);this.scene.physics.velocityFromRotation(e,500*Config.scale,this.body.acceleration),this.moveCallback=this.scene.time.delayedCall(100,this.doMove,[],this)}}const debugLength=0,debugMission=0;let debugMissionIndex=0;const debugLevel=0,debugMapScene=0,debugAlwaysPass=0;class MapScene extends Phaser.Scene{constructor(){super({key:"MapScene"})}preload(){this.load.path=Config.loadPath,this.resname=["-1","-2","-3",""][Config.resolution-1],this.loadSpriteSheet("teleport",200,200),this.loadSpriteSheet("gate-symbols",50,50),this.loadImage("gate-tile")}create(){this.input.keyboard.resetKeys(),this.cursors=this.input.keyboard.createCursorKeys(),this.cursorsLeftHand=this.input.keyboard.addKeys("A,D"),this.cameras.main.setRoundPixels(!0);this.escapeLabel=this.add.text(.25*this.cameras.main.width,this.cameras.main.centerY,"Escape path\n\nwith a shortcut\n\n\n\nPress [LEFT]",Config.titleTextStyle).setScrollFactor(0).setOrigin(.5),this.revengeLabel=this.add.text(.75*this.cameras.main.width,this.cameras.main.centerY,"Revenge path\n\nhard with Reward\n\n\n\nPress [RIGHT]",Config.titleTextStyle).setScrollFactor(0).setOrigin(.5),this.escapeLabel.setColor("cyan"),this.revengeLabel.setColor("orange"),this.passLabel=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,"",Config.titleTextStyle).setScrollFactor(0).setOrigin(.5),this.passLabel.text=25-Config.missions.length+" / 24\n\nMissions\n\nComplete",this.passLabel.visible=!1,this.mission=Config.missions[0],this.mission.last&&(this.escapeLabel.visible=!1,this.revengeLabel.visible=!1,this.revengeLabel.text="Snake Revenge!\nComplete"),this.cameras.main.setBackgroundColor("rgba(0,0,0,0.5)");let e=this.add.group(),t=this.cameras.main.centerX,s=this.cameras.main.centerY,i=this.add.sprite(t,s,"teleport");i.scale=3.2,i.alpha=.25,this.anims.exists("teleport")||this.anims.create({key:"teleport",frameRate:30,frames:this.anims.generateFrameNumbers("teleport"),repeat:-1}),i.play("teleport");let a=i;var h=new Phaser.Geom.Circle(0,0,a.scale*a.width/2);let n=[];for(let e=0;e<24;e++)n.push(e);Phaser.Utils.Array.Shuffle(n);var o=this.add.container(a.x,a.y);e.add(o);let r=this.add.group();this.tiles=r;for(let e=0;e<24;e++){let t=r.create(0,0,"gate-tile");t.angle=15*e,n[e]>-2&&(t.tint=6710886),t.level=n[e],o.add(t)}Phaser.Actions.PlaceOnCircle(r.getChildren(),h);let l=this.add.group();this.symbols=l;for(let e=0;e<24;e++){let t=l.create(0,0,"gate-symbols",e);t.angle=15*e,n[e]>-2&&(t.tint=3355443),o.add(t)}Phaser.Actions.PlaceOnCircle(l.getChildren(),h),this.gate=o,this.symbolTween=this.tweens.add({targets:o,duration:6e4,callbackScope:this,rotation:2*Math.PI,repeat:-1},this),this.events.on(Phaser.Scenes.Events.WAKE,()=>{this.showMap()}),this.showMap(!0)}passLevel(e,t,s,i,a){this.time.delayedCall(2e3*e,()=>{let e=this.tiles.getChildren();for(let i=0;i<24;i++)if(e[i].level===t){e[i].tint=16777215,s&&!Config.escapePath&&(this.symbols.getChildren()[i].tint=16777215);break}this.passLabel.text=i,this.passLabel.visible=!0,this.passLabel.alpha=1,this.tweens.add({targets:[this.passLabel],duration:1500,alpha:1,ease:"Cubic.easeIn",callbackScope:this,onComplete:()=>{a&&(this.passLabel.text=25-Config.missions.length+" / 24\n\nMissions\n\nComplete"),this.passLabel.alpha=1}})},[],this)}startGame(e){Config.escapePath=e,this.escapeLabel.visible=!1,this.revengeLabel.visible=!1,this.time.delayedCall(300,()=>{this.scene.switch("MissionScene")},[],this)}update(){if(this.escapeLabel.visible){var e=this.input.activePointer;if(this.cursors.left.isDown||this.cursorsLeftHand.A.isDown||e.isDown||this.cursors.right.isDown||this.cursorsLeftHand.D.isDown)e.isDown?this.usepointer=!0:this.keyleft=this.cursors.left.isDown|this.cursorsLeftHand.A.isDown,this.isStartGame=!0;else if(this.isStartGame){this.isStartGame=!1;let t=!1;this.usepointer?e.x<this.cameras.main.centerX&&(t=!0):t=this.keyleft,this.startGame(t),this.usepointer=!1,this.keyleft=!1}}}loadImage(e){this.load.image(e,e+this.resname+".png"+Config.refreshLoad)}loadSpriteSheet(e,t,s){let i=Config.scale*t,a=Config.scale*s;this.load.spritesheet(e,e+this.resname+".png"+Config.refreshLoad,{frameWidth:i,frameHeight:a})}showMap(e){let t=Config.missionsPassed[Config.missionsPassed.length-1];this.escapeLabel.visible=!1,this.revengeLabel.visible=!1,this.time.delayedCall(2e3*Config.missionsPassed.length,()=>{t.last?(this.revengeLabel.text="Snake 1\n\nBot 0\n\n\n\nSnake Revenge!\n\n(you win)",this.revengeLabel.visible=!0):(this.escapeLabel.visible=!0,this.revengeLabel.visible=!0)},[],this);for(let e=0;e<Config.missionsPassed.length;e++){let t=Config.missionsPassed[e],s="Mission\n\n"+t.desc+"\n\nComplete";this.passLevel(e,t.index,t.revenge,s,e===Config.missionsPassed.length-1)}Config.missionsPassed=[]}}class RevengeScene extends Phaser.Scene{constructor(){super({key:"RevengeScene"})}preload(){this.load.path=Config.loadPath,this.resname=["-1","-2","-3",""][Config.resolution-1]}create(){this.input.keyboard.resetKeys(),this.cursors=this.input.keyboard.createCursorKeys(),this.cursorsLeftHand=this.input.keyboard.addKeys("A,D"),this.cameras.main.setRoundPixels(!0);this.missionTitle=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY/3,"Begin Reward",Config.titleTextStyle).setScrollFactor(0).setOrigin(.5),this.missionTitle.setFontSize(128*Config.scale),this.missionTitle.visible=!1;let e=.33*this.cameras.main.width,t=this.cameras.main.centerY;this.cardHead=new Card(this,e,t,Config.beginHeadReward,!0),this.cardHead.visible=!1,this.cardBody=new Card(this,2*e,t,Config.beginBodyReward,!0),this.cardBody.visible=!1;this.pressStartText=this.add.text(this.cameras.main.centerX,.8*this.cameras.main.height,"Press [LEFT/RIGHT] to Select",Config.titleTextStyle).setScrollFactor(0).setOrigin(.5),this.showRevenge(!0),this.events.on(Phaser.Scenes.Events.WAKE,()=>{this.showRevenge()}),this.startTitle=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY/2,"",Config.titleTextStyle).setScrollFactor(0).setOrigin(.5),this.startText=this.add.text(this.cameras.main.centerX,this.missionTitle.y+this.missionTitle.height,"",Config.textStyle).setScrollFactor(0).setOrigin(.5)}continueGame(){this.startTitle.visible=!1,this.startText.visible=!1,this.pressStartText.visible=!1,this.scene.switch("MissionScene"),this.cardHead.visible=!1,this.cardBody.visible=!1}startGame(e){if(this.perkSelected)return void this.continueGame();let t,s=Config.addReward(e,this.rewards);this.perkSelected=this.time.now+300,this.pressStartText.visible=!1,this.missionTitle.visible=!1,t=e?this.cardBody:this.cardHead,this.startTitle.text="Revenge Reward",this.startText.text=s,this.startTitle.x=t.x,this.startTitle.y=t.y-this.startTitle.height,this.startTitle.visible=!0,this.startText.x=t.x,this.startText.y=this.startTitle.y+this.startTitle.height,this.startText.visible=!0,this.pressStartText.text="Press to continue",this.pressStartText.x=this.startText.x,this.pressStartText.y=this.startText.y+this.startText.height,this.pressStartText.visible=!0,this.tweens.add({targets:[t],duration:200,alpha:0,callbackScope:this,onComplete:e=>{e.visible=!1,e.alpha=1}})}update(){if(!(this.perkSelected&&this.perkSelected>this.time.now)){var e=this.input.activePointer;if(this.cursors.left.isDown||this.cursorsLeftHand.A.isDown||e.isDown||this.cursors.right.isDown||this.cursorsLeftHand.D.isDown)e.isDown?this.usepointer=!0:this.keyleft=this.cursors.left.isDown|this.cursorsLeftHand.A.isDown,this.isStartGame=!0;else if(this.isStartGame){this.isStartGame=!1;let t=!1;this.usepointer?e.x<this.cameras.main.centerX&&(t=!0):t=this.keyleft,this.startGame(t),this.usepointer=!1,this.keyleft=!1}}}loadImage(e){this.load.image(e,e+this.resname+".png"+Config.refreshLoad)}showRevenge(e){let t=Config.missions[0];this.missionTitle.text="Revenge Reward",this.isStartGame=!1,this.usepointer=!1,this.keyleft=!1,this.perkSelected=0,this.rewards=Config.rewards.splice(0,2);let[s,i]=this.rewards;this.cardHead.setReward(s),this.cardBody.setReward(i),t.end||t.last||(this.missionTitle.visible=!0,this.cardHead.visible=!0,this.cardHead.alpha=1,this.cardBody.visible=!0,this.cardBody.alpha=1)}}class MissionScene extends Phaser.Scene{constructor(){super({key:"MissionScene"})}preload(){this.load.path=Config.loadPath,this.resname=["-1","-2","-3",""][Config.resolution-1],this.loadImage("help-bite"),this.loadImage("help-explode")}create(){if(debugMapScene)return Config.missionsPassed=[],Config.missionsPassed.push(this.scene.get("LoaderScene").mission),Config.missionsPassed=Config.missionsPassed.concat(Config.missions.splice(0,2)),void this.scene.switch("MapScene");let e,t,s,i=this.scene.get("LoaderScene").mission;if(this.restartGame=i.end,i.end?(e=i.desc,t="Snake Revenge!"):(e=Config.missions.length===Config.missionsTotal-1?"Snake Revenge Begins":i.revenge?"Revenge Mission":"Escape Mission",t=(i.revenge,i.desc)),"bite"===i.do||"explode"===i.do){this.helpImage=this.add.image(this.cameras.main.centerX,this.cameras.main.centerY/4,"help-"+i.do),this.helpImage.setDepth(1);let e=["virus","Bomb","Blade","Green","UnitEnergy","flash","virus2","Brain"][i.target-1];this.targetImage=this.add.image(this.helpImage.x,this.helpImage.y,e),this.targetImage.scale=1.5}this.missionTitle=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY/2,e,Config.titleTextStyle).setScrollFactor(0).setOrigin(.5),this.missionText=this.add.text(this.cameras.main.centerX,this.missionTitle.y+this.missionTitle.height,t,Config.textStyle).setScrollFactor(0).setOrigin(.5),this.isGameOver=!0,this.isGameOverTime=0,i.end?(s="Reload to restart",this.isGameOver=!1):(s="Press [LEFT/RIGHT] to start",this.isGameOver=!0),this.startText=this.add.text(this.cameras.main.centerX,.75*this.cameras.main.height,s,Config.titleTextStyle).setScrollFactor(0).setOrigin(.5),this.input.keyboard.resetKeys(),this.cursors=this.input.keyboard.createCursorKeys(),this.cursorsLeftHand=this.input.keyboard.addKeys("A,D"),this.cameras.main.setRoundPixels(!0),this.disableInputTime=this.time.now,this.events.on(Phaser.Scenes.Events.WAKE,()=>{this.disableInputTime=this.time.now})}startGame(){this.isGameOver=!1,this.missionTitle.visible=!1,this.missionText.visible=!1,this.startText.visible=!1,this.input.keyboard.removeAllKeys(!0),this.input.keyboard.resetKeys(),this.helpImage&&(this.helpImage.visible=!1),this.targetImage&&(this.targetImage.visible=!1),0===this.isGameOverTime?this.scene.resume("LoaderScene"):this.scene.get("LoaderScene").scene.restart()}gameOver(e,t,s,i,a,h){this.player=h,e&&(Config.missions[0].end?(this.winGame=!0,this.winGameTime=this.time.now+5e3,this.missionTitle.text="Snake Revenge Complete",this.missionTitle.visible=!0):this.revenge=i.revenge),e&&(this.showMap=i.showMap),this.extralife=a,this.isGameOver=!0,this.isWin=e,this.showMission(t,s)}update(){if(!(this.disableInputTime+500>this.time.now))if(this.winGame)this.winGameTime<this.time.now&&(this.winGame=!1);else if(this.revenge)this.isGameOverTime<this.time.now&&(this.scene.switch("RevengeScene"),this.revenge=!1);else if(this.showMap)this.isGameOverTime<this.time.now&&(this.scene.switch("MapScene"),this.showMap=!1);else if(this.isGameOver&&!(this.isGameOverTime>this.time.now)){if(this.isGameOverTime>0)return this.extralife||this.isWin||Config.reset(),Config.missions.length<=1&&(this.isGameOver=!1),void this.startGame();var e=this.input.activePointer;(this.cursors.left.isDown||this.cursorsLeftHand.A.isDown||e.isDown||this.cursors.right.isDown||this.cursorsLeftHand.D.isDown)&&this.startGame()}}showMission(e,t){let s,i=this.scene.get("LoaderScene");if(s=i.player.head.y-i.cameras.main.worldView.y>this.cameras.main.centerY?.15*this.cameras.main.height:.66*this.cameras.main.height,this.missionTitle.y=s,this.missionText.y=s+this.missionTitle.height,this.missionTween&&(this.tweens.remove(this.missionTween),this.missionTitle.alpha=1,this.missionText.alpha=1),t?(this.missionTitle.text=e,this.missionTitle.visible=!0):(this.missionTitle.visible=!1,t=e),this.missionText.text=t,this.missionText.visible=!0,this.isGameOver){let e=this.isWin?4e3:5e3;this.isGameOverTime=this.time.now+e}else this.missionTween=this.tweens.add({targets:[this.missionTitle,this.missionText],duration:2e3,alpha:0,ease:"Cubic.easeIn",callbackScope:this,onComplete:e=>{this.missionTween=null,this.missionTitle.visible=!1,this.missionTitle.alpha=1,this.missionText.visible=!1,this.missionText.alpha=1}})}loadImage(e){this.load.image(e,e+this.resname+".png"+Config.refreshLoad)}}class LoaderScene extends Phaser.Scene{constructor(){super({key:"LoaderScene",visible:!1}),this.loadProgress=0}preload(){this.load.path=Config.loadPath,this.resname=["-1","-2","-3",""][Config.resolution-1];if(debugLength>0&&(Config.currentLength=debugLength),debugMission){let e=0;for(let t=0;t<Config.missions.length;t++)if(Config.missions[t].id===debugMission){if(e<debugLevel){e++;continue}Config.missions.splice(0,t);break}}debugMissionIndex>0&&(Config.missions.splice(0,debugMissionIndex-1),debugMissionIndex=0),Config.origLength=Config.currentLength;this.mission=Config.missions[0],Config.missions.splice(0,1),Config.escapePath&&this.mission.revenge&&(Config.missionsPassed.push(this.mission),this.mission=Config.missions[0],Config.missions.splice(0,1)),this.loadSpriteSheet("asteroids",32,32),this.loadImage("snakehead"),this.loadImage("snakebite"),this.loadImage("snakebody"),this.loadImage("snaketail"),this.loadImage("snakebody-boom"),this.loadImage("snakeshield"),this.loadImage("Blade"),this.loadImage("Bomb");for(let e=1;e<=3;e++)this.loadImage("planet"+e);this.mission.begin&&(this.loadImage("left"),this.loadImage("right")),this.loadImage("EffectTeleport"),this.loadSpriteSheet("EffectExplode",64,64),this.loadSpriteSheet("virus",64,64),this.loadSpriteSheet("virus2",64,64),this.loadSpriteSheet("damage",160,160),this.loadSpriteSheet("unit-damage",64,16),this.loadSpriteSheet("Green",80,80),this.loadImage("Brain"),this.loadSpriteSheet("teleport",200,200),this.loadImage("Card"),this.loadImage("CardHead"),this.loadImage("CardBody"),this.loadSpriteSheet("CardIcons",500,500),this.loadImage("UnitEnergy"),this.loadSpriteSheet("flash",64,64),this.loadSpriteSheet("flares",132,132),this.loadSpriteSheet("UnitElement",32,32),this.loadImage("UnitElement-flash")}create(){Config.setScale(this),this.snap=this.textures.get("asteroids").getSourceImage().height,this.width=2560*Config.scale/this.snap,this.height=2560*Config.scale/this.snap;let e=this.snap*this.width,t=this.snap*this.height;this.w=e,this.h=t,this.overlapColliders=[],this.missionHelper=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,"",Config.titleTextStyle).setScrollFactor(0).setOrigin(.5),this.missionHelper.visible=!1,this.buildingGroup=this.physics.add.staticGroup(),this.barrierGroup=this.physics.add.staticGroup(),this.enemyGroup=this.physics.add.group({runChildUpdate:!0}),this.teleport=this.buildingGroup.create(e/2,t/2,"teleport"),this.teleport.visible=!1;let s=[];s.push(this.teleport);for(let e=1;e<=3;e++){let t=this.teleport.width;const i=new Phaser.Geom.Rectangle(t,t,this.w-2*t,this.h-2*t);t=3*this.teleport.width;const a=[[1,11639188],[.8,9664102],[.6,13877453]];for(;a.length>0;){let h=this.randomXY(s,t,i),n=this.barrierGroup.create(h.x,h.y,"planet"+e);const o=a.pop();n.setTint(o.pop()),n.setScale(o.pop()),n.body.setSize(n.width/2,n.height/2),s.push(n)}}s.unshift();let i=this.snap,a=i/2,h=this.textures.get("asteroids").frameTotal-2;for(let e=0;e<this.width;e++)this.barrierGroup.create(a+i*e,a,"asteroids",Phaser.Math.Between(0,h)),this.barrierGroup.create(a+i*e,i*this.height-a,"asteroids",Phaser.Math.Between(0,h));for(let e=0;e<this.height;e++)this.barrierGroup.create(a,a+i*e,"asteroids",Phaser.Math.Between(0,h)),this.barrierGroup.create(i*this.width-a,a+i*e,"asteroids",Phaser.Math.Between(0,h));let n=new Phaser.Geom.Point(e/2,t/2);if(this.player=new Player(this),this.time.delayedCall(100,this.addBug,[],this),this.input.keyboard.resetKeys(),this.cursors=this.input.keyboard.createCursorKeys(),this.cursorsLeftHand=this.input.keyboard.addKeys("A,D"),this.input.mouse&&this.input.mouse.disableContextMenu(),this.pointer={left:!1,right:!1},this.text=this.add.text(10,10,"",{font:64*Config.scale+"px Courier",fill:"#00ff00"}).setScrollFactor(0),this.cameras.main.setBounds(0,0,e,t),this.physics.world.setBounds(0,0,e,t),this.addOverlapCollider(this.physics.add.collider(this.enemyGroup,this.barrierGroup)),this.score=0,this.scoreTimer=this.time.addEvent({delay:1e3,callback:function(){this.score++},callbackScope:this,loop:!0}),this.anims.exists("virus")||this.anims.create({key:"virus",frameRate:7,frames:this.anims.generateFrameNumbers("virus"),repeat:-1}),this.anims.exists("Green")||this.anims.create({key:"Green",frameRate:7,frames:this.anims.generateFrameNumbers("Green"),repeat:-1}),this.anims.exists("teleport")||this.anims.create({key:"teleport",frameRate:30,frames:this.anims.generateFrameNumbers("teleport"),repeat:-1}),this.physics.world.timeScale=1,this.player.init(n),this.scene.pause(),this.scene.run("MissionScene"),this.missionScene=this.scene.get("MissionScene"),this.snakeShield=0,this.events.on("resume",()=>{this.time.delayedCall(0,()=>{this.anims.resumeAll(),0===this.snakeShield&&(this.snakeShield=1e3*Config.snakeShield,this.snakeShield+=this.time.now,this.snakeShield>0&&(this.headShield=this.physics.add.sprite(n.x,n.y,"snakeshield"),this.tweens.add({targets:this.headShield,duration:1e3*Config.snakeShield,alpha:0,ease:"Cubic.easeIn"}),this.headShield.preUpdate=(()=>{if(this.player.head){if(!this.player.head.visible||this.snakeShield<this.time.now)return void this.headShield.destroy();this.headShield.x=this.player.head.x,this.headShield.y=this.player.head.y}})))},this)}),this.mission.complete=!1,this.isGameOver=!1,this.mission.blade){let e=[];for(let t=0;t<this.mission.goal;t++){let s;s=0===t?this.player.head:this.randomXY([this.player.head],10*this.snap);let i=this.createBug(3,s.x,s.y);i.moveToUnit=this.player.head,e.push(i),i.setBounce(15,15),i.index=t}for(let t=0;t<e.length;t++)this.addOverlapCollider(this.physics.add.collider(e[t],e,this.collideBlade,null,this))}if(5===this.mission.target){let e,t=10*this.snap;const s=new Phaser.Geom.Rectangle(t,t,this.w-2*t,this.h-2*t);this.teleportDamage=this.add.sprite(this.player.head.x,this.player.head.y,"damage"),this.teleportDamage.setDepth(-1);let i=this.add.sprite(this.player.head.x,this.player.head.y,"EffectTeleport");i.setTint(6710886),i.setDepth(-1),this.teleportDamaged=i,this.teleport.setSize(i.width,i.height),this.tweens.add({targets:i,duration:1e3,alpha:.5,ease:"Cubic.easeIn",yoyo:!0,repeat:-1,callbackScope:this,onComplete:e=>{this.missionTween=null,this.missionHelper.visible=!1,this.missionHelper.alpha=1}});let a=3-this.mission.level;for(let t=0;t<a;t++){e=this.randomXY([this.player.head],20*this.snap,s);this.createBug(5,e.x,e.y)}}if(6===this.mission.target){let e=[],t=this.w/4,i=t/8;t-=2*i,e.push(new Phaser.Geom.Rectangle(i,i,t,this.h-2*i)),e.push(new Phaser.Geom.Rectangle(this.w-t-i,i,t,this.h-2*i)),e.push(new Phaser.Geom.Rectangle(i,i,this.w-2*i,t)),e.push(new Phaser.Geom.Rectangle(i,this.h-t-i,this.w-2*i,t)),Phaser.Utils.Array.Shuffle(e);for(let t=0;t<this.mission.goal;t++){let i,a;this.snap;a=t<e.length?e[t]:Phaser.Math.RND.pick(e),i=this.randomXY([s],10*this.snap,a),s.push(i);let h=this.createBug(6,i.x,i.y);this.anims.exists("flash")||this.anims.create({key:"flash",frameRate:8,frames:this.anims.generateFrameNumbers("flash"),repeat:-1}),h.play("flash")}}if(8===this.mission.target){let e=[],t=this.w/4,i=t/8;t-=2*i,e.push(new Phaser.Geom.Rectangle(i,i,t,this.h-2*i)),e.push(new Phaser.Geom.Rectangle(this.w-t-i,i,t,this.h-2*i)),e.push(new Phaser.Geom.Rectangle(i,i,this.w-2*i,t)),e.push(new Phaser.Geom.Rectangle(i,this.h-t-i,this.w-2*i,t));let a=this.randomXY([s],10*this.snap,Phaser.Math.RND.pick(e)),h=this.createBug(8,a.x,a.y,Phaser.Math.RND.pick(e));h.setScale(1),this.tweens.add({targets:h,scale:.75,ease:"Cubic.easeIn",duration:500,repeat:-1,yoyo:!0}),this.brain=h}if(4===this.mission.target){let e=[],t=this.w/4,i=t/8;t-=2*i,e.push(new Phaser.Geom.Rectangle(i,i,t,this.h-2*i)),e.push(new Phaser.Geom.Rectangle(this.w-t-i,i,t,this.h-2*i)),e.push(new Phaser.Geom.Rectangle(i,i,this.w-2*i,t)),e.push(new Phaser.Geom.Rectangle(i,this.h-t-i,this.w-2*i,t)),Phaser.Utils.Array.Shuffle(e);for(let t=0;t<4;t++){let i;this.snap;i=this.randomXY([s],10*this.snap,e[t]),s.push(i);let a=this.createBug(4,i.x,i.y);this.anims.exists("Green")||this.anims.create({key:"Green",frameRate:8,frames:this.anims.generateFrameNumbers("Green"),repeat:-1}),a.play("Green")}}}collideBlade(e,t){e.collideDelay<this.time.now&&(e.collideDelay=this.time.now+Phaser.Math.Between(1e3,8e3)),t.collideDelay<this.time.now&&(t.collideDelay=this.time.now+Phaser.Math.Between(1e3,8e3))}showProgress(e){this.missionHelperTween&&(this.tweens.remove(this.missionHelperTween),this.missionHelper.alpha=1),this.missionHelper.x=this.player.head.x-this.cameras.main.worldView.x,this.missionHelper.y=this.player.head.y-this.cameras.main.worldView.y,this.player.head.y>this.cameras.main.centerY?this.missionHelper.y-=this.player.head.height:this.missionHelper.y+=this.player.head.height,this.missionHelper.text=e,this.missionHelper.visible=!0,this.missionHelperTween=this.tweens.add({targets:this.missionHelper,duration:1500,alpha:0,ease:"Cubic.easeIn",callbackScope:this,onComplete:e=>{this.missionTween=null,this.missionHelper.visible=!1,this.missionHelper.alpha=1}})}addOverlapCollider(e){if(null===e)for(const e of this.overlapColliders)this.physics.world.removeCollider(e);this.overlapColliders.push(e)}teleportEffect(e,t=3500,s=3){let i,a=this.add.image(e.x,e.y,"EffectTeleport");switch(e.type){case-1:i=11206604;break;case 1:i=10066431;break;case 2:i=16751001;break;case 3:i=16711680;break;case 4:i=10092441;break;default:i=16777215}a.setTint(i),a.scale=0,this.tweens.add({targets:a,scale:s,ease:"Linear",duration:t,alpha:0,rotation:2*Math.PI,callbackScope:this,onComplete:function(){a.destroy()}}),e.scale=0,e.alpha=0,e.visible=!0,this.tweens.add({targets:e,scale:1,ease:"Linear",duration:1500,alpha:1,delay:150,rotation:2*Math.PI,callbackScope:this,onComplete:function(){}})}update(e,t){var s=this.input.activePointer;s.isDown?s.x<this.cameras.main.centerX?(this.pointer.left=!0,this.pointer.right=!1):(this.pointer.left=!1,this.pointer.right=!0):(this.pointer.left=!1,this.pointer.right=!1),this.player.update(t,this.cursors,this.cursorsLeftHand,this.pointer),this.text.visible=!1}gameOver(e){if(this.isGameOver)return;Config.currentLength=this.player.bodyGroup.getLength(),Config.currentLength>Config.snakeLength&&(Config.currentLength=Config.snakeLength),e&&Config.missionsPassed.push(this.mission),this.isGameOver=!0,this.addOverlapCollider(null),this.time.removeEvent(this.addCallback),this.time.removeEvent(this.scoreTimer);let t,s=null,i=!1;if(e&&this.mission.revenge)t="Mission complete",this.mission.begin&&(t="Mission Begins"),s="Snake Revenge!",this.cameras.main.fadeOut(4e3),this.player.isGameOver=!0;else if(e){this.cameras.main.fadeOut(4e3);let e=this.teleport;this.tweens.add({targets:e,scale:0,ease:"Cubic.easeIn",duration:3e3,alpha:0,rotation:2*Math.PI,onComplete:function(){e.destroy()}}),this.tweens.add({targets:this.player.bodyGroup.getChildren(),ease:"Cubic.easeIn",duration:2e3,alpha:0,x:this.teleport.x,y:this.teleport.y,rotation:2*Math.PI,onComplete:function(){}}),this.tweens.add({targets:this.player.head,ease:"Cubic.easeIn",duration:2e3,alpha:0,x:this.teleport.x,y:this.teleport.y,rotation:2*Math.PI,onComplete:function(){}}),t="Snake Escape!",s=null}else this.cameras.main.fadeOut(6e3),t="Lost in Mission "+(this.mission.index+1)+" / 24",0===Config.extraLife&&this.mission.complete&&(Config.extraLife++,Config.missions.unshift(this.mission),this.mission.progress=0,s="That was sooo close, try again",i=!0,Config.currentLength=Config.origLength),i||Config.snakeLife>0?Config.snakeLife>0&&(Config.missions.unshift(this.mission),this.mission.progress=0,s=`Snake Life 1/${Config.snakeLife} to Retry`,Config.snakeLife--,i=!0,Config.currentLength=Config.origLength):s="GAME OVER";this.missionScene.gameOver(e,t,s,this.mission,i,this.player);let a=this.mission.revenge?5e3:2500;e||(a=5e3),this.time.delayedCall(a,()=>{this.physics.pause(),this.anims.pauseAll()},this)}gameOverRestart(){Config.missions.length>0?this.scene.restart():this.time.delayedCall(5e3,()=>{Config.restart(),this.scene.restart()},this)}loadSpriteSheet(e,t,s){let i=Config.scale*t,a=Config.scale*s;this.load.spritesheet(e,e+this.resname+".png"+Config.refreshLoad,{frameWidth:i,frameHeight:a})}loadImage(e){this.load.image(e,e+this.resname+".png"+Config.refreshLoad)}randomX(){const e=this.snap,t=e/2;return Phaser.Math.Between(1,this.width-1)*e+t}randomY(){const e=this.snap,t=e/2;return Phaser.Math.Between(1,this.height-1)*e+t}randomXY(e,t,s){let i=new Phaser.Geom.Point;t*=t;for(let a=0;a<100;a++){if(i.x=this.randomX(),i.y=this.randomY(),s&&!Phaser.Geom.Rectangle.ContainsPoint(s,i))continue;let a;for(a=0;a<e.length;a++){let s=e[a];if(Phaser.Math.Distance.BetweenPointsSquared(i,s)<t)break}if(a===e.length)break}return i}createBug(e,t,s){var i=e;if(!e){let e=this.mission.level;e>=this.mission.levels.length&&(e=this.mission.levels.length-1);let t=this.mission.levels[e].enemies;i=Phaser.Math.RND.pick(t)}let a;if(t)a=new Phaser.Geom.Point(t,s);else{let e=5*this.snap;const t=new Phaser.Geom.Rectangle(e,e,this.w-2*e,this.h-2*e);a=this.randomXY([this.player.head],10*this.snap,t)}let h=new Bug(this,a.x,a.y,["virus","Bomb","Blade","Green","UnitEnergy","flash","virus2","Brain"][i-1]);h.type=i,3!==i&&8!==i||(h.moveToUnits=[],h.hitpoints=15,h.damage=this.add.sprite(h.x,h.y,"unit-damage"),h.damage.visible=!1,h.damage.sprite=h,h.damage.setFrame(3),h.damage.preUpdate=(()=>{h.damage.visible&&(h.damage.timeout<h.scene.time.now&&(h.damage.visible=!1),h.damage.x=h.damage.sprite.x,h.damage.y=h.damage.sprite.y-h.damage.sprite.height/2-h.damage.height/2)})),4!==i&&8!==i||(h.escapeUnit=this.player.head);let n=1;return 1===i&&h.play("virus"),4===i&&h.play("Green"),1!==i&&4!==i&&7!==i||(h.eatable=!0),3===i&&(n=3),this.enemyGroup.add(h,!0),this.teleportEffect(h,1500,n),5===i&&(h.body.angularVelocity=600),h.moveCallback=this.time.delayedCall(1500,()=>{h.initMove()},[],this),h}addBug(e){if(this.mission.complete)return;this.mission.revenge&&0===Phaser.Math.Between(0,10)&&this.createBug(5);this.createBug(e);this.addCallback=this.time.delayedCall(300,this.addBug,[],this)}removeBug(e){this.isGameOver||(debugAlwaysPass||this.mission.status(this,e)?this.missionComplete(e):!this.mission.revenge&&this.mission.complete&&this.missionScene.showMission("Mission complete","Teleport to Escape"),e.destroy())}missionComplete(e){this.mission.complete||(this.mission.complete=!0,this.mission.revenge?(this.player.overlapBuilding(),this.time.delayedCall(350,function(){e&&this.flashRevenge(e)},[this],this)):(this.missionScene.showMission("Mission complete","Teleport to Escape"),this.teleport.visible||(this.teleport.type=-1,this.teleport.body.setSize(this.teleport.width/2,this.teleport.height/2),this.teleportEffect(this.teleport),this.teleport.play("teleport"),this.teleport.scale=0,this.teleport.alpha=0,this.teleport.setTint(16751001),this.tweens.add({targets:this.teleport,ease:"Linear",duration:3500,scale:1,alpha:.5,callbackScope:this,onComplete:function(){this.teleport.clearTint(),this.tweens.add({targets:this.teleport,ease:"Linear",duration:1e3,scale:1,alpha:.25,yoyo:!0,repeat:-1})}}),this.tweens.add({targets:this.teleport,ease:"Linear",duration:3e3,repeat:-1,rotation:2*Math.PI}),this.time.delayedCall(3500,()=>{this.addOverlapCollider(this.physics.add.overlap(this.player.head,this.teleport,this.player.overlapBuilding,null,this.player))},[],this))))}flashRevenge(e){this.cameras.main.flash(1500);let t=this.player.bodyGroup.getChildren();t.length>Config.snakeLength+1&&this.player.cutTail(t[Config.snakeLength]);let s=this.enemyGroup.getChildren();for(let t=s.length-1;t>=0;t--)s[t]!==e&&1!==s[t].type&&(s[t].type=-1,s[t].destroy())}destroyBot(e){if(this.cameras.main.flash(250,100,100,100),3===e.type){let e=this.enemyGroup.getChildren();for(let t=e.length-1;t>=0;t--)2===e[t].type&&0===Phaser.Math.Between(0,2)&&(e[t].type=-1,e[t].destroy())}}}class Player{constructor(e){this.scene=e,this.bodyGroup=e.physics.add.group(),this.bulletGroup=e.physics.add.group(),this.fireGroup=e.physics.add.group(),this.bodyEnemyTimer=0}init(e){let t=this.scene;this.helmet=Config.snakeHelmet,this.speedModifier=1+Config.snakeSpeed/4,this.agilityModifier=1+Config.snakeAgility/4;let s=Math.round(300*Config.scale*this.speedModifier);this.speed=s,this.flashSpeed=1,this.path=[],this.pathRotation=[],this.path.push(new Phaser.Geom.Point(e.x,e.y)),this.pathRotation.push(0),this.pathSpacer=Math.round(10/this.speedModifier),Config.snakeHeal&&Config.currentLength<Config.snakeLength&&(Config.currentLength=Config.snakeLength);let i=Config.currentLength;for(let t=0;t<i;t++){let t=this.addBody(e);this.scene.mission.grayscale&&t.setTexture("snaketail")}i=Config.snakeTail;for(let t=0;t<i;t++){this.addBody(e).setTexture("snaketail")}let a=t.physics.add.sprite(e.x,e.y,"snakehead");a.rotation=Phaser.Math.Angle.Random(),t.cameras.main.startFollow(a,!0,0,.05),a.setCollideWorldBounds(!0),a.body.setVelocity(s),a.body.setSize(a.width/2,a.height/2),a.setDepth(1),this.head=a,t.mission.begin&&(this.head.rotation=-Math.PI/2,this.leftSprite=t.add.sprite(e.x,e.y,"left",0,!0),this.leftSprite.setOrigin(2,0),this.leftSprite.rotation=this.head.rotation+Math.PI/2,this.leftSprite.preUpdate=(()=>{this.leftSprite.visible=!this.isGameOver,this.leftSprite.x=this.head.x,this.leftSprite.y=this.head.y,this.leftSprite.rotation=this.head.rotation+Math.PI/2}),this.rightSprite=t.add.sprite(e.x,e.y,"right",0,!0),this.rightSprite.preUpdate=(()=>{this.rightSprite.visible=!this.isGameOver,this.rightSprite.x=this.head.x,this.rightSprite.y=this.head.y,this.rightSprite.rotation=this.head.rotation+Math.PI/2}),this.rightSprite.setOrigin(-1,0),this.rightSprite.rotation=this.head.rotation+Math.PI/2,this.scene.time.delayedCall(1e4,function(){this.leftSprite.destroy(),this.rightSprite.destroy()},[this],this)),t.addOverlapCollider(t.physics.add.collider(this.head,this.bodyGroup,this.collideHeadBody,null,this)),t.addOverlapCollider(t.physics.add.collider(this.head,t.barrierGroup,this.collideHeadBarrier,null,this)),t.addOverlapCollider(t.physics.add.collider(this.head,this.bulletGroup,this.collideHeadBullet,null,this)),t.addOverlapCollider(t.physics.add.overlap(this.head,t.enemyGroup,this.collideHeadEnemy,null,this)),t.addOverlapCollider(t.physics.add.collider(this.bodyGroup,t.enemyGroup,this.collideBodyEnemy,null,this)),t.addOverlapCollider(t.physics.add.collider(this.bulletGroup,t.enemyGroup,this.collideBulletEnemy,null,this)),5===this.scene.mission.target&&t.addOverlapCollider(t.physics.add.overlap(t.teleport,this.fireGroup,this.overlapTeleportFire,null,this)),this.delta=0,this.collideBarrierTimeout=0,this.collideHeadBodyTime=0,this.isGameOver=!1,this.gameOvertime=1e3,this.explodeTail=0,this.explodeTailFlash=!0}explodeHead(e){let t=150*Config.scale;const s=this.scene.add.particles(e.x,e.y,"EffectExplode",{frame:[0],speed:{start:.67*t,end:.67*-t},quantity:5,ease:"Power2",lifespan:1e3,maxParticles:100,blendMode:"ADD",alpha:{start:1,end:0}});this.scene.time.delayedCall(2e3,function(){s.destroy()},this)}explode(e){let t=150*Config.scale;const s=this.scene.add.particles(e.x,e.y,"EffectExplode",{frame:[3],speed:{start:t,end:-t},quantity:1,ease:"Power2",lifespan:500,maxParticles:5,blendMode:"ADD",alpha:{start:1,end:0}});this.scene.time.delayedCall(2e3,function(){s.destroy()},this)}addBody(e){let t;t=this.bodyGroup.getLength()<Config.snakeLength?"snakebody":this.explodeTail?"snakebody-boom":"snaketail";let s=this.scene.physics.add.sprite(e.x,e.y,t);this.head?s.rotation=this.head.rotation:s.rotation=-Math.PI/2,s.body.setSize(s.width/2,s.height/2),s.collideTime=this.scene.time.now+200,this.bodyGroup.add(s);for(let e=0;e<this.pathSpacer;e++)this.path.push(new Phaser.Geom.Point(s.x,s.y)),this.pathRotation.push(0);return s}removeTail(e){if(this.explodeTail){let t=Phaser.Math.Between(2,4);this.scene.tweens.add({targets:e,duration:Phaser.Math.Between(40*t,40*t),scale:1.25,repeat:Phaser.Math.Between(t-1,t+1),ease:"Cubic.easeIn",callbackScope:this,yoyo:!0,onComplete:()=>{e.effectTimer&&this.scene.time.removeEvent(e.effectTimer),this.explodeElement(e)}})}else this.scene.tweens.add({targets:e,duration:Phaser.Math.Between(2e3,3500),scale:0,ease:"Cubic.easeIn",callbackScope:this,onComplete:e=>{e.effectTimer&&this.scene.time.removeEvent(e.effectTimer),e.destroy()}})}explodeElement(e){for(let t=0;t<4;t++){let t=new Element(this.scene,e.x,e.y,"UnitElement");this.fireGroup.add(t,!0),t.body.setVelocity(Phaser.Math.Between(50*Config.scale,200*Config.scale)),t.rotation=Phaser.Math.Angle.Random(),this.scene.physics.velocityFromRotation(t.rotation,t.body.speed,t.body.velocity),this.scene.teleport.visible?t.moveToUnit=this.scene.teleport:t.moveToUnit=null,t.moveCallback=this.scene.time.delayedCall(50,t.doMove,[],t);let s=100*Config.scale;t.body.setMaxSpeed(Phaser.Math.Between(s,1.25*s))}e.destroy()}cutTail(e){let t=[];for(let s=null;s!==e;){s=this.bodyGroup.getChildren().pop(),t.push(s),s.setTexture("snaketail"),this.scene.mission.goalSnakeLength&&this.scene.mission.progress>this.bodyGroup.getLength()&&(this.scene.mission.progress=this.bodyGroup.getChildren().length),this.bulletGroup.add(s);for(let e=0;e<this.pathSpacer;e++)this.path.pop(),this.pathRotation.pop();s.body.setVelocity(Phaser.Math.Between(100*Config.scale,200*Config.scale)),s.rotation=Phaser.Math.Angle.Random(),this.scene.physics.velocityFromRotation(s.rotation,s.body.speed,s.body.velocity),this.removeTail(s)}if(0===this.bodyGroup.getChildren().length){if(this.isGameOver)return[];this.isGameOver=!0,this.head.visible=!1,this.explodeHead(this.head),this.scene.gameOver(!1)}if(this.explodeTail)for(let e=0;e<t.length;e++){let s=t[e];s.setTexture("snakebody-boom"),s.explodeTail=!0}return t}collideHeadBody(e,t){if(this.collideHeadBodyTime>this.scene.time.now)return;if(this.scene.snakeShield>this.scene.time.now)return;if(this.collideHeadBodyTime=this.scene.time.now+200,t.collideTime>this.scene.time.now)return;let s=this.bodyGroup.getChildren().indexOf(t);if(0===s)return;let i=new Phaser.Geom.Point(this.head.x,this.head.y),a=Math.floor((s+1)/2),h=2*this.scene.snap*(2*this.scene.snap);for(let e=-1;e<a;e++){let t,n;-1===e?(t=this.head,n=this.bodyGroup.getChildren()[s]):(t=this.bodyGroup.getChildren()[e],n=this.bodyGroup.getChildren()[e+a]),i.x=(t.x+n.x)/2,i.y=(t.y+n.y)/2;let o=new Phaser.Geom.Line(t.x,t.y,n.x,n.y).getPoints(0,2*this.scene.snap);for(let e=0;e<o.length;e++)if(this.explode(o[e]),this.explodeEnemies(o[e],h),this.scene.isGameOver)return}this.cutTail(t)}explodeEnemies(e,t){for(let s=this.scene.enemyGroup.getChildren().length-1;s>=0;s--){let i=this.scene.enemyGroup.getChildren()[s];Phaser.Math.Distance.BetweenPointsSquared(i,e)<t&&this.scene.removeBug(i)}}collideHeadBarrier(e,t){if(!(this.scene.snakeShield>this.scene.time.now||0===this.bodyGroup.getLength()||this.scene.time.now<this.collideBarrierTimeout)){if(this.helmet>0)return this.helmet--,this.scene.cameras.main.shake(200,.01),void(this.collideBarrierTimeout=this.scene.time.now+200);this.collideBarrierTimeout=this.scene.time.now+100,this.cutTail(this.bodyGroup.getChildren()[this.bodyGroup.getChildren().length-1]),this.scene.cameras.main.shake(200,.01)}}collideHeadEnemy(e,t){if(!t.moving)return;if(!this.head.visible)return;let s=!0;if(this.scene.mission.grayscale&&t.eatable&&(t.type===this.scene.mission.target?this.scene.mission.progress<this.scene.mission.goal&&(this.scene.mission.progress<this.bodyGroup.getLength()&&(this.bodyGroup.getChildren()[this.scene.mission.progress].setTexture("snakebody"),s=!1),this.scene.mission.progress++):(this.scene.mission.progress>0&&(this.scene.mission.progress--,this.bodyGroup.getChildren()[this.scene.mission.progress].setTexture("snaketail")),s=!1)),t.eatable)s&&this.addBody(this.bodyGroup.getLast()||this.head),this.head.setScale(.6666),this.head.setTexture("snakebite"),this.scene.tweens.add({targets:this.head,duration:75,scale:1,yoyo:!0,callbackScope:this,onComplete:function(){this.head.setTexture("snakehead"),this.head.setScale(1)}});else if(5===t.type){this.explodeTail=this.scene.time.now+4e3;let e=this.bodyGroup.getChildren();for(let t=0;t<e.length;t++)t>=Config.snakeLength&&e[t].setTexture("snakebody-boom");let t=10*this.scene.snap;const s=new Phaser.Geom.Rectangle(t,t,this.scene.w-t,this.scene.h-t);let i=this.scene.randomXY([this.head],10*this.scene.snap,s);this.scene.createBug(5,i.x,i.y)}else if(6===t.type)this.flame||(this.flame=this.scene.add.particles(this.head.x,this.head.y,"flares",{color:[16436258,16291840,16266752,10421252],colorEase:"quad.out",lifespan:2400,angle:{min:-100,max:-80},scale:{start:.7,end:0,ease:"sine.out"},speed:100,advance:2e3,blendMode:"ADD"})),this.flashSpeed+=.1,this.head.body.setVelocity(this.speed*this.flashSpeed);else if(this.scene.snakeShield<this.scene.time.now){let e=this.bodyGroup.getChildren().length-Phaser.Math.Between(3,4);e<=0&&(e=0),this.cutTail(this.bodyGroup.getChildren()[e]),this.scene.cameras.main.shake(200,.01)}3!==t.type&&8!==t.type&&this.scene.removeBug(t)}collideBodyEnemy(e,t){if(t.moving&&(2===t.type&&this.scene.removeBug(t),t.damage)){if(this.bodyEnemyTimer>0){if(this.bodyEnemyTimer<this.scene.time.now){if(this.bodyEnemyTimer=0,t.damage.visible=!0,t.damage.timeout=this.scene.time.now+1500,t.hitpoints--,0===t.hitpoints)return t.damage.visible=!1,void this.scene.removeBug(t);let e=Math.floor(t.hitpoints/4);t.damage.setFrame(e)}}else this.bodyEnemyTimer=this.scene.time.now+100;let e=this.bodyGroup.getChildren();for(let t=0;t<e.length;t++)this.flashColor(e[t],65280)}}overlapTeleportFire(e,t){this.scene.mission.progress<this.scene.mission.goal?(this.scene.mission.progress+=1,this.scene.teleportDamage.setFrame(Math.floor(this.scene.mission.progress))):this.scene.teleportDamage.visible=!1,t.destroy()}collideBulletEnemy(e,t){t.moving&&2===t.type&&(e.destroy(),this.scene.removeBug(t))}overlapBuilding(e,t){if(this.isGameOver)return;this.isGameOver=!0,this.bodyGroup.getChildren().length-1>=Config.snakeLength&&this.cutTail(this.bodyGroup.getChildren()[Config.snakeLength]),this.scene.gameOver(!0)}update(e,t,s,i){this.isGameOver&&(this.gameOvertime+=e,this.scene.physics.world.timeScale+=this.gameOvertime/1e3/20,this.scene.physics.world.timeScale=8);let a=this.head,h=this.path,n=this.pathSpacer;if(a.setAcceleration(0),a.setDrag(0),a.body.angularVelocity=0,this.head.visible&&((t.left.isDown||s.A.isDown||i.left)&&(a.body.angularVelocity=-200*this.agilityModifier*this.speedModifier*this.flashSpeed),(t.right.isDown||s.D.isDown||i.right)&&(a.body.angularVelocity=200*this.agilityModifier*this.speedModifier*this.flashSpeed)),this.flame){let e=this.flame;e.visible=!this.isGameOver,e.x=this.head.x,e.y=this.head.y,e.rotation=this.head.rotation-Math.PI/2,e.setDepth(1)}if(!this.isGameOver||this.scene.mission.revenge){if(this.scene.physics.velocityFromRotation(a.rotation,a.body.speed,a.body.velocity),this.delta+=e,this.delta>16*this.scene.physics.world.timeScale){this.delta-=16*this.scene.physics.world.timeScale;let e=this.path.pop();e.x=a.x,e.y=a.y,this.path.unshift(e);let t=this.pathRotation.pop();t=a.rotation,this.pathRotation.unshift(t);let s=this.bodyGroup.getChildren();for(let e=0,t=s.length;e<t;e++)s[e].x=h[(e+1)*n].x,s[e].y=h[(e+1)*n].y,s[e].rotation=this.pathRotation[(e+1)*n]}if(0!==this.explodeTail){if(this.explodeTailFlash&&this.explodeTail<this.scene.time.now+1e3){this.explodeTailFlash=!1;let e=this.bodyGroup.getChildren();for(let t=0;t<e.length;t++)t>=Config.snakeLength&&e[t].setTint(13434879)}if(this.explodeTail<this.scene.time.now){this.explodeTail=0,this.explodeTailFlash=!0;let e=this.bodyGroup.getChildren();for(let t=0;t<e.length;t++)t>=Config.snakeLength&&(e[t].setTexture("snaketail"),e[t].clearTint())}}}}flashColor(e,t){e.effectTimer||(e.setTint(t),e.effectTimer=this.scene.time.delayedCall(250,function(){e.setTint(16777215),e.effectTimer=null},this))}}class MainGame extends Phaser.Game{constructor(e){let t=window.innerWidth,s=window.innerHeight;if(t<s){let e=t;t=s,s=e}super({key:e.id,type:Phaser.AUTO,parent:e,width:t,height:s,backgroundColor:"#202f53",audio:{noAudio:!0},physics:{default:"arcade",arcade:{}},scale:{mode:Phaser.Scale.NO_SCALE},input:{touch:{capture:!0},gamepad:!0},disableContextMenu:!0,scene:[new LoaderScene,MissionScene,RevengeScene,MapScene]})}}function createGame(){window.game=new MainGame(document.getElementById("canvas")),Config.initGame(window.game)}function log(e){console.log(e)}