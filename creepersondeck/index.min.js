/*! Copyright creepersondeck 21-12-2021 */

let UnitActionBuild=t=>(class extends t{buildInit(t={}){this.build=t;const e=this.build;e.started=!1,e.start=this.buildStart,e.stop=this.buildStop}buildDeinit(){this.build.started&&this.buildStop()}buildStart(t){const e=this.build;e.started=!0,e.unit=t,this.buildDo()}buildStop(){this.currentAction=null,this.build.started=!1}buildDo(){const t=this.build;let e;if("ActionBotIn"===t.menuName){let t=this.scene.getTroops(this.player),e=null;for(let i=0;i<t.length;i++){let s=t[i];s instanceof UnitWorker&&s.visible&&Phaser.Math.Distance.Between(s.x,s.y,this.player.bot.x,this.player.bot.y)<=this.player.bot.width&&(e=s)}return e&&this.scene.cardScene.statusBot.update(1)&&e.destroy(),void this.buildStop()}if("ActionBuild"===t.menuName){if(this.scene.cardScene.statusBot.update(-1)){new UnitWorker(this.scene,this.build.unit.x,this.build.unit.y,this.player,{parent:this.build.unit})}return void this.buildStop()}"ActionBuildSpawner"===t.menuName?e=new UnitSpawner(this.scene,t.unit.x,t.unit.y,this.player,{parent:t.unit}):"ActionBuild"===t.menuName&&(e=new UnitLaser(this.scene,t.unit.x,t.unit.y,this.player,{parent:t.unit}));const i=t.unit.route;e.route;for(let t=0;t<i.sources.length;t++)e.routeAdd(i.sources[t]);for(let t=0;t<i.targets.length;t++)i.targets[t].routeAdd(e);t.unit.destroy(),this.buildStop()}}),UnitActionConnect=t=>(class extends t{connectInit(t){this.connect=t;const e=this.connect;e.start=this.connectStart,e.stop=this.connectStop,e.started=!1,e.range=this.scene.scaleResolution(this.connect.range),e.rangeSquared=this.connect.range*this.connect.range,e.target=null,e.targetImage=this.scene.add.image(this.scene.cameras.main.centerX,this.scene.cameras.main.centerY,"ActionProgress"),e.targetImage.visible=!1,e.targetImage.setDepth(2),e.targetImage.alpha=.5,e.targetImage.setTint(16711935),e.beam=this.scene.add.sprite(this.scene.cameras.main.centerX,this.scene.cameras.main.centerY,"EffectLaser"),this.scene.anims.create({key:"EffectLaser",frames:this.scene.anims.generateFrameNumbers("EffectLaser"),frameRate:8,repeat:-1,yoyo:!1}),e.beam.anims.play("EffectLaser"),e.beam.visible=!1,e.beam.setOrigin(0,.5),e.beam.setTint(16724787)}connectDeinit(){this.connect.beam.destroy(),this.connect.started&&this.connectStop()}connectStart(t){const e=this.connect;e.started=!0,e.target=t,e.target.addListener(this),this.connectDo(),this.connect.beam.visible=!0,e.targetImage.visible=!0}connectStop(){this.currentAction=null;const t=this.connect;if(t.started=!1,this.connectValid()){let e=this.control.target.unit;this.scene.cardScene.statusEnergy.update(-1)&&(e?(e.routeAdd(this.connect.target),this.scene.unitMap.refresh(e)):this.techStart(t.target))}this.connect.beam.visible=!1,t.targetImage.visible=!1,t.target.removeListener(this),t.target=null}connectValid(){let t;var e=Phaser.Math.Distance.Squared(this.x,this.y,this.connect.target.x,this.connect.target.y);let i=this.scene.getBoardDivSquared();if(this.connect.target===this.control.target.unit)this.lastX=this.control.target.unit.x,this.lastY=this.control.target.unit.y,t=!1;else if(e>i)this.lastX=this.x,this.lastY=this.y,t=!1;else if(this.control.target.unit)this.lastX=this.control.target.unit.x,this.lastY=this.control.target.unit.y,t=!0;else{let e=this.scene.getBoardTile(this.lastX,this.lastY);if(e)if(t=3===e.index){let t=this.scene.groundLayer.tileToWorldXY(e.x,e.y);this.lastX=t.x+e.width/2,this.lastY=t.y+e.height/2}else this.lastX=this.x,this.lastY=this.y;else t=!1,this.lastX=this.x,this.lastY=this.y}return t}connectDo(){const t=this.connect;let e;this.lastX=this.x,this.lastY=this.y,e=this.connectValid()?65280:16711680,this.connect.beam.tint=e,t.targetImage.tint=e,t.targetImage.x=this.lastX,t.targetImage.y=this.lastY,this.connect.beam.x=this.lastX,this.connect.beam.y=this.lastY;let i=Phaser.Math.Angle.BetweenPoints(this.connect.beam,this.connect.target);this.connect.beam.setRotation(i);var s=Phaser.Math.Distance.Between(this.connect.beam.x,this.connect.beam.y,this.connect.target.x,this.connect.target.y);this.connect.beam.scaleX=s/this.connect.beam.width}}),UnitActionConsume=t=>(class extends t{consumeInit(t){this.consume=t;const e=this.consume;if(e.time=1/0,!e.buildProducts)return e.buildProducts=null,void(e.useProducts?this.consumeIconAdd(e.useProducts):e.useProducts=null);this.unitState=Unit.StateBuild,this.consumeIconAdd(e.buildProducts)}consumeIconAdd(t){if(!t)return;const e=this.consume;e.slots=[],e.bars=[];let i=this.x,s=this.y,n=this.scene.textures.get("UnitProductSlot").getSourceImage(),a=(n.width,n.height);t.length>=2&&(i-=a/2),t.length>=3&&(s-=a/2);for(let n=0;n<t.length;n++){let h,r;"square"===t[n]?(h=13136183,r=0):"circle"===t[n]&&(h=7456823,r=1);let o=this.scene.add.image(i,s,"UnitProductSlot");o.setTint(h),o.setFrame(r),e.slots.push(o);let l=this.scene.add.image(i,s,"UnitProduct");l.setFrame(r),e.bars.push(l),i+=a,1===n&&(i-=2*a,s+=a)}}consumeIconRemove(){const t=this.consume;if(t.slots){for(let e=t.slots.length-1;e>=0;e--)t.slots[e].destroy(),t.bars[e].destroy();t.slots=[],t.bars=[]}}consumeDeinit(){this.consume.time!==1/0&&this.consumeStop(),this.consumeIconRemove()}consumeStart(t){const e=this.consume;e.time=0,e.unit=t}consumeStop(){const t=this.consume;t.time=1/0,t.unit=null}consumeDo(t){if(this.unitState===Unit.StateBuild){for(let e=0;e<this.consume.buildProducts.length;e++)if(this.consume.buildProducts[e]===t.unit.type){this.consume.buildProducts[e]="filled",this.consume.bars[e].setTint(13136183),t.destroy();break}for(let t=0;t<this.consume.buildProducts.length;t++)if("filled"!==this.consume.buildProducts[t])return;this.unitState=Unit.StateRecharge,this.consumeIconRemove(),this.consumeIconAdd(this.consume.useProducts),this.scene.unitMap.refresh(this)}else{if(!this.consume.useProducts)return;for(let e=0;e<this.consume.useProducts.length;e++)if(this.consume.useProducts[e]===t.unit.type){this.consume.useProducts[e]="filled",this.consume.bars[e].setTint(13136183),t.destroy();break}for(let t=0;t<this.consume.useProducts.length;t++)if("filled"!==this.consume.useProducts[t])return;if(this.consumed())for(let t=0;t<this.consume.useProducts.length;t++)this.consume.useProducts[t]="square"}}consumed(){}consumeNeed(t){const e=this.consume;let i=e.buildProducts;if(i&&0!==i.length||(i=e.useProducts),i)for(let e=0;e<i.length;e++)if(i[e]===t)return!0;return!1}}),UnitActionControl=t=>(class extends t{controlInit(t){this.control=t,this.control.started=!1,this.targetPosition=null,this.targetPositionImage=this.scene.add.image(0,0,"ControlTarget"),this.targetPositionImage.visible=!1,this.control.target={unit:null,focus:null,focusImage:this.scene.add.image(this.x,this.y,UnitBot.name+"Target"),img:this.scene.add.image(this.x,this.y,UnitBot.name+"Target")},this.control.target.img.visible=!1,this.control.target.focusImage.visible=!1,this.control.target.focusImage.tint=10066329,this.control.speed=1,this.body.maxSpeed=1.5*Unit.defaultSpeed*this.scene.game.resolution,this.currentAction=null,this.control.action=null,this.body.moves=!0,this.body.immovable=!1}controlDeinit(){const t=this.control;t.started&&this.controlStop(),t.action&&t.action.menuDeinit(),t.target.img.destroy(),t.target.focusImage.destroy(),this.control=null}controlStart(){this.control.started=!0,this.setDrag(2.5*this.body.maxSpeed),this.body.setAllowDrag(!0)}controlStop(){this.control.started=!1}controlDo(t,e,i,s,n){const a=this.control;if(null===a.action){if(t||e||i||s){n&&(a.target.unit=null,a.target.img.visible=!1,a.target.focus=null,a.target.focusImage.visible=!1,this.controlResume(null));let h=this,r=this.x,o=this.y;t?o-=a.speed:e&&(o+=a.speed),i?r-=a.speed:s&&(r+=a.speed);let l=Phaser.Math.Angle.Between(h.x,h.y,r,o);h.rotation=Phaser.Math.Angle.RotateTo(h.rotation,l,a.turnSpeed),this.scene.physics.velocityFromRotation(this.rotation,2.5*this.body.maxSpeed,this.body.acceleration)}else if(n)this.controlPause();else if(this.targetPosition){let t=Phaser.Math.Angle.Between(this.x,this.y,this.targetPosition[0],this.targetPosition[1]);this.rotation=Phaser.Math.Angle.RotateTo(this.rotation,t,a.turnSpeed),this.scene.physics.velocityFromRotation(this.rotation,2.5*this.body.maxSpeed,this.body.acceleration)}if(null!==this.targetPosition){Phaser.Math.Distance.Squared(this.x,this.y,this.targetPosition[0],this.targetPosition[1])<this.targetPositionProximity&&this.controlPause()}}else n&&(t||e||i||s)&&a.action.actionSelect(t,e,i,s)}controlPause(){this.setFrame(0),this.body.setAcceleration(0),null!==this.targetPosition&&(this.targetPositionImage.visible=!1,this.targetPosition=null)}controlResume(t){if(this.targetPosition=t,this.setFrame(1),t){this.targetPositionImage.setPosition(t[0],t[1]);let e=Phaser.Math.Distance.Squared(this.x,this.y,t[0],t[1]);this.targetPositionProximity=e/5,this.targetPositionProximity>this.width*this.width*2&&(this.targetPositionProximity=this.width*this.width*2)}this.targetPositionImage.visible=null!==t}controlPoint(t){if(null!==this.control.action)return this.controlPause(),!1;if(t){if(this.getBounds().contains(t[0],t[1]))return this.control.pad.select(),!0;this.controlResume(t)}else this.controlPause();return!0}controlAction(t){const e=this.control;return this.currentAction?(this.currentAction.stop.call(this),void(this.currentAction=null)):e.action?(e.action.actionActivate(),void(e.action=null)):(e.target.unit?this.currentAction||(e.action=e.target.unit,e.action.menuStart(this),e.target.unit=null,e.target.img.visible=!1,e.target.focus=null,e.target.focusImage.visible=!1):(e.action=this,this.menuStart(this)),void this.controlPause())}}),UnitActionLive=t=>(class extends t{liveInit(t={}){this.live=t;const e=this.live;e.time=1/0,e.health=(e.health||1)*Unit.defaultHealth,e.damage=(t.damage||0)*e.health,e.supplyUnit=null}liveDeinit(){const t=this.live;t.time!==1/0&&this.liveStop(),t.damageImage&&t.damageImage.destroy(),t.damageImage2&&t.damageImage2.destroy()}liveStart(t){const e=this.live;e.time=0,this.unit.time=0,e.damageSize&&(this.live.damageImage=this.scene.add.image(this.x,this.y,"UnitDamage-"+e.damageSize,0),this.live.damageImage.setDepth(-1),this.live.damageImage.setTint(this.player.color),this.updateDamageImage()),this instanceof UnitGate&&this.anims.play("UnitGate")}liveStop(){const t=this.live;t.time=1/0,t.damageImage&&t.damageImage.destroy(),t.damageImage2&&t.damageImage2.destroy()}liveDo(){const t=this.live;return t.damage>0&&null!==t.supplyUnit&&(t.damage-=t.heal,t.heal=0,t.damage<0&&(t.damage=0),this.updateDamage()),t.supplyUnit&&(t.supplyUnit=null),1e3}liveRecover(t){const e=this.live;0!==e.damage&&(e.damage-=t,e.damage<=0&&(e.damage=0),this.updateDamage())}liveDamage(t){const e=this.live;if(0===e.damage&&this.route&&this.route.connectEmitter.length>0&&this.route.connectEmitter[0].produceAddPath(this.route.connectEmitter),e.damage+=t,e.damage>e.health)return e.damage=e.health,void this.liveDie();this.updateDamage()}liveConsume(t){const e=this.live;0===e.damage&&this.route&&this.route.connectEmitter.length>0&&this.route.connectEmitter[0].produceAddPath(this.route.connectEmitter),e.damage+=t,e.damage>e.health?e.damage=e.health:this.updateDamage()}liveDie(){this.live;this.isMapUnit||this.destroy()}liveOverlap(t){}updateDamage(){if(this.unitState<Unit.StateRecharge)return void(this.incubate&&this.incubate>0&&this.setScale(this.incubate));const t=this.live;if(t){if(t.damageImage)this.updateDamageImage();else{let e=(t.health-t.damage)/t.health;this.setScale(e),this.body.mass=this.scale*this.width}this.scene.anims.exists(this.constructor.name)&&(this.anims.isPlaying,this.live.damage),0===t.damage?(this.route&&this.route.connectEmitter.length>0&&this.route.connectEmitter[0].produceRemovePath(this.route.connectEmitter),this.unitState===Unit.StateRecharge&&(this.unitState=Unit.StateActive,this.unitEventNotify("enable"),this.scene.anims.exists(this.constructor.name)?this.anims.play(this.constructor.name):this.anims.resume())):this.unitState===Unit.StateActive&&(this.unitState=Unit.StateRecharge,this.unitEventNotify("disable"),this.anims.isPlaying&&(this instanceof UnitCrusher||this.anims.pause()))}else this.setScale(this.incubate)}updateDamageImage(){if(1===this.unit.level){let t=this.live.damageImage.texture.frameTotal-2,e=Math.trunc(t*(this.live.health-this.live.damage)/this.live.health);this.live.damageImage.setFrame(e)}else{let t=this.live.health/2;if(this.live.damage<t){let e=this.live.damageImage.texture.frameTotal-2;this.live.damageImage.setFrame(e);let i=Math.trunc(e*(t-this.live.damage)/t);this.live.damageImage2.setFrame(i),this.live.damageImage2.alpha=1}else{let e=this.live.damageImage.texture.frameTotal-2;this.live.damageImage2.setFrame(e-1),this.live.damageImage2.alpha=.5;let i=Math.trunc(e*(this.live.health-this.live.damage)/t);this.live.damageImage.setFrame(i)}}}liveEvent(t,e){"stop"===e&&t===this.live.supplyUnit&&(this.live.supplyUnit=null)}}),UnitActionMenu=t=>(class extends t{menuInit(t={}){this.action=t;const e=this.action;e.started=!1,e.list=t.actions,e.actions=[],e.selected=null,e.latest=null}menuDeinit(){this.action.started&&this.menuStop()}menuStart(t){const e=this.action;e.started=!0;{let i;i="center",e.actions.push(new UIAction(this,"ActionCancel",null,null,i,"green",0)),i="up",e.actions.push(new UIAction(this,"ActionSpawn",t,t.spawn,i,"green",1)),i="left";let s=!1,n=this.scene.getTroops(this.player);for(let e=0;e<n.length;e++){let i=n[e];i instanceof UnitWorker&&i.visible&&Phaser.Math.Distance.Between(i.x,i.y,t.x,t.y)<=t.width&&(s=!0)}s?e.actions.push(new UIAction(this,"ActionBotIn",t,t.build,i,"green",0,0)):e.actions.push(new UIAction(this,"ActionBuild",t,t.build,i,"green",1,!1,this.unitState<Unit.StateActive)),i="down",e.actions.push(new UIAction(this,"ActionConnect",t,t.connect,i,"lila",1,!1,this.unitState<Unit.StateActive)),i="right";{let s=!1;for(let n=0;n<e.list.length;n++){let a=e.list[n];if(a===Unit.Action.Travel){e.actions.push(new UIAction(this,"ActionTeleport",t,t.travel,i,"blue",0,!1,this.unitState<Unit.StateActive)),s=!0;break}if(a===Unit.Action.Cargo){e.actions.push(new UIAction(this,"ActionCargo",t,t.tech,i,"blue",0,!1,this.unitState<Unit.StateActive));break}}s||this.action.latest&&e.actions.push(new UIAction(this,this.action.latest,t,t.spawn,i,"blue",0))}}e.selected=e.actions[0]}destroyItem(t){this.scene.tweens.add({targets:[t.first,t.next,t.icon],alpha:0,ease:"Power1",duration:150,onCompleteScope:this,onComplete:function(){t.destroy()}},this)}menuStop(t=!1){const e=this.action;for(e.started=!1;e.actions.length>0;){let i=e.actions.shift();(t||i!==this.action.selected||this.scene.cardScene.isGameOver)&&this.destroyItem(i)}}menuRemove(t){let e=this.action.list.indexOf(t);-1!==e&&this.action.list.splice(e,1)}setSelected(t){const e=this.action;e.selected&&e.selected.setState("enabled"),t.setState("active"),e.selected=t}menuSelect(t,e,i){const s=this.action;if(!s.started)return null;for(let i=0;i<s.actions.length;i++){let n=s.actions[i];if(n.first.setTexture("ActionBg"),n.first.getBounds().contains(t,e)){if("disabled"!==n.state)return this.setSelected(n),this.actionActivate(),null;n.showStatus()}}return this}actionSelect(t,e,i,s){const n=this.action;if(t+e+i+s>1&&n.selected!==n.actions[0])return;for(let t=0;t<n.actions.length;t++){n.actions[t].first.setTexture("ActionBg")}let a,h=n.selected.index;for(0===n.selected.index?(t?h=10:e&&(h=30),i?h=40:s&&(h=20)):20===h||40===h?t?h--:e?h++:i?h=40:s&&(h=20):10===h||30===h?i?h--:s?h++:t?h=10:e&&(h=30):t?h--:e?h++:i?h--:s&&h++,a=0;a<n.actions.length;a++)if(h===n.actions[a].index){h=a;break}a===n.actions.length&&(h=0),"disabled"!==n.actions[h].state?this.setSelected(n.actions[h]):n.actions[h].showStatus()}actionActivate(){this.action;let t=250;this.action.selected.action&&"tech"===this.action.selected.action.level&&(t=150);let e=this.action.selected;e.setState("active");let i=this;if(!i.scene)return console.log("actionActivate",i),void this.menuStop();i.scene.cameras.main.centerX,i.scene.cameras.main.centerY;let s=e.actionUnit;this.scene.tweens.add({targets:[e.first,e.next,e.icon],ease:"Power1",alpha:0,duration:t,onCompleteScope:this,onComplete:function(){if(e.action){e.action.menuName=e.name,e.action.ActionBotIn=e.ActionBotIn,e.action.ActionBuild=e.ActionBuild;this.scene.cardScene.energy;s.activateAction(e.action,e.menuUnit)}}},this),this.menuStop()}}),UnitActionMinigame=t=>(class extends t{minigameInit(t={}){this.minigame=t;const e=this.minigame;e.start=this.minigameStart,e.stop=this.minigameStop,e.started=!1,this.minigameSet("tictactoe-0")}minigameDeinit(){this.minigame.started&&this.minigameStop()}minigameSet(t){this.minigame.level=t}minigameStart(){const t=this.minigame;t.started=!0,t.fromScene=this.scene,this.minigameDo(),this.scene.scene.sleep()}minigameStop(){this.minigame.started=!1,this.scene.scene.wake()}minigameDo(t){const e=this.minigame;EventDispatcher.getInstance().emit("GameStatus",{minigame:!0,level:e.level,time:500})}}),UnitActionMove=t=>(class extends t{moveInit(t){this.move=t;const e=this.move;e.time=1/0,e.speed=t.speed*this.scene.game.resolution,this.body.moves=!0,this.body.immovable=!1,this.body.maxSpeed=e.speed;e.drag,this.body.maxSpeed;this.setDrag(this.body.maxSpeed,this.body.maxSpeed),this.body.setAllowDrag(!0),e.accuracy||(e.accuracy=500),e.toUnit=null,e.area=null}moveDeinit(){this.move.time!==1/0&&this.moveStop()}moveStart(t=null){const e=this.move;e.time!==1/0&&this.moveStop(),e.time=0,this.unit.time=0,t instanceof Phaser.GameObjects.Sprite?(e.toUnit=t,e.toUnit.addListener(this)):null!==t&&(e.area=t)}moveStop(){const t=this.move;t.time=1/0,null!==t.toUnit&&(t.toUnit.removeListener(this),t.toUnit=null)}moveDo(){const t=this.move;if(null!==t.toUnit)return t.toUnit.damage>=t.toUnit.health-4?(t.toUnit=null,t.accuracy):this.moveToUnit();var e;if(this.x<t.area.x)e=0;else if(this.y<t.area.y)e=Math.PI/2;else if(this.x>t.area.x+t.area.w)e=Math.PI;else if(this.y>t.area.y+t.area.h)e=-Math.PI/2;else if(Math.random()<.75)if(this.scene.unitStations){let t=Phaser.Math.RND.pick(this.scene.unitStations);e=Phaser.Math.Angle.BetweenPoints(this,t)}else e=Math.PI/2;else e=Phaser.Math.Angle.Random();return t.turnSpeed&&(t.turnSpeed=1,e=Phaser.Math.Angle.RotateTo(this.rotation,e,t.turnSpeed),this.rotation=e),this.scene.physics.velocityFromRotation(e,2*this.body.maxSpeed,this.body.acceleration),1500}moveEvent(t,e){"stop"===e&&t===this.move.toUnit&&(this.moveStop(),this.moveStart(this.unit.parent))}moveToUnit(){const t=this.move;let e=Phaser.Math.Angle.BetweenPoints(this,t.toUnit);this.scene.physics.velocityFromRotation(e,2*this.body.maxSpeed,this.body.acceleration);return 500}}),UnitActionProduce=t=>(class extends t{produceInit(t){this.produce=t;const e=this.produce;e.time=1/0,e.product=null,0===this.live.damage&&this.produceStart()}produceDeinit(){this.produce.started&&this.produceStop()}produceStart(){const t=this.produce;t.time=0,this.unit.time=0,t.paths=[],this.produce.delay}produceStop(){const t=this.produce;t.paths=[],t.time=1/0,this.produce.timeout=0}produceDo2s(){this.unit.disabled>0||(this.produce.timeout>0&&this.scene.addEvent(this.produceDo,this.produce.timeout,this),0!==this.route.connectEmitter.length&&this.produceUnit())}produceAddPath(t){if(t.length<=1)return;const e=this.produce;if(e.time!==1/0){e.time=0,this.unit.time=0;for(let e=0;e<this.produce.paths.length;e++){let i=this.produce.paths[e];if(i[i.length-1]===t[t.length-1])return}this.produce.paths.push(t)}}produceRemovePath(t){if(this.produce.time!==1/0)for(let e=this.produce.paths.length-1;e>=0;e--){let i=this.produce.paths[e];i[i.length-1]===t[i.length-1]&&this.produce.paths.splice(e,1)}}}),UnitActionRoute=t=>(class extends t{routeInit(t){this.route=t;const e=this.route;e.time=1/0,e.rangeMin=this.width,e.rangeMinSquared=e.rangeMin*e.rangeMin,e.range=this.scene.scaleResolution(t.range),e.rangeSquared=e.range*e.range,e.sources=[],e.sourceImages=[],e.targets=[],e.connectEmitter=[]}routeDeinit(){const t=this.route;t.time!==1/0&&this.routeStop(),t.sources.forEach(function(t){t.routeTargetRemove(this)},this),t.sources=[],t.targets.forEach(function(t){t.routeSourceRemove(this)},this),t.targets=[],t.connectEmitter.length>0&&t.connectEmitter[0].produceRemovePath(t.connectEmitter)}routeStart(t){return this.route.time=0,this.unit.time=0,!0}routeClear(){}routeStop(){this.route.time=1/0}routeAdd(t){const e=this.route;for(let i=0;i<e.targets.length;i++){if(e.targets[i]===t)return!1;if(e.sources[i]===t)return!1}t.routeConnection(this),e.targets.push(t)}routeSourceRemove(t){const e=this.route;for(let i=0;i<e.sources.length;i++)if(e.sources[i]===t){e.sources.splice(i,1),e.sourceImages.splice(i,1)[0].destroy();break}}routeTargetRemove(t){const e=this.route;for(let i=0;i<e.targets.length;i++)if(e.targets[i]===t){e.targets.splice(i,1);break}}routeConnection(t){const e=this.route;let i=this.scene.add.sprite(this.x,this.y,"UnitMapPipe");i.setOrigin(0,.5);let s=Phaser.Math.Angle.BetweenPoints(this,t);i.setRotation(s);var n=Phaser.Math.Distance.Between(this.x,this.y,t.x,t.y);i.scaleX=n/i.width,i.setDepth(-1),i.setTint(13395660),e.sources.push(t),e.sourceImages.push(i)}routeUpdate(t){if(this.unitState===Unit.StateBuild)return;let e=this.scene.getHqUnits(this.player);for(let i=0,s=e.length;i<s;i++)if(e[i].isPowerSource){let s=t.findUnitPath(e[i],this);s.length>0&&(0===this.route.connectEmitter.length||s.length<this.route.connectEmitter.length)&&(this.route.connectEmitter=s)}this.route.connectEmitter.length>1&&this.live.damage>0&&this.route.connectEmitter[0].produceAddPath(this.route.connectEmitter)}}),UnitActionShoot=t=>(class extends t{shootInit(t={}){this.shoot=t;const e=this.shoot;e.time=1/0,e.start=this.shootStart,e.stop=this.shootStop,e.range=this.scene.scaleResolution(e.range),e.rangeSquared=e.range*e.range,e.target=null,e.targetAuto=null,e.laser=this.scene.add.sprite(this.scene.cameras.main.centerX,this.scene.cameras.main.centerY,"connect.beam"),this.scene.anims.create({key:"EffectLaser",frames:this.scene.anims.generateFrameNumbers("EffectLaser"),frameRate:8,repeat:-1,yoyo:!1}),e.laser.anims.play("EffectLaser"),e.laser.visible=!1,e.laser.setOrigin(0,.5),e.laser.setTint(16724787),e.laser.setDepth(99)}shootDeinit(){this.shoot.time!==1/0&&this.shootStop()}shootStart(t){const e=this.shoot;e.time=0,this.unit.time=0,e.target=t,e.target.addListener(this),this.preUpdate(),e.laser.visible=!0}shootStop(){const t=this.shoot;t.time=1/0,t.target&&(t.target.removeListener(this),t.target=null,t.targetAuto=null),t.laser.visible=!1}shootTarget2(t){const e=this.shoot;t!==e.target?(e.target,e.target=t,null!==e.target?e.laser&&(e.laser.visible=!0):e.laser&&(e.laser.visible=!1)):log("fail")}shootDo(){const t=this.shoot;return null===t.target?1/0:(t.target.liveDamage(t.damage),t.speed)}shootEvent(t,e){if("start"===e){const t=this.shoot;t.time===1/0&&(this.unit.time=0,t.time=0)}else if("stop"===e){t===this.shoot.target&&this.shootStop()}}}),UnitActionSpawn=t=>(class extends t{spawnInit(t={}){this.spawn=t;const e=this.spawn;e.started=!1,e.start=this.spawnStart,e.stop=this.spawnStop}spawnDeinit(){this.spawn.started&&this.spawnStop()}spawnStart(t){if(!this.scene.cardScene.statusEnergy.update(-1))return;const e=this.spawn;e.started=!0,e.unit=t||this,e.count=10,this.spawnDo()}spawnStop(){this.currentAction=null,this.spawn.started=!1}spawnDo(){const t=this.spawn;if(t.count>0){t.count--;new UnitElement(this.scene,this.x,this.y,this.player,{parent:t.unit});this.scene.addEvent(this.spawnDo,100,this)}else this.spawnStop()}}),UnitActionTech=t=>(class extends t{techInit(t={}){this.tech=t;const e=this.tech;e.start=this.techStart,e.stop=this.techStop,e.started=!1,e.unit=null}techDeinit(){this.tech.started&&this.techStop()}techSet(t){}techStart(t){const e=this.tech;console.log(e),e.started=!0,e.unit=t,e.fromScene=this.scene,this.techDo(),this.scene.scene.sleep()}techStop(t){if("ActionCargo"===this.tech.menuName)this.action.latest=t.selected,"ActionBuild"===t.selected?(this.build.menuName=t.selected,this.buildStart(this.tech.unit)):"ActionBotIn"===t.selected&&(this.build.menuName=t.selected,this.buildStart(this.tech.unit));else if("ActionTool"===this.tech.menuName)this.shootActive=!1,this.action.latest=t.selected,"ActionSpawn"===t.selected?this.spawnStart(this):"ActionBuild"===t.selected&&(this.shootActive=!0);else if(this.tech.unit&&t){let e=null;if("UnitLaser"===t.selected?e=UnitLaser:"UnitSpawner"===t.selected?e=UnitSpawner:"UnitRoute"===t.selected?e=UnitRoute:"UnitStorage"===t.selected&&(e=UnitStorage),e){this.action.latest=t.selected;let i=new e(this.scene,this.connect.targetImage.x,this.connect.targetImage.y,this.player,{});this.tech.unit.route&&i.routeAdd(this.tech.unit),this.scene.unitMap.refresh(i)}this.tech.unit=null}this.currentAction=null;const e=this.tech;e.started=!1,e.menuName=null,this.scene.scene.wake()}techDo(t){const e=this.tech;EventDispatcher.getInstance().emit("GameStatus",{tech:!0,modal:!0,type:e.menuName,ActionBotIn:e.ActionBotIn,ActionBuild:e.ActionBuild,time:500})}}),UnitActionTransit=t=>(class extends t{transitInit(t={}){this.transit=t;const e=this.transit;e.started=!1,e.target=null,e.path=null}transitDeinit(){this.transit.started&&this.transitStop()}transitStart(t,e){const i=this.transit;i.started=!0,i.target=t,i.target.addListener(this),i.path=e;for(let t=0;t<e.length-1;t++)e[t].addListener(this);if(e.length>1){this.body.enable=!1;let t=new Phaser.Curves.Path(e[0].x,e[0].y);for(let i=1,s=e.length;i<s;i++)t.lineTo(e[i].x,e[i].y);i.sprite=this.scene.add.follower(t,e[0].x,e[0].y,i.icon),this.visible=!1,i.sprite.setTint(13421772),i.sprite.setScale(.5),i.sprite.startFollow({duration:t.getLength()*i.speed/300,onComplete:(t,e)=>{i.sprite&&(this.x=i.sprite.x,this.y=i.sprite.y,i.sprite.destroy(),i.sprite=null),this.transitDone()}}),i.sprite.setRotateToPath(!0,90)}else this.transitDone()}transitStop(){const t=this.transit;t.started=!1,this.x=this.unit.parent.x,this.y=this.unit.parent.y,t.target.removeListener(this),t.target=null;for(let e=0;e<t.path.length-1;e++)t.path[e].removeListener(this);t.path=null,t.sprite&&(this.x=t.sprite.x,this.y=t.sprite.y,this.body.rotation=t.sprite.rotation,t.sprite.stopFollow(),t.sprite.destroy(),t.sprite=null),this instanceof UnitWorker||(this.body.enable=!0),this.visible=!0}transitEvent(t,e){const i=this.transit;"stop"===e&&i.path&&-1!==i.path.indexOf(t)&&this.destroy()}}),UnitActionTravel=t=>(class extends t{travelInit(t={}){this.travel=t;const e=this.travel;e.start=this.travelStart,e.stop=this.travelStop,e.started=!1,this.travel.from=null,this.travel.to=null}travelDeinit(){this.travel.started&&this.travelStop()}travelStart(t){if(t.live.damage>0)return t.tint=10066329,void this.scene.time.addEvent({delay:500,callback:()=>{from.clearTint()},callbackScope:this});this.travel.started=!0,this.scene.cardScene.disableUnitScene(),this.travelDo(t),this.body.checkCollision.none=!0}travelStop(){this.currentAction=null,this.travel.started=!1;let t=4*this.width,e=this.scene.getEnemyUnits(this.x,this.y,t*t,this.player),i=64*this.scene.game.resolution,s=this.scene.level.grid.w*i,n=this.scene.level.grid.h*i;for(let t=0;t<e.length;t++)if(!(e[t]instanceof UnitTeleport)){let a,h,r;for(r=0;r<10;r++){a=e[t].x,h=e[t].y,a+=0==Phaser.Math.Between(0,1)?1:-1*Phaser.Math.Between(3*this.width,4*this.width),h+=0==Phaser.Math.Between(0,1)?1:-1*Phaser.Math.Between(3*this.height,4*this.height),(a<i||a>s-i||h<i||h>n-i)&&console.log(a,h,s,n,i);break}10===r&&alert("prob"),this.boundUnit(e[t])}this.body.checkCollision.none=!0,this.scene.time.addEvent({delay:2500,callback:()=>{this.body.checkCollision.none=!1},callbackScope:this})}boundUnit(t){t.body.moves=!1,t.alpha=.25,this.scene.tweens.add({targets:t,ease:"Quad.easeOut",duration:2e3,alpha:1,x:dx,y:dy,callback:()=>{t.body.moves=!0},callbackScope:this})}travelEffect(t,e,i=2500){this.travel;this.scene.time.addEvent({callback:()=>{let t=this.scene.add.image(e.x,e.y,"EffectTeleport");t.scale=0,this.scene.tweens.add({targets:t,scale:3,ease:"Linear",duration:i/2,alpha:0,rotation:2*Math.PI,onComplete:function(){t.destroy()}})},callbackScope:this,repeat:1});t&&(this.setScale(0),this.alpha=0);this.scene.tweens.add({targets:this,ease:"Quad.easeOut",duration:i,scale:t?1:0,alpha:t?1:0,callback:()=>{},callbackScope:this})}travelDo(t){this.travel;this.controlPoint(null),this.travel.from=t,this.travelEffect(!1,this.travel.from,1500),EventDispatcher.getInstance().emit("GameStatus",{teleport:!0,from:t,time:2500}),this.body.setVelocity(0),this.body.setAcceleration(0),this.stop()}}),UnitActionWatch=t=>(class extends t{watchInit(t={}){this.watch=t;const e=this.watch;e.time=1/0,e.range&&(e.range*=this.scene.game.resolution),e.rangeSquared||(e.rangeSquared=e.range*e.range),e.unit=null,e.unitDistanceSquared=1/0}watchDeinit(){this.watch.time!==1/0&&this.watchStop()}watchStart(t){const e=this.watch;e.time=0,this.unit.time=0,t instanceof Phaser.GameObjects.Sprite?(this.watchTarget(t),e.unitArrays=null):(this.watchTarget(null),e.unitArrays=t)}watchStop(){const t=this.watch;t.time=1/0,this.watchTarget(null),t.unitArrays=null}watchDo(t){const e=this.watch;let i=1/0;if(null!==e.unit)return e.unit.damage>=e.unit.health-1?(e.unit=null,e.latency):(e.unitDistanceSquared=Phaser.Math.Distance.Squared(this.x,this.y,e.unit.x,e.unit.y),e.unitDistanceSquared>e.rangeSquared&&this.watchTarget(null),e.latency);for(let t=e.unitArrays.length-1;t>=0;t--){let s=e.unitArrays[t];for(let t=s.length-1;t>=0;t--){const n=s[t];if(n===this)continue;if(!(this instanceof UnitEnergy)&&(n.unitState<Unit.StateRecharge||n.live&&n.live.damage>=n.live.health-1))continue;if(e.unitDistanceSquared=Phaser.Math.Distance.Squared(this.x,this.y,n.x,n.y),e.unitDistanceSquared<e.rangeSquared)return this.watchTarget(n),e.latency;let a=e.unitDistanceSquared/e.rangeSquared*e.latency;a<i&&(i=a)}}return i}watchEvent(t,e){const i=this.watch;"stop"===e&&t===i.unit&&this.watchTarget(null),"start"===e&&i.unitArrays&&i.time===1/0&&(this.unit.time=0,i.time=0)}watchTarget(t){const e=this.watch;e.unit&&e.unit.removeListener(this),e.unit=t,e.unit&&e.unit.addListener(this)}});class Unit extends Phaser.Physics.Arcade.Sprite{constructor(t,e,i,s,n,a,h,r){super(t,e,i,s),h.incubate&&(this.incubate={scale:0,speed:h.incubate},t.addIdle(this)),this.player=a,this.action=null,this.isMapUnit=r===t.mapUnitGroup,null!==a&&r===t.mapUnitGroup&&(r=t.teamBuildings[a.team.id]),this.id=h.id||Unit.id++,this.destroyed?this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed):this.on(Phaser.GameObjects.Events.DESTROY,this.deinitUnit),this.unitConfig=h,this.unitConfig.incubate?(this.incubate=0,this.sceneGroup=r,this.scene.idleUnits.add(this,!0),this.body.moves=!1,this.body.immovable=!0,this.unitState=Unit.StateInit):(r.add(this,!0),this.initUnit())}unitInit(t){this.unit=t||{},this.unitState=Unit.StateInit,this.unit.listeners=[],this.unit.consumers=[],this.unit.tweens=[],this.unit.time=0,this.unit.tint=0,this.unit.freeze=0,this.unit.level=1,this.body.mass=this.width,this.body.allowDrag=!1,this.body.allowGravity=!1,this.unit.sizeSquared=this.width*this.width/2,this.unit.parent&&this.unit.parent.addListener(this),this.body.moves=!1,this.body.immovable=!0,this.unitProcess&&this.scene.addUnitProcess(this)}unitDeinit(){this.unit.parent&&this.unit.parent.removeListener(this),this.unitEventNotify("stop"),this.unit.listeners=[],this.unit.consumers=[],this.scene.clearEvents(this)}unitStart(){this.consume&&this.consume.buildProducts?this.unitState=Unit.StateBuild:this.live&&this.live.damage>0?this.unitState=Unit.StateRecharge:this.unitState=Unit.StateActive}unitStop(){}deinitUnit(){if(this.unitProcess&&this.scene.removeUnitProcess(this),this.menu&&this.menuDeinit(),this.route&&this.routeDeinit(),this.spawn&&this.spawnDeinit(),this.watch&&this.watchDeinit(),this.produce&&this.produceDeinit(),this.move&&this.moveDeinit(),this.live&&this.liveDeinit(),this.transit&&this.transitDeinit(),this.consume&&this.consumeDeinit(),this.unit){for(let t=this.unit.tweens.length-1;t>=0;t--)this.unit.tweens[t].remove();this.unitDeinit()}}unitTween(t){let e=this.scene.tweens.add(t);return this.unit.tweens.push(e),e}addWatch2(t){-1===this.unit.watchListeners.indexOf(t)&&this.unit.watchListeners.push(t)}removeWatch2(t){let e=this.unit.watchListeners.indexOf(t);-1!==e&&this.unit.watchListeners.splice(e,1)}watchNotify2(t){for(let e=this.unit.watchListeners.length-1;e>=0;e--)this.unit.watchListeners[e].watchDo(this,t)}addListener(t){-1===this.unit.listeners.indexOf(t)&&this.unit.listeners.push(t)}removeListener(t){let e=this.unit.listeners.indexOf(t);-1!==e&&this.unit.listeners.splice(e,1)}unitEventNotify(t){for(let e=this.unit.listeners.length-1;e>=0&&!this.unit.listeners[e].unitEvent(this,t);e--);}unitEvent(t,e){this.move&&this.moveEvent(t,e),this.live&&this.liveEvent(t,e),this.watch&&this.watchEvent(t,e),this.transit&&this.transitEvent(t,e),this.shoot&&this.shootEvent(t,e)}productAdd(t){this.scene.unitProducts.push(t),this.scene.unitMap.productTransport()}producerAdd(){this.scene.unitProducers.push(this),this.scene.unitMap.productProduce()}consumerAdd(t){-1===this.unit.consumers.indexOf(t)&&this.unit.consumers.push(t)}consumerRemove(t){let e=this.unit.consumers.indexOf(t);-1!==e&&this.unit.consumers.splice(e,1)}consumerNotify(t){for(let e=this.unit.consumers.length-1;e>=0&&!this.unit.consumers[e].consumerEvent(this,t);e--);}scaleResolution(t){return this.scene.game.resolution*t}setPlayer(t){0===t.id&&this.sound("claim"),0===this.player.id&&this.sound("lose"),this.unitEventNotify("stop");let e=[this.live.damageImage];this.scene.tweens.add({targets:e,duration:150,scaleX:0,callbackScope:this,rotation:Math.PI,onComplete:function(t){this.scene.tweens.add({targets:e,duration:150,scaleX:1,callbackScope:this,rotation:0,onComplete:function(t){this.live.damageImage.setTint(this.player.color)}},this)}},this),this.player=t,this.unit.level=1,this.updateDamage(),this.live.damageImage2&&(this.live.damageImage2.alpha=.25,this.live.damageImage2.setTint(16777215))}overlapEnemy(t){let e=t.live.health-t.live.damage;return t.liveDamage(this.live.health-this.live.damage)&&t.destroy(),!!this.liveDamage(e)&&(this.live.damage=this.live.health-(this.live.damage-this.live.health),!0)}explodeEffect(){let t=this.scene.add.particles("Unit-explode");t.createEmitter({frame:[2],x:this.x,y:this.y,speed:{start:this.scene.scaleResolution(112.5),end:this.scene.scaleResolution(-112.5)},quantity:5,ease:"Power2",lifespan:1e3,maxParticles:50,blendMode:"SCREEN",alpha:{start:1,end:0}}),t.createEmitter({frame:[0],x:this.x,y:this.y,speed:{start:this.scene.scaleResolution(75),end:this.scene.scaleResolution(-75)},quantity:5,ease:"Power2",lifespan:750,maxParticles:100,blendMode:"SCREEN",alpha:{start:1,end:0}}),this.scene.time.delayedCall(1e3,function(){t.destroy()},this)}sound(t){this.scene.cardScene.audio.play(t)}toString(){return this.id}static preload(t,e){e.push({name:"UnitDamage-10",size:10});for(let t=40;t<=40;t+=10)e.push({name:"UnitDamage-"+t,size:t})}}Unit.id=1e3,Unit.defaultHealth=64,Unit.defaultMass=100,Unit.defaultSpeed=150,Unit.StateInit=10,Unit.StateBuild=20,Unit.StateRecharge=30,Unit.StateActive=40;class UnitAsteroid extends(UnitActionLive(Unit)){constructor(t,e,i,s,n){super(t,e,i,UnitAsteroid.name+"-"+n.type,0,null,n,t.mapUnitGroup)}initUnit(){this.unitInit({});let t=this.width/this.scene.game.resolution;this.liveInit({health:1*t/60,damage:0}),this.startUnit()}startUnit(){this.unitStart(),this.liveStart(),this.body.setCircle(this.width/2),this.setBounce(1)}static preload(t,e){t.push(UnitAsteroid.name+"-moon"),t.push(UnitAsteroid.name+"-mars"),t.push(UnitAsteroid.name+"-rock0")}updateDamage(){this.setScale((this.live.health-this.live.damage)/this.live.health)}}UnitAsteroid.name="UnitAsteroid";class UnitBarrier extends Unit{constructor(t,e,i,s,n){super(t,e,i,UnitBarrier.name,0,null,n,t.mapUnitGroup)}initUnit(){let t=this.unitConfig;this.unitInit({parent:t.parent,type:t.type}),this.startUnit()}startUnit(){this.unitStart(),this.rotation=Phaser.Math.Angle.Random()}static preload(t,e){t.push(UnitBarrier.name)}}UnitBarrier.name="UnitBarrier";class UnitBot extends(UnitActionWatch(UnitActionShoot(UnitActionMenu(UnitActionMinigame(UnitActionTech(UnitActionBuild(UnitActionSpawn(UnitActionConnect(UnitActionTravel(UnitActionControl(UnitActionLive(Unit)))))))))))){constructor(t,e,i,s,n){super(t,e,i,UnitBot.name,0,s,n,t.teamTroops[s.team.id]),this.unitFollowCamera=!0,this.body.setBounce(.5,.5),this.setDepth(100),this.shootActive=!1,this.visible=!1}initUnit(){this.unitInit({}),this.liveInit({}),this.watchInit({range:75,latency:200}),this.shootInit({range:75,speed:100,damage:8}),this.buildInit({}),this.spawnInit({}),this.controlInit({turnSpeed:.25}),this.travelInit({}),this.connectInit({range:50}),this.minigameInit({}),this.techInit({}),this.menuInit({actions:[Unit.Action.Minigame]}),this.body.setSize(this.width/2,this.height/2),this.setDepth(9),this.startUnit()}startUnit(){this.watchStart(this.scene.getEnemyTroops(this.player)),this.liveStart(),this.controlStart()}destroyed(){this.control.action&&this.control.action!==this&&this.control.action.stop(),this.scene.cardScene.isGameOver||(EventDispatcher.getInstance().emit("GameStatus",{shutdown:!0}),this.scene.explode(this),this.player.bot=null,this.scene.cardScene.disableUnitScene()),this.minigameDeinit(),this.connectDeinit(),this.travelDeinit(),this.controlDeinit(),this.spawnDeinit(),this.shootDeinit(),this.buildDeinit(),this.watchDeinit(),this.liveDeinit(),super.deinitUnit()}unitProcess(t){let e=1/0;const i=this.watch;if(t>i.time){i.unit;i.time=t+this.watchDo(t),i.time<e&&(e=i.time),i.unit,this.connect.started||i.unit!==this.shoot.target&&(this.shoot.target&&this.shootStop(),i.unit&&(this.shootActive&&this.shootStart(i.unit),this.attackUnit(i.unit)))}if(this.shootActive)if(this.connect.started)this.shoot.time!==1/0&&this.shootStop();else{const i=this.shoot;t>i.time&&(!this.scene.cardScene.statusEnergy||this.scene.cardScene.statusEnergy.update(-.02)?(i.time=t+this.shootDo(),i.time<e&&(e=i.time),this.shoot.laser.setTint(16711680)):this.shoot.laser.setTint(16776960))}return e===1/0&&(e=t+1e3),e}overlap(t){if(t.player&&this.player.team.id===t.player.team.id);else{let e=(this.live.health-this.live.damage)/10,i=(t.live.health-t.live.damage)/10;t.liveDamage(e),this.liveDamage(i)}}updateDamage(){this.scene.cardScene.statusBody&&this.scene.cardScene.statusBody.update(-this.live.damage)}attackUnit(t){if(t)for(let e=this.unit.listeners.length-1;e>=0;e--)this.unit.listeners[e].addTarget&&this.unit.listeners[e].addTarget(t);else this.watch.attack;this.watch.attack=t,this.shoot.target&&this.shootStop(),t?this.shootActive&&this.shootStart(t):this.shootStop(t)}shootUnit(t){this.shoot.target.unit.d2amage<this.shoot.target.live.health?this.shoot.target.liveDamage(this.shoot.d2amage):(this.shoot.target.destroy(),this.shoot.laser.visible=!1)}collideGround(){}preUpdate(){let t=this.shoot.target;if(this.shootActive&&t){this.shoot.laser.x=this.x,this.shoot.laser.y=this.y;let i=Phaser.Math.Angle.BetweenPoints(this.shoot.laser,t);this.shoot.laser.setRotation(i);var e=Phaser.Math.Distance.Between(this.shoot.laser.x,this.shoot.laser.y,t.x,t.y);this.shoot.laser.scaleX=e/this.shoot.laser.width}}menuSelect(t,e){this.control.action===this?this.control.action=super.menuSelect(t,e,this):this.control.action=this.control.action.menuSelect(t,e,this)}uiAction(t){this.controlAction(t)}update(t){let e=null,i=this.width,s=this.scene.getUnits(this.x,this.y,i*i,this.player);if(s)for(let t=0;t<s.length;t++){let i=s[t];if(i.action){e=i;break}}e!==this.control.target.unit&&(this.control.target.unit=e,e&&(this.control.target.img.x=e.x,this.control.target.img.y=e.y),this.control.target.img.visible=!!e),this.control.target.focus&&this.control.target.unit===this.control.target.focus&&(this.currentAction?(this.currentAction.stop.call(this),this.currentAction=null):this.control.pad.select(),this.control.target.focus=null,this.control.target.focusImage.visible=!1),this.connect.target&&this.connectDo()}activateAction(t,e){this.currentAction=t,t.start.call(this,e)}static preload(t,e){t.push("ControlTarget"),t.push("EffectTeleport"),t.push(UnitBot.name+"Target"),e.push({name:UnitBot.name,size:16})}buildDo(){super.buildDo()}}UnitBot.name="UnitBot";class UnitCenter extends(UnitActionRoute(UnitActionConsume(UnitActionMenu(UnitActionLive(Unit))))){constructor(t,e,i,s,n){super(t,e,i,"gate-ring-bg",0,s,n,t.mapUnitGroup),this.createGate()}initUnit(){this.unitInit({}),this.liveInit({health:.5,damage:1,damageSize:10}),this.routeInit({range:100}),this.menuInit({actions:[Unit.Action.Build]}),this.consumeInit({useProducts:["circle"]}),this.startUnit(),this.unitState=Unit.StateActive}startUnit(){this.unitStart(),this.liveStart(),this.body.setCircle(this.width/2),this.setBounce(1)}static preload(t,e){e.push({name:"gate-center",size:55}),e.push({name:"gate-symbols",size:6})}createGate(){this.scene.getBounds();let t=this.x,e=this.y;this.scene.anims.create({key:"gate-center",frames:this.anims.generateFrameNumbers("gate-center"),frameRate:30,repeat:-1});let i=this.scene.add.group(),s=i.create(t,e,"gate-center");this.wave=s,s.alpha=.5;let n=i.create(t,e,"gate-ring");var a=new Phaser.Geom.Circle(0,0,n.width/2);let h=[];for(let t=0;t<24;t++)h.push(t);Phaser.Utils.Array.Shuffle(h);var r=this.scene.add.container(n.x,n.y);i.add(r);let o=this.scene.add.group();this.tiles=o;this.savedlevel=-1;for(let t=0;t<24;t++){let e=o.create(0,0,"gate-tile");e.angle=15*t,h[t]>-2&&(e.tint=6710886),r.add(e)}Phaser.Actions.PlaceOnCircle(o.getChildren(),a);let l=this.scene.add.group();this.symbols=l;for(let t=0;t<24;t++){let e=l.create(0,0,"gate-symbols",t);e.angle=15*t,h[t]>-2&&(e.tint=3355443),e.savedlevel=t,r.add(e)}Phaser.Actions.PlaceOnCircle(l.getChildren(),a),this.gate=r}consumed(){this.savedlevel++;let t=this.symbols.getChildren();for(let e=0;e<t.length;e++){let i=t[e];if(i.savedlevel===this.savedlevel)return i.clearTint(),!0}return!1}updateDamage(){super.updateDamage(),0===this.live.damage&&(this.live.tween=this.unitTween({targets:this.gate,duration:6e4,callbackScope:this,rotation:2*Math.PI,repeat:-1}),this.wave.play("gate-center"))}}UnitCenter.name="UnitCenter";class UnitCrusher extends(UnitActionWatch(UnitActionMove(UnitActionLive(Unit)))){constructor(t,e,i,s,n){super(t,e,i,UnitCrusher.name+"Idle",n.frame,s,n,t.teamTroops[s.team.id])}initUnit(){this.unitInit({}),this.liveInit({health:1.5}),this.watchInit({range:150,latency:1e3}),this.moveInit({speed:10,turnSpeed:.5}),this.setTexture(UnitCrusher.name),this.body.setSize(this.width/2,this.height/2),this.startUnit()}startUnit(){this.unitStart(),this.liveStart();let t=this.scene.getEnemyTroops(this.player);t=t.concat(this.scene.getEnemyBuildings(this.player)),this.watchStart(t),this.moveStart(this.scene.getBounds())}unitProcess(t){let e=1/0;const i=this.move;t>i.time&&(i.time=t+this.moveDo(),i.time<e&&(e=i.time));const s=this.watch;if(t>s.time){let i=s.unit;s.time=t+this.watchDo(t),s.time<e&&(e=s.time),i!==s.unit&&(null!==i&&(this.moveStop(),this.moveStart()),null!==s.unit&&this.moveStart(s.unit))}const n=this.live;return t>n.time&&(n.time=t+1e3,n.time<e&&(e=n.time),null!==s.unit&&this.healUnit(s.unit)||this.liveDamage(.25)),e}healUnit(t){if(!t.live)return!1;return!(Phaser.Math.Distance.Squared(this.x,this.y,t.x,t.y)>t.width*t.width)&&(t.liveDamage(1),this.liveRecover(4),!0)}overlap(t){if(t instanceof UnitAsteroid&&this.live.damage>2){let e=this.live.damage/2;t.liveDamage(e),this.liveRecover(e)}else this.move.time=0,this.unit.time=0}static preload(t,e){t.push(UnitCrusher.name+"Idle"),e.push({name:UnitCrusher.name,size:32})}}UnitCrusher.info={name:"Cruncher",desc:"Attack: Stations\nStrength: 5\nPower: 1\nRange: Close\nNo special abilities"},UnitCrusher.name="UnitCrusher";class UnitElement extends(UnitActionLive(UnitActionTransit(UnitActionMove(Unit)))){constructor(t,e,i,s,n){let a=n?n.frame:0;super(t,e,i,UnitElement.name,a,s,n,t.teamBullets[s.team.id]),this.body.setAllowRotation(!1),this.setTint(this.player.color),this.target=null}initUnit(){let t=this.unitConfig;this.unitInit({parent:t.parent}),this.liveInit({health:.1}),this.liveStart(),this.moveInit({speed:50}),this.moveStart(t.parent),this.transitInit({speed:500,icon:UnitElement.name}),t.transit&&t.transit.path?this.transitStart(this,t.transit.path):this.spawn()}destroyed(){this.transitDeinit(),this.moveDeinit(),this.liveDeinit(),this.unitDeinit();let t=this.scene.add.image(this.x,this.y,UnitElement.name+"-flash");this.scene.tweens.add({targets:t,duration:.5,alpha:0,onComplete:function(){t.destroy()}},this)}unitProcess(t){let e=1/0;const i=this.move;return t>i.time&&(i.time=t+this.moveToUnit(),this.liveDamage(.1),i.time<e&&(e=i.time)),e}transitDone(){const t=this.transit;let e=t.path[t.path.length-1];e.live.damage>0?(e.live.damage-=this.live.health-this.live.damage,e.live.damage<0&&(e.live.damage=0),e.updateDamage()):this.unit.gravity=e,this.transitStop(),this.destroy()}addTarget(t){this.moveStart(t)}spawn(){this.body.enable=!0,this.visible=!0,this.rotation=Phaser.Math.RND.rotation(),this.scene.physics.velocityFromRotation(this.rotation,this.body.maxSpeed,this.body.velocity),this.unitState=Unit.StateActive}overlap(t){if(this.player.team.id===t.player.team.id){if(!t.live)return void console.log("err",this,t);if(t.live.damage>0){let e=(this.live.health-this.live.damage)/4;t.liveRecover(e),this.destroy()}}else{let e=this.live.health-this.live.damage;t.liveDamage(e),this.destroy()}}unitEvent(t,e){super.unitEvent(t,e),"stop"===e&&(t===this.unit.target&&(this.unit.target.removeListener(this),this.unit.target=null),t===this.unit.parent&&this.destroy())}static preload(t,e){t.push(UnitElement.name+"-flash"),e.push({name:UnitElement.name,size:8})}}UnitElement.name="UnitElement",UnitElement.health=8;class UnitEmitter extends(UnitActionLive(UnitActionWatch(UnitActionProduce(UnitActionRoute(UnitActionMenu(Unit)))))){constructor(t,e,i,s,n){super(t,e,i,UnitEmitter.name,0,s,n,t.mapUnitGroup),this.isPowerSource=!0}destroyed(){this.deinitUnit()}initUnit(){this.unitInit({mass:200,levelMax:1}),this.liveInit({health:.25,damage:1,damageSize:40}),this.routeInit({range:100}),this.route.connectEmitter=[this],this.produceInit({delay:500}),this.watchInit({range:32,latency:1e3}),this.menuInit({actions:[]}),this.startUnit()}startUnit(){this.unitStart(),this.liveStart(),this.watchStart(this.scene.getEnemyTroops(this.player)),this.updateDamage(),0===this.live.damage&&this.produceStart()}unitProcess(t){let e=1/0;const i=this.watch;if(t>i.time){let s=i.unit;i.time=t+this.watchDo(t),i.time<e&&(e=i.time),s!==i.unit&&(this.attackUnit(i.unit),i.unit)}const s=this.produce;return t>s.time&&(s.time=t+this.produceDo(t),s.time<e&&(e=s.time)),e}unitEvent(t,e){this.watchEvent(t,e),"stop"===e&&t===this.watch.attack&&(this.watch.attack.removeListener(this),this.watch.attack=null)}liveStart(){super.liveStart()}liveRecover(t){super.liveRecover(t),this.produce.time===1/0&&this.produceStart()}updateDamage(){super.updateDamage(),0===this.live.damage&&(this.live.tween=this.unitTween({targets:this,duration:5e3,rotation:2*Math.PI,repeat:-1}))}produceDo(){if(this.live.damage>0&&this.live.damage<this.live.health){new UnitElement(this.scene,this.x,this.y,this.player,{parent:this});return 1e3}let t={};if(0===this.produce.paths.length)return 1e3;let e=Phaser.Math.Between(0,this.produce.paths.length-1);t.path=this.produce.paths[e];let i=new UnitElement(this.scene,this.x,this.y,this.player,{parent:this,transit:t});return this.watch&&this.watch.attack&&i.addTarget(this.watch.attack),this.produce.delay}attackUnit(t){if(t){t.addListener(this);for(let e=this.unit.listeners.length-1;e>=0;e--)this.unit.listeners[e].addTarget&&this.unit.listeners[e].addTarget(t)}else this.watch.attack&&this.watch.attack.removeListener(this);this.watch.attack=t}static preload(t,e){e.push({name:UnitEmitter.name,size:32})}}UnitEmitter.name="UnitEmitter";class UnitEnergy extends(UnitActionLive(UnitActionWatch(Unit))){constructor(t,e,i,s,n){super(t,e,i,UnitEnergy.name,n.frame,s,n,t.fields)}initUnit(){this.unitInit({mass:0}),this.liveInit({}),this.watchInit({range:50,latency:200}),this.startUnit()}startUnit(){this.unitStart(),this.liveStart(),this.watchStart([[this.player.bot]]),this.setScale(0),this.scene.tweens.add({targets:this,duration:250,ease:"Linear",scale:1},this),this.live.tween=this.unitTween({targets:this,duration:2500,rotation:2*Math.PI,repeat:-1})}unitProcess(t){let e=1/0;const i=this.watch;return t>i.time&&(i.time=t+this.watchDo(t),i.time<e&&(e=i.time),null!==i.unit&&this.gainEnergy(i.unit,this.scene.cardScene.statusEnergy)),e>t+1e3&&(e=t+1e3),e}gainEnergy(t,e){if(!this.scene.cardScene.statusEnergy.update(1))return;let i=this.scene.add.image(this.x,this.y,"UnitEnergy");e.bg.tint=0,this.scene.tweens.add({targets:i,ease:"Power1",duration:150,x:t.x,y:t.y,scale:0,angle:360,onComplete:function(){e.bg.clearTint(),i.destroy()}}),this.destroy()}static preload(t,e){e.push({name:UnitEnergy.name,size:20})}}UnitEnergy.name="UnitEnergy";class UnitGate extends(UnitActionLive(Unit)){constructor(t,e,i,s,n){super(t,e,i,"UnitGate",0,s,n,t.teamBuildings[s.team.id])}initUnit(){this.unitConfig;this.unitInit({}),this.liveInit({health:3,damage:0}),this.startUnit()}destroyed(){this.scene.levelFactory.destroyGate(this),super.deinitUnit()}startUnit(){this.unitStart(),this.liveStart(),this.scene.addEvent(this.addUnit,3e3,this)}addUnit(){let t;this.scene.addEvent(this.addUnit,3e4,this),"Crusher"===this.unitConfig.type&&(t=UnitCrusher),"Virus"===this.unitConfig.type&&(t=UnitVirus);new t(this.scene,this.x,this.y,this.player,{parent:this})}unitProcess(t){return 1/0}static preload(t,e){e.push({name:"UnitGate",size:32})}}UnitGate.name="UnitGate",UnitGate.animFrameRate=30;class UnitGuard extends(UnitActionWatch(UnitActionLive(UnitActionMove(Unit)))){constructor(t,e,i,s,n){super(t,e,i,UnitGuard.name+"Idle",n.frame,s,n,t.teamTroops[s.team.id])}initUnit(){let t=this.unitConfig;for(let e=0;e<t.parents.length;e++)t.parents[e].addListener(this);t.parent=t.parents[0],this.incubate&&(this.incubate=null,this.scene.idleUnits.remove(this,!0)),this.unitInit({}),this.liveInit({health:1}),this.watchInit({range:150,latency:500,homeDistanceSquared:this.width*this.width/16}),this.moveInit({speed:25,drag:2}),this.startUnit()}startUnit(){this.unitStart(),this.liveStart(),this.watchStart(this.scene.getEnemyTroops(this.player)),this.moveStart(this.scene.getBounds()),this.setDrag(4*this.body.maxSpeed,4*this.body.maxSpeed),this.anims.play(UnitGuard.name),this.body.setSize(this.width/2,this.height/2)}guardTarget(t){this.guard.enemy=t}healUnit(t){return!(Phaser.Math.Distance.Squared(this.x,this.y,t.x,t.y)>t.width*t.width)&&(t.liveDamage(3),this.liveRecover(6),!0)}healUnit2(){}unitProcess(t){let e=1/0;const i=this.move;t>i.time&&(i.time=t+this.moveDo(),i.time<e&&(e=i.time),this.body.speed>=this.move.speed&&this.body.setAcceleration(0));const s=this.watch;if(t>s.time){let i=s.unit;s.time=t+this.watchDo(t),s.time<e&&(e=s.time),i!==s.unit?(null!==i&&(this.moveStop(),this.moveStart(this.unitConfig.parent)),null!==s.unit?this.moveStart(s.unit):this.moveStart(this.unitConfig.parent)):this.move.toUnit===this.unitConfig.parent&&(this.healUnit(this.unitConfig.parent)||this.liveDamage(1))}const n=this.live;return t>n.time&&(n.time=t+this.liveDo(t),n.time<e&&(e=n.time)),e}overlap(t){if(this.player.team.id===t.player.team.id);else{let e=(this.live.health-this.live.damage)/10,i=(t.live.health-t.live.damage)/10;t.liveDamage(e),this.liveDamage(i)}}static preload(t,e){t.push(UnitGuard.name+"Idle"),e.push({name:UnitGuard.name,size:32})}}UnitGuard.name="UnitGuard",UnitGuard.animFrameRate=8;class UnitLaser extends(UnitActionConsume(UnitActionShoot(UnitActionWatch(UnitActionRoute(UnitActionMenu(UnitActionLive(Unit))))))){constructor(t,e,i,s,n){super(t,e,i,UnitLaser.name,0,s,n,t.teamBuildings[s.team.id])}initUnit(){this.unitInit({}),this.liveInit({health:.5,damage:1,damageSize:40}),this.routeInit({range:100}),this.menuInit({actions:[]});this.watchInit({range:85,latency:1e3}),this.shootInit({range:85,speed:100,damage:8}),this.consumeInit({}),this.startUnit()}startUnit(){this.unitStart(),this.liveStart(),this.watchStart(this.scene.getEnemyTroops(this.player))}static preload(t,e){t.push(UnitLaser.name)}unitProcess(t){let e=1/0;if(this.unitState<Unit.StateRecharge)return;const i=this.watch;if(t>i.time){i.unit;i.time=t+this.watchDo(t),i.time<e&&(e=i.time)}i.unit!==this.shoot.target&&(this.shoot.target&&this.shootStop(),i.unit&&this.live.damage<this.live.health&&this.shootStart(i.unit));const s=this.shoot;return s.target&&t>s.time&&(s.time=t+this.shootDo(),this.liveConsume(4),s.time<e&&(e=s.time),this.shoot.laser.setTint(16711935)),e===1/0&&(e=t+1e3),e}updateDamage(){super.updateDamage(),0===this.live.damage&&(this.unit.time=0,this.watch.time=0,this.shoot.time=0)}preUpdate(){if(this.shoot.target){this.shoot.laser.x=this.x,this.shoot.laser.y=this.y;let e=Phaser.Math.Angle.BetweenPoints(this.shoot.laser,this.shoot.target);this.shoot.laser.setRotation(e);var t=Phaser.Math.Distance.Between(this.shoot.laser.x,this.shoot.laser.y,this.shoot.target.x,this.shoot.target.y);this.shoot.laser.scaleX=t/this.shoot.laser.width}}}UnitLaser.name="UnitLaser";class UnitMining extends(UnitActionProduce(UnitActionRoute(UnitActionMenu(UnitActionLive(Unit))))){constructor(t,e,i,s,n){super(t,e,i,UnitMining.name,0,s,n,t.mapUnitGroup),this.resourceCount=10,this.resources=[];let a=[[-50,-20],[-5,15],[35,-2],[13,-14],[61,-43],[-14,-41],[-47,41],[13,-64],[36,34],[-64,29]];for(let t=0;t<this.resourceCount;t++){let e=a[t][0]/4*this.scene.game.resolution,i=a[t][1]/4*this.scene.game.resolution;this.resources.push(this.scene.add.image(this.x+e,this.y+i,UnitMining.name,t))}}initUnit(){this.unitInit({}),this.liveInit({health:.15,damage:1,damageSize:40}),this.routeInit({range:100}),this.menuInit({actions:[]}),this.produceInit({delay:6e3}),this.startUnit()}startUnit(){this.unitStart(),this.liveStart()}static preload(t,e){e.push({name:UnitMining.name,size:8})}updateDamage(){super.updateDamage(),0===this.live.damage?this.produceStart():this.produce.time!==1/0&&this.produceStop()}produceStart(){0!==this.resourceCount&&(this.produce.slotIcon=this.scene.add.image(this.x,this.y,"UnitProduct"),this.produce.slotIcon.setFrame(0),this.producerAdd())}transitComplete(t){return super.produceStart(),this.produce.worker=t,this.produce.image=this.scene.add.image(this.x,this.y,"StatusBody"),this.produce.image.setScale(.75),this.produce.tween=this.scene.tweens.add({targets:this.produce.image,duration:this.produce.delay,rotation:2*Math.PI}),this.scene.addEvent(this.produceDo,this.produce.delay,this),null}produceStop(){this.produce.worker.available=!0,this.produce.worker=null,this.produce.image.destroy(),this.produce.slotIcon.destroy(),super.produceStop()}produceDo(){if(this.produce.time===1/0)return;this.produceStop();let t=new UnitProduct(this.scene,this.x,this.y,this.player,{parent:this,type:"square"});return this.produce.product=t,this.productAdd(t),this.resourceCount--,this.resourceCount>=0&&this.resources[this.resourceCount].destroy(),1/0}produceDo2(){new UnitElement(this.scene,this.x,this.y,this.player,{parent:this});return 1e3}}UnitMining.name="UnitMining";class UnitProduct extends Unit{constructor(t,e,i,s,n){super(t,e,i,UnitProduct.name,0,s,n,t.teamTroops[s.team.id]),this.body.enable=!1,this.setDepth(2),this.transitSprite=null}initUnit(){let t=this.unitConfig;this.unitInit({parent:t.parent,type:t.type}),this.startUnit()}startUnit(){this.unitStart(),this.setTint(13136183)}static preload(t,e){e.push({name:UnitProduct.name,size:8}),e.push({name:UnitProduct.name+"Slot",size:10})}deinitUnit(){super.deinitUnit()}preUpdate(){this.transitSprite&&(this.rotation=this.transitSprite.rotation,this.x=this.transitSprite.x,this.y=this.transitSprite.y)}transitComplete(t){return this.unit.parent.produceStart&&(this.unit.parent.produceStart(),this.transitSprite=t.transit.sprite),this.unit.parent=t,this}}UnitProduct.name="UnitProduct";class UnitRoute extends(UnitActionRoute(UnitActionConsume(UnitActionMenu(UnitActionLive(Unit))))){constructor(t,e,i,s,n){super(t,e,i,UnitRoute.name,0,s,n,t.teamBuildings[s.team.id])}initUnit(){this.unitInit({}),this.liveInit({health:.5,damage:1,damageSize:10}),this.routeInit({range:100}),this.menuInit({actions:[Unit.Action.Build]}),this.consumeInit({buildProducts:["square"]}),this.startUnit()}startUnit(){this.unitStart(),this.liveStart()}static preload(t,e){t.push(UnitRoute.name)}}UnitRoute.name="UnitRoute";class UnitShield extends(UnitActionLive(Unit)){constructor(t,e,i,s,n){super(t,e,i,UnitShield.name,0,s,n,t.teamTroops[s.team.id])}initUnit(){this.unitInit({}),this.liveInit({health:.5,damage:1,damageSize:10}),this.startUnit()}startUnit(){this.unitStart(),this.liveStart(),this.setAlpha(.5),this.body.setCircle(this.width/2),this.setTint(255),this.timeout=1,this.scene.addEvent(this.doSpell,2500,this)}doSpell(){if(10==++this.timeout)return void this.destroy();let t=255;t|=(1<<this.timeout+7)-1&65280,t|=(1<<this.timeout+8+7)-1&16711680,this.setTint(t),this.scene.addEvent(this.doSpell,1250,this)}static preload(t,e){t.push(UnitShield.name)}overlap(t){}}UnitShield.name="UnitShield";class UnitSparkle extends(UnitActionWatch(UnitActionLive(Unit))){constructor(t,e,i,s,n){n={frame:0},super(t,e,i,UnitSparkle.name,n.frame,s,n,t.teamTroops[s.team.id])}initUnit(){this.unitInit({}),this.liveInit({health:.5}),this.watchInit({range:100,latency:1e3}),this.body.angularVelocity=100,this.body.setSize(this.width/2,this.height/2),this.startUnit()}startUnit(){this.unitStart(),this.liveStart();let t=this.scene.getEnemyTroops(this.player);t=t.concat(this.scene.getEnemyBuildings(this.player)),this.watchStart(t),this.spawnTime=100,this.scene.addEvent(this.doSparkle,this.spawnTime,this),this.live.tween=this.unitTween({targets:this,duration:3e3,rotation:2*Math.PI,repeat:-1})}doSparkle(){if(this.spawnTime>3e3)return;this.spawnTime+=500,this.scene.addEvent(this.doSparkle,this.spawnTime,this);let t=(3e3-this.spawnTime)/300;for(let e=0;e<t;e++){new UnitElement(this.scene,this.x,this.y,this.player,{parent:this})}}unitProcess(t){let e=1/0;const i=this.watch;if(t>i.time){i.unit;i.time=t+this.watchDo(t),this.attackUnit(i.unit)}e>i.time&&(e=i.time);const s=this.live;return t>s.time&&(s.time=t+1e3,this.liveDamage(4)),e>s.time&&(e=s.time),e=t+100,this.unit.time>e&&(this.unit.time=e),e}overlap(t){this.liveDamage(4),t.liveDamage(4)}static preload(t,e){t.push(UnitSparkle.name)}attackUnit(t){if(t)for(let e=this.unit.listeners.length-1;e>=0;e--)this.unit.listeners[e].addTarget&&this.unit.listeners[e].addTarget(t);this.watch.attack=t}}UnitSparkle.name="UnitSparkle";class UnitSpawner extends(UnitActionConsume(UnitActionWatch(UnitActionProduce(UnitActionRoute(UnitActionMenu(UnitActionLive(Unit))))))){constructor(t,e,i,s,n){super(t,e,i,UnitSpawner.name,0,s,n,t.teamBuildings[s.team.id])}initUnit(){this.unitInit({}),this.liveInit({health:.5,damage:1,damageSize:40}),this.routeInit({range:100}),this.menuInit({actions:[]}),this.produceInit({delay:1500}),this.watchInit({range:150,latency:1e3}),this.consumeInit({buildProducts:["square","square","square","square"]}),this.startUnit()}startUnit(){this.unitStart(),this.liveStart(),this.watchStart(this.scene.getEnemyTroops(this.player))}static preload(t,e){t.push(UnitSpawner.name)}updateDamage(){super.updateDamage(),0===this.live.damage?this.produceStart():this.produce.time!==1/0&&this.produceStop()}unitProcess(t){let e=1/0;const i=this.watch;if(t>i.time){i.unit;i.time=t+this.watchDo(t),i.time<e&&(e=i.time),i.unit&&this.attackUnit(i.unit)}const s=this.produce;return t>s.time&&(s.time=t+this.produceDo(t),s.time<e&&(e=s.time)),e===1/0&&(e=t+1e3),e}produceDo(){new UnitElement(this.scene,this.x,this.y,this.player,{parent:this});return this.produce.delay}attackUnit(t){if(t)for(let e=this.unit.listeners.length-1;e>=0;e--)this.unit.listeners[e].addTarget&&this.unit.listeners[e].addTarget(t);this.watch.attack=t}}UnitSpawner.name="UnitSpawner";class UnitStation extends(UnitActionLive(UnitActionWatch(UnitActionProduce(UnitActionRoute(UnitActionMenu(Unit)))))){constructor(t,e,i,s,n){super(t,e,i,UnitStation.name,0,s,n,t.teamBuildings[s.team.id]),this.isPowerSource=!0}destroyed(){this.scene.cardScene.isGameOver||(EventDispatcher.getInstance().emit("GameStatus",{shutdown:!0}),this.scene.explode(this),this.scene.cardScene.disableUnitScene()),super.deinitUnit()}initUnit(){this.unitInit({mass:200,levelMax:1}),this.liveInit({health:.25,damage:0,damageSize:40}),this.routeInit({range:100}),this.route.connectStation=[this],this.produceInit({delay:500}),this.watchInit({range:32,latency:1e3}),this.menuInit({actions:[]}),this.startUnit()}startUnit(){this.unitStart(),this.liveStart(),this.watchStart(this.scene.getEnemyTroops(this.player)),this.updateDamage(),0===this.live.damage&&this.produceStart(),this.scene.addStation(this)}unitProcess(t){let e=1/0;const i=this.watch;if(t>i.time){let e=i.unit;i.time=t+this.watchDo(t),e!==i.unit&&(this.attackUnit(i.unit),i.unit)}e>i.time&&(e=i.time);const s=this.produce;return t>s.time&&(s.time=t+this.produceDo(t)),e>s.time&&(e=s.time),e}unitEvent(t,e){this.watchEvent(t,e),"stop"===e&&t===this.watch.attack&&(this.watch.attack.removeListener(this),this.watch.attack=null)}liveStart(){super.liveStart()}liveRecover(t){super.liveRecover(t),this.produce.time===1/0&&this.produceStart()}updateDamage(){super.updateDamage(),0===this.live.damage&&(this.live.tween=this.unitTween({targets:this,duration:5e3,rotation:2*Math.PI,repeat:-1}))}produceDo(){if(this.live.damage>0){new UnitElement(this.scene,this.x,this.y,this.player,{parent:this});return 1e3}let t={};if(0===this.produce.paths.length)return 1e3;let e=Phaser.Math.Between(0,this.produce.paths.length-1);t.path=this.produce.paths[e];let i=new UnitElement(this.scene,this.x,this.y,this.player,{parent:this,transit:t});return this.watch&&this.watch.attack&&i.addTarget(this.watch.attack),this.produce.delay}attackUnit(t){if(t){t.addListener(this);for(let e=this.unit.listeners.length-1;e>=0;e--)this.unit.listeners[e].addTarget&&this.unit.listeners[e].addTarget(t)}else this.watch.attack&&this.watch.attack.removeListener(this);this.watch.attack=t}static preload(t,e){t.push(UnitStation.name)}}UnitStation.name="UnitStation";class UnitStorage extends(UnitActionRoute(UnitActionConsume(UnitActionMenu(UnitActionLive(Unit))))){constructor(t,e,i,s,n){super(t,e,i,UnitStorage.name,0,s,n,t.teamBuildings[s.team.id])}initUnit(){this.unitInit({}),this.liveInit({health:.5,damage:1,damageSize:10}),this.routeInit({range:100}),this.menuInit({actions:[Unit.Action.Cargo]}),this.consumeInit({buildProducts:["square"]}),this.startUnit()}startUnit(){this.unitStart(),this.liveStart()}static preload(t,e){t.push(UnitStorage.name)}}UnitStorage.name="UnitStorage";class UnitTeleport extends(UnitActionRoute(UnitActionWatch(UnitActionMenu(UnitActionLive(Unit))))){constructor(t,e,i,s,n){super(t,e,i,UnitTeleport.name,0,s,n,t.mapUnitGroup)}initUnit(){const t=this.unitConfig;this.teleport=t,this.unitInit({}),this.liveInit({health:.75,damage:1,damageSize:40}),this.routeInit({range:100}),this.watchInit({rangeSquared:this.scene.cameras.main.centerY*this.scene.cameras.main.centerY,latency:1e3}),this.menuInit({actions:[Unit.Action.Travel]}),this.startUnit()}startUnit(){this.unitStart(),this.liveStart(),this.watchStart([[this.player.bot]])}unitProcess(t){let e=1/0;const i=this.watch;if(t>i.time){let s=i.unit;i.time=t+this.watchDo(t),i.time<e&&(e=i.time),s!==i.unit&&(this.watchStop(),this.scene.cardScene.brain.addTeleport(this))}return e}static preload(t,e){e.push({name:UnitTeleport.name,size:32})}}UnitTeleport.name="UnitTeleport",UnitTeleport.animFrameRate=30;class UnitVirus extends(UnitActionWatch(UnitActionMove(UnitActionLive(Unit)))){constructor(t,e,i,s,n){super(t,e,i,UnitVirus.name+"Idle",n.frame,s,n,t.teamTroops[s.team.id])}initUnit(){this.unitInit({}),this.liveInit({health:.25}),this.watchInit({range:150,latency:1e3}),this.moveInit({speed:20}),this.setTexture(UnitVirus.name),this.body.angularVelocity=100,this.body.setSize(this.width/2,this.height/2),this.startUnit()}startUnit(){this.unitStart(),this.liveStart();let t=this.scene.getEnemyTroops(this.player);t=t.concat(this.scene.getEnemyBuildings(this.player)),this.watchStart(t),this.moveStart(this.scene.getBounds())}unitProcess(t){let e=1/0;const i=this.move;t>i.time&&(i.time=t+this.moveDo(),i.time<e&&(e=i.time));const s=this.watch;if(t>s.time){let i=s.unit;s.time=t+this.watchDo(t),s.time<e&&(e=s.time),i!==s.unit&&(null!==i&&(this.moveStop(),this.moveStart()),null!==s.unit&&this.moveStart(s.unit))}const n=this.live;return t>n.time&&(n.time=t+1e3,n.time<e&&(e=n.time),null!==s.unit&&this.healUnit(s.unit)||this.liveDamage(.25)),e}healUnit(t){if(!t.live)return!1;return!(Phaser.Math.Distance.Squared(this.x,this.y,t.x,t.y)>t.width*t.width)&&(t.liveDamage(1),this.liveRecover(4),!0)}overlap(t){if(t instanceof UnitAsteroid&&this.live.damage>2){let e=this.live.damage/2;t.liveDamage(e),this.liveRecover(e)}else this.move.time=0,this.unit.time=0}static preload(t,e){t.push(UnitVirus.name+"Idle"),t.push(UnitVirus.name)}}UnitVirus.info={name:"Creeper Swarm",desc:"Attack: Everything\nStrength: 1\nPower: 1\nRange: Close\nNo special abilities"},UnitVirus.name="UnitVirus";class UnitWorker extends(UnitActionTransit(UnitActionMenu(UnitActionLive(Unit)))){constructor(t,e,i,s,n){super(t,e,i,"StatusBot",0,s,n,t.teamTroops[s.team.id]),this.setScale(.5),this.deliverPath=null,this.setDepth(1)}initUnit(){let t=this.unitConfig;this.unitInit({parent:t.parent}),this.liveInit({health:1,damage:0}),this.menuInit({actions:[Unit.Action.Build]}),this.transitInit({speed:1500,icon:"StatusBot"}),this.startUnit(),this.body.enable=!1}startUnit(){this.unitStart(),this.liveStart(),this.scene.unitMap.addWorker(this)}static preload(t,e){}overlap(t){}transitDone(){const t=this.transit;let e=t.target.transitComplete(this),i=t.path[t.path.length-1];this.transitStop(),e?this.deliverPath?(this.transitStart(e,this.deliverPath),e.transitSprite=this.transit.sprite,this.unit.parent=this.deliverPath[this.deliverPath.length-1],this.deliverPath=null):(e.transitSprite=null,i.consumeDo(e),this.unit.parent=i,this.x=i.x,this.y=i.y,this.visible=!0,this.scene.unitMap.addWorker(this)):(this.unit.parent=i,this.x=i.x,this.y=i.y)}}UnitWorker.name="UnitWorker";let withSpell=t=>(class extends t{constructor(t,e,i,s,n){super(t,e,i,s),this.spell=n,this.info=n.info,this.spell.range*=this.deck.scene.game.resolution,this.spell.rangeSquared=this.spell.range*this.spell.range}drawValidRouted(t){let e=null;this.positionGraphics.clear();for(let i=(e=t.hqSprites.getChildren()).length-1;i>=0;i--){let t=e[i];if(t.route&&t.player.team.id===this.container.deck.player.team.id&&t.route.connectHq.length>0){if(this.overSprite&&t!==this.overSprite)continue;this.positionGraphics.fillStyle(13056,1),this.positionGraphics.fillCircle(t.x,t.y,t.route.range)}}this.invalidArea.clear();for(let i=(e=t.hqSprites.getChildren()).length-1;i>=0;i--){let t=e[i];this.invalidArea.fillStyle(3342336,1),this.invalidArea.fillCircle(t.x,t.y,t.route.rangeMin)}for(let i=(e=t.planets.getChildren()).length-1;i>=0;i--){let t=e[i];this.invalidArea.fillStyle(3342336,1),this.invalidArea.fillCircle(t.x,t.y,t.width)}}selectRoute(t){if(t){const t=this.deck.scene.unitScene;this.dragTexture=t.add.renderTexture(0,0,2*this.spell.range,2*this.spell.range),this.dragTexture.setOrigin(.5),this.dragTexture.visible=!1;let e=new Phaser.GameObjects.Image(t,0,0,"sprites",this.dragIconName+".png");this.dragTexture.draw(e,this.spell.range,this.spell.range),e.destroy();let i=new Phaser.GameObjects.Graphics(t);i.fillStyle(this.spellColor,.25),i.setBlendMode(Phaser.BlendModes.SCREEN),i.fillCircle(this.spell.range,this.spell.range,this.spell.range),this.dragTexture.draw(i),i.destroy(),this.positionGraphics=t.add.graphics(),this.positionGraphics.setDepth(-2),this.invalidArea=t.add.graphics(),this.invalidArea.setDepth(-2),this.invalidArea.setBlendMode(Phaser.BlendModes.SCREEN),this.renderRoutes&&this.drawValidRouted(t),this instanceof CardTarget||this.renderDisabledArea(this.scene),this.lastX=-1,this.lastY=-1}else this.dragTexture.visible=!1,this.positionGraphics.destroy(),this.invalidArea.destroy();this.routeEnabled=t}contextMenu(t){}select(t,e){t?(e&&(this.overSprite=e),this.selectRoute(t)):(this.overSprite&&null!==this.drawLine&&(this.drawLine.destroy(),this.drawLine=null),this.selectRoute(t))}dragSpell(t,e,i){this.dragCard(e,i)}startSpell(t,e,i,s={}){this.sound("claim"),this.started=!0,this.container&&this.container.enable(!1),this.scene=t,this.spell.rangeSquared=this.spell.range*this.spell.range,this.dragSpell(t,e,i),this.duration&&t.tweens.add(Object.assign(s,{targets:this.dragTexture,duration:this.duration,alpha:0,callbackScope:this,onComplete:this.stop},this)),t.time.addEvent({delay:50,callback:this.doSpell,callbackScope:this,repeat:this.duration/50-1})}stopSpell(){this.emitter&&this.emitter.stop(),this.completed&&this.completed(),this.dragTexture.destroy(),this.started=!1}pullUnits(t,e,i=150){const s=this.scene.unitSprites[this.player.team.id].getChildren();for(let n=s.length-1;n>=0;n--){let a=s[n];Phaser.Math.Distance.Squared(a.x,a.y,t.x,t.y)<=e&&(this.targetPoint?a.unit.gravity=new Phaser.Geom.Point(this.targetPoint.x,this.targetPoint.y):a.unit.gravity=new Phaser.Geom.Point(t.x,t.y),a.unit.gravity.body={mass:i},a.unit.tint=4,a.setTint(16777215))}}enable(t){let e=this.scene.add.image(0,0,"CardAreaSquare").setOrigin(0);e.scaleX=this.scene.cameras.main.width/e.width,e.scaleY=this.scene.cameras.main.height/e.height,e.setTint(65280),e.alpha=.25,this.areaSquare=e,(e=this.scene.add.image(0,0,"CardAreaCircle")).setTint(this.spellColor),e.alpha=.25,e.setScale(this.range/e.width),this.areaCircle=e}disable(){this.areaSquare.destroy(),this.areaSquare=null,this.areaCircle.destroy(),this.areaCircle=null}onPointerdown(t){this.onPointermove(t)}onPointermove(t){this.areaCircle&&this.areaCircle.setPosition(t.x,t.y)}onPointerup(t){return this.startCard(t),this.player.energy.addEnergy(-this.player.cardSelected.card.cost),!0}}),withUnit=t=>(class extends t{constructor(t,e,i,s,n){super(t,e,i,s),this.unit=n,this.info=n.info,this.range=4*n.range*this.deck.scene.game.resolution,this.rangeSquared=this.range*this.range}isValidPosition(t,e,i){return!0}cancel(){this.dragTexture.destroy()}select(t){t?(this.dragTexture=this.container.scene.unitScene.add.image(0,0,"sprites",this.dragIconName+".png"),this.dragTexture.visible=!1,this.invalidArea=this.container.scene.unitScene.add.graphics(),this.invalidArea.setDepth(-2),this.invalidArea.setBlendMode(Phaser.BlendModes.SCREEN),this.renderDisabledArea(this.container.scene)):(this.dragTexture&&(this.dragTexture.destroy(),this.dragTexture=null),this.container.scene.unitScene.pathCurve.clear(),this.invalidArea.destroy())}dragUnit(t,e,i){this.invalidArea.clear(),this.renderDisabledArea(t),this.dragCard(e,i);let s={x:e,y:i};if(e>t.level.x){let n=this.getClosestHq(t.unitScene,e,i),a=this.container.deck;t.unitScene.unitMap.drawPath(t.unitScene.pathCurve,a.player.HQ,s,n,n.x-a.player.HQ.x,(t.level.height-t.level.unit)/2)}else t.unitScene.pathCurve.clear()}getClosestHq(t,e,i){let s=this.container.deck,n=null,a=1/0;const h=t.hqSprites.getChildren();for(let t=h.length-1;t>=0;t--){let r=h[t];if(!(r instanceof UnitHq)||r.player.team.id===s.player.team.id)continue;let o=Phaser.Math.Distance.Squared(e,i,r.x,r.y);o<a&&(a=o,n=r)}return n}startUnit(t,e,i,s,n){let a=this.container.deck,h=t.pathCurve,r=this.getClosestHq(t,e,i);t.unitMap.drawPath(h,a.player.HQ,{x:e,y:i},r,r.x-a.player.HQ.x,(t.level.height-n.level.unit)/2);new s(t,e,i,this.player,{});n.unitScene.pathCurve.clear()}stopUnit(){this.dragTexture&&(this.dragTexture.destroy(),this.dragTexture=null)}enable(t){for(let e=t.length-1;e>=0;e--){let i=t[e];if(i.route){let e=this.scene.add.image(i.x,i.y,"CardSelect");e.unit=i,1===t.length?e.setTint(65280):e.setTint(16776960),this.hightlightUnits.push(e)}}let e=this.scene.add.image(0,0,"CardBuild");e.alpha=.25,this.areaCircle=e}disable(){this.areaCircle&&(this.areaCircle.destroy(),this.areaCircle=null)}onPointerdown(t){if(this.player.cardSelected&&this.player.shoot.target)return this.player.shoot.laser.x=t.x,this.player.shoot.laser.y=t.y,this.player.shoot.laser.visible=!0,void this.onPointermove(t);let e=this.scene.unitScene.getUnits(t.x,t.y,null,this.player);for(let i=e.length-1;i>=0;i--)return this.player.shoot.target=e[i],this.player.shoot.laser.x=t.x,this.player.shoot.laser.y=t.y,this.player.shoot.laser.visible=!0,void this.player.cardSelected.card.enable([e[i]]);this.player.selectCard(null)}onPointermove(t){if((this.player.shoot.target||this.player.shoot.targetAuto)&&(this.isValid(t)?this.player.shoot.laser.setTint(65280):this.player.shoot.laser.setTint(16711680),this.player.shoot.laser.x=t.x,this.player.shoot.laser.y=t.y),!this.player.shoot.target){let e=null,i=this.scene.unitScene.getUnits(t.x,t.y,this.rangeSquared,this.player);if(i.length>0){e=i[0];for(let t=1;t<i.length;t++)i[t].rangeSquared<e.rangeSquared&&(e=i[t])}if(e){for(let t=0;t<this.hightlightUnits.length;t++)e===this.hightlightUnits[t].unit?this.hightlightUnits[t].setTint(65280):this.hightlightUnits[t].setTint(16776960);this.player.shoot.laser.x=t.x,this.player.shoot.laser.y=t.y,this.player.shoot.laser.visible=!0,this.player.shoot.targetAuto=e}else{for(let t=0;t<this.hightlightUnits.length;t++)this.hightlightUnits[t].setTint(16776960);this.player.shoot.laser.visible=!1,this.player.shoot.targetAuto=null}}this.areaCircle&&this.areaCircle.setPosition(t.x,t.y)}onPointerup(t){if(!(this.player.shoot.target||this.player.shoot.targetAuto)){let e=this.scene.unitScene.getUnits(t.x,t.y,null,this.player);return!(e.length>0)||(this.player.cardSelected.card.enable([e[0]]),this.player.shoot.target=e[0],!1)}return this.isValid(t)&&(this.lastX=t.x,this.lastY=t.y,this.startCard(t),this.player.shoot.target=null,this.player.shoot.targetAuto=null,this.player.energy.addEnergy(-this.player.cardSelected.card.cost)),this.player.shoot.laser.visible=!1,this.player.shoot.target=null,this.player.shoot.targetAuto=null,!0}});const CardTypeSpell=0,CardTypeBuild=1;class Card{constructor(t,e,i,s){this.id=Card.id++,this.type=t,this.name=e,this.deck=i,this.player=i.player,this.dragIconName=s,this.started=!1,this.scene=i.scene,this.level=0}get cost(){return this.constructor.cost}renderDisabledArea(t){let e=t.level.area;this.invalidArea.fillStyle(3342336,1),this.invalidArea.fillRect(0,0,e.left,e.bottom),this.invalidArea.fillStyle(3342336,1),this.invalidArea.fillRect(e.left,0,e.right-e.margin,e.top),this.invalidArea.fillStyle(3342336,1),this.invalidArea.fillRect(0,e.bottom,e.right,e.margin),this.invalidArea.fillStyle(3342336,1),this.invalidArea.fillRect(e.right,e.top,e.margin,e.bottom)}cardStart(t,e,i){return this.started=!0,this.player.cardDeck.update(),this.costImage.visible=!1,!0}cardStop(){this.started=!1,this.container.setCard(null),this.deck.recharge(this),this.player.fillCards()}isRouted(t,e,i){if(this.overSprite){this.container.scene.level.area.margin;let t=this.overSprite,s=Phaser.Math.Distance.Squared(t.x,t.y,e,i);if(s>t.route.rangeSquared&&s<=4*t.route.rangeSquared){let s=Phaser.Math.Angle.Between(t.x,t.y,e,i),n=new Phaser.Geom.Line(t.x,t.y,e,i),a=Phaser.Geom.Line.SetToAngle(n,t.x,t.y,s,t.route.range-2);return e=a.x2,i=a.y2,!0}}let s;for(let n=(s=t.hqSprites.getChildren()).length-1;n>=0;n--){let t=s[n];if(t.route&&Phaser.Math.Distance.Squared(t.x,t.y,e,i)<t.route.rangeMinSquared)return!1}for(let n=(s=t.planets.getChildren()).length-1;n>=0;n--){let t=s[n];if(Phaser.Math.Distance.Squared(t.x,t.y,e,i)<t.widthSquared)return!1}if(this.isDisabledArea(e,i))return!1;if(this.overSprite){let t=this.overSprite;if(Phaser.Math.Distance.Squared(t.x,t.y,e,i)<=t.route.rangeSquared)return this.lastX=e,this.lastY=i,!0;this.container.scene.level.area.margin;if(Phaser.Math.Distance.Squared(t.x,t.y,e,i)<=4*t.route.rangeSquared){let s=Phaser.Math.Angle.Between(t.x,t.y,e,i),n=new Phaser.Geom.Line(t.x,t.y,e,i),a=Phaser.Geom.Line.SetToAngle(n,t.x,t.y,s,t.route.range-2);return this.lastX=a.x2,this.lastY=a.y2,!0}return!1}for(let n=(s=t.hqSprites.getChildren()).length-1;n>=0;n--){let t=s[n];if(t.player.team.id===this.container.deck.player.team.id&&t.route&&t.route.connectHq.length>0){if(Phaser.Math.Distance.Squared(t.x,t.y,e,i)<=t.route.rangeSquared)return this.lastX=e,this.lastY=i,!0;this.container.scene.level.area.margin;if(Phaser.Math.Distance.Squared(t.x,t.y,e,i)<=4*t.route.rangeSquared){let s=Phaser.Math.Angle.Between(t.x,t.y,e,i),n=new Phaser.Geom.Line(t.x,t.y,e,i),a=Phaser.Geom.Line.SetToAngle(n,t.x,t.y,s,t.route.range-2);return this.lastX=a.x2,this.lastY=a.y2,!0}}}return!1}isDisabledArea(t,e){let i=this.container.scene.level.area;return t<i.left||t>i.right||e<i.top||e>i.bottom}isValidPosition(t,e,i){this.invalidArea.clear();let s=this.connectedToHq(t,e,i),n=[];for(let t=s.length-1;t>=0;t--){const e=s[t];(e instanceof UnitRoute||e instanceof UnitHq)&&(this.positionGraphics.fillStyle(13056,1),this.positionGraphics.fillCircle(e.x,e.y,e.route.range),n.push(e))}return n.length>0}sound(t){this.scene.audio.play(t)}contextMenu(){}static preload(t,e){t.push("CardSelect"),t.push("CardAreaSquare"),t.push("CardAreaCircle"),t.push("CardBuild"),t.push("CardBg"),e.push({name:"CardCosts",size:12})}}Card.id=0;class CardGravity extends(withSpell(Card)){constructor(t,e,i){super(CardTypeSpell,t,e,CardGravity.name,{range:100,info:{name:"Gravity",desc:"Pull CREEPERS into center."}}),this.level=i,this.renderRoutes=!0,this.started=!1,this.areaSquare=null,this.areaCircle=null,this.spellColor=16776960,this.hightlightUnits=[],this.spellTimeout=5e3,this.spellTick=100,this.range=384*this.scene.game.resolution,this.rangeSquaredHalf=this.range*this.range/2,this.gravityForce=150,this.info.desc+="\nDuration: "+this.spellTimeout/1e3+" seconds"}drag2(t,e,i,s){this.dragSpell(t,e,i),this.isRouted(s,e,i)?this.dragTexture.clearTint():this.dragTexture.setTint(6710886)}static preload(t,e){t.push(CardGravity.name),t.push("EffectTarget")}startCard(t){this.cardStart();let e=this.scene.unitScene;this.emitter=e.add.particles("EffectTarget").createEmitter({blendMode:"SCREEN",x:t.x,y:t.y,speed:{min:e.scaleResolution(-50),max:e.scaleResolution(50)},moveToX:t.x,moveToY:t.y,quantity:5,frequency:500,lifespan:{min:1500,max:2e3},maxParticles:100,rotate:{min:-180,max:180},alpha:{start:1,end:0}});let i={source:new Phaser.Geom.Circle(0,0,this.range),type:"random",quantity:2};this.emitter.setEmitZone(i),this.spellTime=parseInt(this.spellTimeout/this.spellTick),this.x=t.x,this.y=t.y,this.spellUnits=[],e.addEvent(this.doSpell,this.spellTick,this)}stopCard(){for(let t=this.spellUnits.length-1;t>=0;t--){let e=this.spellUnits[t];e.gravitySpellSpeed=!1,e.body.maxSpeed=e.body.maxSpeed/4,e.removeListener(this)}this.spellUnits=null,this.cardStop()}doSpell(){if(0==--this.spellTime)return void this.stopCard();10===this.spellTime&&this.emitter.stop(),this.scene.unitScene.addEvent(this.doSpell,this.spellTick,this);let t=this.scene.unitScene,e=t.getEnemyTroops(this.player);for(let i=0,s=e.length;i<s;i++){let s=e[i];for(let e=s.length-1;e>=0;e--){let i=s[e];if(Phaser.Math.Distance.Squared(i.x,i.y,this.x,this.y)<=this.rangeSquaredHalf/2){i.gravitySpellSpeed||(i.body.maxSpeed=4*i.body.maxSpeed,i.gravitySpellSpeed=!0,i.addListener(this),this.spellUnits.push(i));let e=Phaser.Math.Angle.Between(i.x,i.y,this.x,this.y);i.rotation=e,t.physics.accelerateTo(i,this.x,this.y,this.gravityForce),i.liveDamage(.1)}}}}unitEvent(t,e){if("stop"===e&&this.spellUnits){let e=this.spellUnits.indexOf(t);-1!==e&&this.spellUnits.splice(e,1)}}}CardGravity.cost=1,CardGravity.name="CardGravity";class CardShield extends(withUnit(Card)){constructor(t,e,i){super(CardTypeSpell,t,e,CardShield.name,{range:0,info:{name:"Shield",desc:"Protective shield over buildings."}}),this.level=i,this.started=!1,this.areaSquare=null,this.areaCircle=null,this.spellColor=16776960,this.hightlightUnits=[],this.spellTimeout=5e3,this.spellTick=100,this.range=128*this.scene.game.resolution,this.rangeSquaredHalf=this.range*this.range/2,this.gravityForce=150,this.info.desc+="\nDuration "+this.spellTimeout+" seconds"}startCard(t){this.cardStart(),this.unit=new UnitShield(this.scene.unitScene,this.lastX,this.lastY,this.player,{}),this.scene.unitScene.addEvent(this.stopCard,1500,this)}stopCard(){this.cardStop()}static preload(t,e){t.push(CardShield.name)}onPointerup(t){let e=this.scene.unitScene.getUnits(t.x,t.y,null,this.player);return e.length>0&&(this.lastX=e[0].x,this.lastY=e[0].y,this.startCard(t),this.player.shoot.target=null,this.player.shoot.targetAuto=null,this.player.shoot.laser.visible=!1,this.player.energy.addEnergy(-this.player.cardSelected.card.cost)),!0}disable(){let t=this.hightlightUnits;for(let e=t.length-1;e>=0;e--){t[e].destroy()}this.hightlightUnits=[],super.disable()}isValid(t){let e=this.player.shoot.target||this.player.shoot.targetAuto;return Phaser.Math.Distance.Between(e.x,e.y,t.x,t.y)<48*this.scene.game.resolution}}CardShield.cost=1,CardShield.name="CardShield";class CardSparkle extends(withSpell(Card)){constructor(t,e,i){super(CardTypeSpell,t,e,CardSparkle.name,{info:{name:"Nebula",desc:"Spawn a cloud of photons."}}),this.level=i,this.started=!1,this.areaSquare=null,this.areaCircle=null,this.spellColor=16776960,this.hightlightUnits=[],this.spellTimeout=5500,this.spellTick=100,this.range=128*this.scene.game.resolution,this.rangeSquaredHalf=this.range*this.range/2,this.gravityForce=150,this.info.desc+="\nPhotons 30"}startCard(t){this.cardStart(),this.x=this.areaCircle.x,this.y=this.areaCircle.y,this.scene.unitScene.addEvent(this.doSpell,100,this)}stopCard(){this.cardStop()}doSpell(){new UnitSparkle(this.scene.unitScene,this.x,this.y,this.player);this.scene.unitScene.addEvent(this.stopCard,1500,this)}unitEvent(t,e){}static preload(t,e){t.push(CardSparkle.name)}}CardSparkle.cost=2,CardSparkle.name="CardSparkle";class CardTurret extends(withUnit(Card)){constructor(t,e,i){super(CardTypeBuild,t,e,CardTurret.name,{range:32,info:{name:"Laser",desc:"Destroy CREEPERS with laser beam."}}),this.level=i,this.renderRoutes=!0,this.spellColor=16776960,this.hightlightUnits=[],this.info.desc+="\nDamage 1 hit per sec."}start(t,e,i){if(!this.isRouted(t,e,i))return this.sound("disabled"),!1;if(!this.cardStart(t,this.lastX,this.lastY))return!1;this.scene=t,this.startSpell(t,this.lastX,this.lastY);let s=new UnitTurret(t,this.lastX,this.lastY,this.player,{});return s.unitDamage(s.unit.health/2),this.pullUnits(this.dragTexture,2*this.spell.rangeSquared),this.stop(),!0}stop2(){this.stopSpell(),this.cardStop()}drag(t,e,i,s){this.dragSpell(t,e,i),this.isRouted(s,e,i)?this.dragTexture.clearTint():this.dragTexture.setTint(6710886)}isValid(t){let e=this.player.shoot.target||this.player.shoot.targetAuto;var i=Phaser.Math.Distance.Between(e.x,e.y,t.x,t.y);let s=48*this.scene.game.resolution;return i>=s&&i<=2*s}static preload(t,e){t.push(CardTurret.name)}startCard(t){this.cardStart();let e=new UnitLaser(this.scene.unitScene,this.lastX,this.lastY,this.player,{}),i=this.player.shoot.target||this.player.shoot.targetAuto;e.routeAdd(i),this.scene.unitScene.unitMap.refresh(e),this.scene.unitScene.addEvent(this.stopCard,1e3,this)}stopCard(){this.cardStop()}enable(t){this.disable(),super.enable(t)}disable(){let t=this.hightlightUnits;for(let e=t.length-1;e>=0;e--){t[e].destroy()}this.hightlightUnits=[],super.disable()}}CardTurret.cost=3,CardTurret.name="CardTurret";class CardContainer extends Phaser.GameObjects.Container{constructor(t,e,i,s){super(t,e,i),this.origX=e,this.origY=i,t.add.existing(this),this.containerImage=t.add.image(0,0,"CardBg"),this.setSize(this.containerImage.width,this.containerImage.height),this.add(this.containerImage),this.visible=!0,this.active=!1,this.deck=s,this.sprite=null,this.enabled=!1}setCard(t){if(null===t){for(;this.getAt(1);)this.removeAt(1,!0);this.card=null}else{this.card=t;let e=new Phaser.GameObjects.Image(this.scene,0,0,this.card.name);e.y-=4*this.scene.game.resolution,this.add(e),this.card.container=this,this.card.costImage=this.scene.add.image(this.width/2,-this.height/2,"CardCosts",this.card.cost),this.card.costImage.x-=this.card.costImage.width/2+1*this.scene.game.resolution,this.card.costImage.y+=this.card.costImage.height/2+1*this.scene.game.resolution,this.add(this.card.costImage),this.card.costImage.visible=!0;let i=new Phaser.GameObjects.Text(this.scene,0,this.height/2-2*this.scene.game.resolution,this.card.info.name,{fontFamily:"Arial",fontSize:10*this.scene.game.resolution,color:"#fff",align:"center"}).setOrigin(.5,1);this.add(i)}this.active=null!==t}enabled(){return this.deck.energyValue>=this.card.cost}enable(t){if(!(this.input&&this.input.enabled===t||t&&this.card.started)){if(t){this.containerImage.clearTint()}else this.containerImage.setTint(10066329);this.enabled=t}}select2(t,e){this.card&&this.card.select(t,e),t?this.x-=this.width/5:this.x+=this.width/5}}class CardDeck extends Phaser.GameObjects.Group{constructor(t,e,i,s){super(t),this.player=e,this.cards=i,this.drawDeck=[],this.discardDeck=[];let n=i.length;for(let t=0;t<n;t++){let e=this.parse(this.cards[t]);this.drawDeck.push(e)}if(e){Phaser.Utils.Array.Shuffle(this.drawDeck),n>CardDeck.maxCards&&(n=CardDeck.maxCards),n>s&&(n=s);for(let e=0;e<n;e++){let e=new CardContainer(t,0,0,this);this.add(e)}this.children.each(function(t){t.deck=this},this),this.energyValue=0}}parse(t){let e,i=t.substr(0,t.indexOf("-")),s=t.substr(t.indexOf("-")+1);switch(i){case"CardSparkle":e=CardSparkle;break;case"CardShield":e=CardShield;break;case"CardGravity":e=CardGravity;break;case"CardTurret":e=CardTurret}return new e(i,this,s)}update(t){t>=0&&(this.energyValue=t),this.children.each(function(t){let e=t.card;e&&(this.energyValue>=e.cost&&!e.started?t.enable(!0):t.enable(!1))},this)}getRandom(t,e,i){let s=[];Object.entries(t).forEach(function(t){for(let e=0;e<this.getChildren().length;e++){let i=this.getChildren()[e].card;if(i&&i instanceof t[1])return}s.push(t)},this);let n=Phaser.Math.Between(0,s.length-1);return s[n]}drawCard(t){return this.drawDeck.pop()}recharge(t){this.drawDeck.unshift(t)}getCards(){return this.children}static createDeck(t){if(t)t=t.split(",");else{t=[];for(let e=0;e<4;e++)t.push(CardShield.name+"-0");for(let e=0;e<4;e++)t.push(CardSparkle.name+"-0");for(let e=0;e<4;e++)t.push(CardGravity.name+"-0")}return t}static preload(t,e,i){Card.preload(t,e);let s=CardDeck.createDeck(i);e.push({name:"Card",size:64});for(let i=s.length-1;i>=0;i--){let n,a=s[i].substr(0,s[i].indexOf("-"));s[i].substr(s[i].indexOf("-")+1);switch(a){case"CardSparkle":n=CardSparkle;break;case"CardShield":n=CardShield;break;case"CardGravity":n=CardGravity;break;case"CardTurret":n=CardTurret}n.preload(t,e)}}}CardDeck.maxCards=5;class CardDeckScene extends Phaser.Scene{constructor(t,e,i){super({key:t}),this.player=e,this.level=null,this.complete=!1,this.power=[{text:"Hand cards +1",id:"hand+1"},{text:"Initial energy +1",id:"energy+1"}],this.research=[{text:"Energy loading +10%",id:"energy+10"},{text:"Photon count + 10%",id:"photon+10"}]}init(){}preload(){let t=["CardSelect","gate-tile","gate-ring","gate-ring-bg","gate-earth","UIPowerButton"],e=[{name:"gate-center",size:110},{name:"gate-symbols",size:12.5}],i=["CardGravity-0","CardTurret-0"],s=new CardDeck(this,null,i);CardDeck.preload(t,e,this.game.restore("cards-0")),CardDeck.preload(t,e,i.join(",")),this.rewardCards=s.drawDeck;let n=this.scene.get("LoaderScene");n.loadImages(this,t),n.loadSpritesheets(this,e),this.levelNo=parseInt(this.game.restore("levelNo")||0),this.load.path=this.registry.get("path"),this.load.json("json/"+n.levelList[this.levelNo])}create(t){let e=this.scene.get("LoaderScene");this.level=this.cache.json.get("json/"+e.levelList[this.levelNo]),this.gameData=t,this.input.on("pointerup",function(t){this.onPointerup(t)},this),this.input.on("pointermove",function(t){this.onPointermove(t)},this),this.input.on("pointerdown",function(t){this.onPointerdown(t)},this);let i=this.add.image(0,0,"CardAreaSquare").setOrigin(0);i.scaleX=this.cameras.main.width/i.width,i.scaleY=this.cameras.main.height/i.height,i.setTint(0),i.alpha=this.level.reward?.5:1;let s=.7*this.cameras.main.width,n=this.cameras.main.centerY;this.gateX=s;let a=0,h=.3*this.cameras.main.width,r=this.textures.get("CardBg").getSourceImage(),o=24*this.game.resolution;a+=1.5*o,this.levelNo=parseInt(this.game.restore("levelNo")||0),this.isPower=this.levelNo%3==0,this.isData=this.levelNo%3==1,this.isReward=this.levelNo%3==2;let l;parseInt((this.levelNo+1)/3);a+=2*(l=this.isReward?this.add.text(this.cameras.main.centerX,a,"CREEPERS ELIMINATED",{fontStyle:"",fontSize:o,color:"#3f3",align:"center"}).setOrigin(.5):this.add.text(this.cameras.main.centerX,a,"CREEPERS on DECK",{fontStyle:"",fontSize:o,color:"#f33",align:"center"}).setOrigin(.5)).height;this.add.text(l.x,l.y+l.height,"DEFENSE SECTOR "+parseInt(this.levelNo/3+1),{fontStyle:"",fontSize:o/2,color:"#f99",align:"center"}).setOrigin(.5);if(this.level.gameover){return this.createGate(s,n),a+=2*(o*=.75),void(a+=2.5*this.add.text(h,a,"All sectors cleared.\n\nGood job Commander!",{fontStyle:"",fontSize:o,color:"#ff9",align:"left"}).setOrigin(.5).height)}if(this.isReward){a+=1.5*o;let t="Your Deck",e=!1,i=this.add.text(h,a,"Select one\nReward Card",{fontStyle:"",fontSize:.75*o,color:"#99f",align:"center"}).setOrigin(.5),n=a+=1.5*i.height;e||(a=this.createRewardCards(h,a,o,r),t="Replace in Deck"),this.info={},this.info.name=this.add.text(h,a,"",{fontStyle:"",fontSize:o,color:"#cc3",align:"center",lineSpacing:0}).setOrigin(.5,0),a+=1.5*this.info.name.height;let l=256*this.game.resolution;this.info.desc=this.add.text(h,a,"",{fontStyle:"",fontSize:o/2,color:"#cc3",align:"left",wordWrap:{width:l}}).setOrigin(.5,0),this.createDeckCards(s,n,o,r,"foo");this.add.text(s,i.y,"Replace a card\nin Your Deck",{fontStyle:"",fontSize:.75*o,color:"#99f",align:"center"}).setOrigin(.5);e&&this.completed()}else this.createPowers(h,a,o),this.createGate(s,n),this.isData&&this.completed()}createPowers(t,e,i,s){this.levelNo;e+=2*(i*=.75),e+=2.5*this.add.text(t,e,(this.level.power,"Select Research"),{fontStyle:"",fontSize:i,color:"#ff9",align:"left"}).setOrigin(.5).height,this.buttons=[];let n=this.level.power?"power-0":"research-0",a=(this.game.restore(n)||"").split(","),h=this.level.power?this.power:this.research;if(this.isData)for(let s=0;s<3&&s<h.length;s++){if(h[s].id!==a[a.length-1])continue;this.add.image(t,e,"UIPowerButton").setTint(65280),e+=2.5*this.add.text(t,e,h[s].text,{fontStyle:"",fontSize:i,color:"#000",align:"left"}).setOrigin(.5).height}else for(let s=0;s<3&&s<h.length;s++){if(a.includes(h[s].id))continue;let n=this.add.image(t,e,"UIPowerButton");n.setTint(13421568),this.buttons.push(n),n.id=h[s].id,e+=2.5*this.add.text(t,e,h[s].text,{fontStyle:"",fontSize:i,color:"#000",align:"left"}).setOrigin(.5).height}}createGate(t,e){let i=this.add.group();this.anims.create({key:"gate-center",frames:this.anims.generateFrameNumbers("gate-center"),frameRate:30,repeat:-1}),i.create(t,e,"gate-center").play("gate-center").alpha=.5,i.create(t,e,"gate-earth").setAlpha(.75);i.create(t,e,"gate-ring-bg");let s=i.create(t,e,"gate-ring");var n=new Phaser.Geom.Circle(0,0,s.width/2);let a=[];for(let t=0;t<24;t++)a.push(t);Phaser.Utils.Array.Shuffle(a);var h=this.add.container(s.x,s.y);i.add(h);let r=this.add.group(),o=parseInt(this.levelNo/3);for(let t=0;t<24;t++){let e=r.create(0,0,"gate-tile");e.angle=15*t,a[t]>o&&(e.tint=6710886),h.add(e)}Phaser.Actions.PlaceOnCircle(r.getChildren(),n);let l=this.add.group();this.symbols=l;for(let t=0;t<24;t++){let e=l.create(0,0,"gate-symbols",t);e.angle=15*t,a[t]>o&&(e.tint=3355443),h.add(e)}Phaser.Actions.PlaceOnCircle(l.getChildren(),n),this.gate=h,this.symbolTween=this.tweens.add({targets:h,duration:6e4,callbackScope:this,rotation:2*Math.PI,repeat:-1},this)}createRewardCards(t,e,i,s){let n=this.rewardCards;let a=this.add.group({key:"CardBg",frame:[0],frameQuantity:n.length}).getChildren();this.rewardTiles=a,Phaser.Actions.GridAlign(a,{width:2,height:1,cellWidth:s.width,cellHeight:s.height,x:t-(n.length-1)/2*s.width,y:e}),e+=s.height;for(let t=0;t<n.length;t++){let e=a[t];e.visible=!1;let i=new CardContainer(this,e.x,e.y,null);i.setCard(n[t]),i.setDepth(1),i.enable(!0),i.origX=e.x,i.origY=e.y,e.cardContainer=i}return e}createDeckCards(t,e,i,s,n){let a=this.add.group({key:"CardBg",frame:[0],frameQuantity:12}).getChildren();this.tiles=a,this.tilesX=4,this.tilesY=3,Phaser.Actions.GridAlign(a,{width:this.tilesX,height:this.tilesY,cellWidth:s.width,cellHeight:s.height,x:t-(this.tilesX-1)/2*s.width,y:e});let h=CardDeck.createDeck(this.game.restore("cards-0")),r=new CardDeck(this,null,h);this.cardDeck=r,this.cards=r.drawDeck;for(let t=0;t<r.drawDeck.length;t++){let e=a[t];e.visible=!1;let i=new CardContainer(this,e.x,e.y,null);i.setCard(r.drawDeck[t]),i.setDepth(1),i.origX=e.x,i.origY=e.y,e.cardContainer=i,e.cardId=t}let o=this.add.image(0,0,"CardSelect");o.visible=!1,o.setTint(16776960),o.setDepth(1),this.rewardCardSelect=o;let l=this.add.image(0,0,"CardSelect");l.visible=!1,l.setTint(16776960),this.deckCardSelect=l,l.setDepth(1),this.scene.bringToTop()}getTile(t,e){let i=this.tiles;for(let s=0;s<i.length;s++){let n=i[s];if(n.tx===t&&n.ty===e)return n}return null}getTileAt(t,e,i){for(let s=0;s<i.length;s++){let n=i[s];if(n.getBounds().contains(t,e))return n}return null}setState(t,e){t.setTint({active:11202218,enabled:6723942,disabled:13421772}[e])}onPointerdown(t){if(!this.input.enabled)return;if(this.complete)return void this.quit();if(!this.isReward){for(let e=0;e<this.buttons.length;e++){let i=this.buttons[e];i.getBounds().contains(t.x,t.y)&&(this.button=i,i.setTint(65280))}return}let e=null,i=null;if(this.rewardTiles&&(i=this.getTileAt(t.x,t.y,this.rewardTiles)),i)e=this.rewardCardSelect;else if(!this.rewardCardSelect.visible){let e=this.getTileAt(t.x,t.y,this.tiles);return void(e&&this.setInfo(e.cardContainer.card))}if(e){e.tile=i,e.setPosition(i.x,i.y),e.visible=!0;let t=this.tiles;for(let e=0;e<t.length;e++)t[e].cardContainer.enable(!0);this.setInfo(i.cardContainer.card)}else this.deckCardSelect.visible=!1}setInfo(t){this.info.name.text=t.info.name,this.info.desc.text=t.info.desc}quit(t=0){this.input.enabled&&(EventDispatcher.getInstance().emit("GameStatus",{shutdown:!0,won:!1,card:!0}),!t&&this.hitToContinue&&(this.hitToContinue.destroy(),this.hitToContinue=null),this.input.enabled=!1)}completed(t=0){if(this.complete)return;let e=24*this.game.resolution,i="<Hit anywhere to engage>";t&&(i="Creepers engaging in "+t/1e3+" seconds!",this.time.delayedCall(t,function(){this.quit(t-2e3)},[],this));let s=this.add.text(this.gateX,this.cameras.main.height-2*e,"WARNING\n"+i,{fontStyle:"",fontSize:e/2,color:"#f99",align:"center"}).setOrigin(.5);if(this.hitToContinue=s,this.complete=!0,this.isReward)return this.hitToContinue.visible=!1,this.levelNo++,this.game.save("levelNo",this.levelNo),void this.time.delayedCall(1500,function(){this.quit()},[],this);this.tweens.add({targets:[s],duration:500,ease:Phaser.Math.Easing.Power2,alpha:0,yoyo:!0,repeat:-1}),this.isPower&&(this.levelNo++,this.game.save("levelNo",this.levelNo))}onPointerup(t){if(this.complete)return;if(!this.isReward){if(this.button){let e=this.button;if(e.getBounds().contains(t.x,t.y)){this.saveSkill(e.id),this.completed(2e3);for(let t=0;t<this.buttons.length;t++)e!==this.buttons[t]&&this.buttons[t].destroy();return}}for(let t=0;t<this.buttons.length;t++){this.buttons[t].setTint(13421568)}return void(this.button=null)}let e=null,i=null;if(this.rewardCardSelect.visible&&((i=this.getTileAt(t.x,t.y,this.tiles))?((e=this.deckCardSelect).tile=i,e.setPosition(i.x,i.y),e.visible=!0):this.rewardCardSelect.visible),e)this.rewardCardSelect.visible&&this.deckCardSelect.visible&&(this.changeCard(this.deckCardSelect.tile.cardId,this.rewardCardSelect.tile.cardContainer.card.name),this.rewardCardSelect.visible=!1,this.deckCardSelect.visible=!1,this.tweens.add({targets:[this.deckCardSelect.tile,this.deckCardSelect.tile.cardContainer],duration:400,alpha:0,callbackScope:this,onComplete:function(){}}),this.tweens.add({targets:[this.rewardCardSelect.tile,this.rewardCardSelect.tile.cardContainer],duration:400,x:this.deckCardSelect.x,y:this.deckCardSelect.y,callbackScope:this,onComplete:function(){this.completed(2e3)}}));else if(this.rewardCardSelect.visible){let t=this.rewardCardSelect.tile.cardContainer;this.tweens.add({targets:[t,this.rewardCardSelect],duration:100,x:t.origX,y:t.origY,callbackScope:this,onComplete:function(){}})}}changeCard(t,e){this.cardDeck.cards[t]=e+"-0",this.game.save("cards-0",this.cardDeck.cards)}saveSkill(t){let e=this.level.power?"power-0":"research-0",i=(this.game.restore(e)||"").split();i.push(t),this.game.save(e,i.join(","))}onPointermove(t){this.complete||this.isReward&&this.rewardCardSelect&&this.rewardCardSelect.visible&&(this.children.bringToTop(this.rewardCardSelect.tile.cardContainer),this.children.bringToTop(this.rewardCardSelect),this.children.bringToTop(this.rewardCardSelect),this.rewardCardSelect.tile.cardContainer.setPosition(t.x,t.y),this.rewardCardSelect.setPosition(t.x,t.y))}}class CardEnergy extends Phaser.Physics.Arcade.Image{constructor(t,e,i,s,n){super(t,e,i,CardEnergy.name),this.info={name:"Card Energy",desc:""},e+=this.width/2,i+=this.height/2,this.x=e,this.y=i,this.deck=s,t.add.existing(this),this.value=n.energyValue+n.energy_1,this.deck.update(this.value),this.tick=0;let a=n.energyDelay>=0?n.energyDelay:CardEnergy.TickDelay;a>0&&(this.timer=this.scene.time.addEvent({delay:a,callback:function(){this.tick<9?(this.setFrame(this.tick),this.tick++):this.addEnergy(1)&&(this.tick=0,this.setFrame(this.tick))},args:[],callbackScope:this,loop:!0,repeat:0,startAt:0,timeScale:1,paused:!1})),this.info.desc+="Initial energy "+this.value,n.energy_1&&(this.info.desc+="\n + research bonus +1"),this.info.desc+="\nReload speed "+8*a/1e3+" seconds",n.speed_1&&(this.info.desc+="\n + research bonus 100%"),this.valueImage=this.scene.add.image(e,i,CardEnergy.name+"Digit",this.value)}val(){return this.value}addEnergy(t){let e=this.value<9;return this.value+=t,this.value>9&&(this.value=9),this.valueImage.setFrame(this.value),this.deck.update(this.value),e}stop(){this.timer&&(this.timer.paused=!0)}static preload(t,e){e.push({name:CardEnergy.name,size:50}),e.push({name:CardEnergy.name+"Digit",size:25})}}CardEnergy.name="CardEnergy",CardEnergy.TickDelay=312.5;class EventDispatcher extends Phaser.Events.EventEmitter{constructor(){super()}static getInstance(){return null===EventDispatcher.instance&&(EventDispatcher.instance=new EventDispatcher),EventDispatcher.instance}}EventDispatcher.instance=null;class GameScene extends Phaser.Scene{constructor(t){super({key:t}),this.teleports=[[0,1],[1,2],[2,3],[3,4],[4,5],[5,0]],this.random=Date.now()}init(){this.firstGameToday=!1,parseInt(0|this.game.restore("lastPlayTime"))+43200<(Date.now()/1e3|0)&&(this.firstGameToday=!0)}preload(){this.scene.get("LoaderScene")}create(t){this.debugInfo=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY/2,"",{font:16*this.game.resolution+"px Arial",fill:"#ffffff"}).setOrigin(.5),EventDispatcher.getInstance().on("GameStatus",this.gameStatus.bind(this)),this.startLevel(),this.level.end||this.startGame()}startGame(){let t=this.registry.get("level");this.level=t,t.grid?this.startUIScene():this.startMenuScene()}startLevel(){let t=this.registry.get("level");this.level=t,t.end}startMenuScene(){let t=new CardDeckScene("CardDeckScene",this.player,this.level);this.scene.add("CardDeckScene",t,!0,{})}startUIScene(){let t=this.scene.get("UIScene");t=this.scene.add("UIScene",new UIScene("UIScene"));this.scene.run(t,{sceneCreated:this.uiSceneCreated.bind(this),layout:{y:0,x:0,h:this.cameras.main.height-0,w:this.cameras.main.width-0}}),this.uiScene=t}startScene(t,e){let i=this.scene.get(t);i?(this.scene.run(i,e),this.unitScene=i):this.time.delayedCall(100,function(){this.startScene(t,e)},[],this)}getUnitScene(t,e){return"tech"===e?(this.techScene=new TechScene(t,this.uiScene),this.techScene):"tictactoe"===e?new TictactoeUnitScene(t,this.uiScene):new UnitScene(t,this.uiScene)}uiSceneCreated(){this.level.teleport=this.teleport;let t=this.level,e="UnitScene-"+t.id,i=this.scene.get(e);i?(i.scene.wake(),this.uiScene.setUnitSceneLevel(i,this.level),this.uiScene.setPlayer(t.data.players[0]),this.unitScene=i):(i=this.scene.add(e,this.getUnitScene(e,t.name)),t.sceneCreated=this.sceneCreated.bind(this),this.startScene(e,t)),this.unitScene===this.techScene&&this.techScene.updateItems()}sceneCreated(t){this.level.teleport=this.teleport,this.uiScene.setUnitSceneLevel(t,this.level),this.unitScene.levelFactory||(this.unitScene.levelFactory=new LevelFactory(this.uiScene,this.unitScene,this.level,this.teleports))}gameStatus(t){if(t.shutdown&&(this.scene.wake(),this.cameras.main.fadeOut(150,255,255,255,function(t,e){1===e&&this.cameras.main.fadeIn(1e3,255,255,255,function(t,e){})},this),this.scene.manager.scenes.forEach(function(t){t instanceof LoaderScene||t instanceof GameScene||t.gameOver&&t.gameOver()}),this.time.delayedCall(t.card||t.won?500:3e3,function(){this.scene.manager.scenes.forEach(function(t){t instanceof LoaderScene||t instanceof GameScene||t.destroyed&&t.destroyed()}),this.time.delayedCall(100,function(){EventDispatcher.getInstance().emit("GameStatus",{gameover:!0,won:t.won})},[],this)},[],this)),t.start&&this.scene.setVisible(!1),t.minigameComplete&&(this.startLevel(),this.uiSceneCreated(),this.uiScene.player.bot.minigameStop()),t.teleportComplete&&(this.startLevel(),this.uiSceneCreated(),this.uiScene.player.bot.travelStop()),t.minigame&&(this.teleport=null),t.tech){if(t.close)return this.startLevel(),this.uiSceneCreated(),void this.uiScene.player.bot.techStop(t);this.techLevel||(this.techLevel={name:"tech",minigame:!0,id:1e3,grid:{size:1,x:0,y:0,w:0,h:0},units:[],players:[{bot:[{position:-1}]},{}]}),this.techLevel.type=t.type,this.techLevel.state=t,this.level=this.techLevel,this.uiSceneCreated()}t.teleport&&(this.teleport=t.from.teleport),t.gameover}handleLoseFocus(){console.log("handleLoseFocus")}}Unit.Type={Station:UnitStation,Element:UnitElement,Gate:UnitGate,Virus:UnitVirus,Laser:UnitLaser,Sparkle:UnitSparkle,Shield:UnitShield,Crusher:UnitCrusher};class LevelFactory{constructor(t,e,i,s){this.uiScene=t,this.unitScene=e,this.randomUnitTimeout=0,this.units=[],this.events=[],i.data={players:[],playerTeams:[]};let n=-1,a=CardDeck.createDeck(this.uiScene.game.restore("cards-0"));for(let s=0;s<i.players.length;s++)i.data.players[s]=new Player(s,e,a,i),i.data.players[s].id=s,i.players[s].team>=0?n=i.players[s].team:n++,i.data.playerTeams[n]||(i.data.playerTeams[n]=new PlayerTeam(n,t,e)),i.data.playerTeams[n].addPlayer(i.data.players[s]);e.setColliders&&e.setColliders(),this.level=i,this.tilesize=64*e.game.resolution;let h,r=i.data.players[0];this.player=r,h="tech"===i.name?TechUnitBot:"tictactoe"===i.name?TictactoeUnitBot:UnitBot;if(!i.minigame)for(let t=0;t<i.players.length;t++){let s=i.players[t],n=i.data.players[t],a=(this.createUnits(e,s.guard,UnitGuard,n),this.createUnits(e,s.emitter,UnitEmitter,n));this.createUnits(e,s.mining,UnitMining,n,a),this.createUnits(e,s.teleport,UnitTeleport,n),this.createUnits(e,s.center,UnitCenter,n),this.createUnits(e,s.station,UnitStation,n),this.createUnits(e,s.asteroid,UnitAsteroid,n),this.createUnits(e,s.barrier,UnitBarrier,n)}i.units||(i.units=[]),this.enemyStatus=[];for(let t=0;t<i.units.length;t++){let e=i.units[t];"Virus"===e.type?(this.statusVirus=this.uiScene.addEnemyStatus(0,UnitVirus.info),this.enemyStatus.push(this.statusVirus),this.statusVirus.set(e.count,0,e.count)):"Eye"===e.type?(this.statusCrusher=this.uiScene.addEnemyStatus(1,UnitCrusher.info),this.enemyStatus.push(this.statusCrusher),this.statusCrusher.set(e.count,0,e.count)):console.log("Not implemented:",e.type)}if(this.gates=[],i.gates)for(let t=0;t<i.gates.length;t++){let s=i.gates[t],n={type:s.type},a=this.createUnit(e,UnitGate,1e3,500,this.level.data.players[1],n);a.gateType=s.type,this.gates.push(a)}if(i.event)for(let t=0;t<i.event.length;t++){let e=i.event[t],s=this.getUnitById(e.unit);e.disable&&(e.disableUnit=this.getUnitById(e.disable)),this.events.push(new LevelEvent(s,e))}t.setPlayer(r);for(let t=0;t<this.units.length;t++)this.units[t].unit&&this.units[t].unitEventNotify("start")}isAllEnemiesDead(){return!1}destroyGate(t){this.gates.pop()}unitType(){}createUnit(t,e,i,s,n,a){if(console.log("create",e,a),e===Unit.Type.Virus||e===Unit.Type.Crusher){if(e===Unit.Type.Virus){if(0===this.statusVirus.val())return;this.statusVirus.update(-1)}if(e===Unit.Type.Crusher){if(0===this.statusCrusher.val())return;this.statusCrusher.update(-1)}}if(a.unit){a.parents=[];for(let t=0;t<a.unit.length;t++)a.parents.push(this.getUnitById(a.unit[t]))}let h=new e(t,i,s,n,a);return a.id&&(h.id=a.id),h}randomXY(t){let e=this.level,i=this.tilesize,s=this.position;s||(this.position={},(s=this.position).areas=[1,2,3,4],Phaser.Utils.Array.Shuffle(s.areas));let n=s.areas.splice(0,1),a=e.grid.w/2-1.5,h=e.grid.h/2-1.5;return s.x=Phaser.Math.FloatBetween(1.5,a),s.y=Phaser.Math.FloatBetween(1.5,h),2===n[0]&&(s.x+=e.grid.w/2),3===n[0]&&(s.y+=e.grid.h/2),4===n[0]&&(s.x+=e.grid.w/2,s.y+=e.grid.h/2),s.x=Math.trunc(s.x),s.y=Math.trunc(s.y),s.xx=s.x,s.yy=s.y,s.x*=i,s.y*=i,s}createTeleports(t,e,i,s){let n=[],a=2;for(let h=0;h<i.length;h++){let r=i[h];if(r[0]===e.id||r[1]===e.id){let i=this.randomXY(t);t.groundLayer.putTileAt(null,i.xx-1,i.yy-1),t.groundLayer.putTileAt(null,i.xx,i.yy-1),t.groundLayer.putTileAt(null,i.xx-1,i.yy),t.groundLayer.putTileAt(null,i.xx,i.yy);let h=i.x,o=i.y,l=r[0]===e.id?r[1]:r[0],c={id:a++,from:e.id,to:l},d=new UnitTeleport(t,h,o,s,c);n.push(d),this.units.push(d)}}return n}createEmitters2(t,e,i,s){for(let i=0;i<1;i++){let i=this.randomXY(t);new UnitEmitter(t,i.x,i.y,s,e)}}createEnergy(t,e,i,s){let n=[];for(let i=0;i<e.grid.w+e.grid.h;i+=10){let i=64*t.game.resolution,a=Phaser.Math.Between(2,e.grid.w-2)*i,h=Phaser.Math.Between(2,e.grid.h-2)*i,r=new UnitEnergy(t,a,h,s,e);n.push(r)}return n}relocateUnit(t,e,i,s,n){let a,h,r=64*t.game.resolution;do{a=i.x;let t=Phaser.Math.Between(s,n)*r;0===Phaser.Math.Between(0,1)&&(t=-t),a+=t}while(a<1*r||a>e.grid.w*r-r);do{h=i.y;let t=Phaser.Math.Between(s,n)*r;0===Phaser.Math.Between(0,1)&&(t=-t),h+=t}while(h<1*r||h>e.grid.h*r-r);return{x:a,y:h}}destroy(){for(let t=0;t<this.events.length;t++)this.events[t].destroy();this.events=null}createUnits(t,e,i,s,n){let a=[];if(e)for(let n=0;n<e.length;n++){let h=e[n],r=this.unitScene.hexagonGroup.getChildren()[9*h.x+h.y],o=r.x,l=r.y;1;let c=this.createUnit(t,i,o,l,s,h);a.push(c),this.units.push(c)}return a}getUnitById(t){for(let e=0;e<this.units.length;e++)if(this.units[e].id===t)return this.units[e];return null}createRandomUnit(){if(this.isAllEnemiesDead()){let t=this.unitScene.getEnemyTroops(this.player),e=!0;for(let i=0;i<t.length;i++){if(t[i].length>0){e=!1;break}}if(e){this.unitScene.scene.pause(),this.levelNo=parseInt(this.unitScene.game.restore("levelNo")||0),this.levelNo++,this.unitScene.game.save("levelNo",this.levelNo);let t=new CardDeckScene("CardDeckScene",this.player,this.level);return this.unitScene.scene.add("CardDeckScene",t,!0,{uiScene:this.uiScene,unitScene:this.unitScene}),void this.player.setModalScene(t)}}const t=this.unitScene;t.addEvent(this.createRandomUnit,100,this);let e=t.teamBuildings[0].getChildren(),i=0;for(let t=e.length-1;t>=0;t--){e[t].unitState>Unit.StateBuild&&i++}if(0===i)return;i>500&&(i=500);let s=1e3*(501-i);if(s=100,t.time.now<this.randomUnitTimeout+100)return;this.randomUnitTimeout=t.time.now;let n=this.level.units,a=Phaser.Math.Between(1,100),h=null;for(let t=0;t<n.length;t++){let e=n[t];if((a-=e.freq)<0){h=e;break}}if(h){let e=t.getBounds(),i=32*t.game.resolution,s=i*i;for(let i=0;i<10;i++){let i,n=Phaser.Math.Between(0,e.w),a=Phaser.Math.Between(0,e.h/2);if(t.isFreeSpace(t.mapUnitGroup,n,a,s)&&(t.isFreeSpace(t.fields,n,a,s)&&t.isFreeSpace(t.idleUnits,n,a,s))){for(i=0;i<t.teamBuildings.length&&t.isFreeSpace(t.teamBuildings[i],n,a,s)&&t.isFreeSpace(t.teamTroops[i],n,a,s)&&t.isFreeSpace(t.teamBullets[i],n,a,s);i++);if(i===t.teamBuildings.length){let e;"Virus"===h.type&&(e=Unit.Type.Virus),"Energy"===h.type&&(e=Unit.Type.Energy),"Guard"===h.type&&(e=Unit.Type.Guard),"Crusher"===h.type&&(e=Unit.Type.Crusher),this.createUnit(t,e,n,a,this.level.data.players[h.player],h);break}}}}let r=t.idleUnits.getChildren();for(let e=r.length-1;e>=0;e--){let i=r[e];i.unitConfig.incubate;i.incubate+=i.unitConfig.incubate,i.incubate<1?i.updateDamage():(i.incubate=null,t.idleUnits.remove(i),i.sceneGroup.add(i),i.initUnit())}}static unitType(t){let e;return"Virus"===t&&(e=UnitVirus),e}static preload(t,e,i){if(t.units)for(let s=0;s<t.units.length;s++){let n=t.units[s];this.unitType(n.type).preload(e,i)}UnitElement.preload(e,i),UnitStation.preload(e,i),UnitLaser.preload(e,i),UnitShield.preload(e,i),UnitEmitter.preload(e,i)}}class LoaderScene extends Phaser.Scene{constructor(t){super({key:"LoaderScene",visible:!1}),this.loadProgress=0,this.levelList=t,this.minigame=!1,this.won=!1,this.minigameLevelNo=-1}init(){}preload(){this.load.path=this.registry.get("path"),this.game.getImage=this.getImage,this.game.config.width>=2560&&this.game.config.height>=1440?(this.res="",this.game.resolution=4):this.game.config.width>=1920&&this.game.config.height>=1080?(this.res="-L",this.game.resolution=3):this.game.config.width>=1280&&this.game.config.height>=720?(this.res="-M",this.game.resolution=2):(this.res="-S",this.game.resolution=1),this.game.resolutionSquared=this.game.resolution*this.game.resolution,this.game.res=this.res,this.levelNo=parseInt(this.game.restore("levelNo")||0),this.getLevelNo(LEVEL),this.load.json("json/"+this.levelList[this.levelNo])}getLevelNo(t){for(let e=0;e<this.levelList.length;e++)if(this.levelList[e]===t){this.levelNo=e;break}}gameStatus(t){t.gameover&&(this.won=t.won,this.levelNo=parseInt(this.game.restore("levelNo")||0),this.won,this.restartLevel(500,!0)),t.teleport&&(this.levelNo=t.from.teleport.to,this.restartLevel(t.teleport.time,!1)),t.tech,t.minigame&&(this.minigame=!0,t.level?(this.minigameLevelNo=this.levelNo,this.getLevelNo(t.level),this.restartLevel(t.minigame.time,!1)):(this.levelNo=this.minigameLevelNo,this.minigameLevelNo=-1,this.restartLevel(t.minigame.time,!1)))}checkOriention(t,e){t===Phaser.Scale.PORTRAIT||Phaser.Scale.LANDSCAPE}create(){this.debugInfo=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY/2,"",{font:16*this.game.resolution+"px Arial",fill:"#ffff00"}).setOrigin(.5);let t=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,Text.loading,{font:16*this.game.resolution+"px Arial",fill:"#000000"}).setOrigin(.5);t.visible=!1,this.load.on("loadProgress",function(e){t.text=Text.loading+" "+parseInt(100*e)+" %"},this),EventDispatcher.getInstance().on("GameStatus",this.gameStatus.bind(this)),this.initial=!0,this.startLevel()}loadJson(t){this.load.json("json/"+this.levelList[t])}loadLevel(){this.levelList&&this.levelNo>=this.levelList.length||(this.registry.set("level",null),this.loadJson(this.levelNo),this.load.start())}restartLevel(t,e){if(e){let t=EventDispatcher.getInstance();t.shutdown(),t.on("GameStatus",this.gameStatus.bind(this))}this.scene.setVisible(!0),this.scene.bringToTop(),this.cameras.main.alpha=1,this.cameras.main.once("camerafadeoutcomplete",()=>{e&&this.scene.manager.scenes.forEach(function(t){t!==this&&this.scene.remove(t)},this),this.time.delayedCall(100,function(){this.startLevel()},[],this)}),this.cameras.main.fadeOut(t,255,255,255)}startLevel(){if(!this.debug&&this.initial&&(this.initial=!1,this.levelNo%3==1)){let t=parseInt(this.levelNo/3);this.levelNo=3*t}let t=this.cache.json.get("json/"+this.levelList[this.levelNo]);if(!t)return this.load.once("complete",function(){this.startLevel()},this),this.load.json("json/"+this.levelList[this.levelNo]),void this.load.start();this.registry.set("level",t),this.scene.setVisible(!1),this.scene.get("GameScene")?this.minigame?(this.minigame=!1,EventDispatcher.getInstance().emit("GameStatus",{minigameComplete:!0})):EventDispatcher.getInstance().emit("GameStatus",{teleportComplete:!0}):(this.scene.add("GameScene",new GameScene("GameScene"),!0,{won:this.won}),this.won=!1)}getImage(t,e,i,s){return this.cache.json.get("sprites").frames[s+".png"]?new Phaser.GameObjects.Image(t,e,i,"sprites-doodd",s):new Phaser.GameObjects.Image(t,e,i,s)}loadBitmap2(t,e){this.bitmaps={frames:[]},e.forEach(function(e){t===this||this.sprites.frames[e+".png"]||t.load.bitmapFont(e,"img/"+e+this.res+".png","img/"+e+this.res+".xml")},this)}loadImages(t,e,i="png"){this.sprites={frames:[]},e.forEach(function(e){if(t!==this&&!this.sprites.frames[e+"."+i]){let s="";this.registry.get("debug")&&(s="?t="+Date.now()),t.load.image(e,this.load.path+"img/"+e+this.res+"."+i+s)}},this)}loadSpritesheets(t,e){e.forEach(function(e){let i=e.width?e.width:e.size,s=e.height?e.height:e.size,n="";this.registry.get("debug")&&(n="?t="+Date.now());let a=e.sub?e.sub:"";t.load.spritesheet(e.name,this.load.path+"img/"+e.name+a+this.res+".png"+n,{frameWidth:i*this.game.resolution,frameHeight:s*this.game.resolution})},this)}}const TEAM_COLOR=[13408716,9638133,6710886,6684774],TEAM_COLOR_BG=[1907968,51,3342336,1900573],ROUTE_COLOR=[10066227,3355443,16777215,3355443];class Player{constructor(t,e,i,s){this.id=t,this.cards=i,this.color=TEAM_COLOR[this.id],this.routeColor=ROUTE_COLOR[this.id],this.bgColor=TEAM_COLOR_BG[this.id],this.unitScene=e,this.cardScene=e.cardScene,this.restoreConfig(t)}createCards(){if(0===this.id){let t=4+this.config.hand_1;this.cardDeck=new CardDeck(this.cardScene,this,this.cards,t-1);let e={energyValue:4,energy_1:this.config.energy_1,energyDelay:500},i=60*this.cardScene.game.resolution,s=this.cardScene.layout,n=this.cardScene.cameras.main.centerX-56*this.cardScene.game.resolution/2,a=this.cardScene.cameras.main.height-52*this.cardScene.game.resolution,h=new CardEnergy(this.cardScene,n,a,this.cardDeck,e);this.energy=h,n=h.x+i;let r=s.home.grid;a=h.y;let o=0;this.cardDeck.children.each(function(t){t.x=n,t.y=a,n+=i,o++},this),this.fillCards();this.cardScene.add.text(n-i/10,a-r/2+i/4,"Next card",{fontFamily:"Arial",fontSize:10*this.cardScene.game.resolution,color:"#ccc",align:"center"}).setOrigin(.5,1)}this.cardSelected=null,this.shoot={};let t=this.shoot;t.laser=this.cardScene.add.sprite(0,0,"EffectLaser"),this.cardScene.anims.create({key:"EffectLaser",frames:this.cardScene.anims.generateFrameNumbers("EffectLaser"),frameRate:8,repeat:-1,yoyo:!1}),t.laser.anims.play("EffectLaser"),t.laser.visible=!1,t.laser.setOrigin(0,.5),t.laser.setTint(16724787),t.laser.setDepth(99),this.shoot.target=null,this.shoot.targetAuto=null,this.setModalScene(null);let e=8*this.cardScene.game.resolution;this.popup=this.cardScene.add.container(0,0),this.infoBg=this.popup.add(new Phaser.GameObjects.Image(this.cardScene,0,0,"UIInfoBg")).last,this.popup.visible=!1;let i=24*this.cardScene.game.resolution,s=-this.infoBg.width/2+e,n=-this.infoBg.height/2+e;this.infoName=this.popup.add(new Phaser.GameObjects.Text(this.cardScene,s,n,"",{fontStyle:"",fontSize:.75*i,color:"#333",align:"center",lineSpacing:0})).last,n+=i;let a=this.infoBg.width-2*e;this.infoDesc=this.popup.add(new Phaser.GameObjects.Text(this.cardScene,s,n,"",{fontStyle:"",fontSize:i/2,color:"#333",align:"left",wordWrap:{width:a}})).last}restoreConfig(t){if(0!==t)return;let e=(this.cardScene.game.restore("power-0")||"").split(",");this.config={energy_1:e.includes("energy+1")?1:0,hand_1:e.includes("hand+1")?1:0}}addHQ(t){this.HQ=t}setTeam(t){this.team=t,this.unitScene.addTeamGroups(this.team.id)}gameOver(){this.energy&&this.energy.stop(),log("gameover"),this.cardScene.game.save("cards-0",this.cardDeck.cards)}fillCards(){let t=this.cardDeck.getFirstDead();for(;t;){let e=this.cardDeck.drawCard(t);if(!e)break;t.setCard(e),t=this.cardDeck.getFirstDead()}this.cardDeck.update()}getCards(){return this.cardDeck}selectCard(t){if(this.cardSelected&&(this.cardSelected.x-=.1*this.cardSelected.width,this.cardSelected.card.disable()),this.cardSelected=t,t){this.cardSelected.x+=.1*this.cardSelected.width;let t=this.unitScene.getBuildings(this);this.cardSelected.card.enable(t)}}getCard(t){let e=this.getCards().getChildren();for(let i=0;i<e.length;i++)if(e[i].getBounds().contains(t.x,t.y)&&this.energy.val()>=e[i].card.cost&&!e[i].card.started)return e[i];return null}setModalScene(t){this.modalScene=t}showInfo(t,e){if(this.popup.visible)return;let i=4*this.cardScene.game.resolution,s=t.x,n=t.y;t.x>this.cardScene.cameras.main.centerX?(s+=-t.width/2-i-this.infoBg.width/2,n+=-t.height/2+this.infoBg.height/2):(s+=t.width/2+i+this.infoBg.width/2,n+=-t.height/2+this.infoBg.height/2),this.popup.setPosition(s,n),this.popup.visible=!0,this.infoName.text=e.name,this.infoDesc.text=e.desc}uiIcon(t){let e=this.energy;if(e.getBounds().contains(t.x,t.y))return this.showInfo(e,e.info),!0;let i=this.unitScene.levelFactory.enemyStatus;for(let e=0;e<i.length;e++){let s=i[e];if(s.valueImage.getBounds().contains(t.x,t.y))return this.showInfo(s.valueImage,s.info),!0}return!1}onPointerdown(t){if(this.popup.visible)return void(this.popup.visible=!1);if(this.modalScene)return;if(this.uiIcon(t))return;if(!this.cardSelected){let e=this.getCard(t);return void(e&&(this.selectCard(e),this.onPointermove(t)))}this.getCard(t)?this.selectCard(null):this.cardSelected&&this.cardSelected.card.onPointerdown(t)}onPointerup(t){if(!this.popup.visible&&!this.modalScene)if(this.cardSelected){let e=this.getCard(t);e?e!==this.cardSelected&&this.selectCard(null):this.cardSelected.card.onPointerup(t)&&this.selectCard(null)}else{let e=this.unitScene.hexagonGroup.getChildren(),i=null;for(let s=0;s<e.length;s++){let n=e[s];n.getBounds().contains(t.x,t.y)&&(i=null===i?n:null)}i&&i.setTint(65280)}}onPointermove(t){this.popup.visible||this.modalScene||this.cardSelected&&this.cardSelected.card.onPointermove(t)}update(t,e){if(this.modalScene)return;let i=this.shoot.target||this.shoot.targetAuto;if(i){let t=Phaser.Math.Angle.BetweenPoints(this.shoot.laser,i);this.shoot.laser.setRotation(t);var s=Phaser.Math.Distance.Between(this.shoot.laser.x,this.shoot.laser.y,i.x,i.y);this.shoot.laser.scaleX=s/this.shoot.laser.width}}}class PlayerTeam{constructor(t,e,i){this.id=t,this.cardScene=e,this.unitScene=i,this.players=[]}addPlayer(t){this.players.push(t),t.setTeam(this)}}class PriorityQueue{constructor(){this.collection=[]}enqueue(t){if(this.isEmpty())this.collection.push(t);else{let e=!1;for(let i=1;i<=this.collection.length;i++)if(t[1]<this.collection[i-1][1]){this.collection.splice(i-1,0,t),e=!0;break}e||this.collection.push(t)}}dequeue(){return 0===this.collection.length?null:this.collection.shift()}dequeueExpired(t){return 0===this.collection.length?null:t>=this.collection[0][1]?this.collection.shift():null}isEmpty(){return 0===this.collection.length}clear(t){for(let e=this.collection.length-1;e>=0;e--)t===this.collection[e][2]&&this.collection.splice(e,1)}destroy(){this.collection=[]}}class TechScene extends Phaser.Scene{constructor(t,e){super({key:t}),this.cardScene=e,this.teamBuildings=[]}init(){}preload(){let t=this.scene.get("LoaderScene");t.loadImages(this,[]),t.loadSpritesheets(this,[])}create(t){this.level=t,this.scene.sendToBack(),this.cameras.main.setBackgroundColor("#3b2d63");let e=this.textures.get("ActionBg").getSourceImage();let i=this.add.group({key:"ActionBg",frame:[0],frameQuantity:20}).getChildren();this.tiles=i,this.tilesX=5,this.tilesY=4,Phaser.Actions.GridAlign(i,{width:this.tilesX,height:this.tilesY,cellWidth:e.width,cellHeight:e.height,x:this.cameras.main.centerX-2*e.width,y:this.cameras.main.centerY-1.5*e.height}),this.updateItems(),t.sceneCreated&&t.sceneCreated(this)}updateItems(){if(!this.tiles)return void console.log("err",this);let t,e=this.tiles;for(let t=0;t<e.length;t++){let i=e[t];i.visible=!1,i.icon&&(i.icon.destroy(),i.icon=null)}"ActionTool"===this.level.type?t=["ActionCancel","ActionSpawn","ActionBuild"]:"ActionCargo"===this.level.type?(t=["ActionCancel"],this.level.state.ActionBuild&&t.push("ActionBuild"),this.level.state.ActionBotIn&&t.push("ActionBotIn")):t=["ActionCancel","UnitRoute","UnitStorage","UnitSpawner","UnitLaser"];let i=0,s=0;for(let n=0;n<e.length;n++){let a=e[n];if(t[n]){{let e=this.add.image(a.x,a.y,t[n]);a.icon=e,a.buildName=t[n],a.visible=!0}i===this.tilesX&&(i=0,s++),a.tx=i,a.ty=s,i++,this.setState(a,"enabled")}}this.bot&&this.bot.selectTile(this.getTile(0,0))}addTeamGroups(t){let e=this.physics.add.group();this.teamBuildings[t]=e}getTile(t,e){let i=this.tiles;for(let s=0;s<i.length;s++){let n=i[s];if(n.tx===t&&n.ty===e)return n}return null}getTileAt(t,e){let i=this.tiles;for(let s=0;s<i.length;s++){let n=i[s];if(n.getBounds().contains(t,e)&&n.visible)return n}return null}setState(t,e){t.setTint({active:11202218,enabled:6723942,disabled:13421772}[e])}}class TechUnitBot extends Unit{constructor(t,e,i,s,n){super(t,e,i,"CardSelect",0,s,n,t.teamBuildings[s.team.id]),this.control={};let a=0;t.registry.get("minigame")?(a=parseInt(0|this.scene.game.restore("minigame-tictactoe")),this.maxLevel=a%2==0?a+2:a+1,this.maxLevel>6&&(this.maxLevel=6),this.maxLevel=a+1):this.maxLevel=6;this.scene.tictactoe;let h=this.scene.cardScene.cameras.main.centerX,r=(this.scene.cardScene.cameras.main.centerY,"foo");t.registry.get("minigame")&&(r="BUILD");let o=16*this.scene.game.resolution;this.gameLabel=this.scene.add.text(h,o,r,{fontStyle:"",fontSize:o,color:"#99f",align:"center"}).setOrigin(.5),this.moveTime=0,this.selectTile(this.scene.getTile(0,0)),this.scene.bot=this,this.modal=!0,this.setDepth(10)}initUnit(){}travelEffect(){}techStop(){}menuSelect(){}controlPoint(t){if(t){let e=this.scene.getTileAt(t[0],t[1]);e&&(this.selectTile(e),this.scene.time.delayedCall(150,function(){this.uiAction()},[],this))}return!1}controlDo(t,e,i,s,n){if(!(this.moveTime>this.scene.time.now)){let n=this.tile,a=null;t&&(a=this.scene.getTile(n.tx,n.ty-1)),s&&(a=this.scene.getTile(n.tx+1,n.ty)),e&&(a=this.scene.getTile(n.tx,n.ty+1)),i&&(a=this.scene.getTile(n.tx-1,n.ty)),a&&(this.moveTime=this.scene.time.now+200,this.selectTile(a))}}uiAction(t){EventDispatcher.getInstance().emit("GameStatus",{tech:!0,close:!0,selected:this.tile.buildName})}activateAction(t,e){this.currentAction=t,t.start.call(this,e)}static preload(t,e,i){let s="";t.registry.get("minigame")&&(s="-minimind",e.push("EffectExplode-0"),e.push("EffectExplode-1"),e.push("MinigameTechnology"),e.push("ActionBuild")),i.push({name:"TictactoeTokens",size:64,sub:s})}selectTile(t){this.tile&&this.scene.setState(this.tile,"enabled"),this.tile=t,this.x=this.tile.x,this.y=this.tile.y,this.scene.setState(this.tile,"active")}}TechUnitBot.name="TechUnitBot";var Text={id:"minimind",gameName:"minimind",loading:"Loading",next:"NEXT",play:"PLAY",quit:"QUIT",pause:"PAUSE",resume:"RESUME",restart:"TRY\nAGAIN",gameOverCongratulations:"All levels passed.\n\nCongratulations!",win:"YOU WIN",wait:"Wait for computer,\nmay take a minute.",setLang(t){"fi"===t&&(this.gameName="NANOBOT LIFE",this.loading="Ladataan",this.next="JATKA",this.play="PELAA",this.quit="POISTU",this.pause="PAUSE",this.resume="RESUME",this.restart="ALOITA\nALUSTA",this.gameOverCongratulations="Kaikki tasot selvitetty.\n\nOnnittelut!",this.draw="TASAN",this.win="VOITIT",this.wait="Odota tietokonetta,\nvoi kest minuutin.")}};class TictactoeLogic{constructor(t){this.level=0,this.reset(),this.evaluateValue="win"===t?this.evaluateWinThreeInLine:this.evaluateLoseThreeInLine,this.evaluateTerminal=this.gameOver,this.players=[],this.players[0]={id:1},this.players[1]={id:2},this.players[1].ai=new TictactoeNegamax(this.evaluate.bind(this),this.evaluateTerminal.bind(this)),this.setSkill(0)}getSkill(){return this.players[1].ai.skill}setSkill(t){this.players[1].ai.skill=t}reset(){this.board=[[0,0,0],[0,0,0],[0,0,0]]}selectTile(t,e){this.selectTileX=t,this.selectTileY=e}setTile(t){this.board[this.selectTileY][this.selectTileX]=t.id+1}isValid(){return 0===this.board[this.selectTileY][this.selectTileX]}getBoard(){return this.board}hasPlayerInput(){return!this.players[this.currentPlayer].ai}getMove(){let t=this.players[this.currentPlayer].ai.getMoves(this.board,this.players,this.player,this.opponent);return(t=Phaser.Math.RND.shuffle(t)).sort(function(t,e){return t.value>e.value?-1:t.value<e.value?1:0}),t[0]}validMove(t,e){return 0===this.board[e][t]}gameOver(t=this.board,e=this.player,i=!0){return this.gameoverMoves=[],this.winner=this.evaluateValue(t,e,0,i),0!==this.winner?this.gameoverMoves:this.availableMoves()?null:[]}availableMoves(){let t=0;for(let e=0;e<3;e++)for(let i=0;i<3;i++)0===this.board[e][i]&&t++;return t}evaluate(t,e,i,s=!1){this.moveCount++;let n=this.evaluateValue(t,e,i,s);return 0===n?0:n===this.player?10-i:i-10}evaluateWinThreeInLine(t,e,i,s=!0){for(let e=0;e<3;e++)if(0!==t[e][0]&&t[e][0]===t[e][1]&&t[e][1]===t[e][2])return s&&(this.gameoverMoves.push({col:0,row:e}),this.gameoverMoves.push({col:1,row:e}),this.gameoverMoves.push({col:2,row:e})),t[e][0];for(let e=0;e<3;e++)if(0!==t[0][e]&&t[0][e]===t[1][e]&&t[1][e]===t[2][e])return s&&(this.gameoverMoves.push({col:e,row:0}),this.gameoverMoves.push({col:e,row:1}),this.gameoverMoves.push({col:e,row:2})),t[0][e];return 0!==t[0][0]&&t[0][0]===t[1][1]&&t[1][1]===t[2][2]?(s&&(this.gameoverMoves.push({col:0,row:0}),this.gameoverMoves.push({col:1,row:1}),this.gameoverMoves.push({col:2,row:2})),t[0][0]):0!==t[0][2]&&t[0][2]===t[1][1]&&t[1][1]===t[2][0]?(s&&(this.gameoverMoves.push({col:0,row:2}),this.gameoverMoves.push({col:1,row:1}),this.gameoverMoves.push({col:2,row:0})),t[0][2]):0}evaluateLoseThreeInLine(t,e,i,s=!1){let n=this.evaluateWinThreeInLine(t,e,s);return 1===n?2:2===n?1:n}drawThreeInLine(t,e,i,s){let n=this.evaluateWinThreeInLine(t,e,s);return 10===Math.abs(n)?-10:this.availableMoves()?0:10}winOrLoseThreeInLine(t,e,i,s){let n=this.evaluateWinThreeInLine(t,e,s);return 10===Math.abs(n)?10:this.availableMoves()?0:-10}win15InLine(t,e,i,s){for(let n=0;n<3;n++)if(t[n][0]+t[n][1]+t[n][2]===15){if(s&&(this.gameoverMoves.push({col:0,row:n}),this.gameoverMoves.push({col:1,row:n}),this.gameoverMoves.push({col:2,row:n})),t[n][0]===e)return this.winning;if(t[n][0]===i)return-this.winning}for(let n=0;n<3;n++)if(t[0][n]+t[1][n]+t[2][n]===15){if(s&&(this.gameoverMoves.push({col:n,row:0}),this.gameoverMoves.push({col:n,row:1}),this.gameoverMoves.push({col:n,row:2})),t[0][n]===e)return this.winning;if(t[0][n]===i)return-this.winning}if(t[0][0]+t[1][1]+t[2][2]===15){if(s&&(this.gameoverMoves.push({col:0,row:0}),this.gameoverMoves.push({col:1,row:1}),this.gameoverMoves.push({col:2,row:2})),t[0][0]===e)return this.winning;if(t[0][0]===i)return-this.winning}if(t[0][2]+t[1][1]+t[2][0]===15){if(s&&(this.gameoverMoves.push({col:0,row:2}),this.gameoverMoves.push({col:1,row:1}),this.gameoverMoves.push({col:2,row:0})),t[0][2]===e)return this.winning;if(t[0][2]===i)return-this.winning}return 0}get player(){return this.players[this.currentPlayer].id}get opponent(){return 1===this.player?2:1}nextPlayer(){this.currentPlayer=(this.currentPlayer+1)%this.players.length}test(){if(0===this.humanPlayer){this.latestPlayer=0;for(let t=6;t<=6;t++){let e={depth:t,games:0,p1:0,p2:0,skill:0};this.players[0].ai.skill=0,this.players[0].ai.skill=t-1,this.players[0].ai.skill<0&&(this.players[0].ai.skill=0),this.players[1].ai.skill=t,this.moveCount=0;let i=1;for(let t=0;t<100;t++){Phaser.Math.RND.init([i]),i++;let t=null;this.board=[[0,0,0],[0,0,0],[0,0,0]],this.boardMoves=[[0,0,0],[0,0,0],[0,0,0]];let s=1;for(this.currentPlayer=this.latestPlayer,this.latestPlayer=0===this.latestPlayer?1:0;null===t;){let e=this.getMove();this.board[e.row][e.col]=this.player,this.boardMoves[e.row][e.col]=s,s++,null===(t=this.gameOver())&&this.nextPlayer()}if(e.games++,0===t.length||(0===this.currentPlayer?e.p1++:e.p2++),e.p2>0||3===i){console.log(this.board),console.log(this.boardMoves),console.log(i);break}}e.skill=(e.p2-e.p1)/e.p2*100,e.moves=this.moveCount/e.games,console.log(e)}this.board=[[0,0,0],[0,0,0],[0,0,0]]}}}class TictactoeNegamax{constructor(t,e){this.evaluateValue=t,this.evaluateTerminal=e,this.depthMax=-1}negamax(t,e,i,s,n,a,h,r){if(i>this.depthMax)return 0;if(i===this.depthMax||this.evaluateTerminal(e,s,!1))return r*this.evaluateValue(e,s,i);let o=Number.NEGATIVE_INFINITY;for(let l=0;l<e.length;l++)for(let c=0;c<e[0].length;c++)if(0===e[l][c]&&(e[l][c]=s,o=Math.max(o,-this.negamax(t,e,i+1,n,s,-h,-a,-r)),a=Math.max(a,o),e[l][c]=0,a>=h))return a;return o}minimax(t,e,i,s,n,a,h,r){if(i===this.depthMax||null!==this.evaluateTerminal(e,s,!1)){return this.evaluateValue(e,s,i)}let o;o=1===r?Number.NEGATIVE_INFINITY:Number.POSITIVE_INFINITY;for(let l=0;l<e.length;l++)for(let c=0;c<e[0].length;c++)if(0===e[l][c]&&(e[l][c]=s,o=1===r?Math.max(o,this.minimax(t,e,i+1,n,s,-h,-a,-r)):Math.min(o,this.minimax(t,e,i+1,n,s,-h,-a,-r)),a=Math.max(a,o),e[l][c]=0,a>=h))return a;return o}getMoves(t,e,i,s){let n=[];this.players=e,this.depthMax=this.players[i-1].ai.skill;for(let e=0;e<3;e++)for(let a=0;a<3;a++)if(0===t[e][a]){let h={col:a,row:e,value:0};this.depthMax>0?(t[e][a]=i,h.value=-this.negamax(h,t,1,s,i,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,-1),t[e][a]=0):this.evaluateValue(t,i,0),n.push(h)}return n}}class TictactoeUnitBot extends Unit{constructor(t,e,i,s,n){super(t,e,i,"TictactoeTokens",0,s,n,t.teamBuildings[s.team.id]),this.setFrame(3),this.control={};let a=0;t.registry.get("minigame")?(a=parseInt(0|this.scene.game.restore("minigame-tictactoe")),this.maxLevel=a%2==0?a+2:a+1,this.maxLevel>6&&(this.maxLevel=6),this.maxLevel=a+1):this.maxLevel=6,this.scene.tictactoe.setSkill(a);let h="Score 0",r="LEVEL "+a+" / "+this.maxLevel;t.registry.get("minigame")&&(h="VIRUS to THREE-IN-ROW",r="Sequencing "+a+" / "+this.maxLevel),this.gameLabel=this.scene.cardScene.add.text(this.scene.cardScene.cameras.main.centerX,0,h,{fontStyle:"",fontSize:16*this.scene.game.resolution,color:"#99f",align:"center"}).setOrigin(.5,-1),this.skillLabel=this.scene.cardScene.add.text(this.scene.cardScene.cameras.main.centerX,this.gameLabel.height,r,{fontStyle:"bold",fontSize:16*this.scene.game.resolution,color:"#99f",align:"center"}).setOrigin(.5,-1.5),this.infoLabel=this.scene.cardScene.add.text(this.scene.cardScene.cameras.main.centerX,this.scene.cardScene.cameras.main.height,"YOUR TURN",{fontStyle:"bold",fontSize:16*this.scene.game.resolution,color:"#99f",align:"center"}).setOrigin(.5,3),this.startingPlayer=this.player.id,t.registry.get("minigame")?(this.target=this.scene.add.image(this.x,this.y,"TictactoeTokens",3),this.targetImage=this.target,this.setFrame(4)):this.target=this,this.target.setTint(65280),this.currentTile=this.scene.board.getTileAt(1,1),this.scene.tictactoe.selectTile(1,1),this.scene.tictactoe.currentPlayer=this.startingPlayer+1,this.x=this.currentTile.getCenterX(),this.y=this.currentTile.getCenterY(),this.score=0,this.moveTime=0,this.modal=!0,this.setDepth(10),this.moving=!1,this.winBg=null}controlPoint(t){if(!this.isGameOver()&&!this.moving&&t){const e=this.scene.board;let i=e.worldToTileXY(t[0],t[1]),s=e.getTileAt(i.x,i.y);if(s){let t=null;this.scene.tictactoe.validMove(s.x,s.y)&&(t=this.player),this.updateBoard(s,t)}}}isGameOver(){if(null!==this.winBg){if(this.scene.registry.get("minimind")){this.scene.level.id,this.scene;let t=this;this.scene.time.delayedCall(500,function(){t.destroy(),EventDispatcher.getInstance().emit("GameStatus",{minigame:!0,win:!0})},this)}return!0}return!1}controlDo(t,e,i,s,n){if(this.moving)return;if(this.moveTime>this.scene.time.now)return;if(n&&this.isGameOver())return;const a=this.scene.board;let h=a.worldToTileXY(this.x,this.y),r=a.getTileAt(h.x,h.y),o=r;s&&r.x<a.layer.width-1&&(r=a.getTileAt(h.x+1,h.y),this.moveTime=this.scene.time.now+300),i&&r.x>0&&(r=a.getTileAt(h.x-1,h.y),this.moveTime=this.scene.time.now+300),t&&r.y>0&&(r=a.getTileAt(h.x,h.y-1),this.moveTime=this.scene.time.now+300),e&&r.y<a.layer.height-1&&(r=a.getTileAt(h.x,h.y+1),this.moveTime=this.scene.time.now+300),o!==r&&this.updateBoard(r)}updateBoard(t,e){let i=this.scene.board.tileToWorldXY(t.x,t.y),s=i.x+t.width/2,n=i.y+t.height/2;this.moving=!0;let a=0;this.scene.registry.get("minigame")&&(a=Phaser.Math.Angle.Between(this.x,this.y,s,n)+Math.PI/2),t===this.currentTile?a=this.rotation:this.currentTile=t,this.scene.tweens.add({targets:this,duration:100,rotation:a,callbackScope:this,onComplete:function(t){this.scene.tweens.add({targets:this,duration:200,x:s,y:n,callbackScope:this,onComplete:function(t){this.moving=!1;let i=this.scene.tictactoe;i.selectTile(this.currentTile.x,this.currentTile.y),i.isValid()?this.target.setTint(65280):this.target.setTint(16776960),e&&this.placeTile(e)}},this)}},this)}placeTile(t){let e=this.scene.tictactoe;e.setTile(t),new TictactoeUnitToken(this.scene,this.x,this.y,t,{tile:this.currentTile});let i=e.gameOver();if(i)i.length>0?e.winner===this.player.id+1?this.gameover("win",i):this.gameover("lose",i):this.gameover("draw");else{let e=this.scene.cardScene;t===this.player?(this.nextMove(e),e.enableInput(!1),this.infoLabel.text="WAIT...",this.target.setTint(16711680)):(e.enableInput(!0),this.infoLabel.text="YOUR TURN")}}initUnit(){}startUnit(){this.controlStart()}destroyed(){this.scene.cardScene.disableUnitScene(!0),this.gameLabel.destroy(),this.skillLabel.destroy(),this.infoLabel.destroy(),this.actionIcon&&this.actionIcon.destroy(),this.actionLabel&&this.actionLabel.destroy(),this.winBg&&this.winBg.destroy(),this.targetImage&&this.targetImage.destroy();let t="UnitScene-"+this.scene.level.id;this.scene.scene.remove(t)}unitProcess(t){return 1/0}updateDamage(){this.scene.cardScene.statusBody.update(-this.live.damage)}shootUnit(t){this.shoot.target.unit.d2amage<this.shoot.target.live.health?this.shoot.target.unitDamage(this.shoot.d2amage):(this.shoot.target.destroy(),this.laser.visible=!1)}collideGround(){}preUpdate(){this.target!==this&&this.target.setPosition(this.x,this.y)}menuSelect(t,e){this.isGameOver()||this.getBounds().contains(t,e)&&this.uiAction(this.scene.cardScene)}showScore(){this.visible&&(this.target.visible=!1,this.visible=!1,this.skillLabel.text="Sequencing complete!",this.winBg=this.scene.add.image(this.scene.cardScene.cameras.main.centerX,this.scene.cardScene.cameras.main.centerY,"MinigameTechnology"),this.actionIcon=this.scene.add.image(this.winBg.x-this.winBg.width/4,this.winBg.y+this.winBg.height/4,"ActionBuild"),this.actionLabel=this.scene.cardScene.add.text(this.actionIcon.x+this.actionIcon.width,this.actionIcon.y,"Antibiotic\nLaser+",{fontStyle:"bold",fontSize:16*this.scene.game.resolution,color:"#000",align:"left"}).setOrigin(0,.5),this.infoLabel.text="HIT ANY TO CONTINUE")}restartGame(t){this.visible=!0;let e=this.scene.tictactoe;if(this.scene.registry.get("minigame")&&"win"===t&&e.getSkill()===this.maxLevel)return this.showScore(),void this.scene.cardScene.enableInput(!0);e.reset();for(let t=0;t<=1;t++){let e=this.scene.teamTroops[t];for(let t=e.getChildren().length-1;t>=0;t--){e.getChildren()[t].destroy(!0,!0)}}const i=this.scene.board;this.updateBoard(i.getTileAt(1,1)),this.startingPlayer=0===this.startingPlayer?1:0,this.startingPlayer===this.player.id?(this.infoLabel.text="YOUR TURN",this.scene.cardScene.enableInput(!0)):this.nextMove(this.scene.cardScene)}nextMove(t){let e=this.scene.tictactoe,i=this.scene.levelFactory.level.data.players[1],s=e.getMove();e.selectTile(s.col,s.row);const n=this.scene.board;this.updateBoard(n.getTileAt(s.col,s.row),i)}setToken(){}explode(t,e){let i=this.scene.add.image(t,e,"EffectExplode-0").setScale(0);this.scene.tweens.add({targets:i,duration:500,scale:1,alpha:0,callbackScope:this,onComplete:function(t){i.destroy()}}),i=this.scene.add.image(t,e,"EffectExplode-1").setScale(0),this.scene.tweens.add({targets:i,duration:200,scale:1,alpha:0,callbackScope:this,onComplete:function(t){i.destroy()}})}uiAction(t){this.isGameOver()||this.moving||this.scene.tictactoe.isValid()&&(this.target.setTint(16776960),this.placeTile(this.player))}gameover(t,e=null){if(this.alpha=0,this.scene.tweens.add({targets:this,duration:1200,rotation:8*Math.PI,alpha:1},this),e){let i=[];for(let t=0;t<=1;t++){let s=this.scene.teamTroops[t];for(let t=s.getChildren().length-1;t>=0;t--){let n=s.getChildren()[t];for(let t=0;t<e.length;t++){let s=e[t];n.tile.x===s.col&&n.tile.y===s.row&&i.push(n)}}}if("win"!==t&&this.scene.registry.get("minigame")){this.alpha=0;for(let t=i.length-1;t>=0;t--){let e=i[t];this.explode(e.x,e.y),e.destroy()}}else this.scene.tweens.add({targets:i,duration:375,repeat:2,scaleX:-1},this)}let i=this.scene.tictactoe;"win"===t?(this.infoLabel.text="YOU WIN",this.score+=i.getSkill()):"lose"===t?(this.score=0,this.infoLabel.text="YOU LOSE"):(this.infoLabel.text="DRAW",this.score+=i.getSkill()),this.scene.registry.get("minigame")||(this.scene.registry.get("minigame")?this.gameLabel.text="Sequencing "+this.score:this.gameLabel.text="Score "+this.score),this.scene.time.delayedCall(1600,function(){let e=i.getSkill();if("win"===t&&e<6&&e++,"lose"===t&&e>0&&e--,this.scene.registry.get("minigame")){e>(0|this.scene.game.restore("minigame-tictactoe"))&&this.scene.game.save("minigame-tictactoe",e)}i.setSkill(e),this.scene.registry.get("minigame")?this.skillLabel.text="Sequencing "+i.getSkill()+" / "+this.maxLevel:this.skillLabel.text="LEVEL "+i.getSkill()+" / "+this.maxLevel,this.restartGame(t)},[],this)}update(t){}activateAction(t,e){this.currentAction=t,t.start.call(this,e)}travelEffect(){}static preload(t,e,i){let s="";t.registry.get("minigame")&&(s="-minimind",e.push("EffectExplode-0"),e.push("EffectExplode-1"),e.push("MinigameTechnology"),e.push("ActionBuild")),i.push({name:"TictactoeTokens",size:64,sub:s})}}TictactoeUnitBot.name="TictactoeUnitBot";class TictactoeUnitScene extends Phaser.Scene{constructor(t,e){super({key:t}),this.debug=!0,this.cardScene=e,this.teamBuildings=[],this.teamTroops=[],this.teamBullets=[],this.eventQueue=new PriorityQueue,this.unitListeners=[]}init(){this.events.on(Phaser.Scenes.Events.DESTROY,()=>{})}preload(){let t=[],e=[];TictactoeUnitBot.preload(this,t,e);let i=this.scene.get("LoaderScene");i.loadImages(this,t),i.loadSpritesheets(this,e)}create(t){this.level=t,this.scene.sendToBack(),this.tictactoe=new TictactoeLogic(this.registry.get("minigame")?"lose":"win");let e=this.textures.get("TictactoeTokens").getSourceImage(),i=this.make.tilemap({data:this.tictactoe.getBoard(),tileWidth:e.height,tileHeight:e.height});var s=i.addTilesetImage("TictactoeTokens");this.board=i.createLayer(0,s,0,0),this.board.x=this.cameras.main.centerX-this.board.width/2,this.board.y=this.cameras.main.centerY-this.board.height/2,this.mapUnitGroup=this.physics.add.staticGroup(),this.cameras.main.setBackgroundColor("#0b032d"),t.sceneCreated&&t.sceneCreated(this)}getBounds(t=null){let e,i,s,n,a=64*this.game.resolution;return t||(e=0*a,i=0*a,s=this.level.grid.w*a,n=this.level.grid.h*a),{x:e,y:i,w:s,h:n}}createBackground(){let t=64*this.game.resolution;var e=[];let i=this.textures.get("BgTileCell").getSourceImage().width/this.textures.get("BgTileCell").getSourceImage().height,s=this.level.grid.w,n=this.level.grid.h;for(let t=0;t<n;t++){e[t]=[];for(let n=0;n<s;n++){let s=Phaser.Math.Between(0,i-2);e[t][n]=s}}let a=this.make.tilemap({data:e,tileWidth:t,tileHeight:t});var h=a.addTilesetImage("BgTileCell","BgTileCell",t,t);let r=a.createLayer(0,h);this.groundLayer=r,r.depth=-1,r.setCollisionBetween(3,i-1)}isFreeSpace(t,e,i,s){let n=t.getChildren();for(let t=n.length-1;t>=0;t--){let a=n[t];if(Phaser.Math.Distance.Squared(e,i,a.x,a.y)<s)return!1}return!0}countEnergy(){let t=this.fields.getChildren(),e=0;for(let i=t.length-1;i>=0;i--)t[i]instanceof UnitEnergy&&e++;return e}createEnergy2(t,e){new UnitEnergy(this,t,e,this.cardScene.player,this.level)}addIdle(t){this.idleUnits.add(t,!0)}zoomTo(t,e,i){}addTeamGroups(t){if(this.teamTroops[t])return;let e=this.physics.add.group();e.runChildUpdate=!1;let i=this.physics.add.group();i.runChildUpdate=!1;let s=this.physics.add.group();s.runChildUpdate=!1,this.teamBuildings[t]=e,this.teamTroops[t]=i,this.teamBullets[t]=s}addUnitProcess(t){if(-1===this.unitListeners.indexOf(t)){for(let e=this.unitListeners.length-1;e>=0;e--){this.unitListeners[e].unitEvent(t,"start")}this.unitListeners.push(t)}}removeUnitProcess(t){const e=this.unitListeners;let i=e.indexOf(t);if(-1!==i){e.splice(i,1);for(let e=this.unitListeners.length-1;e>=0;e--){this.unitListeners[e].unitEvent(t,"stop")}}}executeUnitProcess(t){const e=this.unitListeners;for(let i=e.length-1;i>=0;i--){let s=e[i];t>s.unit.time&&(s.unit.time=s.unitProcess(t))}}overlapUnit(t,e){this.physics.world.isPaused||t.overlap(e)}scaleResolution(t){return t*this.game.resolution}explode(t){let e=this.add.particles("EffectExplode");e.createEmitter({frame:[2],x:t.x,y:t.y,speed:{start:this.scaleResolution(112.5),end:this.scaleResolution(-112.5)},quantity:5,ease:"Power2",lifespan:1500,maxParticles:50,blendMode:"SCREEN",alpha:{start:1,end:0}}),e.createEmitter({frame:[0],x:t.x,y:t.y,speed:{start:this.scaleResolution(75),end:this.scaleResolution(-75)},quantity:5,ease:"Power2",lifespan:1e3,maxParticles:100,blendMode:"SCREEN",alpha:{start:1,end:0}}),e.createEmitter({frame:[0],x:t.x,y:t.y,speed:{start:this.scaleResolution(56.25),end:this.scaleResolution(-56.25)},quantity:5,ease:"Power2",lifespan:1e3,maxParticles:50,blendMode:"SCREEN",alpha:{start:1,end:0}});e.createGravityWell({x:t.x,y:t.y,power:2,epsilon:100,gravity:t.scene.scaleResolution(8)});this.time.delayedCall(2e3,function(){e.destroy()},this)}showGameOver(t,e,i,s,n,a,h){this.input.enabled=!1;let r=this.add.group();this.cardScene.input.once("pointerdown",function(){r.destroy(!0),r=null,this.input.enabled=!0},this);let o=this.add.graphics();if(r.add(o),o.fillStyle(0,.5),o.fillRect(0,0,this.cameras.main.width,this.cameras.main.height),this.level.tutorial.img)return void this.add.image(this.cameras.main.centerX,this.cameras.main.centerY/3,"tutorial-drag-to-select");let l=-1===e?this.cameras.main.centerX:e*a,c=-1===i?this.cameras.main.centerY:i*h,d=r.create(l,c,"sprites","alice.png");if(d.setDepth(10),d.alpha=0,n){let t=r.create(n[0]*a,n[1]*h,"sprites","hand.png");t.x<this.cameras.main.width/2&&(t.scaleX=-1),this.tweens.add({targets:t,duration:400,x:t.x+20,delay:s,repeat:n.length>2?2:4,yoyo:!0,callbackScope:this,onComplete:function(){r&&(n.length>2?(t.scaleX=1,t.x=n[2]*a,t.y=n[3]*h,this.tweens.add({targets:t,duration:400,x:t.x+20,delay:s,repeat:1,yoyo:!0,callbackScope:this,onComplete:function(){}},this)):t.destroy())}},this)}this.tweens.add({targets:d,duration:400,alpha:1,delay:s/4,repeat:1,callbackScope:this,onComplete:function(){if(!r)return;let e=r.create(d.x,d.y+d.height/2,"sprites","dialog.png");e.setDepth(10);let i=e.width/12,s=this.add.text(e.x,e.y-e.width/26/2,t,{fontFamily:"Source Code Pro",fontSize:i,color:"#000",align:"center"}).setOrigin(.5);s.setDepth(10),r.add(s)}},this)}destroyed(){for(let t=0;t<this.teamTroops.length;t++){let e=this.teamBuildings[t];e.runChildUpdate=!1;for(let t=e.getChildren().length-1;t>=0;t--){e.getChildren()[t].destroy(!0,!0)}(e=this.teamTroops[t]).runChildUpdate=!1;for(let t=e.getChildren().length-1;t>=0;t--){e.getChildren()[t].destroy(!0,!0)}(e=this.teamBullets[t]).runChildUpdate=!1;for(let t=e.getChildren().length-1;t>=0;t--){e.getChildren()[t].destroy(!0,!0)}}this.mapUnitGroup.runChildUpdate=!1;for(let t=this.mapUnitGroup.getChildren().length-1;t>=0;t--){this.mapUnitGroup.getChildren()[t].destroy(!0,!0)}this.eventQueue.destroy()}gameOver(){this.eventQueue.destroy(),this.time.removeAllEvents(),this.physics.world.colliders.destroy(),this.physics.pause(),this.tweens.killAll()}getHqUnits(t){return this.mapUnitGroup.getChildren().concat(this.teamBuildings[t.id].getChildren())}getUnits(t,e,i,s){return[]}getEnemyTroops(t){let e=[];for(let i=0;i<this.teamTroops.length;i++)t.team.id!==i&&e.push(this.teamTroops[i].getChildren());return e}getEnemyUnits(t,e,i,s){let n=[];for(let a=0;a<this.teamTroops.length;a++){if(s.id===a)continue;let h=this.teamTroops[a].getChildren();for(let s=h.length-1;s>=0;s--){let a=h[s];i?Phaser.Math.Distance.Squared(t,e,a.x,a.y)<i&&n.push(a):a.getBounds().contains(t,e)&&n.push(a)}}return n}addEvent(t,e,i){this.eventQueue.enqueue([t,this.time.now+e,i])}clearEvents(t){this.eventQueue.clear(t)}update(t,e){this.executeUnitProcess(t);let i=this.eventQueue.dequeueExpired(t);for(;null!==i;)i[0].call(i[2]),i=this.eventQueue.dequeueExpired(t)}}class TictactoeUnitToken extends Unit{constructor(t,e,i,s,n){super(t,e,i,"TictactoeTokens",n.frame,s,n,t.teamTroops[s.team.id]),this.tile=n.tile}initUnit(){this.setFrame(this.player.id+1)}startUnit(){}unitProcess(t){let e=1/0;const i=this.move;t>i.time&&(i.time=t+this.moveDo(),i.time<e&&(e=i.time));const s=this.watch;if(t>s.time){let i=s.unit;s.time=t+this.watchDo(t),s.time<e&&(e=s.time),i!==s.unit&&(null!==i&&(this.moveStop(),this.moveStart()),null!==s.unit&&this.moveStart(s.unit))}return e}static preload(t,e){}}TictactoeUnitToken.name="TictactoeUnitToken",Unit.Action={Connect:UnitActionConnect,Build:UnitActionBuild,Travel:UnitActionTravel,Minigame:UnitActionMinigame,Tech:UnitActionTech};class UIAction extends Phaser.GameObjects.Container{constructor(t,e,i=null,s=null,n="center",a="gray",h=0,r=!1,o=!1){let l=t.scene.cardScene;super(l),l.add.existing(this),this.menuUnit=t,this.actionUnit=i,this.action=s,this.bgColor=a,this.cost=h;let c=l.cameras.main.centerX,d=l.cameras.main.centerY,u=new Phaser.GameObjects.Image(l,c,d,"ActionBg");this.add(u);let g=new Phaser.GameObjects.Image(l,c,d,"ActionIconBg");this.add(g);let m=new Phaser.GameObjects.Image(l,c,d,e);this.icon=m,this.add(m),this.index=0;"up"===n?(this.index=10,this.y-=1.05*u.height,r&&(this.x+=r*u.width*1.05)):"down"===n?(this.index=30,this.y+=1.05*u.height,r&&(this.x+=r*u.width*1.05)):"left"===n?(this.index=40,this.x-=1.05*u.width,r&&(this.y+=r*u.height*1.05)):"right"===n&&(this.index=20,this.x+=1.05*u.width,r&&(this.y+=r*u.height*1.05)),r&&(this.index+=r),"ActionTech"===e||"ActionTool"===e?this.setState("enabled"):o?this.setState("disabled"):"ActionCancel"===e?this.setState("active"):"ActionSpawn"===e&&this.scene.statusEnergy.val()>=this.cost?this.setState("enabled"):t.unitState>Unit.StateBuild&&this.scene.statusBot.val()>=this.cost?this.setState("enabled"):this.setState("disabled"),this.name=e,this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}setState(t){const e={gray:{active:10079385,enabled:6723942,disabled:13421772},blue:{active:10079385,enabled:6723942,disabled:13421772},green:{active:11202218,enabled:6723942,disabled:13421772},lila:{active:10079385,enabled:6723942,disabled:13421772},yellow:{active:13421721,enabled:10066278,disabled:13421772}};this.first.setTint(e[this.bgColor][t]),"active"===t?this.next.clearTint():this.next.setTint(e[this.bgColor][t]),this.state=t}showStatus(){if("disabled"===this.state){let t;t="ActionSpawn"===this.name?this.scene.statusEnergy.valueImage:this.scene.statusBot.valueImage,this.scene.tweens.addCounter({from:0,to:204,duration:150,onComplete:()=>{this.first.setState(),t.setTint(t.color)},onUpdate:e=>{const i=Math.floor(e.getValue());this.first.setTint(Phaser.Display.Color.GetColor(i,i,i)),t.setTint(Phaser.Display.Color.GetColor(i,i,i))}})}}destroyed(){}}class UIBrain extends Phaser.GameObjects.Graphics{constructor(t){super(t),t.add.existing(this);let e=4*this.scene.game.resolution;this.brain=t.add.image(t.cameras.main.width-e,e,"StatusBigBrain"),this.brain.setDepth(-1),this.brain.setOrigin(1,0),this.bot=t.add.image(0,0,"BrainBot"),this.teleports=[],this.reset(this.scene.level.grid),this.lastUpdate=0}reset(t){let e=this.brain.getTopLeft();this.x0=e.x-1*this.scene.game.resolution+t.x*this.scene.game.resolution,this.y0=e.y-8*this.scene.game.resolution+t.y*this.scene.game.resolution,this.w0=t.w*this.scene.game.resolution,this.h0=t.h*this.scene.game.resolution,this.dd=0}addTeleport(t){let e=this.scene.add.image(this.x0,this.y0,"BrainTeleport");e.connection=t.teleport,e.x+=t.x/t.scene.groundLayer.width*this.w0,e.y+=t.y/t.scene.groundLayer.height*this.h0;for(let t=0;t<this.teleports.length;t++){let i=this.teleports[t];e.connection.from===i.connection.to&&e.connection.to===i.connection.from&&(this.lineStyle(2*this.scene.game.resolution,16776960,.5),this.lineBetween(e.x,e.y,i.x,i.y))}this.teleports.push(e)}update(t){if(this.scene.time.now<this.updateTime)return;this.updateTime=this.scene.time.now+340,0===this.dd&&(this.dd=this.w0/t.scene.groundLayer.width);let e=t.x*this.dd,i=t.y*this.dd;this.bot.x=this.x0+e,this.bot.y=this.y0+i,this.bot.rotation=t.rotation+Math.PI/2}}class UIControl{constructor(t){this.scene=t;let e=t.add.image(0,t.cameras.main.height,"ControlPadBg").setOrigin(.5,.5);e.x=.3*e.width,e.y-=.3*e.height,e.tint=8421504,this.padMoveBg=e,e.alpha=.5,this.padMove=t.add.image(e.x,e.y,"ControlPadButton"),this.padMove.tint=10079385,this.padMove.step=this.padMove.width/4;let i=t.add.image(t.cameras.main.width-e.x,e.y,"ControlPadBg").setOrigin(.5,.5);i.tint=8421504,i.alpha=.5,this.padButtonBg=i,this.padButton=t.add.image(i.x,i.y,"ControlPadButton"),this.padButton.tint=16751001,this.reset()}resetMove(){this.up=!1,this.down=!1,this.left=!1,this.right=!1,this.move=!1}resetButton(){this.button=!1}reset(){this.resetMove(),this.resetButton(),this.actionKeyDown=!1}setUnit(t){this.unit=t,t&&(this.unit.control.pad=this)}isPointerOver(t){return this.padMoveBg.getBounds().contains(t.x,t.y)?this.padMoveBg:this.padButtonBg.getBounds().contains(t.x,t.y)?this.padButtonBg:null}onPointermove(t,e,i){if(!this.unit)return;let s=null;if(this.padButtonBg.pointerId===t.id){s=this.padButtonBg,this.isPointerOver(t)||(s.x+=(t.x-s.x)/8,s.y+=(t.y-s.y)/8,this.padButton.x=this.padButtonBg.x,this.padButton.y=this.padButtonBg.y)}else if(this.padMoveBg.pointerId===t.id){s=this.padMoveBg,this.isPointerOver(t)?this.updatePadmove(t):(s.x+=(t.x-s.x)/8,s.y+=(t.y-s.y)/8,this.padMove.x=this.padMoveBg.x,this.padMove.y=this.padMoveBg.y)}else this.isPointerOver(t)||(this.padMove.tint=10551200,this.unit.controlPoint([t.x+e,t.y+i]))}onPointerdown(t){if(!this.unit)return;this.update(!1,!1,!1,!1),this.unit.controlPoint(null);let e=this.isPointerOver(t);return e===this.padMoveBg?(this.move=!0,e.pointerId=t.id):e===this.padButtonBg&&(e.pointerId=t.id,this.button=!0),this.move|this.button}updatePadmove(t){let e=!1,i=!1;t.y<this.padMoveBg.y-this.padMove.step?e=!0:t.y>this.padMoveBg.y+this.padMove.step&&(i=!0);let s=!1,n=!1;t.x<this.padMoveBg.x-this.padMove.step?s=!0:t.x>this.padMoveBg.x+this.padMove.step&&(n=!0),this.update(e,i,s,n)}onPointerup(t,e,i){if(!this.unit)return;this.update(!1,!1,!1,!1);this.move,this.button;this.padMoveBg.pointerId===t.id&&(this.up=!1,this.down=!1,this.left=!1,this.right=!1,this.move=!1,this.padMoveBg.pointerId=-1),this.padButtonBg.pointerId===t.id&&(this.button=!1,this.padButtonBg.pointerId=-1);let s=this.isPointerOver(t);if(s)s===this.padButtonBg&&this.select();else if(this.unit.controlPoint([t.x+e,t.y+i])&&this.unit.control.target){this.unit.control.target.unit=null,this.unit.control.target.focus=null;let s=this.unit.width,n=this.unit.scene.getUnits(t.x+e,t.y+i,s*s,this.unit.player);if(n)for(let t=0;t<n.length;t++){let e=n[t];if(e.action){this.unit.control.target.focus=e;break}}this.unit.control.target.focus?(this.unit.control.target.focusImage.setPosition(this.unit.control.target.focus.x,this.unit.control.target.focus.y),this.unit.control.target.focusImage.visible=!0):this.unit.control.target.focusImage.visible=!1}else this.unit.menuSelect(t.x,t.y),this.scene.moveTime=this.scene.time.now+150}padActive2(t){t||this.move?this.padMove.tint=10551200:this.padMove.tint=10079385}update(t,e,i,s){if(t!==this.up||e!==this.down||i!==this.left||s!==this.right){this.up=t,this.down=e,this.left=i,this.right=s,this.unit.controlPoint(null),this.padMove.y=this.padMoveBg.y,this.up?this.padMove.y-=this.padMove.step:this.down&&(this.padMove.y+=this.padMove.step),this.padMove.x=this.padMoveBg.x,this.left?this.padMove.x-=this.padMove.step:this.right&&(this.padMove.x+=this.padMove.step),this.unit.controlDo(t,e,i,s,!0);let n=t||e||i||s;this.padMove.tint=n?10551200:10079385}}refresh(){this.unit.controlDo(this.up,this.down,this.left,this.right,!1)}select(){this.scene.select()}static preload(t,e,i){Array.prototype.push.apply(e,["ControlPadBg","ControlPadButton"])}}Card.Type={Turret:CardTurret,Gravity:CardGravity};class UIScene extends Phaser.Scene{constructor(t){super({key:t}),this.selectTime=0,this.moveTime=0,this.updateControlTargetTime=0,this.isGameOver=!1,this.actionKeyDown=!1,this.player=null}init(){if(this.levelNo=parseInt(this.game.restore("levelNo")||1),this.level=this.registry.get("level"),this.events.on(Phaser.Scenes.Events.SHUTDOWN,()=>{}),this.events.on(Phaser.Scenes.Events.DESTROY,()=>{}),this.game.config.width>this.game.config.height){this.landscape=!0;let t=640,e=360,i=4;this.layout={margin:i*this.game.resolution,grid:56*this.game.resolution},this.layout.home={x:0,y:0,w:this.layout.grid+2*this.layout.margin,h:e*this.game.resolution,grid:224},this.layout.enemy={w:this.layout.grid+2*this.layout.margin,h:e*this.game.resolution},this.layout.game={x:(this.layout.home.x+this.layout.home.w)*this.game.resolution,y:0,w:t*this.game.resolution-this.layout.home.w-this.layout.enemy.w,h:e*this.game.resolution},this.layout.enemy={x:(this.layout.game.x+this.layout.game.w)*this.game.resolution,y:0}}else this.landscape=!1}preload(){let t,e,i=this.scene.get("LoaderScene");this.registry.get("minimind")?(t=["UIInfoBg"],e=[{name:"StatusIcon",size:32},{name:"StatusValue",size:32}]):(t=[],e=[]),CardEnergy.preload(t,e),CardDeck.preload(t,e,this.game.restore("cards-0")),LevelFactory.preload(this.level,t,e),i.loadImages(this,t),i.loadSpritesheets(this,e)}create(t){this.debugInfo=this.add.text(this.cameras.main.centerX,40*this.game.resolution,"",{font:12*this.game.resolution+"px Arial",fill:"#ffffff"}).setOrigin(.5),this.debugInfo.y-=this.debugInfo.height,this.input.setTopOnly(!0),this.input.addPointer(1),this.input.dragDistanceThreshold=16,this.input.dragTimeThreshold=500,this.upPrev=!1,this.downPrev=!1,this.leftPrev=!1,this.rightPrev=!1,EventDispatcher.getInstance().on("GameStatus",this.gameStatus.bind(this));var e=this.input.keyboard.addKeys("W,S,A,D,CTRL,SPACE");this.keys=e;let i=this.input.keyboard.createCursorKeys();this.cursors=i,this.gamepad=null,this.input.gamepad.once("connected",function(t){this.gamepad=t,this.gamepad.on(Phaser.Input.Gamepad.Events.BUTTON_DOWN,function(t){!this.gamepad.left&&this.gamepad.right},this)},this),this.input.mouse&&this.input.mouse.disableContextMenu(),this.game.input.touch.capture=!1,this.input.on("pointerup",this.onPointerup,this),this.input.on("pointerdown",this.onPointerdown,this),this.input.on("pointermove",this.onPointermove,this),t.sceneCreated&&t.sceneCreated(this),this.enemyStatus=[],this.enableInput(!1)}addEnemyStatus(t,e){let i=4*this.game.resolution,s=i,n=i;return s+=this.unitScene.getBounds().w,new UIStatus(this,s,n,"Status",t,10070528,1,0,1,e)}onPointermove(t){if(!this.input.enabled)return;if(!t.isDown)return;let e=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollX:0,i=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollY:0;this.controlPad.onPointermove(t,e,i)}onPointerdown(t){this.input.enabled&&(this.time.now<this.moveTime||this.controlPad.onPointerdown(t))}onPointerup(t){if(!this.input.enabled)return;this.moveTime=this.time.now+10;let e=t.upTime-t.downTime,i=t.upX-t.downX,s=t.upY-t.downY;if(e<200){let t=64*this.game.resolution,e=Math.abs(i),n=Math.abs(s);if(e>t||n>t){let a=!1,h=!1,r=!1,o=!1;e>t&&(i>0?a=!0:h=!0),n>t&&(s>0?o=!0:r=!0)}}let n=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollX:0,a=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollY:0;this.controlPad.onPointerup(t,n,a)}update(t,e){if(this.input.enabled&&(this.player.update(t,e),this.input.enabled)){this.debugInfo.text="FPS "+parseInt(this.game.loop.actualFps)+"\n"+this.cameras.main.width+"x"+this.cameras.main.height;let t=!1,e=!1,i=!1,s=!1;if(this.keys){let n=this.keys;n.W.isDown&&(t=!0),n.S.isDown&&(e=!0),n.A.isDown&&(i=!0),n.D.isDown&&(s=!0),this.actionKeyDown?n.CTRL.isUp&&n.SPACE.isUp&&(this.actionKeyDown=!1):(n.CTRL.isDown||n.SPACE.isDown)&&(this.actionKeyDown=!0)}if(this.cursors){let n=this.cursors;n.up.isDown&&(t=!0),n.down.isDown&&(e=!0),n.left.isDown&&(i=!0),n.right.isDown&&(s=!0)}this.gamepad&&((this.gamepad.up||this.gamepad.leftStick.y<=-.5||this.gamepad.rightStick.y<=-.5)&&(t=!0),(this.gamepad.down||this.gamepad.leftStick.y>=.5||this.gamepad.rightStick.y>=.5)&&(e=!0),(this.gamepad.left||this.gamepad.leftStick.x<=-.5||this.gamepad.rightStick.x<=-.5)&&(i=!0),(this.gamepad.right||this.gamepad.leftStick.x>=.5||this.gamepad.rightStick.x>=.5)&&(s=!0)),this.upPrev===t&&this.downPrev===e&&this.leftPrev===i&&this.rightPrev===s||(this.upPrev=t,this.downPrev=e,this.leftPrev=i,this.rightPrev=s)}}setUnitSceneLevel(t,e){this.up=this.upPrev=!1,this.down=this.downPrev=!1,this.left=this.leftPrev=!1,this.right=this.rightPrev=!1,this.input.keyboard.resetKeys(),this.level=e,this.unitScene&&this.unitScene.scene.sleep(),this.unitScene=t}setPlayer(t){if(!this.isGameOver)if(this.player=t,this.controlPad=this.player,this.player.createCards(),this.bot){if(this.level.teleport&&!this.level.minigame&&!this.modalScene){let t=this.unitScene.getHqUnits(this.player);for(let e=t.length-1;e>=0;e--){let i=t[e];if(i instanceof UnitTeleport&&this.level.teleport.from===i.teleport.to){this.bot.setPosition(i.x,i.y);break}}}this.bot.setActive(!0),this.modalScene?this.modalScene--:this.bot.travelEffect(!0,this.bot),this.unitScene.children.bringToTop(this.bot),this.unitScene.children.bringToTop(this.bot),this.bot?(this.brain&&this.brain.reset(this.level.grid),this.enableInput(!0)):this.enableInput(!1)}else this.enableInput(!0)}enableInput(t){this.input.keyboard.resetKeys(),this.input.keyboard.enabled=t,this.input.enabled=t}disableUnitScene(t){this.enableInput(!1),this.bot=null,t&&(this.unitScene=null)}select(){this.input.enabled&&(this.time.now<this.selectTime||(this.selectTime=this.time.now+150,this.tweens.addCounter({from:204,to:153,duration:125,callbackScope:this,onUpdate:function(t){const e=Math.floor(t.getValue());this.controlPad.padButton.setTint(Phaser.Display.Color.GetColor(255,e,e))}},this),this.bot&&this.bot.uiAction(this)))}gameStatus(t){if(t.start){this.scene.get("UnitScene");this.time.delayedCall(500,function(){},[],this)}t.gameover,t.teleport&&this.enableInput(!1),t.teleportComplete&&this.time.delayedCall(200,function(){this.enableInput(!0)},[],this)}closeUI(){}destroyed(){let t=this.children.getChildren();for(let e=t.length-1;e>=0;e--)t[e].destroy(!0,!0)}gameOver(t){this.isGameOver=!0,this.enableInput(!1),this.tweens.killAll()}}class UIStatus extends Phaser.GameObjects.Container{constructor(t,e,i,s,n,a,h=0,r=0,o=1,l=null){super(t),this.value=h,this.min=r,this.max=o,this.info=l,this.valueImage=t.add.image(e,i,s+"Value"),this.valueImage.x+=this.valueImage.width/2,this.valueImage.y+=this.valueImage.height/2,this.valueImage.setTint(a),this.valueImage.setDepth(-1),this.color=a,this.image=t.add.image(this.valueImage.x,this.valueImage.y,s+"Icon",n),this.image.setDepth(-1),this.update(0)}set(t=0,e=0,i=1){this.value=t,this.min=e,this.max=i,this.update(0)}val(){return this.value}showStatus(){let t=this.valueImage,e=this;this.scene.tweens.addCounter({from:0,to:204,duration:250,onComplete:()=>{t.setTint(e.color)},onUpdate:e=>{const i=Math.floor(e.getValue());t.setTint(Phaser.Display.Color.GetColor(i,i,i))}})}update(t){if(0!==t){if(t>0&&this.value>=this.max)return this.showStatus(),!1;if(t<0&&this.value<=this.min)return this.showStatus(),!1;this.value+=t,this.value<this.min&&(this.value=this.min),this.value>this.max&&(this.value=this.max)}return this.valueImage.setFrame(parseInt(this.value/(this.max-this.min)*8)),!0}reset(){return this.value}}class UnitEffect{constructor(t){this.scene=t}static preload(t,e){t.push("EffectTeleport"),e.push({name:"EffectExplode",size:16}),e.push({name:"EffectLaser",width:30,height:8})}explode(){}}class UnitMap{constructor(t,e,i,s,n){this.scene=t,this.mapUnitGroup=i,this.buildingGroup=s,this.player=n,this.adjacencyList={},this.updateList=[]}refresh(t){this.updateList.length>0||(this.updateList.push(t),t.scene.addEvent(this.update,0,this))}update(){this.updateList.pop();let t=this.mapUnitGroup.getChildren().concat(this.buildingGroup.getChildren());for(let e=t.length-1;e>=0;e--){let i=t[e];i.route&&i.routeUpdate(this)}this.work()}static preload(t,e){t.push("UnitMapPipe")}findUnitPath(t,e){if(t===e)return[t];let i={},s={};this.mapUnitGroup.getChildren().concat(this.buildingGroup.getChildren()).forEach(t=>{i[t]=1/0}),i[t]=0;let n=new PriorityQueue;n.enqueue([t,0]);let a=n.dequeue();for(;null!==a;){let t=a[0];if(null===t)break;for(let e=t.route.targets.length-1;e>=0;e--){let a=t.route.targets[e],h=1,r=i[t]+h;r<i[a]&&(i[a]=r,s[a]=t,n.enqueue([a,r]))}for(let e=t.route.sources.length-1;e>=0;e--){let a=t.route.sources[e],h=1,r=i[t]+h;r<i[a]&&(i[a]=r,s[a]=t,n.enqueue([a,r]))}a=n.dequeue()}let h=[e],r=e;for(;r!==t;)if(h.unshift(s[r]),!(r=s[r]))return[];return h}findTransport(t){let e={sprite:null,path:null},i=this.scene.getTroops(this.player),s=1/0;for(let n=0;n<i.length;n++){let a=i[n];if(a.transit&&a.available){let i=this.scene.unitMap.findUnitPath(a.unit.parent,t);if(i&&i.length>0){let n=Phaser.Math.Distance.Squared(a.x,a.y,t.x,t.y);n<s&&(s=n,e.sprite=a,e.path=i)}}}return e}productProduce(){if(0===this.scene.unitProducers.length)return;let t=this.scene.unitProducers[0],e=this.findTransport(t);e.sprite&&(e.sprite.available=!1,e.sprite.transitStart(t,e.path),this.scene.unitProducers.splice(0,1))}productTransport(){if(0===this.scene.unitProducts.length)return;let t=this.scene.unitProducts[0],e=this.findTransport(t.unit.parent),i=e.sprite;if(i){let s=this.scene.getHqUnits(this.player);for(let n=0;n<s.length;n++){let a=s[n];if(a.consume&&a.consumeNeed(t.unit.type)){let s=this.scene.unitMap.findUnitPath(t.unit.parent,a);if(s.length>0){i.deliverPath=s,i.available=!1,i.transitStart(t,e.path),this.scene.unitProducts.splice(0,1);break}}}}}addWorker(t){t.available=!0,this.work()}work(){this.productTransport(),this.productProduce()}}const ZOOMTIME=500;class UnitScene extends Phaser.Scene{constructor(t,e){super({key:t}),this.debug=!0,this.cardScene=e,this.teamBuildings=[],this.teamTroops=[],this.teamBullets=[],this.unitProducts=[],this.unitProducers=[],this.eventQueue=new PriorityQueue,this.loser=null,this.unitListeners=[],this.guardListeners=[],this.executeUnitProcessIndex=0,this.unitStations=[]}init(){this.tilesizeSquared=64*this.game.resolution*64*this.game.resolution,this.zoomTween=null,this.events.on(Phaser.Scenes.Events.DESTROY,()=>{})}preload(){let t=["BgAtmosphere","BgTileCell","hex","CardBoard"],e=[];UnitMap.preload(t,e),UnitEffect.preload(t,e);let i=this.scene.get("LoaderScene");i.loadImages(this,t),i.loadSpritesheets(this,e)}create(t){this.level=t,this.level.grid;this.createHex([[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]]),this.scene.sendToBack(),this.effect=new UnitEffect(this),this.mapUnitGroup=this.physics.add.group(),this.fields=this.physics.add.staticGroup(),this.idleUnits=this.physics.add.group(),this.unitMaps=[],this.scene.sendToBack(),t.sceneCreated&&t.sceneCreated(this),this.addEvent(this.levelFactory.createRandomUnit,1e3,this.levelFactory)}createHex(t){var e=36*this.game.resolution,i=Math.floor(41.25*this.game.resolution);this.hexagonGroup=this.add.group();let s=this.game,n=this.hexagonGroup;var a=this.add.sprite(0,this.cameras.main.height,"CardBoard").setOrigin(0,1);a.scaleX=this.cameras.main.width/a.width;let h=this.cameras.main.centerX;for(var r=0;r<17;r++)for(var o=0;o<9;o++){var l=h-17*e/2+e/2+e*r,c=i/2+i/8+i*o/4*3;if(this.hexTopLeft||(this.hexTopLeft={x:l,y:c,w:e,h:i}),o%2){if(16===r)continue;l+=e/2}var d=this.add.sprite(l,c,"hex");d.setTint(3355443),8===r&&8===o&&d.setTint(65280),7===r&&7===o&&d.setTint(39168),9===r&&8===o&&d.setTint(39168),n.add(d),0===r&&0===o&&(d.visible=!1),16===r&&0===o&&(d.visible=!1)}n.y=(s.height-i*Math.ceil(4.5))/2,n.x=(s.width-Math.ceil(8.5)*e-Math.floor(8.5)*e/2)/2,this.checkHex(100,100)}checkHex(t,e){var i=36*this.game.resolution,s=Math.floor(41.25*this.game.resolution),n=i/4*3,a=s,h=i/4/(s/2);let r=this.hexagonGroup;var o=Math.floor((game.input.worldX-r.x)/n),l=(Math.floor((game.input.worldY-r.y)/a),(game.input.worldX-r.x)%n),c=(game.input.worldY-r.y)%a;o%2==0?(l<i/4-c*h&&(o--,0),l<-i/4+c*h&&o--):c>=s/2?l<i/2-c*h&&o--:l<c*h&&o--}placeMarker(t,e){let i=this.marker;let s=[Math.ceil(6),Math.floor(6)];t<0||e<0||t>=10||e>s[t%2]-1?i.visible=!1:(i.visible=!0,i.x=60*t+40,i.y=70*e,i.y+=t%2==0?35:70)}getBoardDiv(){return 64*this.game.resolution}getBoardDivSquared(){return 20*this.tilesizeSquared}getBounds(t=null){let e=0,i=0,s=640,n=360;return{x:e*=this.game.resolution,y:i*=this.game.resolution,w:s*=this.game.resolution,h:n*=this.game.resolution}}createBackground(){let t=64*this.game.resolution;var e=[];let i=this.textures.get("BgTileCell").getSourceImage().width/this.textures.get("BgTileCell").getSourceImage().height,s=this.level.grid.w,n=this.level.grid.h;for(let t=0;t<n;t++){e[t]=[];for(let n=0;n<s;n++){let s=Phaser.Math.Between(0,i-2);e[t][n]=s}}let a=this.add.image(0,this.cameras.main.height,"BgAtmosphere").setOrigin(0,0);a.angle=-90,a.scaleY=this.cameras.main.width/a.height,this.atmosphere=a;let h=this.make.tilemap({data:e,tileWidth:t,tileHeight:t});var r=h.addTilesetImage("BgTileCell","BgTileCell",t,t);let o=h.createLayer(0,r);this.groundLayer=o,o.x=.35*t,o.y=.625*t/2,o.depth=-1,o.setCollisionBetween(3,i-1)}getBoardTile(t,e){let i=this.groundLayer.worldToTileXY(t,e);return this.groundLayer.getTileAt(i.x,i.y)}isFreeSpace(t,e,i,s){let n=t.getChildren();for(let t=n.length-1;t>=0;t--){let a=n[t];if(Phaser.Math.Distance.Squared(e,i,a.x,a.y)<s)return!1}return!0}countEnergy(){let t=this.fields.getChildren(),e=0;for(let i=t.length-1;i>=0;i--)t[i]instanceof UnitEnergy&&e++;return e}createEnergy2(t,e){new UnitEnergy(this,t,e,this.cardScene.player,this.level)}addIdle(t){this.idleUnits.add(t,!0)}zoomTo(t,e,i){}overlapUnit(t,e){this.physics.world.isPaused||(t.overlap?t.overlap(e):console.log("ERR",t,e))}setCollideGroup(t,e,i,s=!0){for(let n=0;n<e.length;n++)i!==n&&(s?this.physics.add.collider(t,e[n],this.overlapUnit,null,this):this.physics.add.overlap(t,e[n],this.overlapUnit,null,this))}setColliders(){for(let t=0;t<this.teamBullets.length;t++)this.setCollideGroup(this.teamBullets[t],this.teamBuildings,-1,!1);for(let t=0;t<this.teamBullets.length;t++)this.setCollideGroup(this.teamBullets[t],this.teamTroops,t);for(let t=0;t<this.teamTroops.length;t++)this.setCollideGroup(this.teamTroops[t],this.teamTroops,-1),this.physics.add.collider(this.teamTroops[t],this.mapUnitGroup,this.overlapUnit,null,this);for(let t=0;t<this.teamTroops.length;t++){this.teamTroops[t]}}groupBuildingsAdd(t,e){this.unitMap.refresh(t)}groupBuildingsRemove(t,e){this.unitMap.refresh(t)}addTeamGroups(t){if(this.teamTroops[t])return;let e=this.physics.add.group({createCallback:e=>this.groupBuildingsAdd.call(this,e,t),removeCallback:e=>this.groupBuildingsRemove.call(this,e,t)});e.runChildUpdate=!1;let i=this.physics.add.group();i.runChildUpdate=!1;let s=this.physics.add.group();s.runChildUpdate=!1,this.teamBuildings[t]=e,this.teamTroops[t]=i,this.teamBullets[t]=s,0===t&&(this.unitMap=new UnitMap(this,this.level,this.mapUnitGroup,e,this.level.data.players[t]))}addStation(t){this.unitStations.push(t)}addUnitProcess(t){if(-1===this.unitListeners.indexOf(t)){for(let e=this.unitListeners.length-1;e>=0;e--){this.unitListeners[e].unitEvent(t,"start")}this.unitListeners.push(t)}}removeUnitProcess(t){const e=this.unitListeners;let i=e.indexOf(t);if(-1!==i){e.splice(i,1);for(let e=this.unitListeners.length-1;e>=0;e--){this.unitListeners[e].unitEvent(t,"stop")}}}executeUnitProcess(t){const e=this.unitListeners;let i=this.executeUnitProcessIndex+1;i>=e.length&&(i=e.length-1);for(let s=i;s>=this.executeUnitProcessIndex;s--){let i=e[s];t>i.unit.time&&(i.unit.time=i.unitProcess(t))}i>=e.length-1?this.executeUnitProcessIndex=0:this.executeUnitProcessIndex=i+1}scaleResolution(t){return t*this.game.resolution}explode(t){let e=this.add.particles("EffectExplode");e.createEmitter({frame:[2],x:t.x,y:t.y,speed:{start:this.scaleResolution(112.5),end:this.scaleResolution(-112.5)},quantity:5,ease:"Power2",lifespan:1500,maxParticles:50,blendMode:"SCREEN",alpha:{start:1,end:0}}),e.createEmitter({frame:[0],x:t.x,y:t.y,speed:{start:this.scaleResolution(75),end:this.scaleResolution(-75)},quantity:5,ease:"Power2",lifespan:1e3,maxParticles:100,blendMode:"SCREEN",alpha:{start:1,end:0}}),e.createEmitter({frame:[0],x:t.x,y:t.y,speed:{start:this.scaleResolution(56.25),end:this.scaleResolution(-56.25)},quantity:5,ease:"Power2",lifespan:1e3,maxParticles:50,blendMode:"SCREEN",alpha:{start:1,end:0}});e.createGravityWell({x:t.x,y:t.y,power:2,epsilon:100,gravity:t.scene.scaleResolution(8)});this.time.delayedCall(2e3,function(){e.destroy()},this)}showGameOver(t,e,i,s,n,a,h){this.input.enabled=!1;let r=this.add.group();this.cardScene.input.once("pointerdown",function(){r.destroy(!0),r=null,this.input.enabled=!0},this);let o=this.add.graphics();if(r.add(o),o.fillStyle(0,.5),o.fillRect(0,0,this.cameras.main.width,this.cameras.main.height),this.level.tutorial.img)return void this.add.image(this.cameras.main.centerX,this.cameras.main.centerY/3,"tutorial-drag-to-select");let l=-1===e?this.cameras.main.centerX:e*a,c=-1===i?this.cameras.main.centerY:i*h,d=r.create(l,c,"sprites","alice.png");if(d.setDepth(10),d.alpha=0,n){let t=r.create(n[0]*a,n[1]*h,"sprites","hand.png");t.x<this.cameras.main.width/2&&(t.scaleX=-1),this.tweens.add({targets:t,duration:400,x:t.x+20,delay:s,repeat:n.length>2?2:4,yoyo:!0,callbackScope:this,onComplete:function(){r&&(n.length>2?(t.scaleX=1,t.x=n[2]*a,t.y=n[3]*h,this.tweens.add({targets:t,duration:400,x:t.x+20,delay:s,repeat:1,yoyo:!0,callbackScope:this,onComplete:function(){}},this)):t.destroy())}},this)}this.tweens.add({targets:d,duration:400,alpha:1,delay:s/4,repeat:1,callbackScope:this,onComplete:function(){if(!r)return;let e=r.create(d.x,d.y+d.height/2,"sprites","dialog.png");e.setDepth(10);let i=e.width/12,s=this.add.text(e.x,e.y-e.width/26/2,t,{fontFamily:"Source Code Pro",fontSize:i,color:"#000",align:"center"}).setOrigin(.5);s.setDepth(10),r.add(s)}},this)}destroyed(){for(let t=0;t<this.teamTroops.length;t++){let e=this.teamBuildings[t];e.runChildUpdate=!1;for(let t=e.getChildren().length-1;t>=0;t--){e.getChildren()[t].destroy(!0,!0)}(e=this.teamTroops[t]).runChildUpdate=!1;for(let t=e.getChildren().length-1;t>=0;t--){e.getChildren()[t].destroy(!0,!0)}(e=this.teamBullets[t]).runChildUpdate=!1;for(let t=e.getChildren().length-1;t>=0;t--){e.getChildren()[t].destroy(!0,!0)}}this.mapUnitGroup.runChildUpdate=!1;for(let t=this.mapUnitGroup.getChildren().length-1;t>=0;t--){this.mapUnitGroup.getChildren()[t].destroy(!0,!0)}this.eventQueue.destroy()}gameOver(){this.eventQueue.destroy(),this.time.removeAllEvents(),this.physics.world.colliders.destroy(),this.physics.pause(),this.tweens.killAll()}getHqUnits(t){return this.mapUnitGroup.getChildren().concat(this.teamBuildings[t.id].getChildren())}getTroops(t){return this.teamTroops[t.id].getChildren()}getBuildings(t){return this.teamBuildings[t.id].getChildren()}getUnits(t,e,i,s){let n,a=[];if(!s)for(let s=(n=this.mapUnitGroup.getChildren()).length-1;s>=0;s--){let h=n[s];if(i){let s=Phaser.Math.Distance.Squared(t,e,h.x,h.y);h.rangeSquared=s,s<i&&a.push(h)}else h.getBounds().contains(t,e)&&a.push(h)}if(s)for(let h=(n=this.teamBuildings[s.id].getChildren()).length-1;h>=0;h--){let r=n[h];if(i){let s=Phaser.Math.Distance.Squared(t,e,r.x,r.y);r.rangeSquared=s,s<i&&a.push(r)}else r.player.id===s.id&&r.getBounds().contains(t,e)&&a.push(r)}return a}getEnemyTroops(t){let e=[];for(let i=0;i<this.teamTroops.length;i++)t.team.id!==i&&e.push(this.teamTroops[i].getChildren());return e}getEnemyBuildings(t){let e=[];for(let i=0;i<this.teamBuildings.length;i++)t.team.id!==i&&e.push(this.teamBuildings[i].getChildren());return e}getEnemyUnits(t,e,i,s){let n=[];for(let a=0;a<this.teamTroops.length;a++){if(s.id===a)continue;let h=this.teamTroops[a].getChildren();for(let s=h.length-1;s>=0;s--){let a=h[s];i?Phaser.Math.Distance.Squared(t,e,a.x,a.y)<i&&n.push(a):a.getBounds().contains(t,e)&&n.push(a)}}return n}addEvent(t,e,i){this.eventQueue.enqueue([t,this.time.now+e,i])}clearEvents(t){this.eventQueue.clear(t)}update(t,e){this.executeUnitProcess(t);let i=this.eventQueue.dequeueExpired(t);for(;null!==i;)i[0].call(i[2]),i=this.eventQueue.dequeueExpired(t)}}class MainGame extends Phaser.Game{constructor(t,e,i){let s=window.innerWidth,n=window.innerHeight;if(s<n){let t=s;s=n,n=t}window.devicePixelRatio>=2||window.devicePixelRatio;super({key:t.id,type:Phaser.AUTO,parent:t,width:s,height:n,backgroundColor:"#0b0b0b",fps:{target:30,forceSetTimeOut:!0},audio:{noAudio:!0},physics:{default:"arcade",arcade:{debug:!1}},render:{},scale:{zoom:1,mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},input:{touch:{capture:!0},gamepad:!0},disableContextMenu:!0,scene:[new LoaderScene(e)]});let a=document.getElementsByTagName("html")[0].getAttribute("lang");a&&Text.setLang(a),this.registry.set("debug",!0),0===window.location.href.indexOf("file:///")?(this.registry.set("debug",!0),this.registry.set("path",""),this.registry.set("app",!0)):-1!==window.location.href.indexOf("localhost:8383")?(this.registry.set("debug",!0),this.registry.set("path","./")):-1!==window.location.href.indexOf("test/")?(this.registry.set("release",!0),this.registry.set("path","/test-"+Text.id+"/")):(this.registry.set("release",!0),i="creepersondeck",this.registry.set("path","/"+i+"/")),this.registry.set("gameid",i),this.registry.set("minimind",!0),this.registry.set("minigame",!0)}clear(t){window.localStorage.removeItem(this.registry.get("gameid")+t)}save(t,e){window.localStorage.setItem(this.registry.get("gameid")+t,e)}restore(t){return window.localStorage.getItem(this.registry.get("gameid")+t)}}const LEVEL="level-test";function createGame(){var t,e=new URL(window.location);t=e.hash.length>0?e.hash.substr(1):Text.id,window.game=new MainGame(document.getElementById("canvas"),["level-0-begin","level-0-data","level-0-end","level-1-begin","level-1-data","level-1-end","level-test"],t)}function setGameConfig(t,e,i){}function log(t){console.log(t)}