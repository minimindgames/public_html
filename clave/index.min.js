/*! Copyright minimindgames.com 14-02-2021 */

class Button extends Phaser.GameObjects.Container{constructor(t,e){super(t),this.scene.add.existing(this),this.setData("states",e);let s=this.scene.add.image(this.x,this.y,"ui-button");s.setInteractive().on("pointerover",()=>this.pointerover()).on("pointerout",()=>this.pointerout()).on("pointerdown",()=>this.pointerdown()).on("pointerup",()=>this.pointerup()),s.setOrigin(.5),this.add(s);let i=this.scene.add.text(this.x,this.y,e[0],{fontFamily:"Source Code Pro",fontSize:28,color:"#fff",align:"center"});i.setShadow(2,2,"#000",2),i.setOrigin(.5),this.add(i),this.selectTime=0}next(){let t=this.getData("states").indexOf(this.getText());t+1>=this.getData("states").length?t=0:t++,this.set(this.getData("states")[t])}getText(){return this.getAt(1).text}set(t){this.getAt(1).text=t}pointerover(){this.getAt(0).setTexture("ui-button-active")}pointerout(){this.getAt(0).setTexture("ui-button")}pointerdown(){}pointerup(){this.scene.time.now<this.selectTime||(this.selectTime=this.scene.time.now+150,this.scene.events.emit(this.getText()))}}class GameScene extends Phaser.Scene{constructor(){super({key:"GameScene"}),this.layout=null,this.level=null,this.sheet=null,this.markers=null,this.beatTime=null,this.metronome=null,this.music=null,this.levelInfo=null,this.startPlayDelay=0,this.isPlaying=!1}init(t){this.startPlaying=t.startPlaying,this.layout=t.layout,this.layout.cx=(this.layout.w+this.layout.x)/2,this.layout.cy=(this.layout.h+this.layout.y)/2}preload(){this.load.path=Locale.path(""),this.level=this.cache.json.get("levels").levels[this.registry.get("level")],["beat-0","beat-1","beat-check","beat-marker"].forEach(function(t){this.load.image(t,"img/"+t+".png")},this),this.load.audio("sfx",["audio/sfx.ogg"],{instances:4}),this.soundMarkers=[{name:"bongo-low",start:0,duration:.05}],this.load.audio(this.level.music,["audio/"+this.level.music+".ogg"])}create(){this.input.on("pointerdown",this.pointerDown,this),this.music=this.sound.add(this.level.music),this.addContent(),this.gamepad=null,this.input.gamepad.once("connected",function(t){this.gamepad=t,this.gamepad.on(Phaser.Input.Gamepad.Events.BUTTON_DOWN,function(t){this.music.isPlaying?this.pointerDown():this.startPlay()},this)},this),this.subscribeEvents(),this.startPlaying&&this.startPlay()}update(){let t=this.metronome.getData("beat");if(t&&this.isPlaying){this.updateSheet();let e=(1e3*this.music.getCurrentTime()-t.getData("time"))/(this.beatTime/2)*(t.width/2);this.metronome.x=this.sheet.x+t.x+e}}startPlay(){if(this.startPlayDelay>=0&&(this.startPlayDelay--,this.startPlayDelay>=0))return this.levelInfo.setText(""+(this.startPlayDelay+1)),this.sound.play("sfx",this.soundMarkers[3===this.startPlayDelay?0:1]),void this.time.delayedCall(4*this.beatTime,this.startPlay,[],this);this.music.on("play",function(t){this.isPlaying=!0,this.hasTrick("blind")||(this.metronome.visible=!0),this.feedbackText.visible=!0;let e=this.sheet.first;this.metronome.setData("beat",e),this.metronome.x=this.sheet.x+e.x,this.metronome.y=this.sheet.y+e.y},this),this.music.on("looped",function(t){let e=!0;if(this.isGoodBeat(this.sheet.last),this.sheet.iterate(function(t){this.isGoodBeat(t)||(e=!1)},this),e)return void(this.input.enabled&&(this.input.enabled=!1,this.pausePlay(),this.events.emit("PASSED"),this.feedbackText.setText(this.level.feedback[Locale.i])));this.sheet.each(function(t){t.setData("hit",!1),t.clearTint()},this),this.markers.clear(!0,!0);let s=this.sheet.first;this.metronome.setData("beat",s),this.metronome.x=this.sheet.x+s.x,this.metronome.y=this.sheet.y+s.y},this),this.music.play({loop:!0})}pausePlay(){this.isPlaying=!1,this.metronome.visible=!1,this.music.stop()}createSheet(){let t=new GridContainer(this,"beat",this.level.barbeat[0].length,this.level.barbeat.length,0,30),e=0,s=this.level.barbeat.length,i=this.level.barbeat[0].length;this.beatTime=1e3*this.music.duration/(s*i);for(let a=0;a<s;a++)for(let s=0;s<i;s++){let i=this.level.barbeat[a][s],h=t.addCell(s,a,i);h.setData("time",e+this.beatTime/2),h.setData("hit",!1),e+=this.beatTime}return this.markers=this.add.group(),this.metronome=this.add.image(0,0,"beat-marker"),this.metronome.setData("beat",null),this.metronome.visible=!1,t}isGoodBeat(t){let e=!1;return(e=0!==t.getData("value")?t.getData("hit"):!t.getData("hit"))&&0!==t.getData("value")?t.setTint(65280):!e&&t.getData("hit")&&t.setTint(16711680),e}updateSheet(){let t=this.metronome.getData("beat");if(1e3*this.music.getCurrentTime()>t.getData("time")+this.beatTime/2){this.isGoodBeat(t);let e=this.sheet.nextCell(t);e&&(this.metronome.setData("beat",e),this.metronome.x=this.sheet.x+e.x,this.metronome.y=this.sheet.y+e.y)}}pointerDown(){let t=this.music.getCurrentTime();if(this.input.stopPropagation(),this.sound.play("sfx",this.soundMarkers[1]),!this.isPlaying)return;this.update();let e=this.metronome.getData("beat");if(e){e.setData("hit",!0),this.isGoodBeat(e);let s=(1e3*t-e.getData("time"))/(this.beatTime/2)*(e.width/2);this.markers.create(this.sheet.x+e.x+s,this.sheet.y+e.y-e.height/2,"beat-check").setOrigin(.5,0)}}hasTrick(t){return!!this.level.trick&&this.level.trick.includes(t)}subscribeEvents(){let t=this.scene.get("UIScene");t.events.on(Locale.play,function(){this.startPlay(),this.feedbackText.visible=!0},this),t.events.on(Locale.pause,function(){this.pausePlay(),this.feedbackText.visible=!1},this)}addContent(){let t=[];var e=this.add.text(0,0,this.level.title,{fontFamily:"Source Code Pro",fontSize:20,color:"#000000",align:"left"});e.setShadow(2,2,"rgba(255,255,255,1)",3),t.push(e),this.levelInfo=this.add.text(0,0,parseInt(this.registry.get("level"))+1+" / "+this.cache.json.get("levels").levels.length+"\n\n"+this.level.info[Locale.i],{fontFamily:"Source Code Pro",fontSize:18,color:"#000000",align:"center",wordWrap:{width:this.layout.w}}),this.levelInfo.setShadow(2,2,"rgba(255,255,255,1)",3),t.push(this.levelInfo),this.sheet=this.createSheet(),t.push(this.sheet),this.feedbackText=this.add.text(0,0,Locale.drum,{fontFamily:"Source Code Pro",fontSize:20,color:"#000000",fill:"#080",align:"center",wordWrap:{width:this.layout.w}}),this.feedbackText.setShadow(2,2,"rgba(255,255,255,1)",3),this.feedbackText.visible=!1,t.push(this.feedbackText);let s=0;t.forEach(function(t){s+=t.height});let i=(this.layout.h-this.layout.y-s)/(t.length+2),a=this.layout.y+i;for(let e=0;e<t.length;e++){let s=t[e];s.setOrigin(.5),s.x=this.layout.cx,s.y=a+s.height/2,a+=s.height+i}}}class GridContainer extends Phaser.GameObjects.Container{constructor(t,e,s,i,a=0,h=0){super(t),this.scene.add.existing(this),this.name=e,this.cols=s,this.rows=i,this.paddingX=a,this.paddingY=h,this.cells=[];for(let t=0;t<this.rows;t++)this.cells[t]=[]}addCell(t,e,s){let i=this.scene.add.image(0,0,this.name+"-"+s);return this.add(i),i.x=(t-this.cols/2+.5)*(i.width+this.paddingX/(this.cols%2==0?2:1)),i.y=(e-this.rows/2+.5)*(i.height+this.paddingY/(this.rows%2==0?2:1)),i.setData("value",s),i.setData("col",t),i.setData("row",e),this.cells[e][t]=i,i}getCell(t,e){return this.cells[e][t]}getCells(){return this.cells}nextCell(t){return this.getAt(this.getIndex(t)+1)}setOrigin(t,e){}get height(){return this.rows*(this.cells[0][0].height+this.paddingY)-this.paddingY}}class LoaderScene extends Phaser.Scene{constructor(){super({key:"LoaderScene"})}init(){this.cameras.main.setRoundPixels(!0)}preload(){this.load.path=Locale.path(""),this.load.json("levels"),this.registry.set("level",localStorage.getItem("level")||0)}create(){let t=this.game.config.width,e=this.game.config.height;this.add.text(t/2,e/2,"Loading 0 %",{font:"48px Arial",fill:"#000000"});this.scene.start("UIScene")}}var Locale={i:0,lang:"en",drum:"DRUM HERE",play:"START",pause:"PAUSE",continue:"PLAY",start:"Press to play",nextLevel:"Press to play",playAgain:"Play again",restart:"RESTART",fi(){this.i=1,this.lang="fi",this.drum="RUMMUTA TÄHÄN",this.play="ALOITA",this.pause="TAUKO",this.continue="JATKA",this.start="Aloita tästä",this.nextLevel="Seuraava taso",this.playAgain="Aloita alusta",this.restart="ALUSTA"},init(){"fi"===document.getElementsByTagName("html")[0].getAttribute("lang")&&this.fi(),-1===window.location.href.indexOf("localhost:8383")||(this.debug=!0)},path(t){return this.debug?t:"/clave/"+t}};class UIScene extends Phaser.Scene{constructor(){super({key:"UIScene"}),this.score=0,this.playButton=null,this.status=null}preload(){this.load.path=Locale.path(""),this.level=this.cache.json.get("levels").levels[this.registry.get("level")],["ui-button","ui-button-active"].forEach(function(t){this.load.image(t,"img/"+t+".png")},this)}create(){this.margin=10;let t=new Button(this,[Locale.play,Locale.pause,Locale.continue]);t.x=this.cameras.main.width-t.getBounds().width/2-10,t.y=this.cameras.main.height-t.getBounds().height/2-10,this.events.on(Locale.continue,function(){e.visible=!1,e.setText(Locale.start),t.set(Locale.pause),this.startGame(!0)},this),this.events.on(Locale.pause,function(){this.status.visible=!0,t.set(Locale.play)},this),this.events.on(Locale.play,function(){this.status.visible=!1,t.set(Locale.pause)},this),this.events.on(Locale.restart,function(){this.status.visible=!1,this.setStatus(Locale.start),t.set(Locale.pause),this.startGame(!0)},this),this.scene.get("GameScene").events.on("PASSED",function(){parseInt(this.registry.get("level"))+1<this.cache.json.get("levels").levels.length?(e.setText(Locale.nextLevel),e.visible=!0,t.set(Locale.continue),this.registry.set("level",parseInt(this.registry.get("level"))+1)):(e.setText(Locale.playAgain),e.visible=!0,t.set(Locale.restart),this.registry.set("level",0)),localStorage.setItem("level",this.registry.get("level"))},this);var e=this.add.text(t.x-t.getBounds().width/2-10,t.y,"",{fontFamily:"Source Code Pro",fontSize:18,color:"#000000",align:"right"});e.setOrigin(1,.5),e.setShadow(2,2,"rgba(255,255,255,1)",3),this.playButton=t,this.status=e,this.setStatus(Locale.start),this.startGame(!1)}setStatus(t){this.status.setText(t)}startGame(t){let e={startPlaying:t,layout:{y:this.margin,x:this.margin,h:this.playButton.getBounds().y-this.margin,w:this.cameras.main.width-this.margin}};t?this.scene.get("GameScene").scene.restart(e):this.scene.launch("GameScene",e)}}class BeatIt extends Phaser.Game{constructor(t,e,s){super({key:"BeatIt",type:Phaser.AUTO,parent:t,width:e,height:s,backgroundColor:"#fefefe",scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},input:{touch:{capture:!1},gamepad:!0},disableContextMenu:!0,scene:[new LoaderScene,new GameScene,new UIScene]})}}function createGame(){Locale.init();let t=Math.min(window.innerWidth,320),e=Math.min(window.innerHeight,320);window.game=new BeatIt("canvas",t,e)}function setGameConfig(t,e,s){}