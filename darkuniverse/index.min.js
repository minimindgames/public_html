/*! Copyright darkuniverse 28-02-2021 */

class AI{constructor(t,e,i,s,a){this.player=t,this.unitScene=e,this.level=i,this.teams=s,this.players=a,this.step=0,this.lastStep=0}}class AIgravity extends AI{constructor(t,e,i,s,a){super(t,e,i,s,a),this.config=this.player.config[this.player.id]}play(){if(!this.player.HQ)return;if(this.config.ai.gravity){if(this.step++>this.lastStep){this.step=0;let t=this.config.ai.gravityDelay||1;this.lastStep=Phaser.Math.Between(10*t,50*t);const e=this.unitScene.unitSprites[this.player.team.id].getChildren();for(let t=e.length-1;t>=0;t--){let i=e[t];if(i.player.id===this.player.id)if("planet"===this.config.ai.gravity){let t=this.unitScene.planets.getChildren()[0];new Phaser.Geom.Point(t.x,t.y).body={mass:150},i.unit.gravity=this.unitScene.planets.getChildren()[0]}else if(i.unit.gravity.player===this.player){let t=1/0;for(let e=this.players.length-1;e>=0;e--){let s=this.players[e];if(s.HQ){if(s.team===this.player.team)continue;let e=Phaser.Math.Distance.Squared(this.player.HQ.x,this.player.HQ.y,i.x,i.y);e<t&&(t=e,i.unit.gravity=s.HQ);break}}}}}return}if(this.config.ai.routes){if(this.step++>this.lastStep){this.step=0;let e=this.config.ai.routes.delay||1;this.lastStep=Phaser.Math.Between(8*e,18*e);let i=null,s=null,a=null,r=1/0,h=null,n=1/0;const l=this.unitScene.hqSprites.getChildren();for(let t=l.length-1;t>=0;t--){let e=l[t];if(e.player===this.player){if(e.unit.damage>0){let t=Phaser.Math.Distance.Squared(this.player.HQ.x,this.player.HQ.y,e.x,e.y);t<r&&(i=e,r=t)}e.route&&0===e.route.connectHq.length&&Phaser.Math.Distance.Squared(this.player.HQ.x,this.player.HQ.y,e.x,e.y)<4*this.player.HQ.route.rangeSquared&&(h=e)}else if(e.player.team!==this.player.team){let t=Phaser.Math.Distance.Squared(this.player.HQ.x,this.player.HQ.y,e.x,e.y);t<n&&(s=e,n=t)}}if(h){var t=new Phaser.Geom.Line(this.player.HQ.x,this.player.HQ.y,h.x,h.y);let e=Phaser.Geom.Line.GetMidPoint(t);const i=this.unitScene.hqSprites.getChildren();let s=!1;for(let t=i.length-1;t>=0;t--){let a=i[t],r=Phaser.Math.Distance.Squared(e.x,e.y,a.x,a.y);if(a.route&&r<a.width*a.width){s=!0;break}}s||(h=new UnitRoute(this.unitScene,e.x,e.y,this.player,{}))}if(i&&(a=i),s&&(a=s),a){const t=this.unitScene.unitSprites[this.player.team.id].getChildren();for(let e=t.length-1;e>=0;e--){let i=t[e];i.player.id===this.player.id&&(i.unit.gravity=a)}}}return}let e=this.player.cards;for(let t=0;t<e.children.size;t++){let i=e.getChildren()[t].sprite;if(i&&i.unit.cost<=e.energy()){let t,e=this.player.HQ.x-this.enemyHQ.x,s=2*this.player.HQ.y-2*this.level.size-this.level.size;for(;;){i.x=Phaser.Math.Between(this.enemyHQ.x,this.player.HQ.x),i.y=Phaser.Math.Between(this.level.size,2*this.player.HQ.y-2*this.level.size),t=[this.player.HQ,i,this.enemyHQ];let a=new Phaser.Curves.Spline(t);if(!(a.getBounds().width>e||a.getBounds().height>s))break;i.x>e/2?i.x--:i.x++,i.y>s/2?i.y--:i.y++}let a=new Phaser.Curves.Spline(t);this.player.playCard(i),i.unit.doFollowPath(a),this.unitScene.renderPath(i,a),i.visible=!0}}}}let unitMove=t=>(class extends t{initMove(t){this.move=t}startMove(t){const e=this.move;e.pointDivision=this.scene.scaleResolution(24),e.points=t.getDistancePoints(e.pointDivision),e.currentPoint=0,this.drawMovePath();let i=e.points[e.currentPoint];this.setPosition(i.x,i.y);let s=Phaser.Math.Angle.Between(this.x,this.y,e.points[1].x,e.points[1].y);this.rotation=s,e.timer=this.scene.time.addEvent({delay:20,callback:function(){this.doMove()},callbackScope:this,loop:!0})}drawMovePath(){const t=this.move,e=this;for(let i=t.currentPoint;i<t.points.length;i++)t.points[i].image=e.scene.add.image(t.points[i].x,t.points[i].y,"sprites","checkpoint.png")}stopMove(){const t=this.move;t.timer.remove();for(let e=0;e<t.points.length;e++)null!==t.points[e].image&&t.points[e].image.destroy()}doMove(){const t=this.move,e=this,i=this.shoot;if(i&&null!==i.target){if(i.angle!==2*Math.PI){let s=Phaser.Math.Angle.Between(e.x,e.y,i.target.x,i.target.y);return void(e.rotation=Phaser.Math.Angle.RotateTo(e.rotation,s,t.turnSpeed))}return this.setDamping(!0),this.setDrag(.95),this.body.setAllowDrag(!0),void this.body.setAcceleration(0)}const s=this.scene.hqSprites.getChildren();if(this instanceof UnitLauncher)for(let t=s.length-1;t>=0;t--){let e=s[t];if(!(this instanceof UnitFighter)&&(e.player.team.id!==this.player.team.id&&Phaser.Math.Distance.Squared(this.x,this.y,e.x,e.y)<this.shoot.rangeSquared))return void this.setShootTarget(e)}let a;if(!this.stoppedFollow){if(t.currentPoint>=t.points.length)return;if(a=t.points[t.currentPoint],Phaser.Math.Distance.Squared(this.x,this.y,a.x,a.y)<t.pointDivision*t.pointDivision&&t.currentPoint<t.points.length&&(t.points[t.currentPoint].image.destroy(),t.points[t.currentPoint].image=null,t.currentPoint++,a=t.points[t.currentPoint],t.currentPoint===t.points.length))return void this.stopMove();let e=this,i=Phaser.Math.Angle.Between(e.x,e.y,a.x,a.y);0===t.turnSpeed?e.scene.physics.velocityFromRotation(i,this.body.maxSpeed,e.body.acceleration):(e.rotation=Phaser.Math.Angle.RotateTo(e.rotation,i,this.turnSpeed),e.scene.physics.velocityFromRotation(e.rotation,this.body.maxSpeed,e.body.acceleration))}}}),skillProduce=t=>(class extends t{initProduce(t){this.produce=t}startProduce(){this.produce.delay>0&&(this.produce.timeout=this.produce.delay,this.scene.addEvent(this.doProduce,this.produce.timeout,this))}stopProduce(){this.produce.timeout=0}doProduce(){if(this.produce.timeout>0&&this.scene.addEvent(this.doProduce,this.produce.timeout,this),0===this.route.connectHq.length)return;if(this.unit.damage>0){let t=this.unit.level||1;return this.unit.damage-=UnitElement.health/(t+1),this.unit.damage<=0&&(this.unit.damage=0,this.player.id),void this.updateDamageImage()}new UnitElement(this.scene,this.x,this.y,this.player,{parent:this}).unit.gravity=this}}),skillRoute=t=>(class extends t{startRoute(t){t&&(this.route=t),this.route.rangeMin=this.width,this.route.rangeMinSquared=this.route.rangeMin*this.route.rangeMin,this.route.range=this.scene.scaleResolution(t.range),this.route.rangeSquared=this.route.range*this.route.range,this.route.sources=[],this.route.targets=[],this.route.connectHq=[]}stopRoute(){this.clearRoutes()}clearRoutes(){this.route.sources.forEach(function(t){t.routeTargetRemove(this)},this),this.route.sources=[],this.route.targets.forEach(function(t){t.routeSourceRemove(this)},this),this.route.targets=[]}updateRoutes(){this.stopRoute();const t=this.scene.hqSprites.getChildren();for(let e=t.length-1;e>=0;e--){let i=t[e];i!==this&&i.player.id===this.player.id&&Phaser.Math.Distance.Squared(i.x,i.y,this.x,this.y)<=this.route.rangeSquared&&i.addRoute(this)}}addRoute(t){for(let e=0;e<this.route.targets.length;e++){if(this.route.targets[e]===t)return;if(this.route.sources[e]===t)return}this.route.targets.push(t),t.route.sources.push(this),this.scene.unitMap.refresh()}routeTargetRemove(t){for(let e=0;e<this.route.targets.length;e++)if(this.route.targets[e]===t){this.route.targets.splice(e,1),this.scene.unitMap.refresh();break}}routeSourceRemove(t){for(let e=0;e<this.route.sources.length;e++)if(this.route.sources[e]===t){this.route.sources.splice(e,1),this.scene.unitMap.refresh();break}}}),unitShoot=t=>(class extends t{startShoot(t){this.shoot=t,this.shoot.range=this.scene.scaleResolution(this.shoot.range),this.shoot.rangeSquared=this.shoot.range*this.shoot.range;this.shoot;this.shoot.target=null,this.shoot.delay>0&&(this.shoot.timeout=this.shoot.delay,this.scene.addEvent(this.doShoot,this.shoot.timeout,this))}stopShoot(){const t=this.shoot;t.timeout=0,null!==t.target&&t.target.removeListener(this)}setShootTarget(t){const e=this.shoot,i=this;null!==e.target&&e.target.removeListener(this),e.target=t,null!==e.target?(e.target.addListener(this),this.move&&0!==this.move.turnSpeed&&(i.setAcceleration(0),i.setAngularAcceleration(0),i.setAngularVelocity(0),i.setDamping(!0),i.setDrag(.95),i.body.setAllowDrag(!0)),this.laser&&(this.laser.visible=!0)):(this.move&&0!==this.move.turnSpeed&&i.body.setAllowDrag(!1),this.laser&&(this.laser.visible=!1))}doShoot(){const t=this.shoot,e=this;if(this.shoot.timeout>0&&this.scene.addEvent(this.doShoot,this.shoot.timeout,this),!(0===this.route.connectHq.length||this.unit.damage>0)){if(null!==t.target&&Phaser.Math.Distance.Squared(e.x,e.y,t.target.x,t.target.y)>t.rangeSquared&&this.setShootTarget(null),null===t.target)for(let i=t.enemies.length-1;i>=0;i--){let s=t.enemies[i];if(i===this.player.team.id)continue;let a=s.getChildren();for(let i=a.length-1;i>=0;i--){let s=a[i];if(Phaser.Math.Distance.Squared(e.x,e.y,s.x,s.y)<=t.rangeSquared)return void this.setShootTarget(s)}}if(null!==t.target){let i=Phaser.Math.Angle.Between(e.x,e.y,t.target.x,t.target.y);Math.abs(i-e.rotation)<=t.angle&&this.shootUnit(i)}}}});class Unit extends Phaser.Physics.Arcade.Sprite{constructor(t,e,i,s,a,r){"UnitElement"===s||"UnitHq"===s?super(t,e,i,s):super(t,e,i,"sprites",s+".png"),this.player=r,this.scene.anims.exists(s)&&this.anims.play(s),this.id=Unit.id++}toString(){return this.id}startUnit(t){this.unit=t,this.unit.listeners=[],this.unit.tint=0,this.unit.freeze=0,this.unit.level=t.level||1,this.unit.damage=t.damage||0,this.unit.defenceFactor=t.defenceFactor||1,this.body.mass=t.mass||this.width,this.body.maxSpeed=this.scene.scaleResolution(t.maxSpeed||Unit.speedMax),this.body.allowDrag=!1,this.body.allowGravity=!1,this.unit.sizeSquared=this.width*this.width/2,t.damageSize&&(this.unit.levelMax>=2&&(this.unit.damageImage2=this.scene.add.image(this.x,this.y,"damage-"+(t.damageSize+10)),this.unit.damageImage2.setDepth(-1),this.unit.level<this.unit.levelMax?(this.unit.damageImage2.alpha=.25,this.unit.damageImage2.setFrame(this.unit.damageImage2.texture.frameTotal-2)):this.unit.damageImage2.setTint(this.player.color)),this.unit.damageImage=this.scene.add.image(this.x,this.y,"damage-"+t.damageSize,0),this.unit.damageImage.setDepth(-1),this.unit.damageImage.setTint(this.player.color),this.updateDamageImage())}stopUnit(){this.unit.damageImage&&this.unit.damageImage.destroy(),this.unit.damageImage2&&this.unit.damageImage2.destroy(),this.notify("stop"),this.scene.clearEvents(this)}addListener(t){-1===this.unit.listeners.indexOf(t)&&this.unit.listeners.push(t)}removeListener(t){let e=this.unit.listeners.indexOf(t);-1!==e&&this.unit.listeners.splice(e,1)}notify(t){for(let e=this.unit.listeners.length-1;e>=0;e--)this.unit.listeners[e].event(this,t)}event(t,e){}updateDamageImage(){if(1===this.unit.level){let t=this.unit.damageImage.texture.frameTotal-2,e=Math.trunc(t*(this.unit.health-this.unit.damage)/this.unit.health);this.unit.damageImage.setFrame(e)}else{let t=this.unit.health/2;if(this.unit.damage<t){let e=this.unit.damageImage.texture.frameTotal-2;this.unit.damageImage.setFrame(e);let i=Math.trunc(e*(t-this.unit.damage)/t);this.unit.damageImage2.setFrame(i),this.unit.damageImage2.alpha=1}else{let e=this.unit.damageImage.texture.frameTotal-2;this.unit.damageImage2.setFrame(e-1),this.unit.damageImage2.alpha=.5;let i=Math.trunc(e*(this.unit.health-this.unit.damage)/t);this.unit.damageImage.setFrame(i)}}}setPlayer(t){0===t.id&&this.sound("claim"),0===this.player.id&&this.sound("lose"),this.notify("stop");let e=[this.unit.damageImage];this.scene.tweens.add({targets:e,duration:150,scaleX:0,callbackScope:this,rotation:Math.PI,onComplete:function(t){this.scene.tweens.add({targets:e,duration:150,scaleX:1,callbackScope:this,rotation:0,onComplete:function(t){this.unit.damageImage.setTint(this.player.color)}},this)}},this),this.player=t,this.unit.level=1,this.updateDamage(),this.updateRoutes(),this.unit.damageImage2&&(this.unit.damageImage2.alpha=.25,this.unit.damageImage2.setTint(16777215))}unitDamage(t){this.unit.damage;return this.unit.damage+=t*this.unit.defenceFactor,this.unit.damage>this.unit.health?(this.unit.damage=this.unit.health,!0):(this.updateDamage(),!1)}damageEnemy(t){if(this.player.team.id!==t.player.team.id){let e=t.unit.health-t.unit.damage;t.unitDamage(this.unit.health-this.unit.damage)&&t.destroy(),this.unitDamage(e)&&this.destroy()}}overlapEnemy(t){let e=t.unit.health-t.unit.damage;return t.unitDamage(this.unit.health-this.unit.damage)&&t.destroy(),!!this.unitDamage(e)&&(this.unit.damage=this.unit.health-(this.unit.damage-this.unit.health),!0)}overlapFriend(t){if(t instanceof UnitElement&&this.unit.damage>0){let e=t.unit.health-t.unit.damage;this.unit.level>1&&(e/=this.unit.level),e/=2,this.unit.damage-=e,this.unit.damage<0&&(this.unit.damage=0),t.destroy(),this.updateDamage()}}overlap(t){this.player.team.id===t.player.team.id?this.overlapFriend(t):this.damageEnemy(t)}unitMapUpdated(){}explodeEffect(){let t=this.scene.add.particles("Unit-explode");t.createEmitter({frame:[2],x:this.x,y:this.y,speed:{start:this.scene.scaleResolution(112.5),end:this.scene.scaleResolution(-112.5)},quantity:5,ease:"Power2",lifespan:1e3,maxParticles:50,blendMode:"SCREEN",alpha:{start:1,end:0}}),t.createEmitter({frame:[0],x:this.x,y:this.y,speed:{start:this.scene.scaleResolution(75),end:this.scene.scaleResolution(-75)},quantity:5,ease:"Power2",lifespan:750,maxParticles:100,blendMode:"SCREEN",alpha:{start:1,end:0}}),this.scene.time.delayedCall(1e3,function(){t.destroy()},this)}sound(t){this.scene.cardScene.audio.play(t)}static preload(t,e){for(let t=10;t<=40;t+=10)e.push({name:"damage-"+t,size:t});e.push({name:"Unit-explode",size:16})}}Unit.id=1,Unit.speedMax=40;class UnitAsteroid extends Unit{constructor(t,e,i,s,a){super(t,e,i,UnitAsteroid.name,a.frame,s),t.asteroids.add(this,!0),this.startUnit({health:1e3,mass:10}),this.body.setSize(this.width/2),this.setDamping(!0),this.setDrag(.999)}overlap(t){t.destroy()}unitDamage(){}static preload(t,e){e.push({name:UnitAsteroid.name,size:10})}}UnitAsteroid.name="UnitAsteroid";class UnitBase extends(skillProduce(skillRoute(Unit))){constructor(t,e,i,s,a){super(t,e,i,UnitBase.name,0,s),t.hqSprites.add(this,!0),this.body.move=!1,this.body.immovable=!0,this.startUnit({health:8*UnitElement.health,damageSize:30,levelMax:1,defenceFactor:1}),this.startRoute({range:100}),this.initProduce({delay:a.produceDelay||1e3,disabled:!1}),this.updateRoutes(),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.sound("impact"),this.stopRoute(),this.stopUnit()}updateDamage(){this.updateDamageImage()}unitMapUpdated(t){if(null!==t&&this.player.HQ&&(this.route.connectHq=t.findUnitPath(this.player.HQ,this),this.route.connectHq.length>0)){this.produce.disabled||(this.player.HQ.addPath(this,this.route.connectHq),t.drawConnectHq(this),t.rotating.push(this));for(let e=this.route.sources.length-1;e>=0;e--)t.drawConnection(this,this.route.sources[e])}}static preload(t,e){t.push(UnitBase.name)}}UnitBase.name="UnitBase";class UnitBullet extends Unit{constructor(t,e,i,s,a){super(t,e,i,UnitBullet.name,a.frame,s),t.bulletSprites[this.player.team.id].add(this,!0),this.startUnit({damage:1}),this.body.setSize(this.width/2)}overlap(t){t.destroy()}unitDamage(){}static preload(t,e){t.push(UnitBullet.name)}}UnitBullet.name="UnitBullet";class UnitColony extends Unit{constructor(t,e,i,s,a){super(t,e,i,UnitColony.name,a.frame,s),t.planets.add(this,!0),this.body.move=!1,this.body.immovable=!0,this.startUnit({health:64,damageSize:30}),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.stopUnit(),this.scene.gameOver(this.player),this.scene.explode(this)}updateDamage(){this.updateDamageImage()}static preload(t,e){t.push(UnitColony.name)}}UnitColony.name="UnitColony";class UnitElement extends Unit{constructor(t,e,i,s,a){let r=a?a.frame:0;super(t,e,i,UnitElement.name,r,s),t.unitSprites[this.player.team.id].add(this,!0),this.setTint(this.player.color),this.target=null,this.startUnit({health:a.health||UnitElement.health,parent:a.parent,gravity:a.parent}),this.decay={timeout:300},this.followPath()||this.spawn(),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.decay.timeout=0,this.pathFollower&&this.pathFollower.destroy(!0),this.stopUnit();let t=this.scene.add.image(this.x,this.y,"sprites",UnitElement.name+"-flash.png");this.scene.tweens.add({targets:t,duration:.5,alpha:0,onComplete:function(){t.destroy()}},this)}eventGravityDecay(){this.unit.tint>0&&(this.unit.tint--,0===this.unit.tint&&this.setTint(this.player.color)),0!==this.decay.timeout&&(this.unit.damage+=.1,this.unit.damage>this.unit.health?this.destroy():(this.updateDamage(),this.scene.addEvent(this.eventGravityDecay,this.decay.timeout,this),this.unit.gravity.body&&this.scene.physics.accelerateToObject(this,this.unit.gravity,this.unit.gravity.body.mass)))}updateDamage(){let t=this.texture.frameTotal-1,e=t-Math.trunc(t*(this.unit.health-this.unit.damage-1)/this.unit.health);e>0&&e--,this.setFrame(e)}followPath(){if(this.unit.damage>0)return!1;let t=null,e=null;if(this.unit.parent.healPaths){let i=Object.keys(this.unit.parent.healPaths);for(let s=i.length-1;s>=0;s--){let a=this.unit.parent.healPaths[i[s]];a[a.length-1].damage>0&&(t=a,e=this.unit.parent.healCurve[i[s]])}}if(null===t&&this.unit.parent.paths){let i=Object.keys(this.unit.parent.paths);if(i.length>0){let s=i.length*Math.random()<<0;t=this.unit.parent.paths[i[s]],e=this.unit.parent.curve[i[s]]}}if(this.unit.parent instanceof UnitMining&&(t=this.unit.parent.route.connectHq,e=this.unit.parent.route.curveToHq),null===t||t.length<=1)return!1;this.unit.parent=t[t.length-1],this.body.enable=!1,this.visible=!1;let i=new Phaser.Curves.Path(t[0].x,t[0].y);for(let e=1,s=t.length;e<s;e++)i.lineTo(t[e].x,t[e].y);return this.pathFollower=this.scene.add.follower(i,t[0].x,t[0].y,UnitElement.name),this.pathFollower.setTint(13421772),this.pathFollower.startFollow({duration:500*t.length,onComplete:(e,i)=>{if(this.x=this.pathFollower.x,this.y=this.pathFollower.y,this.pathFollower.destroy(!0),this.pathFollower=null,0===this.decay.timeout)return this.destroy(),!1;this.followPath()||(this.unit.gravity=t[t.length-1],this.spawn())}}),!0}spawn(){this.scene.addEvent(this.eventGravityDecay,this.decay.timeout,this),this.body.enable=!0,this.visible=!0,this.alpha=1;let t=this.scene.scaleResolution(.75*Unit.speedMax);this.rotation=Phaser.Math.RND.rotation(),this.scene.physics.velocityFromRotation(this.rotation,t,this.body.velocity);this.setAngularAcceleration(Phaser.Math.RND.between(100,300)),this.setAngularVelocity(Phaser.Math.RND.between(100,300))}static preload(t,e){t.push(UnitElement.name+"-flash"),e.push({name:UnitElement.name,size:8})}}UnitElement.name="UnitElement",UnitElement.health=8;class UnitFighter extends(unitMove(unitShoot(Unit))){constructor(t,e,i,s,a){super(t,e,i,UnitFighter.name,0,s),t.unitSprites[this.player.team.id].add(this,!0),this.startUnit({health:4*UnitElement.health,mass:1024,maxSpeed:25}),this.startShoot({enemies:this.scene.unitSprites,speed:50,range:50,damage:1,angle:2*Math.PI}),this.initMove({speed:5,turnSpeed:0}),this.startMove(t.pathCurve.getPath()),this.setAngularVelocity(300),this.damage=this.scene.add.image(e,i,"damage-4"),this.damage.halfHeight=this.damage.height;let r=this.scene.add.sprite(this.scene.cameras.main.centerX,this.scene.cameras.main.centerY,"laser");this.scene.anims.create({key:"laser",frames:this.scene.anims.generateFrameNumbers("laser"),frameRate:8,repeat:-1,yoyo:!1}),r.setOrigin(0,.5),r.anims.play("laser"),r.visible=!1,r.setOrigin(0,.5),this.laser=r,this.laser.setTint(16724787),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.damage.destroy(),this.laser.destroy(),this.stopMove(),this.stopShoot(),this.stopUnit()}event(t,e){"stop"===e&&t===this.shoot.target&&this.setShootTarget(null)}updateDamage(){let t=this.damage.texture.frameTotal-1,e=t-Math.trunc(t*(this.unit.health-this.unit.damage-1)/this.unit.health);this.damage.setFrame(e-1)}shootUnit(t){this.shoot.target.unit.damage<this.shoot.target.unit.health?this.shoot.target.unitDamage(this.shoot.damage):this.laser.visible=!1}static preload(t,e){t.push(UnitFighter.name),e.push({name:"laser",width:30,height:8}),e.push({name:"damage-4",width:16,height:4})}preUpdate(){if(this.shoot.target){this.laser.x=this.x,this.laser.y=this.y;let e=Phaser.Math.Angle.BetweenPoints(this.laser,this.shoot.target);this.laser.setRotation(e);var t=Phaser.Math.Distance.Between(this.laser.x,this.laser.y,this.shoot.target.x,this.shoot.target.y);this.laser.scaleX=t/this.laser.width}this.damage.x=this.x,this.damage.y=this.y-this.body.halfHeight-this.damage.halfHeight}}UnitFighter.name="UnitFighter";class UnitHq extends(skillProduce(skillRoute(Unit))){constructor(t,e,i,s,a){super(t,e,i,UnitHq.name,a.frame,s),t.hqSprites.add(this,!0),this.body.move=!1,this.body.immovable=!0,s.addHQ(this),this.startUnit({health:100,gravity:this,damageSize:40}),this.startRoute({range:100}),this.route.connectHq=[this],this.initProduce({delay:a.produceDelay||750}),this.startProduce(),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.player.HQ=null,this.scene.gameOver(this.player),this.scene.explode(this),this.rotateTween&&this.rotateTween.remove(),this.stopProduce(),this.stopRoute(),this.stopUnit()}updateDamage(){this.updateDamageImage(),this.scene.cameras.main.setBackgroundColor(this.player.team.bgColor),this.scene.addEvent(function(){this.scene.cameras.main.setBackgroundColor(0)},20,this)}overlap(t){this.player.team.id===t.player.team.id?this.overlapFriend(t):this.overlapEnemy(t)&&this.destroy()}removePath(t,e){delete this.paths[t.id]}addPath(t,e){if(t instanceof UnitBase){for(let t=e.length-2;t>0;t--)this.paths[e[t].id]&&delete this.paths[e[t].id];let i=!1;if(Object.keys(this.paths).forEach(function(e){let s=this.paths[e];if(s[s.length-1]instanceof UnitBase)for(let e=s.length-1;e>=0;e--)if(s[e].id===t.id)return void(i=!0)},this),i)return}this.paths[t.id]=e;let i=new Phaser.Curves.Spline(this.paths[t.id]);this.curve[t.id]=i}unitMapUpdated(t){null===t&&(this.paths={},this.curve={},this.healPaths={},this.healCurve={})}static preload(t,e){e.push({name:UnitHq.name,size:32})}}UnitHq.name="UnitHq",UnitHq.animFrameRate=30;class UnitLauncher extends(unitMove(unitShoot(Unit))){constructor(t,e,i,s,a){super(t,e,i,UnitLauncher.name,0,s),t.unitSprites[this.player.team.id].add(this,!0),this.startUnit({health:8*UnitElement.health,mass:1024,maxSpeed:15}),this.startShoot({enemies:this.scene.unitSprites,speed:500,range:75,angle:Math.PI/360*10}),this.initMove({speed:5,turnSpeed:.01}),this.startMove(t.pathCurve.getPath()),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.stopMove(),this.stopShoot(),this.stopUnit()}event(t,e){"stop"===e&&t===this.shoot.target&&this.setShootTarget(null)}updateDamage(){let t=(this.unit.health-this.unit.damage)/this.unit.health;this.setScale(t)}shootUnit(t){let e=new UnitElement(this.scene,this.x,this.y,this.player,{parent:this});e.unit.gravity=this.shoot.target,e.rotation=t,e.scene.physics.velocityFromRotation(e.rotation,600,e.body.velocity)}static preload(t,e){t.push(UnitLauncher.name)}preUpdate2(){if(this.shoot.target){this.laser.x=this.x,this.laser.y=this.y;let e=Phaser.Math.Angle.BetweenPoints(this.laser,this.shoot.target);this.laser.setRotation(e);var t=Phaser.Math.Distance.Between(this.laser.x,this.laser.y,this.shoot.target.x,this.shoot.target.y);this.laser.scaleX=t/this.laser.width}}}UnitLauncher.name="UnitLauncher";class UnitMining extends(skillProduce(skillRoute(Unit))){constructor(t,e,i,s,a){super(t,e,i,UnitMining.name,0,s),t.hqSprites.add(this,!0),this.body.move=!1,this.body.immovable=!0,this.startUnit({health:4*UnitElement.health,damage:4*UnitElement.health-UnitElement.health,damageSize:30,levelMax:a.levelMax||1}),this.startRoute({range:100}),this.initProduce({delay:a.produceDelay||750}),this.startProduce(),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.stopProduce(),this.stopRoute(),this.stopUnit()}updateDamage(){this.updateDamageImage()}damageEnemy(t){if(t instanceof UnitMissile)return;0===this.player.id&&this.unit.damage;let e=t.player;this.overlapEnemy(t)&&(e.id,this.player.id,this.setPlayer(e))}unitMapUpdated(t){if(null===t||!this.player.HQ)return this.stopProduce(),void this.scene.clearEvents(this);if(this.route.connectHq=t.findUnitPath(this.player.HQ,this),this.route.connectHq.length>0){this.startProduce(),this.produce.timeout=this.produce.delay,t.drawConnectHq(this);for(let e=this.route.sources.length-1;e>=0;e--)t.drawConnection(this,this.route.sources[e]);this.route.connectHq=this.route.connectHq.reverse(),this.route.curveToHq=new Phaser.Curves.Spline(this.route.connectHq)}}upgradeLevel(){this.unit.level++,this.unit.damage+=this.unit.health,this.unit.health*=2,this.produce.delay*=.66,this.produce.timeout=this.produce.delay,this.unit.damageImage2.setTint(this.player.color),this.unit.damageImage2.alpha=1,this.updateDamage()}static preload(t,e){e.push({name:UnitMining.name,size:30})}}UnitMining.name="UnitMining";class UnitMissile extends(unitMove(Unit)){constructor(t,e,i,s,a){super(t,e,i,UnitMissile.name,0,s),t.unitSprites[this.player.team.id].add(this,!0),this.startUnit({health:4*UnitElement.health,mass:32*UnitElement.health,maxSpeed:50}),this.initMove({speed:15,turnSpeed:.01}),this.startMove(t.pathCurve.getPath()),this.explode={range:this.scene.scaleResolution(80),damage:2*UnitElement.health},this.damage=this.scene.add.image(e,i,"damage-4"),this.damage.halfHeight=this.damage.height,this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.damage.destroy();for(let t=0,e=this.scene.unitSprites.length;t<e;t++){const e=this.scene.unitSprites[t].getChildren();for(let t=e.length-1;t>=0;t--){let i=e[t];i!==this&&i.player.team.id!==this.player.team.id&&(Phaser.Math.Distance.Squared(i.x,i.y,this.x,this.y)<=this.explode.range*this.explode.range&&i.unitDamage(this.explode.damage))}}const t=this.scene.hqSprites.getChildren();for(let e=t.length-1;e>=0;e--){let i=t[e];i.player.team.id!==this.player.team.id&&(Phaser.Math.Distance.Squared(i.x,i.y,this.x,this.y)<=this.explode.range*this.explode.range&&i.unitDamage(this.explode.damage))}this.stopMove(),this.stopUnit(),this.explodeEffect()}updateDamage(){let t=this.damage.texture.frameTotal-1,e=t-Math.trunc(t*(this.unit.health-this.unit.damage-1)/this.unit.health);this.damage.setFrame(e-1)}preUpdate(){this.damage.x=this.x,this.damage.y=this.y-this.body.halfHeight-this.damage.halfHeight}static preload(t,e){t.push(UnitMissile.name)}}UnitMissile.name="UnitMissile";class UnitPlanet extends Unit{constructor(t,e,i,s,a){super(t,e,i,UnitPlanet.name+"-"+a.name,a.frame,s),t.planets.add(this,!0),this.body.move=!1,this.body.immovable=!0,this.startUnit({health:1e3}),this.unit.sizeSquaredHalf=this.unit.sizeSquared/2,this.body.setCircle(this.width,-this.width/2,-this.width/2),this.widthSquared=this.width*this.width}overlap(t){Phaser.Math.Distance.Squared(t.x,t.y,this.x,this.y)<=this.unit.sizeSquaredHalf?t.destroy():t.unit.gravity=this}unitDamage(){}static preload(t,e){t.push(UnitPlanet.name+"-moon"),t.push(UnitPlanet.name+"-pluto"),t.push(UnitPlanet.name+"-saturn"),t.push(UnitPlanet.name+"-earth")}}UnitPlanet.name="UnitPlanet";class UnitRoute extends(skillRoute(Unit)){constructor(t,e,i,s,a){super(t,e,i,UnitRoute.name,0,s),t.hqSprites.add(this,!0),this.startUnit({health:UnitElement.health,damageSize:10}),this.startRoute({range:100}),this.updateRoutes(),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.stopRoute(),this.stopUnit()}updateDamage(){this.updateDamageImage()}unitMapUpdated(t){if(null!==t&&this.player.HQ){this.route.connectHq=t.findUnitPath(this.player.HQ,this);for(let e=this.route.sources.length-1;e>=0;e--)t.drawConnection(this,this.route.sources[e])}}static preload(t,e){t.push(UnitRoute.name)}}UnitRoute.name="UnitRoute";class UnitTurret extends(skillRoute(unitShoot(Unit))){constructor(t,e,i,s,a){super(t,e,i,UnitTurret.name,0,s),t.hqSprites.add(this,!0),this.body.move=!1,this.body.immovable=!0,this.startUnit({health:4*UnitElement.health,damageSize:30,levelMax:1,defenceFactor:1}),this.startRoute({range:100}),this.startShoot({enemies:this.scene.unitSprites,speed:50,range:50,delay:50,damage:UnitElement.health/2,angle:2*Math.PI});let r=this.scene.add.sprite(this.scene.cameras.main.centerX,this.scene.cameras.main.centerY,"laser");this.scene.anims.create({key:"laser",frames:this.scene.anims.generateFrameNumbers("laser"),frameRate:8,repeat:-1,yoyo:!1}),r.x=this.x,r.y=this.y,r.setOrigin(0,.5),r.anims.play("laser"),r.visible=!1,r.setOrigin(0,.5),this.laser=r,this.laser.setTint(16724787),this.updateRoutes(),this.on(Phaser.GameObjects.Events.DESTROY,this.destroyed)}destroyed(){this.sound("impact"),this.laser.destroy(),this.stopShoot(),this.rotateTween&&this.rotateTween.remove(),this.stopRoute(),this.stopUnit()}event(t,e){"stop"===e&&t===this.shoot.target&&this.setShootTarget(null)}updateDamage(){this.player.HQ?(this.updateDamageImage(),0===this.unit.damage?this.player.HQ.removePath(this):this.route.connectHq.length>0&&this.player.HQ.addPath(this,this.route.connectHq),this.unit.damage>0&&this.setShootTarget(null)):this.destroy()}unitMapUpdated(t){if(null!==t&&this.player.HQ)if(this.route.connectHq=t.findUnitPath(this.player.HQ,this),this.route.connectHq.length>0){this.unit.damage>0&&(this.player.HQ.addPath(this,this.route.connectHq),t.drawConnectHq(this)),t.rotating.push(this);for(let e=this.route.sources.length-1;e>=0;e--)t.drawConnection(this,this.route.sources[e])}else this.setShootTarget(null)}shootUnit(t){this.shoot.target.unit.damage<this.shoot.target.unit.health?this.shoot.target.unitDamage(this.shoot.damage):this.laser.visible&&(0===this.player.id&&this.sound("laser"),this.laser.visible=!1)}preUpdate(){if(this.shoot.target){let e=Phaser.Math.Angle.BetweenPoints(this.laser,this.shoot.target);this.laser.setRotation(e);var t=Phaser.Math.Distance.Between(this.laser.x,this.laser.y,this.shoot.target.x,this.shoot.target.y);this.laser.scaleX=t/this.laser.width}}static preload(t,e){t.push(UnitTurret.name),e.push({name:"laser",width:30,height:8})}}UnitTurret.name="UnitTurret";let withSpell=t=>(class extends t{constructor(t,e,i,s,a){super(t,e,i,s),this.spell=a,this.spell.range=this.deck.scene.unitScene.scaleResolution(this.spell.range),this.spell.rangeSquared=this.spell.range*this.spell.range}drawValidRouted(t){let e=null;this.positionGraphics.clear();for(let i=(e=t.hqSprites.getChildren()).length-1;i>=0;i--){let t=e[i];if(t.route&&t.player.team.id===this.container.deck.player.team.id&&t.route.connectHq.length>0){if(this.overSprite&&t!==this.overSprite)continue;this.positionGraphics.fillStyle(13056,1),this.positionGraphics.fillCircle(t.x,t.y,t.route.range)}}this.invalidArea.clear();for(let i=(e=t.hqSprites.getChildren()).length-1;i>=0;i--){let t=e[i];this.invalidArea.fillStyle(3342336,1),this.invalidArea.fillCircle(t.x,t.y,t.route.rangeMin)}for(let i=(e=t.planets.getChildren()).length-1;i>=0;i--){let t=e[i];this.invalidArea.fillStyle(3342336,1),this.invalidArea.fillCircle(t.x,t.y,t.width)}}selectRoute(t){if(t){const t=this.deck.scene.unitScene;this.dragTexture=t.add.renderTexture(0,0,2*this.spell.range,2*this.spell.range),this.dragTexture.setOrigin(.5),this.dragTexture.visible=!1;let e=new Phaser.GameObjects.Image(t,0,0,"sprites",this.dragIconName+".png");this.dragTexture.draw(e,this.spell.range,this.spell.range),e.destroy();let i=new Phaser.GameObjects.Graphics(t);i.fillStyle(this.spellColor,.25),i.setBlendMode(Phaser.BlendModes.SCREEN),i.fillCircle(this.spell.range,this.spell.range,this.spell.range),this.dragTexture.draw(i),i.destroy(),this.positionGraphics=t.add.graphics(),this.positionGraphics.setDepth(-2),this.invalidArea=t.add.graphics(),this.invalidArea.setDepth(-2),this.invalidArea.setBlendMode(Phaser.BlendModes.SCREEN),this.renderRoutes&&this.drawValidRouted(t),this instanceof CardTarget||this.renderDisabledArea(this.scene),this.lastX=-1,this.lastY=-1}else this.dragTexture.visible=!1,this.positionGraphics.destroy(),this.invalidArea.destroy();this.routeEnabled=t}contextMenu(t){}select(t,e){t?(e&&(this.overSprite=e),this.selectRoute(t)):(this.overSprite&&null!==this.drawLine&&(this.drawLine.destroy(),this.drawLine=null),this.selectRoute(t))}dragSpell(t,e,i){this.dragCard(e,i)}startSpell(t,e,i,s={}){this.sound("claim"),this.started=!0,this.container&&this.container.enable(!1),this.scene=t,this.spell.rangeSquared=this.spell.range*this.spell.range,this.dragSpell(t,e,i),this.duration&&t.tweens.add(Object.assign(s,{targets:this.dragTexture,duration:this.duration,alpha:0,callbackScope:this,onComplete:this.stop},this)),t.time.addEvent({delay:50,callback:this.doSpell,callbackScope:this,repeat:this.duration/50-1})}stopSpell(){this.emitter&&this.emitter.stop(),this.completed&&this.completed(),this.dragTexture.destroy(),this.started=!1}pullUnits(t,e,i=150){const s=this.scene.unitSprites[this.player.team.id].getChildren();for(let a=s.length-1;a>=0;a--){let r=s[a];Phaser.Math.Distance.Squared(r.x,r.y,t.x,t.y)<=e&&(this.targetPoint?r.unit.gravity=new Phaser.Geom.Point(this.targetPoint.x,this.targetPoint.y):r.unit.gravity=new Phaser.Geom.Point(t.x,t.y),r.unit.gravity.body={mass:i},r.unit.tint=4,r.setTint(16777215))}}}),withUnit=t=>(class extends t{constructor(t,e,i,s,a){super(t,e,i,s),this.unit=a}isValidPosition(t,e,i){return!0}cancel(){this.dragTexture.destroy()}select(t){t?(this.dragTexture=this.container.scene.unitScene.add.image(0,0,"sprites",this.dragIconName+".png"),this.dragTexture.visible=!1,this.invalidArea=this.container.scene.unitScene.add.graphics(),this.invalidArea.setDepth(-2),this.invalidArea.setBlendMode(Phaser.BlendModes.SCREEN),this.renderDisabledArea(this.container.scene)):(this.dragTexture&&(this.dragTexture.destroy(),this.dragTexture=null),this.container.scene.unitScene.pathCurve.clear(),this.invalidArea.destroy())}dragUnit(t,e,i){this.invalidArea.clear(),this.renderDisabledArea(t),this.dragCard(e,i);let s={x:e,y:i};if(e>t.level.x){let a=this.getClosestHq(t.unitScene,e,i),r=this.container.deck;t.unitScene.unitMap.drawPath(t.unitScene.pathCurve,r.player.HQ,s,a,a.x-r.player.HQ.x,(t.level.height-t.level.unit)/2)}else t.unitScene.pathCurve.clear()}getClosestHq(t,e,i){let s=this.container.deck,a=null,r=1/0;const h=t.hqSprites.getChildren();for(let t=h.length-1;t>=0;t--){let n=h[t];if(!(n instanceof UnitHq)||n.player.team.id===s.player.team.id)continue;let l=Phaser.Math.Distance.Squared(e,i,n.x,n.y);l<r&&(r=l,a=n)}return a}startUnit(t,e,i,s,a){let r=this.container.deck,h=t.pathCurve,n=this.getClosestHq(t,e,i);t.unitMap.drawPath(h,r.player.HQ,{x:e,y:i},n,n.x-r.player.HQ.x,(t.level.height-a.level.unit)/2);new s(t,e,i,this.player,{});a.unitScene.pathCurve.clear()}stopUnit(){this.dragTexture&&(this.dragTexture.destroy(),this.dragTexture=null)}});const CardTypeMove=0,CardTypeBuild=1,CardTypeSpell=2,CardTypeUnit=3;class Card{constructor(t,e,i,s){this.id=Card.id++,this.type=t,this.name=e,this.deck=i,this.player=i.player,this.dragIconName=s,this.started=!1,this.scene=i.scene}dragCard(t,e){this.dragTexture.setPosition(t,e),this.dragTexture.visible=!0}get cost(){return this.constructor.cost}renderDisabledArea(t){let e=t.level.area;this.invalidArea.fillStyle(3342336,1),this.invalidArea.fillRect(0,0,e.left,e.bottom),this.invalidArea.fillStyle(3342336,1),this.invalidArea.fillRect(e.left,0,e.right-e.margin,e.top),this.invalidArea.fillStyle(3342336,1),this.invalidArea.fillRect(0,e.bottom,e.right,e.margin),this.invalidArea.fillStyle(3342336,1),this.invalidArea.fillRect(e.right,e.top,e.margin,e.bottom)}startCard(t,e,i){return!this.started&&!this.isDisabledArea(e,i)&&(this.container.enable(!1),this.player.energy.addEnergy(-this.cost),this.costImage.visible=!1,!0)}stopCard(){this.started=!1,this.container.setCard(null),this.deck.recharge(this),this.player.fillCards()}isRouted(t,e,i){if(this.overSprite){this.container.scene.level.area.margin;let t=this.overSprite,s=Phaser.Math.Distance.Squared(t.x,t.y,e,i);if(s>t.route.rangeSquared&&s<=4*t.route.rangeSquared){let s=Phaser.Math.Angle.Between(t.x,t.y,e,i),a=new Phaser.Geom.Line(t.x,t.y,e,i),r=Phaser.Geom.Line.SetToAngle(a,t.x,t.y,s,t.route.range-2);return e=r.x2,i=r.y2,!0}}let s;for(let a=(s=t.hqSprites.getChildren()).length-1;a>=0;a--){let t=s[a];if(t.route&&Phaser.Math.Distance.Squared(t.x,t.y,e,i)<t.route.rangeMinSquared)return!1}for(let a=(s=t.planets.getChildren()).length-1;a>=0;a--){let t=s[a];if(Phaser.Math.Distance.Squared(t.x,t.y,e,i)<t.widthSquared)return!1}if(this.isDisabledArea(e,i))return!1;if(this.overSprite){let t=this.overSprite;if(Phaser.Math.Distance.Squared(t.x,t.y,e,i)<=t.route.rangeSquared)return this.lastX=e,this.lastY=i,!0;this.container.scene.level.area.margin;if(Phaser.Math.Distance.Squared(t.x,t.y,e,i)<=4*t.route.rangeSquared){let s=Phaser.Math.Angle.Between(t.x,t.y,e,i),a=new Phaser.Geom.Line(t.x,t.y,e,i),r=Phaser.Geom.Line.SetToAngle(a,t.x,t.y,s,t.route.range-2);return this.lastX=r.x2,this.lastY=r.y2,!0}return!1}for(let a=(s=t.hqSprites.getChildren()).length-1;a>=0;a--){let t=s[a];if(t.player.team.id===this.container.deck.player.team.id&&t.route&&t.route.connectHq.length>0){if(Phaser.Math.Distance.Squared(t.x,t.y,e,i)<=t.route.rangeSquared)return this.lastX=e,this.lastY=i,!0;this.container.scene.level.area.margin;if(Phaser.Math.Distance.Squared(t.x,t.y,e,i)<=4*t.route.rangeSquared){let s=Phaser.Math.Angle.Between(t.x,t.y,e,i),a=new Phaser.Geom.Line(t.x,t.y,e,i),r=Phaser.Geom.Line.SetToAngle(a,t.x,t.y,s,t.route.range-2);return this.lastX=r.x2,this.lastY=r.y2,!0}}}return!1}isDisabledArea(t,e){let i=this.container.scene.level.area;return t<i.left||t>i.right||e<i.top||e>i.bottom}isValidPosition(t,e,i){this.invalidArea.clear();let s=this.connectedToHq(t,e,i),a=[];for(let t=s.length-1;t>=0;t--){const e=s[t];(e instanceof UnitRoute||e instanceof UnitHq)&&(this.positionGraphics.fillStyle(13056,1),this.positionGraphics.fillCircle(e.x,e.y,e.route.range),a.push(e))}return a.length>0}sound(t){this.scene.audio.play(t)}contextMenu(){}static preload(t,e){t.push("card-disabled"),t.push("card-enabled"),e.push({name:"Card-costs",size:12})}}Card.id=0;class CardBase extends(withSpell(Card)){constructor(t,e){super(CardTypeBuild,t,e,CardBase.name,{range:100}),this.renderRoutes=!0,this.spellColor=65280}start(t,e,i){if(!this.isRouted(t,e,i))return this.sound("disabled"),!1;if(!this.startCard(t,this.lastX,this.lastY))return!1;this.scene=t,this.startSpell(t,this.lastX,this.lastY);let s=new UnitBase(t,this.lastX,this.lastY,this.player,{});return s.unitDamage(s.unit.health/2),this.pullUnits(this.dragTexture,2*this.spell.rangeSquared),this.stop(),!0}stop(){this.stopSpell(),this.stopCard()}drag(t,e,i,s){this.dragSpell(t,e,i),this.isRouted(s,e,i)?this.dragTexture.clearTint():this.dragTexture.setTint(6710886)}static preload(t,e){t.push(CardBase.name)}}CardBase.cost=2,CardBase.name="CardBase";class CardBoost extends(withSpell(Card)){constructor(t,e){super(CardTypeBuild,t,e,CardBoost.name,{range:75}),this.duration=3e3,this.spellColor=3407667}doRadiate(){let t=new UnitElement(this.unit.player);this.unit.doGenerateElement(t)}doSpell(){const t=this.scene.hqSprites.getChildren();for(let e=t.length-1;e>=0;e--){let i=t[e];this.player===i.player&&(Phaser.Math.Distance.Squared(i.x,i.y,this.dragTexture.x,this.dragTexture.y)<=this.spell.rangeSquared&&i.produce&&-1===this.boostUnits.indexOf(i)&&(this.boostUnits.push(i),i.produce.timeout/=4))}}start(t,e,i){return!!this.startCard(t,e,i)&&(this.startSpell(t,e,i),this.boostUnits=[],!0)}stop(){this.boostUnits&&this.boostUnits.forEach(function(t){t.produce.timeout*=4},this),this.stopSpell(),this.stopCard()}drag(t,e,i){this.dragSpell(t,e,i)}static preload(t,e){t.push(CardBoost.name)}}CardBoost.name="CardBoost",CardBoost.cost=4;class CardDestroy extends(withSpell(Card)){constructor(t,e){super(CardTypeSpell,t,e,CardDestroy.name,{range:50}),this.duration=500,this.spellColor=16711680}static preload(t,e){t.push(CardDestroy.name),t.push("bullet")}doSpell(){for(let t=this.scene.unitSprites.length-1;t>=0;t--){if(this.player.team.id===t)continue;let e=this.scene.unitSprites[t].getChildren();for(let t=e.length-1;t>=0;t--){let i=e[t];Phaser.Math.Distance.Squared(i.x,i.y,this.dragTexture.x,this.dragTexture.y)<=this.spell.rangeSquared&&i.destroy()}}const t=this.scene.hqSprites.getChildren();for(let e=t.length-1;e>=0;e--){let i=t[e];i.player.team.id!==this.container.deck.player.team.id&&(i.route&&Phaser.Math.Distance.Squared(i.x,i.y,this.dragTexture.x,this.dragTexture.y)<=this.spell.rangeSquared&&i.clearRoutes())}}start(t,e,i){return!!this.startCard(t,e,i)&&(this.scene=t,this.startSpell(t,e,i),this.emitter=t.add.particles("sprites","bullet.png").createEmitter({x:e,y:i,blendMode:"SCREEN",scale:{start:1,end:0},speed:{min:t.scaleResolution(-50),max:t.scaleResolution(50)},quantity:1,alpha:{start:1,end:0},emitZone:{source:new Phaser.Geom.Circle(0,0,this.spell.range),type:"edge",quantity:30}}),!0)}stop(){this.stopSpell(),this.stopCard()}drag(t,e,i){this.dragSpell(t,e,i)}}CardDestroy.name="CardDestroy",CardDestroy.cost=3;class CardFighter extends(withUnit(Card)){constructor(t,e){super(CardTypeUnit,t,e,"CardTarget",{})}start(t,e,i,s){return!!this.startCard(t,e,i)&&(this.startUnit(t,e,i,Unit.Type.Fighter,s),this.stop(),!0)}stop(){this.stopUnit(),this.stopCard()}drag(t,e,i){this.dragUnit(t,e,i)}static preload(t,e){t.push(CardFighter.name)}}CardFighter.cost=5,CardFighter.name="CardFighter";class CardFreeze extends(withSpell(Card)){constructor(t,e){super(CardTypeSpell,t,e,CardFreeze.name,{range:100}),this.duration=5e3,this.spellColor=3355596}doSpell(){for(let t=0,e=this.scene.unitSprites.length;t<e;t++){const e=this.scene.unitSprites[t].getChildren();for(let t=e.length-1;t>=0;t--){let i=e[t];if(Phaser.Math.Distance.Squared(i.x,i.y,this.dragTexture.x,this.dragTexture.y)<=this.spell.rangeSquared){let t=-.2;i.body.velocity.x+=i.body.velocity.x*t,i.body.velocity.y+=i.body.velocity.y*t,i.body.angularVelocity-=i.body.angularVelocity*t,i.unit.freeze=1}}}}start(t,e,i){if(!this.startCard(t,e,i))return!1;if(this.isDisabledArea(e,i))return!1;this.scene=t,this.startSpell(t,e,i),this.emitter=t.add.particles("sprites",CardFreeze.name+"-snowflake.png").createEmitter({x:e,y:i,blendMode:"SCREEN",scale:{start:1,end:0},speed:{min:t.scaleResolution(-50),max:t.scaleResolution(50)},quantity:5,frequency:100,lifespan:{min:1500,max:2e3},maxParticles:100,rotate:{min:-180,max:180},alpha:{start:1,end:0}});let s={source:new Phaser.Geom.Circle(0,0,this.spell.range),type:"random",quantity:1};return this.emitter.setEmitZone(s),!0}stop(){this.stopSpell(),this.stopCard()}drag(t,e,i){this.dragSpell(t,e,i)}static preload(t,e){t.push(CardFreeze.name),t.push(CardFreeze.name+"-snowflake")}}CardFreeze.name="CardFreeze",CardFreeze.cost=1;class CardGravity extends(withSpell(Card)){constructor(t,e){super(CardTypeSpell,t,e,CardGravity.name,{range:100}),this.duration=5e3,this.gravityForce=e.scene.unitScene.scaleResolution(100),this.spellColor=16711680}doSpell(){for(let t=0,e=this.scene.unitSprites.length;t<e;t++){const e=this.scene.unitSprites[t].getChildren();for(let t=e.length-1;t>=0;t--){let i=e[t];if(Phaser.Math.Distance.Squared(i.x,i.y,this.dragTexture.x,this.dragTexture.y)<=this.spell.rangeSquared){let t=Phaser.Math.Angle.Between(i.x,i.y,this.dragTexture.x,this.dragTexture.y);i.rotation=t,this.scene.physics.accelerateTo(i,this.dragTexture.x,this.dragTexture.y,this.gravityForce)}}}}start(t,e,i){if(!this.startCard(t,e,i))return!1;this.scene=t,this.startSpell(t,e,i),this.emitter=t.add.particles("sprites","pointer.png").createEmitter({blendMode:"SCREEN",scale:{start:1,end:0},speed:{min:t.scaleResolution(-50),max:t.scaleResolution(50)},moveToX:e,moveToY:i,quantity:5,frequency:500,lifespan:{min:1500,max:2e3},maxParticles:100,rotate:{min:-180,max:180},alpha:{start:1,end:0}});let s={source:new Phaser.Geom.Circle(this.dragTexture.x,this.dragTexture.y,this.spell.range),type:"random",quantity:2};return this.emitter.setEmitZone(s),!0}stop(){this.stopSpell(),this.stopCard()}drag(t,e,i){this.dragSpell(t,e,i)}static preload(t,e){t.push(CardGravity.name)}}CardGravity.name="CardGravity",CardGravity.cost=2;class CardLauncher extends(withUnit(Card)){constructor(t,e){super(CardTypeUnit,t,e,"CardTarget",{})}start(t,e,i,s){return!!this.startCard(t,e,i)&&(this.startUnit(t,e,i,Unit.Type.Launcher,s),this.stop(),!0)}stop(){this.stopUnit(),this.stopCard()}drag(t,e,i){this.dragUnit(t,e,i)}static preload(t,e){t.push(CardLauncher.name)}}CardLauncher.cost=5,CardLauncher.name="CardLauncher";class CardLevel extends(withSpell(Card)){constructor(t,e){super(CardTypeSpell,t,e,CardLevel.name,{range:50}),this.duration=2500,this.spellColor=6710886,this.boostUnits=[]}doSpell(){}start(t,e,i){if(!this.startCard(t,e,i))return!1;this.scene=t,this.startSpell(t,e,i),this.emitter=t.add.particles("sprites","bullet.png").createEmitter({x:e,y:i,blendMode:"SCREEN",moveToX:e,moveToY:i,scale:{start:1,end:0},speed:{min:t.scaleResolution(-10),max:t.scaleResolution(10)},quantity:3,alpha:{start:1,end:0}});let s={source:new Phaser.Geom.Circle(0,0,this.spell.range),type:"random",quantity:10};this.emitter.setEmitZone(s),this.pullUnits(this.dragTexture,2*this.spell.rangeSquared);const a=this.scene.hqSprites.getChildren();for(let t=a.length-1;t>=0;t--){let e=a[t];Phaser.Math.Distance.Squared(e.x,e.y,this.dragTexture.x,this.dragTexture.y)<=this.spell.rangeSquared&&e.player.id===this.deck.player.id&&(e.unit.level&&e.unit.level<e.unit.levelMax?e.upgradeLevel&&e.upgradeLevel():(e.unit.damage-=e.unit.damage/2,e.updateDamageImage(),e.produce&&-1===this.boostUnits.indexOf(e)&&(this.boostUnits.push(e),e.produce.timeout=e.produce.delay/2)))}return!0}stop(){this.boostUnits&&this.boostUnits.forEach(function(t){t.produce.timeout=t.produce.delay},this),this.boostUnits=[],this.stopSpell(),this.stopCard()}drag(t,e,i){this.dragSpell(t,e,i)}isValidPosition(t,e,i){const s=t.hqSprites.getChildren();for(let t=s.length-1;t>=0;t--){let e=s[t];if(Phaser.Math.Distance.Squared(e.x,e.y,this.dragTexture.x,this.dragTexture.y)<=this.spell.rangeSquared&&e.player.id===this.deck.player.id&&e.produce)return!0}return!1}static preload(t,e){t.push(CardLevel.name)}}CardLevel.name="CardLevel",CardLevel.cost=4;class CardMine extends(withSpell(Card)){constructor(t,e){super(CardTypeMove,t,e,CardMine.name,{range:50}),this.spellColor=16711935,this.baseDistance=e.scene.unitScene.scaleResolution(25)}start(t,e,i){let s=this.isValidPosition(t,e,i);if(!s)return;if(e=s.sprite.x,i=s.sprite.y,!this.startCard(t,e,i))return!1;this.scene=t,this.startSpell(t,e,i);let a=this.scene.addUnitSprite(new UnitMine(this.container.deck.player,1,2),e,i);a.unit.damage=a.unit.health,a.start(),this.base=a;const r=this.scene.hqSprites.getChildren();for(let t=r.length-1;t>=0;t--){let e=r[t];e.player.team.id===this.container.deck.player.team.id&&e!==a&&(Phaser.Math.Distance.Squared(e.x,e.y,this.dragTexture.x,this.dragTexture.y)<=e.route.rangeSquared&&e.addRoute(a))}return a.unit.mining=s,s.mining=a.unit,this.stop(),!0}stop(){this.stopSpell(),this.stopCard()}isValidPosition(t,e,i){this.invalidArea.clear();let s=null;const a=this.container.scene.unitScene.planets.getChildren();for(let r=a.length-1;r>=0;r--){let h=a[r];if(h.unit instanceof UnitMineComplex&&null===h.unit.mining)if(-1===e){let e=this.connectedToHq(t,h.x,h.y);this.positionGraphics.fillStyle(e.length>0?13056:3342336),this.positionGraphics.fillCircle(h.x,h.y,this.spell.range)}else if(-1===e||Phaser.Math.Distance.Squared(h.x,h.y,e,i)<=this.spell.rangeSquared){let i=this.connectedToHq(t,h.x,h.y);for(let t=i.length-1;t>=0;t--){const a=i[t].sprite;(-1===e||Phaser.Math.Distance.Squared(h.x,h.y,a.x,a.y)<=a.route.rangeSquared)&&(this.positionGraphics.fillStyle(13056,1),this.positionGraphics.fillCircle(h.x,h.y,this.spell.range),s=h.unit)}}}return s}drag(t,e,i,s){let a=this.isValidPosition(s,e,i);a?(e=a.sprite.x,i=a.sprite.y,this.dragTexture.clearTint()):this.dragTexture.setTint(6710886),this.dragSpell(t,e,i)}static preload(t,e){t.push(CardMine.name)}}CardMine.name="CardMine",CardMine.cost=5;class CardMissile extends(withUnit(Card)){constructor(t,e){super(CardTypeUnit,t,e,CardMissile.name,{}),this.duration=3e3}start(t,e,i,s){return!!this.startCard(t,e,i)&&(this.startUnit(t,e,i,Unit.Type.Missile,s),this.stop(),!0)}stop(){this.stopUnit(),this.stopCard()}drag(t,e,i){this.dragUnit(t,e,i)}static preload(t,e){t.push(CardMissile.name)}}CardMissile.cost=3,CardMissile.name="CardMissile";class CardPoison extends(withSpell(Card)){constructor(t,e){super(CardTypeSpell,t,e,CardPoison.name,{range:60}),this.duration=3e3,this.spellColor=13382451}doSpell(){for(let t=this.scene.unitSprites.length-1;t>=0;t--){if(this.player.team.id===t)continue;let e=this.scene.unitSprites[t].getChildren();for(let t=e.length-1;t>=0;t--){let i=e[t];Phaser.Math.Distance.Squared(i.x,i.y,this.dragTexture.x,this.dragTexture.y)<=this.spell.rangeSquared&&i.unitDamage(.15)}}}start(t,e,i){if(!this.startCard(t,e,i))return!1;this.scene=t,this.startSpell(t,e,i),this.emitter=t.add.particles("sprites","bullet.png").createEmitter({x:e,y:i,blendMode:"SCREEN",scale:{start:1,end:0},speed:{min:t.scaleResolution(-50),max:t.scaleResolution(50)},quantity:2,alpha:{start:1,end:0}});let s={source:new Phaser.Geom.Circle(0,0,this.spell.range),type:"random",quantity:1};return this.emitter.setEmitZone(s),!0}stop(){this.stopSpell(),this.stopCard()}drag(t,e,i){this.dragSpell(t,e,i)}static preload(t,e){t.push(CardPoison.name),t.push("bullet")}}CardPoison.cost=2,CardPoison.name="CardPoison";class CardRoute extends(withSpell(Card)){constructor(t,e){super(CardTypeBuild,t,e,CardRoute.name,{range:100}),this.renderRoutes=!0,this.spellColor=16711935,this.drawLine=null,this.duration=0}start(t,e,i){if(!this.isRouted(t,e,i))return this.sound("disabled"),!1;if(!this.startCard(t,this.lastX,this.lastY))return!1;this.scene=t,this.startSpell(t,this.lastX,this.lastY);new UnitRoute(t,this.lastX,this.lastY,this.player,{});return this.pullUnits(this.dragTexture,2*this.spell.rangeSquared),this.stop(),!0}stop(){this.stopSpell(),this.stopCard()}drag(t,e,i,s){this.isRouted(s,e,i)?(this.overSprite&&(null===this.drawLine&&(this.drawLine=s.add.line(0,0,this.overSprite.x,this.overSprite.y,this.lastX,this.lastY,16711680),this.drawLine.setOrigin(0)),this.drawLine.setTo(this.overSprite.x,this.overSprite.y,this.lastX,this.lastY)),this.dragTexture.clearTint(),this.dragSpell(t,this.lastX,this.lastY)):this.dragTexture.setTint(6710886)}contextMenu(t,e){this.contextSprite=t?e:null}static preload(t,e){t.push(CardRoute.name)}}CardRoute.name="CardRoute",CardRoute.cost=1;class CardTarget extends(withSpell(Card)){constructor(t,e,i,s){super(CardTypeMove,t,e,CardTarget.name,{range:5}),this.x=i,this.y=s,this.duration=1e3,this.spellColor=3355392,this.moveTexture=this.scene.unitScene.add.renderTexture(0,0,this.scene.level.width,this.scene.level.height),this.active=!1,this.select(!0)}static preload(t,e){t.push(CardTarget.name),t.push("pointer")}doSpell(){const t=this.scene.unitSprites[this.player.team.id].getChildren();for(let e=t.length-1;e>=0;e--){let i=t[e];Phaser.Geom.Rectangle.ContainsPoint(this.rect,i)&&(i.unit.gravity=this.targetPoint,i.unit.gravity.body={mass:200})}}start(t,e,i){this.targetPoint=new Phaser.Geom.Point(e,i),this.moveTexture.visible=!1,this.dragTexture.visible=!1,this.dragCard(e,i),this.scene=t,this.scene=t,this.spell.rangeSquared=this.spell.range*this.spell.range,this.dragSpell(t,e,i),this.started=!0,t.tweens.add(Object.assign({},{targets:this.dragTexture,duration:this.duration,alpha:0,callbackScope:this,onComplete:this.stop},this)),t.time.addEvent({delay:50,callback:this.doSpell,callbackScope:this,repeat:this.duration/50-1}),this.emitter=t.add.particles("sprites","pointer.png").createEmitter({blendMode:"SCREEN",scale:{start:1,end:0},speed:{min:t.scaleResolution(-50),max:t.scaleResolution(50)},moveToX:e,moveToY:i,quantity:2,frequency:500,lifespan:{min:1500,max:2e3},maxParticles:100,rotate:{min:-180,max:180},alpha:{start:1,end:0}});let s={source:this.rect,type:"random",quantity:2};return this.emitter.setEmitZone(s),this.gravityPosition={sprite:{x:e,y:i}},!0}stop(){this.stopSpell(),this.started=!1,this.dragTexture.destroy(),delete this.rect,this.moveTexture.destroy()}completed(){}activate(t,e){this.active=!0,this.rect=new Phaser.Geom.Rectangle(this.x,this.y,t-this.x,e-this.y),this.rect.width<0&&(this.rect.x+=this.rect.width,this.rect.width=-this.rect.width),this.rect.height<0&&(this.rect.y+=this.rect.height,this.rect.height=-this.rect.height)}drag(t,e,i){if(this.dragSpell(this.moveTexture.scene,this.x,this.y),this.moveTexture.clear(),-1===e)return;let s=new Phaser.GameObjects.Graphics(this.moveTexture.scene);s.fillStyle(this.spellColor,.5),s.setBlendMode(Phaser.BlendModes.SCREEN);Phaser.Math.Distance.Between(e,i,this.x,this.y);s.fillRect(this.x,this.y,e-this.x,i-this.y),this.moveTexture.draw(s),s.destroy(),this.dragSpell(t,e,i)}}CardTarget.name="CardTarget",CardTarget.cost=0,CardTarget.type=CardTypeMove;class CardTurret extends(withSpell(Card)){constructor(t,e){super(CardTypeBuild,t,e,CardTurret.name,{range:100}),this.renderRoutes=!0,this.spellColor=65280}start(t,e,i){if(!this.isRouted(t,e,i))return this.sound("disabled"),!1;if(!this.startCard(t,this.lastX,this.lastY))return!1;this.scene=t,this.startSpell(t,this.lastX,this.lastY);let s=new UnitTurret(t,this.lastX,this.lastY,this.player,{});return s.unitDamage(s.unit.health/2),this.pullUnits(this.dragTexture,2*this.spell.rangeSquared),this.stop(),!0}stop(){this.stopSpell(),this.stopCard()}drag(t,e,i,s){this.dragSpell(t,e,i),this.isRouted(s,e,i)?this.dragTexture.clearTint():this.dragTexture.setTint(6710886)}static preload(t,e){t.push(CardTurret.name)}}CardTurret.cost=3,CardTurret.name="CardTurret";class Audio{constructor(t){this.scene=t,this.scene.load.audio("sfx",["audio/space.ogg"],{instances:4}),this.soundMarkers=[{name:"laser",start:0,duration:.2,started:0},{name:"claim",start:.2,duration:.3,started:0},{name:"lose",start:.5,duration:.2,started:0},{name:"disabled",start:.7,duration:.3,started:0},{name:"impact",start:1,duration:.3,started:0}],this.sounds={laser:this.soundMarkers[0],claim:this.soundMarkers[1],lose:this.soundMarkers[2],disabled:this.soundMarkers[3],impact:this.soundMarkers[4]}}play(t){let e=this.scene.time.now+1e3;this.sounds[t]&&this.sounds[t].started<e&&(this.sounds[t].started=e,this.scene.sound.play("sfx",this.sounds[t]))}}class Bullet extends Phaser.Physics.Arcade.Sprite{constructor(t,e,i,s){super(t,e.x,e.y,"bullet"),this.degenerateTimer=this.scene.time.addEvent({delay:500,callback:function(){this.destroy()},callbackScope:this}),this.unit={source:e,fireDamage:s},this.unit.sprite=this,this.unit.overlap=this.overlap}fireXY(t,e){let i=200*this.scene.game.resolution;this.scene.physics.moveTo(this,t,e,i)}overlap(t){t.unitDamage(100)>0&&this.destroy()}}class CardContainer extends Phaser.GameObjects.Container{constructor(t,e,i,s){super(t,e,i),this.origX=e,this.origY=i,t.add.existing(this),this.containerImage=t.add.image(0,0,"sprites","card-disabled.png"),this.setSize(this.containerImage.width,this.containerImage.height),this.add(this.containerImage),this.visible=!0,this.active=!1,this.deck=s,this.sprite=null}setCard(t){if(null===t){for(;this.getAt(1);)this.removeAt(1,!0);this.card=null}else this.card=t,this.add(new Phaser.GameObjects.Image(this.scene,0,0,"sprites",this.card.name+".png")),this.card.container=this,this.card.costImage=this.scene.add.image(this.width/2,this.height/2,"Card-costs",this.card.cost),this.card.costImage.x-=this.card.costImage.width/2,this.card.costImage.y-=this.card.costImage.height/2,this.add(this.card.costImage),this.card.costImage.visible=!0;this.active=null!==t}enabled(){return this.deck.energyValue>=this.card.cost}enable(t){this.input&&this.input.enabled===t||t&&this.card.started||(this.containerImage.setTexture("sprites",t?"card-enabled.png":"card-disabled.png"),t?(this.setInteractive(),this.scene.input.setDraggable(this)):this.disableInteractive())}select(t,e){this.card&&this.card.select(t,e),t?this.x+=this.width/5:this.x-=this.width/5}}class CardDeck extends Phaser.GameObjects.Group{constructor(t,e,i){super(t),this.player=e,this.cards=[Card.Type.Route,Card.Type.Base,Card.Type.Turret,Card.Type.Freeze,Card.Type.Poison,Card.Type.Level,Card.Type.Missile,Card.Type.Gravity,Card.Type.Destroy,Card.Type.Fighter,Card.Type.Launcher],this.drawDeck=[],this.discardDeck=[],i>=0||(i=this.cards.length);for(let t=i-1;t>=0;t--){let e=new this.cards[t](this.cards[t].name,this);this.drawDeck.push(e)}i>CardDeck.maxCards&&Phaser.Utils.Array.Shuffle(this.drawDeck),i>CardDeck.maxCards&&(i=CardDeck.maxCards);for(let e=0;e<i;e++){let e=new CardContainer(t,0,0,this);this.add(e)}this.children.each(function(t){t.deck=this},this),this.energyValue=0}update(t){t>=0&&(this.energyValue=t),this.children.each(function(t){let e=t.card;e&&(this.energyValue>=e.cost?t.enable(!0):t.enable(!1))},this)}getRandom(t,e,i){let s=[];Object.entries(t).forEach(function(t){for(let e=0;e<this.getChildren().length;e++){let i=this.getChildren()[e].card;if(i&&i instanceof t[1])return}s.push(t)},this);let a=Phaser.Math.Between(0,s.length-1);return s[a]}drawCard(t){let e;switch(Math.trunc(this.getChildren().indexOf(t))){case 0:case 1:case 2:e=1;break;case 3:case 4:case 5:e=2;break;case 6:e=3}let i=this.drawDeck.pop();for(;i.type!==e;)this.recharge(i),i=this.drawDeck.pop();return i}recharge(t){this.drawDeck.unshift(t)}}CardDeck.maxCards=7;class CardEnergy extends Phaser.Physics.Arcade.Image{constructor(t,e,i,s,a){super(t,e,i,CardEnergy.name),this.deck=s,t.add.existing(this),this.value=a.energyValue>=0?a.energyValue:CardEnergy.InitialEnergy,this.deck.update(this.value),this.tick=0;let r=a.energyDelay>=0?a.energyDelay:CardEnergy.TickDelay;r>0&&(this.timer=this.scene.time.addEvent({delay:r,callback:function(){this.tick<9?(this.setFrame(this.tick),this.tick++):this.addEnergy(1)&&(this.tick=0,this.setFrame(this.tick))},args:[],callbackScope:this,loop:!0,repeat:0,startAt:0,timeScale:1,paused:!1})),this.valueImage=this.scene.add.image(e,i,CardEnergy.name+"Digit",this.value)}energy(){return this.value}addEnergy(t){let e=this.value<9;return this.value+=t,this.value>9&&(this.value=9),this.valueImage.setFrame(this.value),this.deck.update(this.value),e}stop(){this.timer&&(this.timer.paused=!0)}static preload(t,e){e.push({name:CardEnergy.name,size:36}),e.push({name:CardEnergy.name+"Digit",size:16})}}CardEnergy.name="CardEnergy",CardEnergy.InitialEnergy=6,CardEnergy.TickDelay=312.5;const LEVEL_SIZE=1;Card.Type={Target:CardTarget,Turret:CardTurret,Base:CardBase,Level:CardLevel,Boost:CardBoost,Gravity:CardGravity,Poison:CardPoison,Destroy:CardDestroy,Freeze:CardFreeze,Missile:CardMissile,Fighter:CardFighter,Route:CardRoute,Launcher:CardLauncher};class CardScene extends Phaser.Scene{constructor(t,e){super({key:t}),this.gameEvent=e}init(){this.cameras.main.roundPixels=!0,this.isDragging=!1,this.selectedCard=null,this.selectedAction=null,this.winnerTeam=null}preload(){this.load.path=this.registry.get("path");let t=this.scene.get("LoaderScene"),e=[],i=[];CardEnergy.preload(e,i),Object.entries(Card.Type).forEach(function(t){t[1].preload&&t[1].preload(e,i)}),Card.preload(e,i),LevelFactory.preload(e,i),t.loadImages(this,e),t.loadSpritesheets(this,i),this.audio=new Audio(this)}create(t){this.scene.sendToBack(),this.input.setTopOnly(!0);let e=1*t.layout.w,i=t.layout.h,s=20*this.game.resolution;this.level=this.registry.get("level");let a=32*this.level.grid.size;Object.assign(this.level,{size:a,zoom:e/(s*a),unit:s,width:s*a,height:s*a*i/e,x:1===LEVEL_SIZE?3*s:6*s}),this.level.area={margin:s,top:s,left:2*s,right:this.level.width-s,bottom:this.level.height-s},this.zoom=1,this.gamepad=null,this.gamepadTimeout=0;let r="UnitScene";this.scene.get(r)||this.scene.add(r,new UnitScene(r,this));let h=this.scene.get(r);this.unitScene=h,this.unitScene.audio=this.audio,this.scene.run(h,this.level)}readyToStart(){this.level;this.levelFactory=new LevelFactory(this,this.unitScene,this.level),this.zoomUnitScene(this.level.width/2,this.level.height/2,0),this.input.on("drag",this.onDrag,this),this.input.on("gameobjectdown",this.onGameobjectdown,this),this.input.on("pointerup",this.onPointerup,this),this.input.on("pointerdown",this.onPointerdown,this),this.input.on("pointermove",this.onMove,this),this.input.on("gameout",this.onGameout,this),this.input.dragTimeThreshold=500,this.input.mouse&&(this.input.on("wheel",function(t,e,i,s,a){s<0?this.zoomUnitScene(t.x/this.level.zoom,t.y/this.level.zoom,-1):s>0&&this.zoomUnitScene(t.x/this.level.zoom,t.y/this.level.zoom,1),t.event.preventDefault()},this),this.input.mouse.disableContextMenu()),this.input.gamepad.once("down",function(t,e,i){this.gamepad=t},this)}selectCancel(){if(null!==this.selectedAction)this.onGameout();else{let t=this.selectedCard;null!==this.selectedCard&&this.onGameout();let e=this.level.data.players[0].cardDeck;for(let i=e.getChildren().indexOf(t)+1;i<e.getChildren().length;i++){let t=e.getChildren()[i];if(t.input.enabled)return this.cancelUp=!0,void this.selectCard(t,null)}this.onGameout()}}update(t,e){this.input.pointer1.isUp&&this.input.pointer2.isUp&&this.selectCancel(),null!==this.gamepad&&this.gamepad.B&&t>this.gamepadTimeout&&(this.gamepadTimeout=t+150,this.selectCancel())}onGameobjectdown(t,e){this.prevPointerX=t.x,this.prevPointerY=t.y,this.isDragging=!1,this.selectedCard!==e?(null!==this.selectedCard&&this.selectCard(null),e.enabled()&&this.selectCard(e)):this.selectCard(null)}onMove(t,e){if(!(e.length>0))if(this.selectedAction&&!this.selectedAction.active){let e=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollX:0,i=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollY:0;this.isDragging=!0,this.selectedAction.drag(this,e+t.x/this.unitScene.cameras.main.zoom,i+t.y/this.unitScene.cameras.main.zoom,this.unitScene)}else if(this.selectedCard){let e=this.isDragging||Phaser.Math.Distance.Between(this.prevPointerX,this.prevPointerY,t.x,t.y);(this.isDragging||e>=this.input.dragDistanceThreshold)&&(this.onDrag(t),this.isDragging=!0)}}onDrag(t,e,i,s){if(this.isDragging=!0,this.selectedCard){if(!this.selectedCard.card.routeEnabled&&this.selectedCard.card.selectRoute&&this.selectedCard.card.selectRoute(!0),t.x===this.prevPointerX&&t.y===this.prevPointerY)return;this.prevPointerX=t.x,this.prevPointerY=t.y;let e=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollX:0,i=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollY:0;this.selectedCard.card.drag(this,e+t.x/this.unitScene.cameras.main.zoom,i+t.y/this.unitScene.cameras.main.zoom,this.unitScene)}}onPointerdown(t,e){if(t.rightButtonDown())return void this.selectCancel();if(this.prevPointerX=t.x,this.prevPointerY=t.y,e.length>0)return void this.selectedAction;let i=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollX:0,s=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollY:0;if(!this.selectedCard&&0===e.length){if(this.selectedAction)return this.selectedAction.active?(this.selectedAction.start(this.unitScene,i+t.x/this.unitScene.cameras.main.zoom,s+t.y/this.unitScene.cameras.main.zoom,this,this.unitScene),this.selectedAction=null,void(this.isDragging=!1)):void(this.isDragging=!1);let e=this.unitScene.getSpritesAt(i+t.x/this.unitScene.cameras.main.zoom,s+t.y/this.unitScene.cameras.main.zoom);for(let t=e.length-1;t>=0;t--)if(e[t].player===this.level.data.players[0]&&e[t].route){let i=this.level.data.players[0].cardDeck.getChildren()[0];return void(i&&i.input&&i.input.enabled&&this.selectCard(i,e[t]))}this.selectedAction=new CardTarget(CardTarget.name,this.level.data.players[0].cardDeck,i+t.x/this.unitScene.cameras.main.zoom,s+t.y/this.unitScene.cameras.main.zoom)}null!==this.winnerTeam&&(this.winnerTeam.id,this.input.enabled=!1,this.unitScene.children.each(function(t){t.destroy(!0)}),this.children.each(function(t){t.destroy(!0)}),this.gameEvent.emit(GameEvent.nextLevel)),this.isDragging=!1}onGameout(t,e){null!==this.selectedCard&&this.selectCard(null),null!==this.selectedAction&&(this.selectedAction.stop(),this.selectedAction=null)}onPointerup(t,e){if(this.cancelUp)return void(this.cancelUp=!1);let i=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollX:0,s=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollY:0;if(null!==this.selectedCard){if(t.x<this.level.area.left)return this.isDragging?void this.selectCard(null):void(this.isDragging=!0);let e=this.selectedCard.card;this.selectCard(null);{let i=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollX:0,s=1===this.unitScene.cameras.main.zoom?this.unitScene.cameras.main.scrollY:0;e.start(this.unitScene,i+t.x/this.unitScene.cameras.main.zoom,s+t.y/this.unitScene.cameras.main.zoom,this,this.unitScene)}}else!this.isDragging&&t.upTime-t.downTime<150?this.selectedAction&&(this.selectedAction.stop(),this.selectedAction=null):null!==this.selectedAction&&(this.selectedAction.active||this.selectedAction.activate(i+t.x/this.unitScene.cameras.main.zoom,s+t.y/this.unitScene.cameras.main.zoom,this.isDragging))}selectCard(t,e){t!==this.selectedCard&&(null!==this.selectedCard&&this.selectedCard.select(!1,e),this.selectedCard=t,null!==this.selectedCard&&this.selectedCard.select(!0,e))}zoomUnitScene(t,e,i){let s=(1-this.level.zoom)/5;i<0?this.zoom+=s:i>0?this.zoom-=s:(this.zoom=this.level.zoom,t=this.level.width/2,e=this.level.height/2),this.zoom<this.level.zoom&&(this.zoom=this.level.zoom,t=this.level.width/2,e=this.level.height/2),this.zoom>1&&(this.zoom=1),t=this.level.width/2,e=this.level.height/2,this.unitScene.zoomTo(t,e,this.zoom)}gameOver(t){let e;e=0!==t.id?"YOU WIN":"YOU LOSE",this.winnerTeam||(this.winnerTeam=e,this.input.enabled=!1,this.children.each(function(t){t.destroy(!0)}),this.cameras.main.fadeOut(2e3,255,255,255,function(t,e){1===e&&(this.unitScene.destroyed(),"YOU WIN"===this.winnerTeam?this.gameEvent.emit(GameEvent.nextLevel):this.gameEvent.emit(GameEvent.restartLevel))},this),this.time.removeAllEvents(),this.selectedCard&&this.selectedCard.card.stop(),this.level.data.players.forEach(function(t){t.gameOver()},this))}}class GameEvent extends Phaser.Events.EventEmitter{constructor(){super()}static get play(){return"play"}static get gameOver(){return"gameOver"}static get nextLevel(){return"nextLevel"}static get skill(){return"skill"}}class LevelFactory{constructor(t,e,i){this.cardScene=t,this.unitScene=e,this.level=i,this.createPlayerTeams(t,e,i),this.AIs=[],this.level.data.players.forEach(function(t){if(this.level.players[t.id].ai){let e=new AIgravity(t,this.unitScene,this.level,this.level.data.playerTeams,this.level.data.players);this.AIs.push(e)}},this),this.AIs.length>0&&(this.aiTimer=this.unitScene.time.addEvent({delay:50,callback:function(){for(let t=0,e=this.AIs.length;t<e;t++)this.AIs[t].play()},callbackScope:this,loop:!0}));let s=i.tutorial;s&&e.showGameOver(s.text,s.x,s.y,1500,s.hand,this.dx,this.dy),log("LevelFactory done")}createPlayerTeams(t,e,i){let s=i.width/i.grid.x,a=Math.round(i.height/i.grid.y),r=Math.round(s/2),h=Math.round(a/2);this.dx=s,this.dy=a,this.dx2=r,this.dy2=h,i.data.playerTeams=[],i.data.players=[];let n=-1;for(let t=0;t<i.players.length;t++)i.data.players[t]=new Player(t,this.cardScene,this.unitScene,i,i.players),i.players[t].team>=0?n=i.players[t].team:n++,i.data.playerTeams[n]||(i.data.playerTeams[n]=new PlayerTeam(n,this.cardScene,this.unitScene)),i.data.playerTeams[n].addPlayer(i.data.players[t]);for(let t=0;t<i.players.length;t++){let e=i.players[t],s=i.data.players[t];this.createUnits(e.hq,UnitHq,s),this.createUnits(e.bases,UnitBase,s),this.createUnits(e.asteroids,UnitAsteroid,s),this.createUnits(e.planets,UnitPlanet,s),this.createUnits(e.minings,UnitMining,s),this.createUnits(e.turrets,UnitTurret,s),this.createUnits(e.colonies,UnitColony,s)}i.data.players.forEach(function(s){0===s.id&&(s.fillCards(),i.players[0].hq&&i.players[0].hq.type&&s.HQ.setTexture(i.players[0].hq.type)),s.cardScene=t,s.unitScene=e},this)}createUnits(t,e,i){let s=[];if(t)for(let a=0;a<t.length;a++){let r=t[a],h=new e(this.unitScene,r.x*this.dx-this.dx2,r.y*this.dy-this.dy2,i,r);s.push(h.sprite)}return s}static preload(t,e){t.push("alice"),t.push("dialog")}}class LoaderScene extends Phaser.Scene{constructor(t){super({key:"LoaderScene",visible:!1}),this.loadProgress=0,this.levelList=t,this.version="?v="+Date.now()}loadImages(t,e){e.forEach(function(e){t!==this&&(this.cache.json.get("sprites")&&this.cache.json.get("sprites").frames[e+".png"]||t.load.image(e,"img/"+this.res+"/"+e+".png"+this.version))},this)}loadSpritesheets(t,e){e.forEach(function(e){let i=e.width?e.width:e.size,s=e.height?e.height:e.size;t.load.spritesheet(e.name,"img/"+this.res+"/"+e.name+".png"+this.version,{frameWidth:i*this.game.resolution,frameHeight:s*this.game.resolution})},this)}init(){this.cameras.main.roundPixels=!0,this.registry.set("level",localStorage.getItem("level")||"");for(let t=0;t<this.levelList.length;t++)if(this.levelList[t]===LEVEL){this.levelNo=t;break}}preload(){this.load.path=this.registry.get("path"),this.game.getImage=this.getImage,this.game.config.width>=1280?(this.res="res-hi",this.game.resolution=2):this.game.config.width>=960?(this.res="res-mid",this.game.resolution=1.5):(this.res="res-lo",this.game.resolution=1),this.game.res=this.res,this.loadImages(this,["button"]),this.load.atlas("sprites","img/"+this.res+"/sprites.png"+this.version,"img/"+this.res+"/sprites.js"+this.version)}getImage(t,e,i,s){return this.cache.json.get("sprites").frames[s+".png"]?new Phaser.GameObjects.Image(t,e,i,"sprites",s):new Phaser.GameObjects.Image(t,e,i,s)}create(){let t=24*this.game.resolution;if(this.loadProgressText=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,Text.tictactoe,{font:t+"px Source Code Pro",fill:"#000000"}).setOrigin(.5),this.cameras.main.setBackgroundColor("#ffffff"),this.levelNo||this.started)this.startGame();else{this.titleText="THE WAR OF THE PARALLEL",this.titleIndex=15;let t=24*this.game.resolution;this.title=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY/2,this.titleText.substring(0,this.titleIndex),{font:t+"px Source Code Pro",fill:"#000000"}),this.title.x-=this.title.width,this.title.setOrigin(0),this.title2=this.add.text(this.title.x,this.title.y+1.25*this.title.height,"WORLDS",{font:t+"px Source Code Pro",fill:"#000000"}),this.title2.setOrigin(0);let e=this.add.image(this.cameras.main.centerX,1.25*this.cameras.main.centerY,"sprites","button.png");this.input.once("pointerup",function(){e.destroy(),this.startGame()},this)}}startGame(){this.gameEvent=new GameEvent,this.gameEvent.on(GameEvent.nextLevel,function(){this.levelNo=this.levelNo+1,this.closeLevel()},this).on(GameEvent.restart,function(){this.closeLevel()},this);let t=this.loadProgressText;this.load.on("loadProgress",function(e){t.text=Text.loading+" "+parseInt(100*e)+" %"},this).on("complete",function(){t.text=Text.tictactoe;let e=this.cache.json.get("level/"+this.levelList[this.levelNo]);if(this.registry.set("level",e),!e.info)return this.cameras.main.fadeOut(250),this.cameras.main.fadeEffect.alpha=1,void this.time.delayedCall(250,function(){this.scene.setVisible(!1),this.nextLevel("loaded")},[],this);let i=this.title;i.y,i.height;this.time.addEvent({delay:150,callback:function(){this.title.text=this.titleText.substring(0,this.titleIndex++)},callbackScope:this,repeat:8}),this.time.addEvent({delay:2500,callback:function(){this.nextLevel("loaded"),this.scene.setVisible(!1)},callbackScope:this})},this),this.registry.set("startCounter",0),this.loadLevel()}facebookReady(){console.log("fb")}createMask(t){const e=this.make.graphics();this.maskGraphics=e,e.fillStyle(16777215,1),e.fillCircle(this.cameras.main.centerX,this.cameras.main.centerY,t);let i=e.createGeometryMask();this.cameras.main.setMask(i)}closeLevel(){this.registry.set("startCounter",parseInt(this.registry.get("startCounter"))+1),this.loadLevel(this.levelNo),this.cameras.main.fadeIn(500,255,255,255),this.tweens.add({targets:this.cameras.main,x:{value:0,duration:500,ease:Phaser.Math.Easing.Sine.Out,yoyo:!1},callbackScope:this,onComplete:function(t){this.scene.manager.scenes.forEach(function(t){t!==this&&this.scene.remove(t)},this),this.time.delayedCall(100,function(){this.nextLevel("closed")},[],this)}},this)}loadLevel(){this.levelList&&this.levelNo>=this.levelList.length||(this.registry.set("level",null),this.load.json("level/"+this.levelList[this.levelNo]),this.load.start())}nextLevel(t){(!this.levelList||this.levelNo>=this.levelList.length||"closed"===t&&this.registry.get("level")||"loaded"===t&&1===this.scene.manager.scenes.length)&&(this.levelList&&this.levelNo>=this.levelList.length?this.scene.add("GameOverScene",new GameOverScene("GameOverScene"),!0):this.scene.add("UIScene",new UIScene("UIScene",this.gameEvent),!0))}set levelNo(t){this.game.save("levelNo",t)}get levelNo(){return parseInt(this.game.restore("levelNo")||0)}}class MainGame extends Phaser.Game{constructor(t,e,i,s){if(console.log(t),super({key:"Main",type:Phaser.AUTO,parent:"canvas",width:e.offsetWidth,height:e.offsetHeight,backgroundColor:s,transparent:!1,physics:{default:"arcade",arcade:{debug:!1,fps:60}},scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH},input:{touch:{capture:!1},gamepad:!0},disableContextMenu:!0,scene:[new LoaderScene(i)]}),"fi"===document.getElementsByTagName("html")[0].getAttribute("lang")&&this.fi(),-1===window.location.href.indexOf("localhost:8383"))return this.registry.set("release",!0),this.registry.set("path","/"+t+"/");this.registry.set("debug",!0),this.registry.set("path","");let a={play:Text.play,pause:Text.pause};this.registry.set("events",a)}clear(t){window.localStorage.removeItem(t)}save(t,e){window.localStorage.setItem(t,e)}restore(t){return window.localStorage.getItem(t)}}class PathCurve{constructor(t,e){this.levelSize=e,this.points=[null,null,null],this.graphics=t.add.graphics(),this.valid=!1}drawCurve(t,e){this.graphics.lineStyle(this.levelSize/8,e[0]),t.draw(this.graphics),this.graphics.lineStyle(this.levelSize/16,e[1]),t.draw(this.graphics),this.graphics.lineStyle(this.levelSize/24,e[2]),t.draw(this.graphics)}draw(t,e,i,s,a){if(this.graphics.clear(),null===e)return!1;let r=[t,e,i],h=new Phaser.Curves.Spline(r);for(let t=0;t<10&&(h.getBounds().width>s||h.getBounds().height>a);t++)e.x>s/2?e.x--:e.x++,e.y>a/2?e.y--:e.y++,h=new Phaser.Curves.Spline(r);if(this.points=r,this.valid=!0,this.path=h,this.valid||this.drawCurve(h,[10027008,16711680,16777215]),null!==this.points[1]){let t=new Phaser.Curves.Spline(this.points);this.drawCurve(t,this.valid?[39168,65280,16777215]:[13056,26112,10066329])}return this.valid}clear(){this.graphics.clear(),this.points=[null,null,null],this.valid=!1}getPath(){return this.path}}class PathSprite extends Phaser.Physics.Arcade.Sprite{constructor(t,e,i,s){super(t,0,0,e),this.setInteractive(),t.input.setDraggable(this),this.pathIndex=0,this.pathSpeed=s,this.pathVector=new Phaser.Math.Vector2,this.path.getPoint(0,this.pathVector),this.setPosition(this.pathVector.x,this.pathVector.y)}preUpdate(t,e){this.anims.update(t,e),this.path.getPoint(this.pathIndex,this.pathVector),this.setPosition(this.pathVector.x,this.pathVector.y),this.pathIndex=Phaser.Math.Wrap(this.pathIndex+this.pathSpeed,0,1)}}const TEAM_COLOR=[975857,9638133,6710886,6684774],TEAM_COLOR_BG=[1907968,51,3342336,1900573],ROUTE_COLOR=[3355443,3355443,16777215,3355443];class Player{constructor(t,e,i,s,a){this.config=a,this.debug=!0,this.id=t,this.color=TEAM_COLOR[this.id],this.routeColor=ROUTE_COLOR[this.id],this.bgColor=TEAM_COLOR_BG[this.id],this.cardScene=e,this.unitScene=i,this.cardDeck=new CardDeck(this.cardScene,this,s.cards);let r=0===t?20*this.cardScene.game.resolution:this.cardScene.levelWidth,h=30*this.cardScene.game.resolution,n=2*h,l=0;this.cardDeck.children.each(function(t){switch(t.x=r,t.y=n,n+=h,++l){case 3:case 5:n+=Math.trunc(h/4)}},this),0!==t||0!==s.cards&&(this.width=this.cardDeck.getChildren()[0].x+this.cardDeck.getChildren()[0].width,this.energy=new CardEnergy(e,this.cardDeck.getChildren()[0].x,this.cardDeck.getChildren()[0].x,this.cardDeck,this.config[this.id]))}setTeam(t){this.team=t,this.unitScene.addTeam(this.team.id)}fillCards(){let t=this.cardDeck.getFirstDead();for(;t;){let e=this.cardDeck.drawCard(t);if(!e)break;t.setCard(e),t=this.cardDeck.getFirstDead()}this.cardDeck.update()}getCards(){return this.cardDeck}addHQ(t){this.HQ=t}gameOver(){this.energy&&this.energy.stop()}}class PlayerTeam{constructor(t,e,i){this.id=t,this.cardScene=e,this.unitScene=i,this.players=[]}addPlayer(t){this.players.push(t),t.setTeam(this)}}class PriorityQueue{constructor(){this.collection=[]}enqueue(t){if(this.isEmpty())this.collection.push(t);else{let e=!1;for(let i=1;i<=this.collection.length;i++)if(t[1]<this.collection[i-1][1]){this.collection.splice(i-1,0,t),e=!0;break}e||this.collection.push(t)}}dequeue(){return 0===this.collection.length?null:this.collection.shift()}dequeueExpired(t){return 0===this.collection.length?null:t>=this.collection[0][1]?this.collection.shift():null}isEmpty(){return 0===this.collection.length}clear(t){for(let e=this.collection.length-1;e>=0;e--)t===this.collection[e][2]&&this.collection.splice(e,1)}destroy(){this.collection=[]}}var Text={i:0,loading:"Loading",fullscreen:"Fullscreen",fi(){this.i=1,this.lang="fi",this.loading="Ladataan",this.fullscreen="Kokoruutu"}};class UIScene extends Phaser.Scene{constructor(t,e){super({key:t}),this.gameEvent=e}init(){this.cameras.main.roundPixels=!1,this.level=this.registry.get("level")}preload(){this.load.path=this.registry.get("path");let t=["button","gate-tile","gate-ring","gate-ring-bg","alice","dialog-tall","button","CardTurret","dialog"];this.level.tutorial&&this.level.tutorial.img&&t.push(this.level.tutorial.img),this.level.anim&&(t.push("shuttle"),t.push("UnitElement-flash"));let e=this.scene.get("LoaderScene");e.loadImages(this,t),e.loadSpritesheets(this,[{name:"gate-center",size:220},{name:"gate-symbols",size:25},{name:"plasma",size:32},{name:"explode",size:16}]),this.load.image("ui-bg","img/"+this.game.res+"/ui-bg.jpg")}create(){this.layout={y:0,x:0,h:this.cameras.main.height-0,w:this.cameras.main.width-0},this.scene.sendToBack();let t=this.level.intro;if(!t)return void this.startLevel();this.add.image(this.cameras.main.centerX,this.cameras.main.centerY,"ui-bg");let e=this.add.group();this.group=e;let i=e.create(this.cameras.main.width,this.cameras.main.centerY,"sprites","dialog-tall.png");i.x-=.75*i.width;let s=i.width/13;this.texSize=s;let a=this.add.text(i.x-i.width/2+s,i.y-i.height/2+s,"",{fontFamily:"Source Code Pro",fontSize:.9*s,color:"#000",wordWrap:{width:.9*i.width,useAdvancedWrap:!1}}).setOrigin(0);e.add(a);let r=0,h=this.time.addEvent({delay:75,callback:function(){for(r++;" "!==t.text[r]&&"."!==t.text[r]&&r<t.text.length;)r++;r>=t.text.length&&(r=t.text.length,h.remove()),a.text=t.text.substring(0,r)},callbackScope:this,repeat:t.text.length}),n=i.x-1.75*i.width,l=this.cameras.main.centerY;this.anims.create({key:"gate-center",frames:this.anims.generateFrameNumbers("gate-center"),frameRate:30,repeat:-1}),e.create(n,l,"gate-center").play("gate-center").alpha=.5;e.create(n,l,"sprites","gate-ring-bg.png");let o=e.create(n,l,"sprites","gate-ring.png");var d=new Phaser.Geom.Circle(0,0,o.width/2);let c=[];for(let t=0;t<24;t++)c.push(t);Phaser.Utils.Array.Shuffle(c);var u=this.add.container(o.x,o.y);e.add(u);let p=this.add.group();this.tiles=p;for(let e=0;e<24;e++){let i=p.create(0,0,"sprites","gate-tile.png");i.angle=15*e,c[e]>2*t.level&&(i.tint=6710886),u.add(i)}Phaser.Actions.PlaceOnCircle(p.getChildren(),d);let g=this.add.group();this.symbols=g;for(let e=0;e<24;e++){let i=g.create(0,0,"gate-symbols",e);i.angle=15*e,c[e]>2*t.level&&(i.tint=3355443),u.add(i)}Phaser.Actions.PlaceOnCircle(g.getChildren(),d),this.gate=u,this.symbolTween=this.tweens.add({targets:u,duration:6e4,callbackScope:this,rotation:2*Math.PI,repeat:-1},this);let m,y;this.add.group();t.icon?(m=e.create(n,.5*l,"sprites",t.icon+".png"),e.create(.75*n,.75*l,"sprites",t.icon+".png"),e.create(1.25*n,.75*l,"sprites",t.icon+".png"),y=m.height):y=(m=e.create(n,l,"sprites","alice.png")).height/2;let v=e.create(n,l+y,"sprites","dialog.png"),S=this.add.text(v.x,v.y-this.texSize/4,t.dialog,{fontFamily:"Source Code Pro",fontSize:s,color:"#000",align:"center"}).setOrigin(.5);e.add(S),this.level.intro.tobecontinued||this.time.delayedCall(2e3,function(){let t=e.create(i.x,i.y+i.height/2,"sprites","button.png");t.y-=1.25*t.height,this.input.once("pointerup",function(){this.level.intro.end?this.endAnim():(this.scene.setVisible(!1),this.startLevel())},this)},[],this)}startLevel(){if(this.level.anim)return void this.anim();this.scene.get("CardScene")||this.scene.add("CardScene",new CardScene("CardScene",this.gameEvent));let t=this.scene.get("CardScene");this.cardScene=t,this.scene.run(t,{autostart:this.registry.get("startCounter")>0,layout:this.layout}),this.registry.get("startCounter")>0&&this.gameEvent.emit(GameEvent.play,Text.start)}pointerover(t,e,i,s){}pointerout(){}pointerdown(){}pointerup(t,e,i,s){return!1}anim(){this.add.image(-this.cameras.main.centerX,this.cameras.main.centerY,"ui-bg").setScale(2),this.shuttle=this.add.image(-this.cameras.main.centerX,this.cameras.main.centerY,"sprites","shuttle.png"),this.shuttle.depth=1;let t=this.level,e=24*this.game.resolution,i=25*t.grid.size;t.width=e*i,t.height=e*i*this.layout.h/this.layout.w;let s=t.width/t.grid.x,a=Math.round(t.height/t.grid.y),r=Math.round(s/2),h=Math.round(a/2),n=this.add.particles("plasma");this.particles=n;let l=n.createEmitter(),o=t.players[1].hq[0];this.enemy=o;let d=o.x*s-r,c=o.y*a-h;l.setPosition(d,c),l.setSpeed(25*this.game.resolution),l.setLifespan(7e3),l.setBlendMode(Phaser.BlendModes.ADD),this.shuttleEmitter=n.createEmitter({x:-this.shuttle.width/2,frame:1,y:0,lifespan:200,speed:{min:200*this.game.resolution,max:300*this.game.resolution},angle:180,scale:{start:.4,end:0},quantity:2,blendMode:"ADD",follow:this.shuttle}),this.cameras.main.zoom=.5,this.cameras.main.startFollow(this.shuttle);let u=this.add.image(this.shuttle.x,this.shuttle.y,"sprites","dialog.png");this.dialog=u,u.visible=!1,u.y-=u.height;let p=u.width/5,g=0;this.t="SPACESHIP 1701:\nWe have found an unknown formation,\nsending a probe to look at it.";let m=this.t,y=this.add.text(this.cameras.main.centerX/4,0,"",{fontFamily:"Source Code Pro",fontSize:p,color:"#fff",align:"left"}).setOrigin(0);this.tweens.add({targets:y,duration:7e3,delay:1500,callbackScope:this,alpha:0},this),y.scrollFactorX=0,this.time.addEvent({delay:30,callback:function(){y.text=m.substring(0,g++)},callbackScope:this,repeat:m.length});this.time.addEvent({delay:7e3,callback:function(){this.cameras.main.zoomTo(1,5e3),this.continueAnim()},callbackScope:this});this.tweens.add({targets:this.shuttle,duration:7e3,callbackScope:this,ease:"Power1",x:.75*o.x},this)}continueAnim(){let t=this.dialog,e=0;this.t="It seems to evolve slowly,\nproceeding with caution...";let i=this.t,s=t.width/13,a=this.add.text(this.cameras.main.centerX/2,this.cameras.main.centerY/2,"",{fontFamily:"Source Code Pro",fontSize:s,color:"#fff",align:"left"});this.tweens.add({targets:a,delay:2e3,duration:5e3,callbackScope:this,alpha:0},this),a.scrollFactorX=0,this.time.addEvent({delay:10,callback:function(){a.text=i.substring(0,e++)},callbackScope:this,repeat:i.length}),this.time.addEvent({delay:3e3,callback:function(){this.shuttleEmitter.stop(),this.well=this.particles.createGravityWell({x:(this.enemy.x+this.shuttle.x)/2,y:this.shuttle.y,power:3,epsilon:100,gravity:75*this.game.resolution})},callbackScope:this});this.time.addEvent({delay:3e3,callback:function(){this.time.addEvent({delay:2200,callback:function(){this.explode(this.shuttle),this.well.active=!1},callbackScope:this})},callbackScope:this})}explode(t){this.shuttle.destroy();let e=this.add.particles("explode");e.createEmitter({frame:[2],x:t.x,y:t.y,speed:{start:this.scaleResolution(150),end:-150},quantity:5,ease:"Power2",lifespan:1500,maxParticles:50,blendMode:"SCREEN",alpha:{start:1,end:0}}),e.createEmitter({frame:[0],x:t.x,y:t.y,speed:{start:this.scaleResolution(100),end:-100},quantity:5,ease:"Power2",lifespan:1e3,maxParticles:100,blendMode:"SCREEN",alpha:{start:1,end:0}}),e.createEmitter({frame:[0],x:t.x,y:t.y,speed:{start:this.scaleResolution(75),end:-75},quantity:5,ease:"Power2",lifespan:1e3,maxParticles:50,blendMode:"SCREEN",alpha:{start:1,end:0}});e.createGravityWell({x:t.x,y:t.y,power:2,epsilon:100,gravity:this.scaleResolution(8)});this.time.addEvent({delay:5e3,callback:function(){this.level.anim=null,this.scene.restart()},callbackScope:this}),this.cameras.main.flash(1500,255,255,255),this.time.addEvent({delay:4e3,callback:function(){this.cameras.main.fadeOut(1e3,255,255,255)},callbackScope:this})}scaleResolution(t){return t*this.game.resolution}endAnim(){this.cameras.main.fadeOut(1500,255,255,255),this.time.addEvent({delay:1500,callback:function(){this.group.destroy(!0),this.cameras.main.fadeIn(1e3,255,255,255);let t=this.add.text(this.cameras.main.centerX,this.cameras.main.centerY,"Goodbye,\nmy Commander...",{fontFamily:"Source Code Pro",fontSize:this.texSize,color:"#c39"});t.setOrigin(.5),this.tweens.add({targets:t,duration:7500,alpha:0},this)},callbackScope:this}),this.symbolTween.stop(),this.tweens.add({targets:this.gate,duration:1e3,callbackScope:this,rotation:2*Math.PI,repeat:-1},this)}}class UnitMap extends Phaser.GameObjects.Graphics{constructor(t,e,i){super(t),this.level=e,t.add.existing(this),this.setDepth(-1),this.hqSprites=i,this.adjacencyList={},this.updateList=[],this.refresh(null)}refresh(t){this.updateList.length>0||(this.updateList.push(t),this.scene.addEvent(this.update,0,this))}findUnitPath(t,e){let i={},s={};this.hqSprites.getChildren().forEach(t=>{i[t]=1/0}),i[t]=0;let a=new PriorityQueue;a.enqueue([t,0]);let r=a.dequeue();for(;null!==r;){let t=r[0];if(null===t)break;for(let e=t.route.targets.length-1;e>=0;e--){let r=t.route.targets[e],h=1,n=i[t]+h;n<i[r]&&(i[r]=n,s[r]=t,a.enqueue([r,n]))}for(let e=t.route.sources.length-1;e>=0;e--){let r=t.route.sources[e],h=1,n=i[t]+h;n<i[r]&&(i[r]=n,s[r]=t,a.enqueue([r,n]))}r=a.dequeue()}let h=[e],n=e;for(;n!==t;)if(h.unshift(s[n]),!(n=s[n]))return[];return h}update(){this.updateList.pop(),this.clear();this.unconnectedSprites=[];this.connectedSprites=[];let t=this.scene.cardScene.selectedCard;t&&(t.card.select(!1),t.card.select(!0));let e=[];this.rotating=e;const i=this.hqSprites.getChildren();for(let t=i.length-1;t>=0;t--){i[t].unitMapUpdated(null)}const s=this.hqSprites.getChildren();for(let t=s.length-1;t>=0;t--){s[t].unitMapUpdated(this)}this.rotateTween&&this.rotateTween.remove(),this.rotateTween=this.scene.tweens.add({targets:e,duration:5e3,rotation:2*Math.PI,callbackScope:this,repeat:-1,onComplete:function(t){}},this)}drawPath(t,e,i,s,a,r){t.draw(e,{x:i.x,y:i.y},s,a,r)}loopTargets(t){if(!0!==t.visited){t.visited=!0;for(let e=t.route.targets.length-1;e>=0;e--){let i=t.route.targets[e];i.isConnectedToHq=!0,this.connectedArr.push(i.sprite),this.tagConnected(i)}}}drawConnectHq(t){t.route.connectHq.length}drawConnection(t,e){let i=[t,e],s=new Phaser.Curves.Spline(i);this.lineStyle(this.level.size/12,t.player.routeColor),s.draw(this)}}Unit.Type={Hq:UnitHq,Base:UnitBase,Turret:UnitTurret,Element:UnitElement,Fighter:UnitFighter,Launcher:UnitLauncher,Missile:UnitMissile,Planet:UnitPlanet,Route:UnitRoute,Mining:UnitMining,Colony:UnitColony};const ZOOMTIME=500;class UnitScene extends Phaser.Scene{constructor(t,e){super({key:t}),this.debug=!0,this.cardScene=e,this.unitSprites=[],this.bulletSprites=[],this.eventQueue=new PriorityQueue,this.loser=null}init(){this.zoomTween=null}preload(){this.load.path=this.registry.get("path");let t=["checkpoint","bullet","hand"],e=[{name:"explode",size:16}];Unit.preload(t,e),Object.entries(Unit.Type).forEach(function(i){i[1].preload&&i[1].preload(t,e)});let i=this.scene.get("LoaderScene");i.loadImages(this,t),i.loadSpritesheets(this,e)}create(t){this.scene.sendToBack(),Object.entries(Unit.Type).forEach(function(t){if(t[1].animFrameRate){let e="Unit"+t[0];this.anims.create({key:e,frames:this.anims.generateFrameNumbers(e),frameRate:t[1].animFrameRate,repeat:-1,yoyo:!1})}},this),this.level=t,this.hqSprites=this.physics.add.group(),this.asteroids=this.physics.add.group(),this.physics.add.collider(this.asteroids,this.asteroids),this.physics.add.overlap(this.hqSprites,this.asteroids,this.overlapUnit,null,this),this.planets=this.physics.add.group(),this.physics.add.overlap(this.asteroids,this.planets,this.overlapUnit,null,this),this.fields=this.physics.add.group(),this.physics.add.overlap(this.fields,this.fields,this.overlapUnit,null,this),this.unitMap=new UnitMap(this,this.level,this.hqSprites),this.pathCurve=new PathCurve(this,this.level.size),this.pathCurve.graphics.setDepth(-1),this.scene.sendToBack(),this.cardScene.readyToStart(),this.cameras.main.fadeIn(500)}zoomTo(t,e,i){}addTeam(t){if(this.unitSprites[t])return;let e=this.physics.add.group();e.runChildUpdate=!1;let i=this.physics.add.group();i.runChildUpdate=!1;for(let t=0;t<this.unitSprites.length;t++)this.physics.add.collider(e,this.unitSprites[t],this.overlapUnit,null,this),this.physics.add.overlap(i,this.unitSprites[t],this.overlapUnit,null,this),this.physics.add.overlap(this.bulletSprites[t],e,this.overlapUnit,null,this);this.unitSprites[t]=e,this.bulletSprites[t]=i,this.physics.add.overlap(this.hqSprites,this.unitSprites[t],this.overlapUnit,null,this),this.physics.add.collider(this.asteroids,e,this.overlapUnit,null,this),this.physics.add.overlap(this.fields,e,this.overlapUnit,null,this),this.physics.add.overlap(this.asteroids,i,this.overlapUnit,null,this),this.physics.add.overlap(this.planets,e,this.overlapUnit,null,this)}addBullet(t,e){this.bulletSprites[t].add(e),e.scene=this,this.add.existing(e),this.debug&&(e.body.debugShowBody=!0,e.body.debugShowVelocity=!0)}overlapUnit(t,e){this.physics.world.isPaused||t.overlap(e)}scaleResolution(t){return t*this.game.resolution}explode(t){let e=this.add.particles("explode");e.createEmitter({frame:[2],x:t.x,y:t.y,speed:{start:this.scaleResolution(150),end:this.scaleResolution(-150)},quantity:5,ease:"Power2",lifespan:1500,maxParticles:50,blendMode:"SCREEN",alpha:{start:1,end:0}}),e.createEmitter({frame:[0],x:t.x,y:t.y,speed:{start:this.scaleResolution(100),end:this.scaleResolution(-100)},quantity:5,ease:"Power2",lifespan:1e3,maxParticles:100,blendMode:"SCREEN",alpha:{start:1,end:0}}),e.createEmitter({frame:[0],x:t.x,y:t.y,speed:{start:this.scaleResolution(75),end:this.scaleResolution(-75)},quantity:5,ease:"Power2",lifespan:1e3,maxParticles:50,blendMode:"SCREEN",alpha:{start:1,end:0}});e.createGravityWell({x:t.x,y:t.y,power:2,epsilon:100,gravity:t.scene.scaleResolution(8)});this.time.delayedCall(2e3,function(){e.destroy()},this)}showGameOver(t,e,i,s,a,r,h){this.input.enabled=!1;let n=this.add.group();this.cardScene.input.once("pointerdown",function(){n.destroy(!0),n=null,this.input.enabled=!0},this);let l=this.add.graphics();if(n.add(l),l.fillStyle(0,.5),l.fillRect(0,0,this.cameras.main.width,this.cameras.main.height),this.level.tutorial.img)return void this.add.image(this.cameras.main.centerX,this.cameras.main.centerY/3,"tutorial-drag-to-select");let o=-1===e?this.cameras.main.centerX:e*r,d=-1===i?this.cameras.main.centerY:i*h,c=n.create(o,d,"sprites","alice.png");if(c.setDepth(10),c.alpha=0,a){let t=n.create(a[0]*r,a[1]*h,"sprites","hand.png");t.x<this.cameras.main.width/2&&(t.scaleX=-1),this.tweens.add({targets:t,duration:400,x:t.x+20,delay:s,repeat:a.length>2?2:4,yoyo:!0,callbackScope:this,onComplete:function(){n&&(a.length>2?(t.scaleX=1,t.x=a[2]*r,t.y=a[3]*h,this.tweens.add({targets:t,duration:400,x:t.x+20,delay:s,repeat:1,yoyo:!0,callbackScope:this,onComplete:function(){}},this)):t.destroy())}},this)}this.tweens.add({targets:c,duration:400,alpha:1,delay:s/4,repeat:1,callbackScope:this,onComplete:function(){if(!n)return;let e=n.create(c.x,c.y+c.height/2,"sprites","dialog.png");e.setDepth(10);let i=e.width/12,s=this.add.text(e.x,e.y-e.width/26/2,t,{fontFamily:"Source Code Pro",fontSize:i,color:"#000",align:"center"}).setOrigin(.5);s.setDepth(10),n.add(s)}},this)}gameOver(t){if(!this.loser){if(0!==t.id){let t=!1;if(this.level.data.players.forEach(function(e){0!==e.id&&e.HQ&&(t=!0)},this),t)return}this.loser=t,this.cardScene.gameOver(t),this.time.removeAllEvents(),this.physics.pause(),this.anims.pauseAll(),this.eventQueue.destroy(),this.physics.world.colliders.destroy()}}destroyed(){for(let t=0;t<this.unitSprites.length;t++){let e=this.unitSprites[t];e.runChildUpdate=!1;for(let t=e.getChildren().length-1;t>=0;t--){e.getChildren()[t].destroy(!0)}let i=this.bulletSprites[t];i.runChildUpdate=!1;for(let t=0,e=i.getChildren().length;t<e;t++){i.getChildren()[t].destroy(!0)}}this.hqSprites.runChildUpdate=!1;for(let t=this.hqSprites.getChildren().length-1;t>=0;t--){this.hqSprites.getChildren()[t].destroy(!0)}this.planets.runChildUpdate=!1;for(let t=this.planets.getChildren().length-1;t>=0;t--){this.planets.getChildren()[t].destroy(!0)}this.asteroids.runChildUpdate=!1;for(let t=this.asteroids.getChildren().length-1;t>=0;t--){this.asteroids.getChildren()[t].destroy(!0)}this.eventQueue.destroy()}getSpritesAt(t,e){let i=[],s=this.hqSprites.getChildren();for(let a=s.length-1;a>=0;a--){let r=s[a];r.getBounds().contains(t,e)&&i.push(r)}return i}addEvent(t,e,i){this.eventQueue.enqueue([t,this.time.now+e,i])}clearEvents(t){this.eventQueue.clear(t)}update(t,e){if(this.loser)return;let i=this.eventQueue.dequeueExpired(t);for(;null!==i;)i[0].call(i[2]),i=this.eventQueue.dequeueExpired(t)}}const LEVEL="building-4";function log(t){console.log(t)}const levels=["begin-1","building-1","building-2","building-3","building-4","laser-1","laser-2","laser-3","mining-1","mining-2","energylow-1","energylow-2","energylow-3","spell-1","spell-2","spell-3","airoute-1","airoute-2","airoute-3","multi-1","multi-2","multi-3","aiturret-1","to-be-continued","aiturret-2","aiturret-3","limitedtech-1","limitedtech-2","gravity-1","gravity-2","fighter-1","fighter-2","end"];function createGame(){let t=document.getElementById("canvas");window.game=new MainGame("darkuniverse",t,levels,"#00001b")}function setGameConfig(t,e,i){}window.onresize=function(t){};